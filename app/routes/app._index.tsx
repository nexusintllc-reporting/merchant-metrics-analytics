// // // // ==================== 1.0 IMPORTS & SETUP ====================

// // // import { json, type LoaderFunctionArgs } from "@remix-run/node";
// // // import { useLoaderData } from "@remix-run/react";
// // // import { authenticate } from "../shopify.server";
// // // import { useState, useEffect, useMemo } from "react";
// // // import "../styles/orders.css";

// // // import {
// // //   Chart as ChartJS,
// // //   CategoryScale,
// // //   LinearScale,
// // //   BarElement,
// // //   LineElement,
// // //   PointElement,
// // //   ArcElement,
// // //   Title,
// // //   Tooltip,
// // //   Legend,
// // //   Filler,
// // // } from 'chart.js';
// // // import { Bar, Line, Pie, Doughnut } from 'react-chartjs-2';

// // // ChartJS.register(
// // //   CategoryScale,
// // //   LinearScale,
// // //   BarElement,
// // //   LineElement,
// // //   PointElement,
// // //   ArcElement,
// // //   Title,
// // //   Tooltip,
// // //   Legend,
// // //   Filler
// // // );

// // // // ==================== 1.1 API CONFIGURATION ====================

// // // const SHOPIFY_API_VERSION = process.env.SHOPIFY_API_VERSION || '2024-04';

// // // // ==================== 2.0 TYPE DEFINITIONS ====================

// // // interface Order {
// // //   id: number;
// // //   created_at: string;
// // //   total_price: string;
// // //   total_discounts?: string;
// // //   total_shipping_price_set?: {
// // //     shop_money: { amount: string };
// // //   };
// // //   total_tax?: string;
// // //   total_refunds?: string;
// // //   fulfillment_status?: string;
// // //   line_items?: Array<{
// // //     quantity: number;
// // //   }>;
// // //   customer?: {
// // //     id?: string | number;
// // //   };
// // // }

// // // type EventSummary = {
// // //   refunds: {
// // //     count: number;
// // //     value: number;
// // //   };
// // //   exchanges: {
// // //     count: number;
// // //     value: number;
// // //   };
// // //   partialRefunds: {
// // //     count: number;
// // //     value: number;
// // //   };
// // //   totalEvents: number;
// // //   netValue: number;
// // // };

// // // interface OrderStats {
// // //   total: number;
// // //   items: number;
// // //   fulfilled: number;
// // //   unfulfilled: number;
// // //   discounts: number;
// // //   shipping: number;
// // //   taxes: number;
// // //   returns: number;
// // //   orderCount: number;
// // //   netSales: number;
// // //   extraFees: number;
// // //   totalSales: number;
// // //   shippingRefunds: number;
// // //   netReturns: number;
// // //   totalRefund: number;
// // //   discountsReturned?: number;
// // //   netDiscounts?: number;
// // //   returnShippingCharges?: number;
// // //   restockingFees?: number;
// // //   returnFees?: number;
// // //   refundDiscrepancy?: number;
// // //   hasSubsequentEvents: boolean;
// // //   eventSummary: EventSummary | null;
// // //   refundsCount: number;
// // //   financialStatus: string;
// // // }

// // // interface CustomerData {
// // //   newCustomers: number;
// // //   repeatedCustomers: number;
// // //   totalCustomers: number;
// // // }

// // // interface AnalyticsData {
// // //   shop: string;
// // //   totals: Record<string, OrderStats>;
// // //   dailyTotals: Record<string, OrderStats & CustomerData>;
// // //   weeklyTotals: Record<string, OrderStats & CustomerData>;
// // //   monthlyTotals: Record<string, OrderStats & CustomerData>;
// // //   totalOrders: number;
// // //   totalCustomerData: CustomerData;
// // //   monthRanges: string[];
// // //   dailyKeys: string[];
// // //   weeklyKeys: string[];
// // //   lastUpdated: string;
// // //   shopTimeZone: string;
// // //   shopCurrency: string;
// // // }

// // // interface CachedAnalyticsData extends AnalyticsData {
// // //   _cacheInfo?: {
// // //     fetchMode: "incremental" | "full";
// // //     apiSuccess: boolean;
// // //     cacheHealth: {
// // //       total: number;
// // //       valid: number;
// // //       expired: number;
// // //       health: number;
// // //     };
// // //     cacheStats: {
// // //       size: number;
// // //       version: number;
// // //     };
// // //     cacheUsed: boolean;
// // //     cacheHit: boolean;
// // //     fallbackUsed: boolean;
// // //     cacheTimestamp?: number;
// // //     performance?: {
// // //       cacheOperationTime: number;
// // //       totalLoaderTime: number;
// // //     };
// // //   };
// // // }

// // // interface OrderData {
// // //   totalOrders: number;
// // //   totalCustomers: number;
// // //   fulfillmentRate: number;
// // //   totalRevenue: number;
// // //   netRevenue: number;
// // //   averageOrderValue: number;
// // //   totalItems: number;
// // //   todayOrders: number;
// // //   todayRevenue: number;
// // //   todayItems: number;
// // //   ordersChangeVsYesterday: number;
// // //   revenueChangeVsYesterday: number;
// // //   itemsChangeVsYesterday: number;
// // //   newCustomers: number;
// // //   repeatCustomers: number;
// // //   customerRetentionRate: number;
// // //   averageOrderFrequency: number;
// // //   shopTimezone: string;
// // //   shopCurrency: string;
// // //   totalRefunds?: number;
// // //   totalExchanges?: number;
// // //   totalPartialRefunds?: number;
// // //   totalEvents?: number;
// // //   ordersWithEvents?: number;
// // //   netEventValue?: number;
// // // }

// // // // ==================== 3.0 CACHE MANAGER ====================

// // // class PersistentCacheManager {
// // //   private memoryStorage: Map<string, any> = new Map();
// // //   public version = 1;

// // //   private performanceMetrics = {
// // //     setOperations: 0,
// // //     getOperations: 0,
// // //     removeOperations: 0,
// // //     totalSetTime: 0,
// // //     totalGetTime: 0,
// // //     totalRemoveTime: 0
// // //   };

// // //   private validateCacheData(data: any): boolean {
// // //     try {
// // //       if (!data) return false;
// // //       if (data.orders && !Array.isArray(data.orders)) return false;
// // //       if (data.lastUpdatedAt && isNaN(Date.parse(data.lastUpdatedAt))) return false;
// // //       return true;
// // //     } catch (error) {
// // //       return false;
// // //     }
// // //   }

// // //   private async getPersistentStorage(): Promise<Map<string, any>> {
// // //     return this.memoryStorage;
// // //   }

// // //   async set<T>(key: string, value: T, ttl: number = 30 * 60 * 1000): Promise<void> {
// // //     const startTime = performance.now();
    
// // //     try {
// // //       if (!key || typeof key !== 'string') {
// // //         throw new Error('Invalid cache key');
// // //       }

// // //       if (!this.validateCacheData(value)) {
// // //         throw new Error('Invalid cache data structure');
// // //       }

// // //       const storage = await this.getPersistentStorage();
// // //       const entry = {
// // //         value,
// // //         timestamp: Date.now(),
// // //         ttl,
// // //         key,
// // //         version: this.version
// // //       };
      
// // //       storage.set(key, entry);
      
// // //       if (typeof window !== 'undefined' && window.localStorage) {
// // //         try {
// // //           localStorage.setItem(key, JSON.stringify(entry));
// // //         } catch (e) {
// // //         }
// // //       }
// // //       await this.enforceSizeLimit(50);
      
// // //     } catch (error) {
// // //       throw error;
// // //     } finally {
// // //       const duration = performance.now() - startTime;
// // //       this.performanceMetrics.setOperations++;
// // //       this.performanceMetrics.totalSetTime += duration;
// // //     }
// // //   }

// // //   async get<T>(key: string): Promise<{ value: T; timestamp: number } | null> {
// // //     const startTime = performance.now();
    
// // //     try {
// // //       const storage = await this.getPersistentStorage();
// // //       let entry = storage.get(key);
      
// // //       if (!entry && typeof window !== 'undefined' && window.localStorage) {
// // //         try {
// // //           const stored = localStorage.getItem(key);
// // //           if (stored) {
// // //             entry = JSON.parse(stored);
// // //             storage.set(key, entry);
// // //           }
// // //         } catch (e) {
// // //           await this.remove(key);
// // //           return null;
// // //         }
// // //       }

// // //       if (!entry) {
// // //         return null;
// // //       }

// // //       const isExpired = Date.now() - entry.timestamp > entry.ttl;
// // //       if (isExpired) {
// // //         await this.remove(key);
// // //         return null;
// // //       }

// // //       if (!this.validateCacheData(entry.value)) {
// // //         await this.remove(key);
// // //         return null;
// // //       }

// // //       return { value: entry.value, timestamp: entry.timestamp };
// // //     } catch (error) {
// // //       await this.remove(key);
// // //       return null;
// // //     } finally {
// // //       const duration = performance.now() - startTime;
// // //       this.performanceMetrics.getOperations++;
// // //       this.performanceMetrics.totalGetTime += duration;
// // //     }
// // //   }

// // //   async remove(key: string): Promise<void> {
// // //     const startTime = performance.now();
    
// // //     try {
// // //       const storage = await this.getPersistentStorage();
// // //       storage.delete(key);
      
// // //       if (typeof window !== 'undefined' && window.localStorage) {
// // //         try {
// // //           localStorage.removeItem(key);
// // //         } catch (e) {
// // //         }
// // //       }
// // //     } catch (error) {
// // //     } finally {
// // //       const duration = performance.now() - startTime;
// // //       this.performanceMetrics.removeOperations++;
// // //       this.performanceMetrics.totalRemoveTime += duration;
// // //     }
// // //   }

// // //   async emergencyReset(shop: string): Promise<void> {
// // //     const keys = [
// // //       makeCacheKey(shop, "orders"),
// // //     ];
    
// // //     for (const key of keys) {
// // //       await this.remove(key);
// // //     }
// // //   }

// // //   async cleanAllExpired(): Promise<number> {
// // //     let cleanedCount = 0;
// // //     const storage = await this.getPersistentStorage();
// // //     const now = Date.now();
    
// // //     for (const [key, entry] of storage.entries()) {
// // //       if (now - entry.timestamp > entry.ttl) {
// // //         await this.remove(key);
// // //         cleanedCount++;
// // //       }
// // //     }
    
// // //     if (typeof window !== 'undefined' && window.localStorage) {
// // //       for (let i = 0; i < localStorage.length; i++) {
// // //         const key = localStorage.key(i);
// // //         if (key && key.includes('::analytics::')) {
// // //           try {
// // //             const stored = localStorage.getItem(key);
// // //             if (stored) {
// // //               const entry = JSON.parse(stored);
// // //               if (now - entry.timestamp > entry.ttl) {
// // //                 localStorage.removeItem(key);
// // //                 cleanedCount++;
// // //               }
// // //             }
// // //           } catch (e) {
// // //             localStorage.removeItem(key);
// // //             cleanedCount++;
// // //           }
// // //         }
// // //       }
// // //     }
    
// // //     return cleanedCount;
// // //   }

// // //   async enforceSizeLimit(maxSize: number = 100): Promise<void> {
// // //     const storage = await this.getPersistentStorage();
// // //     if (storage.size <= maxSize) return;
    
// // //     const entries = Array.from(storage.entries())
// // //       .sort((a, b) => a[1].timestamp - b[1].timestamp);
      
// // //     const toRemove = storage.size - maxSize;
// // //     for (let i = 0; i < toRemove; i++) {
// // //       await this.remove(entries[i][0]);
// // //     }
// // //   }

// // //   getStats() {
// // //     return {
// // //       size: this.memoryStorage.size,
// // //       version: this.version
// // //     };
// // //   }

// // //   getPerformanceReport() {
// // //     const avgSetTime = this.performanceMetrics.setOperations > 0 
// // //       ? this.performanceMetrics.totalSetTime / this.performanceMetrics.setOperations 
// // //       : 0;
    
// // //     const avgGetTime = this.performanceMetrics.getOperations > 0 
// // //       ? this.performanceMetrics.totalGetTime / this.performanceMetrics.getOperations 
// // //       : 0;
    
// // //     const avgRemoveTime = this.performanceMetrics.removeOperations > 0 
// // //       ? this.performanceMetrics.totalRemoveTime / this.performanceMetrics.removeOperations 
// // //       : 0;

// // //     return {
// // //       operations: {
// // //         set: this.performanceMetrics.setOperations,
// // //         get: this.performanceMetrics.getOperations,
// // //         remove: this.performanceMetrics.removeOperations
// // //       },
// // //       averageTimes: {
// // //         set: parseFloat(avgSetTime.toFixed(2)),
// // //         get: parseFloat(avgGetTime.toFixed(2)),
// // //         remove: parseFloat(avgRemoveTime.toFixed(2))
// // //       },
// // //       totalTimes: {
// // //         set: parseFloat(this.performanceMetrics.totalSetTime.toFixed(2)),
// // //         get: parseFloat(this.performanceMetrics.totalGetTime.toFixed(2)),
// // //         remove: parseFloat(this.performanceMetrics.totalRemoveTime.toFixed(2))
// // //       }
// // //     };
// // //   }

// // //   healthReport() {
// // //     const now = Date.now();
// // //     let expiredCount = 0;
// // //     let validCount = 0;

// // //     for (const entry of this.memoryStorage.values()) {
// // //       if (now - entry.timestamp > entry.ttl) {
// // //         expiredCount++;
// // //       } else {
// // //         validCount++;
// // //       }
// // //     }

// // //     const total = this.memoryStorage.size;
// // //     const health = total > 0 ? validCount / total : 1;

// // //     return {
// // //       total: total,
// // //       valid: validCount,
// // //       expired: expiredCount,
// // //       health: health,
// // //       sizeInfo: {
// // //         memorySize: total,
// // //         recommendedMax: 50,
// // //         needsCleaning: total > 50
// // //       }
// // //     };
// // //   }
// // // }

// // // const cacheManager = new PersistentCacheManager();

// // // // ==================== 4.0 HELPER FUNCTIONS ====================

// // // function makeCacheKey(shop: string, segment: string): string {
// // //   return `${shop}::analytics::${segment}::v${cacheManager.version}`;
// // // }

// // // function nowISO(): string {
// // //   return new Date().toISOString();
// // // }

// // // function getMonthRanges(shopTimeZone: string = "UTC") {
// // //   const ranges: { start: string; end: string; key: string }[] = [];
// // //   const now = new Date();

// // //   for (let i = 6; i >= 0; i--) {
// // //     const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
// // //     const start = new Date(date.getFullYear(), date.getMonth(), 1);
// // //     const end = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
// // //     ranges.push({
// // //       start: start.toISOString(),
// // //       end: end.toISOString(),
// // //       key: date.toLocaleString("default", { month: "short", year: "numeric" }),
// // //     });
// // //   }

// // //   return ranges;
// // // }

// // // function getLastNDays(n: number, shopTimeZone: string = "UTC") {
// // //   const days: string[] = [];
// // //   const now = new Date();
  
// // //   for (let i = n - 1; i >= 0; i--) {
// // //     const d = new Date(now);
// // //     d.setDate(now.getDate() - i);
// // //     const dayKey = d.toLocaleDateString("en-CA", { timeZone: shopTimeZone });
// // //     days.push(dayKey);
// // //   }
  
// // //   return days;
// // // }

// // // function getLast8Weeks(shopTimeZone: string = "UTC") {
// // //   const weeks: string[] = [];
// // //   const now = new Date();
// // //   const monday = new Date(now);
// // //   monday.setDate(now.getDate() - ((now.getDay() + 6) % 7));
// // //   for (let i = 7; i >= 0; i--) {
// // //     const startOfWeek = new Date(monday);
// // //     startOfWeek.setDate(monday.getDate() - i * 7);
// // //     const key = `Week of ${startOfWeek.toLocaleDateString("en-CA", { timeZone: shopTimeZone })}`;
// // //     weeks.push(key);
// // //   }
// // //   return weeks;
// // // }


// // // function formatWeekDisplay(weekKey: string): string {
// // //   if (weekKey.startsWith('Week of ')) {
// // //     const dateStr = weekKey.replace('Week of ', '');
// // //     const startOfWeek = new Date(dateStr + 'T00:00:00');
// // //     const endOfWeek = new Date(startOfWeek);
// // //     endOfWeek.setDate(startOfWeek.getDate() + 6);
    
// // //     const startMonth = startOfWeek.toLocaleDateString("en-US", { month: "short" });
// // //     const startDay = startOfWeek.getDate();
// // //     const endMonth = endOfWeek.toLocaleDateString("en-US", { month: "short" });
// // //     const endDay = endOfWeek.getDate();
    
// // //     return `${startMonth} ${startDay}-${endMonth} ${endDay}`;
// // //   }
// // //   return weekKey;
// // // }

// // // // ==================== 5.0 API FETCHING FUNCTIONS ====================

// // // async function fetchOrdersSince(
// // //   shop: string, 
// // //   accessToken: string, 
// // //   sinceDate: string, 
// // //   cachedOrders: any[] = []
// // // ): Promise<{ orders: any[]; hasMore: boolean }> {

// // //   let newOrders: any[] = [];
// // //   let url = `https://${shop}/admin/api/${SHOPIFY_API_VERSION}/orders.json?status=any&limit=250&updated_at_min=${sinceDate}`;
// // //   let pageCount = 0;
// // //   let hasMore = true;

// // //   while (url && hasMore) {
// // //     pageCount++;

// // //     const response = await fetch(url, { 
// // //       headers: { "X-Shopify-Access-Token": accessToken } 
// // //     });

// // //     if (!response.ok) {
// // //       if (response.status === 429) {
// // //         const retryAfter = response.headers.get('Retry-After') || '10';
// // //         const waitTime = parseInt(retryAfter) * 1000;
// // //         await new Promise(resolve => setTimeout(resolve, waitTime));
// // //         continue;
// // //       }
// // //       throw new Error(`HTTP error! status: ${response.status}`);
// // //     }

// // //     const data = await response.json();
// // //     const apiOrders: any[] = data.orders || [];
    
// // //     newOrders = newOrders.concat(apiOrders);

// // //     const linkHeader = response.headers.get("Link");
// // //     const nextMatch = linkHeader?.match(/<([^>]+)>; rel="next"/);
// // //     url = nextMatch ? nextMatch[1] : "";
// // //     hasMore = !!url;

// // //     if (url) {
// // //       await new Promise(resolve => setTimeout(resolve, 200));
// // //     }
// // //   }

// // //   return { orders: newOrders, hasMore: false };
// // // }

// // // async function fetchOrdersForPeriod(shop: string, accessToken: string, startDate: string, endDate: string) {
// // //   let allOrders: any[] = [];
// // //   let url = `https://${shop}/admin/api/${SHOPIFY_API_VERSION}/orders.json?status=any&limit=250&created_at_min=${startDate}&created_at_max=${endDate}`;
// // //   let pageCount = 0;

// // //   while (url) {
// // //     pageCount++;

// // //     const response = await fetch(url, { 
// // //       headers: { "X-Shopify-Access-Token": accessToken } 
// // //     });

// // //     if (!response.ok) {
// // //       if (response.status === 429) {
// // //         const retryAfter = response.headers.get('Retry-After') || '10';
// // //         const waitTime = parseInt(retryAfter) * 1000;
// // //         await new Promise(resolve => setTimeout(resolve, waitTime));
// // //         continue;
// // //       } else {
// // //         throw new Error(`HTTP error! status: ${response.status}`);
// // //       }
// // //     }

// // //     const data = await response.json();
// // //     const ordersCount = data.orders?.length || 0;
    
// // //     allOrders = allOrders.concat(data.orders || []);

// // //     const linkHeader = response.headers.get("Link");
// // //     const nextMatch = linkHeader?.match(/<([^>]+)>; rel="next"/);
// // //     url = nextMatch ? nextMatch[1] : "";
// // //   }

// // //   return allOrders;
// // // }

// // // // ==================== 6.0 EVENT DETECTION LOGIC ====================

// // // function calculateOrderEventSummary(order: any, periodStart: Date, periodEnd: Date): EventSummary | null {
// // //   const eventSummary: EventSummary = {
// // //     refunds: { count: 0, value: 0 },
// // //     exchanges: { count: 0, value: 0 },
// // //     partialRefunds: { count: 0, value: 0 },
// // //     totalEvents: 0,
// // //     netValue: 0
// // //   };

// // //   const orderRefunds = order.refunds || [];
// // //   let hasEvents = false;

// // //   orderRefunds.forEach((refund: any) => {
// // //     const refundDate = new Date(refund.created_at);
    
// // //     if (refundDate >= periodStart && refundDate <= periodEnd) {
// // //       let refundAmount = 0;
      
// // //       if (refund.transactions && refund.transactions.length > 0) {
// // //         refund.transactions.forEach((transaction: any) => {
// // //           if (transaction.kind === 'refund' && transaction.status === 'success') {
// // //             refundAmount += Math.abs(parseFloat(transaction.amount) || 0);
// // //           }
// // //         });
// // //       }

// // //       const isFullRefund = refundAmount === parseFloat(order.total_price);
// // //       const hasExchangeTags = order.tags?.includes('exchange') || order.note?.includes('exchange');
// // //       const hasMultipleFulfillments = order.fulfillments && order.fulfillments.length > 1;
// // //       const isExchange = hasExchangeTags || hasMultipleFulfillments;

// // //       if (isFullRefund && !isExchange) {
// // //         eventSummary.refunds.count++;
// // //         eventSummary.refunds.value -= refundAmount;
// // //       } else if (isExchange) {
// // //         eventSummary.exchanges.count++;
// // //         const exchangeValue = -refundAmount;
// // //         eventSummary.exchanges.value += exchangeValue;
// // //       } else {
// // //         eventSummary.partialRefunds.count++;
// // //         eventSummary.partialRefunds.value -= refundAmount;
// // //       }

// // //       eventSummary.totalEvents++;
// // //       eventSummary.netValue -= refundAmount;
// // //       hasEvents = true;
// // //     }
// // //   });

// // //   return hasEvents ? eventSummary : null;
// // // }

// // // // ==================== 7.0 FINANCIAL CALCULATION ENGINE ====================

// // // function processSimpleOrder(order: any): OrderStats {
// // //   const grossSales = parseFloat(order.total_line_items_price) || 0;
// // //   const totalDiscounts = Math.abs(parseFloat(order.total_discounts) || 0);
// // //   const shipping = parseFloat(order.total_shipping_price_set?.shop_money?.amount || "0") || 0;
// // //   const taxes = parseFloat(order.current_total_tax) || 0;
// // //   const totalSales = parseFloat(order.current_total_price) || 0;
  
// // //   const itemsCount = order.line_items?.reduce((sum: number, li: any) => sum + li.quantity, 0) || 0;
// // //   const fulfilledCount = order.fulfillment_status === "fulfilled" ? 1 : 0;
// // //   const unfulfilledCount = order.fulfillment_status !== "fulfilled" ? 1 : 0;

// // //   return {
// // //     total: parseFloat(grossSales.toFixed(2)),
// // //     discounts: parseFloat(totalDiscounts.toFixed(2)),
// // //     returns: 0,
// // //     netSales: parseFloat((grossSales - totalDiscounts).toFixed(2)),
// // //     shipping: parseFloat(shipping.toFixed(2)),
// // //     taxes: parseFloat(taxes.toFixed(2)),
// // //     extraFees: 0,
// // //     totalSales: parseFloat(totalSales.toFixed(2)),
// // //     shippingRefunds: 0,
// // //     netReturns: 0,
// // //     totalRefund: 0,
    
// // //     items: itemsCount,
// // //     fulfilled: fulfilledCount,
// // //     unfulfilled: unfulfilledCount,
// // //     orderCount: 1,
    
// // //     discountsReturned: 0,
// // //     netDiscounts: parseFloat(totalDiscounts.toFixed(2)),
// // //     returnShippingCharges: 0,
// // //     restockingFees: 0,
// // //     returnFees: 0,
// // //     refundDiscrepancy: 0,
    
// // //     hasSubsequentEvents: false,
// // //     eventSummary: null,
// // //     refundsCount: 0,
// // //     financialStatus: order.financial_status || 'pending'
// // //   };
// // // }

// // // function processOrderToStats(order: any): OrderStats {
// // //   const hasRefunds = order.refunds && order.refunds.length > 0;
// // //   const hasComplexFulfillment = order.fulfillments && order.fulfillments.length > 1;
// // //   const hasExchangeTags = order.tags?.includes('exchange') || order.note?.includes('exchange');
  
// // //   if (!hasRefunds && !hasComplexFulfillment && !hasExchangeTags) {
// // //     return processSimpleOrder(order);
// // //   }

// // //   const grossSales = parseFloat(order.total_line_items_price) || 0;
// // //   const totalDiscounts = Math.abs(parseFloat(order.total_discounts) || 0);
// // //   const originalShipping = parseFloat(order.total_shipping_price_set?.shop_money?.amount || "0") || 0;
// // //   const taxes = parseFloat(order.current_total_tax) || 0;
// // //   const totalSales = parseFloat(order.current_total_price) || 0;

// // //   let grossReturns = 0;
// // //   let discountsReturned = 0;
// // //   let shippingRefunds = 0;
// // //   let returnShippingCharges = 0;
// // //   let restockingFees = 0;
// // //   let returnFees = 0;
// // //   let positiveAdjustments = 0;
// // //   let totalItemRefunds = 0;
// // //   let totalActualRefund = 0;
// // //   let extraFees = 0;
// // //   let refundDiscrepancy = 0;
// // //   let netReturns = 0;

// // //   let isExchangeOrder = false;
// // //   let exchangeItemValue = 0;

// // //   const orderRefunds = order.refunds || [];

// // //   if (orderRefunds.length > 0) {
// // //     for (let i = 0; i < orderRefunds.length; i++) {
// // //       const refund = orderRefunds[i];
      
// // //       if (refund.transactions && refund.transactions.length > 0) {
// // //         for (let j = 0; j < refund.transactions.length; j++) {
// // //           const transaction = refund.transactions[j];
// // //           if (transaction.kind === 'refund' && transaction.status === 'success') {
// // //             const refundAmount = Math.abs(parseFloat(transaction.amount) || 0);
// // //             totalActualRefund += refundAmount;
// // //             netReturns += refundAmount;
// // //           }
// // //         }
// // //       }

// // //       if (refund.refund_line_items) {
// // //         for (let j = 0; j < refund.refund_line_items.length; j++) {
// // //           const item = refund.refund_line_items[j];
// // //           const itemValue = Math.abs(parseFloat(item.subtotal) || 0);
// // //           grossReturns -= itemValue;
// // //           totalItemRefunds += itemValue;
          
// // //           const lineItemDiscount = parseFloat(item.total_discount) || 0;
// // //           discountsReturned += Math.abs(lineItemDiscount);
// // //         }
// // //       }
      
// // //       if (refund.order_adjustments && refund.order_adjustments.length > 0) {
// // //         for (let j = 0; j < refund.order_adjustments.length; j++) {
// // //           const adjustment = refund.order_adjustments[j];
// // //           const amount = parseFloat(adjustment.amount) || 0;
// // //           const absAmount = Math.abs(amount);
          
// // //           if (adjustment.kind === 'shipping_refund') {
// // //             shippingRefunds += amount;
// // //           }
// // //           else if (adjustment.kind === 'return_shipping' || adjustment.reason?.includes('shipping')) {
// // //             returnShippingCharges += absAmount;
// // //           }
// // //           else if (adjustment.kind === 'restocking_fee' || adjustment.reason?.includes('restock')) {
// // //             restockingFees += absAmount;
// // //           }
// // //           else if (adjustment.kind === 'return_fee' || adjustment.reason?.includes('fee')) {
// // //             returnFees += absAmount;
// // //           }
// // //           else if (adjustment.kind === 'refund_discrepancy') {
// // //             refundDiscrepancy += amount;
// // //             if (amount > 0) {
// // //               positiveAdjustments += absAmount;
// // //             } else if (amount < 0) {
// // //               grossReturns += amount;
// // //             }
// // //           }
// // //         }
// // //       }
      
// // //       if (refund.total_additional_fees_set) {
// // //         const additionalFees = parseFloat(refund.total_additional_fees_set?.shop_money?.amount || "0") || 0;
// // //         returnFees += additionalFees;
// // //       }
// // //     }
// // //   }

// // //   const shopifyReturns = grossReturns + positiveAdjustments - discountsReturned;
// // //   const totalRefund = shopifyReturns + refundDiscrepancy;
// // //   const isFullRefund = Math.abs(grossSales + shopifyReturns) < 0.01;

// // //   const netDiscounts = totalDiscounts - discountsReturned;
// // //   const shippingCharges = Math.max(0, originalShipping - Math.abs(shippingRefunds));

// // //   let netSales;
// // //   let adjustedTotalSales = totalSales;

// // //   if (orderRefunds.length > 0) {
// // //     const hasMultipleFulfillments = order.fulfillments && order.fulfillments.length > 1;
    
// // //     if (hasMultipleFulfillments) {
// // //       isExchangeOrder = true;
      
// // //       if (order.line_items) {
// // //         for (let i = 0; i < order.line_items.length; i++) {
// // //           const item = order.line_items[i];
// // //           let isRefunded = false;
          
// // //           if (orderRefunds[0]?.refund_line_items) {
// // //             for (let j = 0; j < orderRefunds[0].refund_line_items.length; j++) {
// // //               const refundItem = orderRefunds[0].refund_line_items[j];
// // //               if (refundItem.line_item_id === item.id) {
// // //                 isRefunded = true;
// // //                 break;
// // //               }
// // //             }
// // //           }
          
// // //           if (!isRefunded && item.fulfillment_status === 'fulfilled') {
// // //             const itemPrice = parseFloat(item.price) || 0;
// // //             const itemQuantity = item.current_quantity || item.quantity || 0;
// // //             exchangeItemValue += itemPrice * itemQuantity;
// // //           }
// // //         }
// // //       }
// // //     }
    
// // //     if (!isExchangeOrder) {
// // //       const hasExchangeTags = order.tags?.includes('exchange') || 
// // //                              order.note?.includes('exchange') ||
// // //                              order.note?.includes('exchanged');
// // //       const hasComplexRefundHistory = orderRefunds.length > 1;
      
// // //       if (hasExchangeTags || hasComplexRefundHistory) {
// // //         isExchangeOrder = true;
        
// // //         if (order.line_items) {
// // //           for (let i = 0; i < order.line_items.length; i++) {
// // //             const item = order.line_items[i];
// // //             if (item.fulfillment_status === 'fulfilled') {
// // //               const itemPrice = parseFloat(item.price) || 0;
// // //               const itemQuantity = item.current_quantity || item.quantity || 0;
// // //               exchangeItemValue += itemPrice * itemQuantity;
// // //             }
// // //           }
// // //         }
// // //       }
// // //     }
// // //   }

// // //   if (isFullRefund && orderRefunds.length > 0) {
// // //     netSales = 0;
// // //   } else {
// // //     netSales = grossSales - netDiscounts + shopifyReturns + returnShippingCharges + restockingFees - refundDiscrepancy;
// // //   }

// // //   let appliedFunction = 'none';

// // //   if (isFullRefund && isExchangeOrder && orderRefunds.length > 0) {
// // //     extraFees = Math.max(0, Math.abs(totalSales) - exchangeItemValue);
// // //     appliedFunction = 'full_refund_with_exchange';
// // //   }
// // //   else if (isFullRefund && orderRefunds.length > 0) {
// // //     extraFees = Math.abs(totalSales);
// // //     appliedFunction = 'full_refund_no_exchange';
// // //   } 
// // //   else if (isExchangeOrder && !isFullRefund) {
// // //     extraFees = Math.max(0, totalSales - shippingCharges - netSales);
// // //     appliedFunction = 'exchange_partial';
// // //   }
// // //   else if (isExchangeOrder && !isFullRefund && totalItemRefunds > 0 && totalActualRefund > 0) {
// // //     const refundDifference = totalItemRefunds - totalActualRefund;
// // //     if (refundDifference > 0.01) {
// // //       extraFees = Math.max(0, refundDifference - exchangeItemValue);
// // //       appliedFunction = 'partial_refund_with_exchange';
// // //     }
// // //   }
// // //   else if (!isFullRefund && totalItemRefunds > 0 && totalActualRefund > 0) {
// // //     const refundDifference = totalItemRefunds - totalActualRefund;
// // //     if (refundDifference > 0.01) {
// // //       extraFees = refundDifference;
// // //       appliedFunction = 'regular_partial_refund';
// // //     }
// // //   }

// // //   if (isFullRefund && orderRefunds.length > 0) {
// // //     adjustedTotalSales = extraFees;
// // //   }

// // //   const shouldApplyCatchAll = 
// // //     Math.abs(netSales) < 0.01 &&
// // //     totalSales > 0.01 &&
// // //     Math.abs(extraFees - (totalSales - shippingCharges)) > 0.01;

// // //   if (shouldApplyCatchAll) {
// // //     extraFees = Math.max(0, totalSales - shippingCharges);
// // //     appliedFunction = 'final_catch_all_override';
// // //   }

// // //   if (refundDiscrepancy < -0.01) {
// // //     adjustedTotalSales = Math.max(0, adjustedTotalSales + refundDiscrepancy);
// // //   }

// // //   const orderDate = new Date(order.created_at);
// // //   const periodStart = new Date(orderDate.getFullYear(), orderDate.getMonth(), orderDate.getDate());
// // //   const periodEnd = new Date(periodStart);
// // //   periodEnd.setDate(periodStart.getDate() + 1);
  
// // //   const eventSummary = calculateOrderEventSummary(order, periodStart, periodEnd);

// // //   const itemsCount = order.line_items?.reduce((sum: number, li: any) => sum + li.quantity, 0) || 0;
// // //   const fulfilledCount = order.fulfillment_status === "fulfilled" ? 1 : 0;
// // //   const unfulfilledCount = order.fulfillment_status !== "fulfilled" ? 1 : 0;

// // //   return {
// // //     total: parseFloat(grossSales.toFixed(2)),
// // //     discounts: parseFloat(totalDiscounts.toFixed(2)),
// // //     returns: parseFloat(shopifyReturns.toFixed(2)),
// // //     netSales: parseFloat(netSales.toFixed(2)),
// // //     shipping: parseFloat(shippingCharges.toFixed(2)),
// // //     taxes: parseFloat(taxes.toFixed(2)),
// // //     extraFees: parseFloat(extraFees.toFixed(2)),
// // //     totalSales: parseFloat(adjustedTotalSales.toFixed(2)),
// // //     shippingRefunds: parseFloat(Math.abs(shippingRefunds).toFixed(2)),
// // //     netReturns: parseFloat(netReturns.toFixed(2)),
// // //     totalRefund: parseFloat(totalRefund.toFixed(2)),
    
// // //     items: itemsCount,
// // //     fulfilled: fulfilledCount,
// // //     unfulfilled: unfulfilledCount,
// // //     orderCount: 1,
    
// // //     discountsReturned: parseFloat(discountsReturned.toFixed(2)),
// // //     netDiscounts: parseFloat(netDiscounts.toFixed(2)),
// // //     returnShippingCharges: parseFloat(returnShippingCharges.toFixed(2)),
// // //     restockingFees: parseFloat(restockingFees.toFixed(2)),
// // //     returnFees: parseFloat(returnFees.toFixed(2)),
// // //     refundDiscrepancy: parseFloat(refundDiscrepancy.toFixed(2)),
    
// // //     hasSubsequentEvents: !!eventSummary,
// // //     eventSummary: eventSummary,
// // //     refundsCount: orderRefunds.length,
// // //     financialStatus: order.financial_status || 'pending'
// // //   };
// // // }

// // // function mergeStats(existing: OrderStats, newStats: OrderStats): OrderStats {
// // //   return {
// // //     total: existing.total + newStats.total,
// // //     discounts: existing.discounts + newStats.discounts,
// // //     returns: existing.returns + newStats.returns,
// // //     netSales: existing.netSales + newStats.netSales,
// // //     shipping: existing.shipping + newStats.shipping,
// // //     taxes: existing.taxes + newStats.taxes,
// // //     extraFees: existing.extraFees + newStats.extraFees,
// // //     totalSales: existing.totalSales + newStats.totalSales,
// // //     shippingRefunds: existing.shippingRefunds + newStats.shippingRefunds,
// // //     netReturns: existing.netReturns + newStats.netReturns,
// // //     totalRefund: existing.totalRefund + newStats.totalRefund,
    
// // //     items: existing.items + newStats.items,
// // //     fulfilled: existing.fulfilled + newStats.fulfilled,
// // //     unfulfilled: existing.unfulfilled + newStats.unfulfilled,
// // //     orderCount: existing.orderCount + newStats.orderCount,
    
// // //     discountsReturned: (existing.discountsReturned || 0) + (newStats.discountsReturned || 0),
// // //     netDiscounts: (existing.netDiscounts || 0) + (newStats.netDiscounts || 0),
// // //     returnShippingCharges: (existing.returnShippingCharges || 0) + (newStats.returnShippingCharges || 0),
// // //     restockingFees: (existing.restockingFees || 0) + (newStats.restockingFees || 0),
// // //     returnFees: (existing.returnFees || 0) + (newStats.returnFees || 0),
// // //     refundDiscrepancy: (existing.refundDiscrepancy || 0) + (newStats.refundDiscrepancy || 0),
    
// // //     hasSubsequentEvents: existing.hasSubsequentEvents || newStats.hasSubsequentEvents,
// // //     eventSummary: mergeEventSummaries(existing.eventSummary, newStats.eventSummary),
// // //     refundsCount: existing.refundsCount + newStats.refundsCount,
// // //     financialStatus: newStats.financialStatus
// // //   };
// // // }

// // // function mergeEventSummaries(a: EventSummary | null, b: EventSummary | null): EventSummary | null {
// // //   if (!a && !b) return null;
// // //   if (!a) return b;
// // //   if (!b) return a;
  
// // //   return {
// // //     refunds: {
// // //       count: a.refunds.count + b.refunds.count,
// // //       value: a.refunds.value + b.refunds.value
// // //     },
// // //     exchanges: {
// // //       count: a.exchanges.count + b.exchanges.count,
// // //       value: a.exchanges.value + b.exchanges.value
// // //     },
// // //     partialRefunds: {
// // //       count: a.partialRefunds.count + b.partialRefunds.count,
// // //       value: a.partialRefunds.value + b.partialRefunds.value
// // //     },
// // //     totalEvents: a.totalEvents + b.totalEvents,
// // //     netValue: a.netValue + b.netValue
// // //   };
// // // }



// // // // ==================== 8.0 CUSTOMER TRACKING LOGIC ====================

// // // function buildCustomerOrderMap(allOrders: any[], shopTimeZone: string) {
// // //   const customerOrderMap: Record<string, Date[]> = {};
  
// // //   for (let i = 0; i < allOrders.length; i++) {
// // //     const order = allOrders[i];
// // //     const custId = order?.customer?.id;
    
// // //     if (custId === undefined || custId === null) continue;
    
// // //     const customerId = custId.toString();
    
// // //     if (!customerOrderMap[customerId]) {
// // //       customerOrderMap[customerId] = [];
// // //     }
    
// // //     customerOrderMap[customerId].push(new Date(order.created_at));
// // //   }
  
// // //   return customerOrderMap;
// // // }

// // // function analyzeCustomerBehavior(
// // //   customerOrderMap: Record<string, Date[]>, 
// // //   shopTimeZone: string,
// // //   periodKeys: string[],
// // //   periodType: 'daily' | 'weekly' | 'monthly'
// // // ): Record<string, CustomerData> {
// // //   const periodAnalytics: Record<string, CustomerData> = {};
  
// // //   for (const key of periodKeys) {
// // //     periodAnalytics[key] = { newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 };
// // //   }

// // //   const customerIds = Object.keys(customerOrderMap);
  
// // //   for (let i = 0; i < customerIds.length; i++) {
// // //     const customerId = customerIds[i];
// // //     const orderDates = customerOrderMap[customerId];
// // //     if (orderDates.length === 0) continue;
    
// // //     let firstOrderDate = orderDates[0];
// // //     for (let j = 1; j < orderDates.length; j++) {
// // //       if (orderDates[j] < firstOrderDate) {
// // //         firstOrderDate = orderDates[j];
// // //       }
// // //     }
    
// // //     let firstOrderKey: string;
// // //     if (periodType === 'daily') {
// // //       firstOrderKey = firstOrderDate.toLocaleDateString("en-CA", { timeZone: shopTimeZone });
// // //     } else if (periodType === 'monthly') {
// // //       firstOrderKey = firstOrderDate.toLocaleString("default", { month: "short", year: "numeric", timeZone: shopTimeZone });
// // //     } else {
// // //       const firstOrderMonday = new Date(firstOrderDate);
// // //       firstOrderMonday.setDate(firstOrderDate.getDate() - ((firstOrderDate.getDay() + 6) % 7));
// // //       firstOrderKey = `Week of ${firstOrderMonday.toLocaleDateString("en-CA", { timeZone: shopTimeZone })}`;
// // //     }
    
// // //     for (let j = 0; j < orderDates.length; j++) {
// // //       const orderDate = orderDates[j];
// // //       let orderKey: string;
      
// // //       if (periodType === 'daily') {
// // //         orderKey = orderDate.toLocaleDateString("en-CA", { timeZone: shopTimeZone });
// // //       } else if (periodType === 'monthly') {
// // //         orderKey = orderDate.toLocaleString("default", { month: "short", year: "numeric", timeZone: shopTimeZone });
// // //       } else {
// // //         const orderMonday = new Date(orderDate);
// // //         orderMonday.setDate(orderDate.getDate() - ((orderDate.getDay() + 6) % 7));
// // //         orderKey = `Week of ${orderMonday.toLocaleDateString("en-CA", { timeZone: shopTimeZone })}`;
// // //       }
      
// // //       if (periodAnalytics[orderKey]) {
// // //         if (firstOrderKey === orderKey) {
// // //           periodAnalytics[orderKey].newCustomers++;
// // //         } else {
// // //           periodAnalytics[orderKey].repeatedCustomers++;
// // //         }
        
// // //         periodAnalytics[orderKey].totalCustomers++;
// // //       }
// // //     }
// // //   }
  
// // //   return periodAnalytics;
// // // }

// // // function calculateOverallCustomerData(customerOrderMap: Record<string, Date[]>): CustomerData {
// // //   const customers = Object.values(customerOrderMap);
// // //   const totalCustomers = customers.length;
  
// // //   let newCustomers = 0;
// // //   let repeatedCustomers = 0;

// // //   customers.forEach(orderDates => {
// // //     if (orderDates.length === 1) {
// // //       newCustomers++;
// // //     } else {
// // //       repeatedCustomers++;
// // //     }
// // //   });

// // //   return {
// // //     newCustomers,
// // //     repeatedCustomers,
// // //     totalCustomers,
// // //   };
// // // }

// // // // ==================== 9.0 LOADER FUNCTION ====================

// // // export const loader = async ({ request }: LoaderFunctionArgs) => {
// // //   let cacheUsed = false;
// // //   let apiSuccess = false;
// // //   let fetchMode: "incremental" | "full" = "full";
// // //   let cacheHit = false;
// // //   let fallbackUsed = false;

// // //   const loaderStartTime = performance.now();
// // //   let cacheOperationTime = 0;

// // //   try {
// // //     const { session } = await authenticate.admin(request);
// // //     const shop = session.shop;
// // //     const accessToken = session.accessToken!;

// // //     const shopRes = await fetch(`https://${shop}/admin/api/${SHOPIFY_API_VERSION}/shop.json`, {     
// // //       headers: { "X-Shopify-Access-Token": accessToken },
// // //     });
    
// // //     if (!shopRes.ok) throw new Error(`Failed to fetch shop info: ${shopRes.status}`);
    
// // //     const shopData = await shopRes.json();
// // //     const shopTimeZone = shopData.shop.iana_timezone || "UTC";
// // //     const shopCurrency = shopData.shop.currency || "USD";

// // //     const monthRanges = getMonthRanges(shopTimeZone);
// // //     const dailyKeys = getLastNDays(7, shopTimeZone);
// // //     const weeklyKeys = getLast8Weeks(shopTimeZone);

// // //     const initStats = (): OrderStats => ({
// // //       total: 0,
// // //       discounts: 0,
// // //       returns: 0,
// // //       netSales: 0,
// // //       shipping: 0,
// // //       taxes: 0,
// // //       extraFees: 0,
// // //       totalSales: 0,
// // //       shippingRefunds: 0,
// // //       netReturns: 0,
// // //       totalRefund: 0,
// // //       items: 0,
// // //       fulfilled: 0,
// // //       unfulfilled: 0,
// // //       orderCount: 0,
// // //       discountsReturned: 0,
// // //       netDiscounts: 0,
// // //       returnShippingCharges: 0,
// // //       restockingFees: 0,
// // //       returnFees: 0,
// // //       refundDiscrepancy: 0,
// // //       hasSubsequentEvents: false,
// // //       eventSummary: null,
// // //       refundsCount: 0,
// // //       financialStatus: 'pending'
// // //     });

// // //     const totals: Record<string, OrderStats> = {};
// // //     const dailyTotals: Record<string, OrderStats & CustomerData> = {};
// // //     const weeklyTotals: Record<string, OrderStats & CustomerData> = {};
// // //     const monthlyTotals: Record<string, OrderStats & CustomerData> = {};

// // //     monthRanges.forEach((r) => {
// // //       totals[r.key] = initStats();
// // //       monthlyTotals[r.key] = { ...initStats(), newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 };
// // //     });
// // //     dailyKeys.forEach((d) => (dailyTotals[d] = { ...initStats(), newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 }));
// // //     weeklyKeys.forEach((w) => (weeklyTotals[w] = { ...initStats(), newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 }));

// // //     const ordersKey = makeCacheKey(shop, "orders");
// // //     const cacheStartTime = performance.now();
// // //     const cacheEntry = await cacheManager.get<{ orders: any[]; lastUpdatedAt?: string }>(ordersKey);
    
// // //     cacheOperationTime = performance.now() - cacheStartTime;

// // //     const cacheHealth = cacheManager.healthReport();
// // //     const shouldClean = cacheHealth.health < 0.7 || Math.random() < 0.1;
    
// // //     if (shouldClean) {
// // //       await cacheManager.cleanAllExpired();
// // //       await cacheManager.enforceSizeLimit(50);
// // //     }

// // //     let allOrders: any[] = [];

// // //     try {
// // //       if (cacheEntry && cacheEntry.value.lastUpdatedAt) {
// // //         cacheUsed = true;
// // //         cacheHit = true;
// // //         fetchMode = "incremental";

// // //         const apiStart = performance.now();
// // //         const result = await fetchOrdersSince(shop, accessToken, cacheEntry.value.lastUpdatedAt, cacheEntry.value.orders);
// // //         const apiTime = performance.now() - apiStart;
        
// // //         if (result.orders.length > 0) {
// // //           apiSuccess = true;
// // //           const orderMap = new Map();
// // //           cacheEntry.value.orders.forEach((order: any) => orderMap.set(order.id, order));
// // //           result.orders.forEach((order: any) => orderMap.set(order.id, order));
          
// // //           allOrders = Array.from(orderMap.values());
// // //           await cacheManager.set(ordersKey, { 
// // //             orders: allOrders, 
// // //             lastUpdatedAt: nowISO() 
// // //           }, 30 * 60 * 1000);
// // //         } else {
// // //           allOrders = cacheEntry.value.orders;
// // //           apiSuccess = true;
// // //         }
// // //       } else {
// // //         fetchMode = "full";
// // //       }

// // //       if (fetchMode === "full") {
// // //         allOrders = await fetchOrdersForPeriod(
// // //           shop,
// // //           accessToken,
// // //           monthRanges[0].start,
// // //           monthRanges[monthRanges.length - 1].end
// // //         );
// // //         apiSuccess = true;
// // //         await cacheManager.set(ordersKey, { 
// // //           orders: allOrders, 
// // //           lastUpdatedAt: nowISO() 
// // //         }, 30 * 60 * 1000);
// // //       }

// // //     } catch (error) {
// // //       if (cacheEntry && cacheEntry.value.orders) {
// // //         allOrders = cacheEntry.value.orders;
// // //         apiSuccess = true;
// // //         fallbackUsed = true;
// // //       } else {
// // //         await cacheManager.remove(ordersKey);
// // //         throw error;
// // //       }
// // //     }

// // //     const timing = {
// // //       customerAnalysis: 0,
// // //       orderProcessing: 0,
// // //       calculations: 0
// // //     };

// // //     const customerStart = performance.now();
// // //     const customerOrderMap = buildCustomerOrderMap(allOrders, shopTimeZone);
// // //     const dailyCustomerAnalytics = analyzeCustomerBehavior(customerOrderMap, shopTimeZone, dailyKeys, 'daily');
// // //     const weeklyCustomerAnalytics = analyzeCustomerBehavior(customerOrderMap, shopTimeZone, weeklyKeys, 'weekly');
// // //     const monthlyCustomerAnalytics = analyzeCustomerBehavior(customerOrderMap, shopTimeZone, monthRanges.map(r => r.key), 'monthly');
// // //     timing.customerAnalysis = performance.now() - customerStart;

// // //     const orderProcessStart = performance.now();
    
// // //     const BATCH_SIZE = 500;
// // //     let processedCount = 0;
    
// // //     for (let i = 0; i < allOrders.length; i += BATCH_SIZE) {
// // //       const batch = allOrders.slice(i, i + BATCH_SIZE);
      
// // //       batch.forEach((order: any) => {
// // //         const date = new Date(order.created_at);
// // //         const monthKey = date.toLocaleString("default", { month: "short", year: "numeric", timeZone: shopTimeZone });
// // //         const dayKey = date.toLocaleDateString("en-CA", { timeZone: shopTimeZone });
        
// // //         const monday = new Date(date);
// // //         monday.setDate(date.getDate() - ((date.getDay() + 6) % 7));
// // //         const weekKey = `Week of ${monday.toLocaleDateString("en-CA", { timeZone: shopTimeZone })}`;

// // //         const orderStats = processOrderToStats(order);

// // //         if (totals[monthKey]) {
// // //           totals[monthKey] = mergeStats(totals[monthKey], orderStats);
// // //         }

// // //         if (dailyTotals[dayKey]) {
// // //           dailyTotals[dayKey] = {
// // //             ...mergeStats(dailyTotals[dayKey], orderStats),
// // //             newCustomers: dailyCustomerAnalytics[dayKey]?.newCustomers || 0,
// // //             repeatedCustomers: dailyCustomerAnalytics[dayKey]?.repeatedCustomers || 0,
// // //             totalCustomers: dailyCustomerAnalytics[dayKey]?.totalCustomers || 0
// // //           };
// // //         }

// // //         if (weeklyTotals[weekKey]) {
// // //           weeklyTotals[weekKey] = {
// // //             ...mergeStats(weeklyTotals[weekKey], orderStats),
// // //             newCustomers: weeklyCustomerAnalytics[weekKey]?.newCustomers || 0,
// // //             repeatedCustomers: weeklyCustomerAnalytics[weekKey]?.repeatedCustomers || 0,
// // //             totalCustomers: weeklyCustomerAnalytics[weekKey]?.totalCustomers || 0
// // //           };
// // //         }

// // //         if (monthlyTotals[monthKey]) {
// // //           monthlyTotals[monthKey] = {
// // //             ...mergeStats(monthlyTotals[monthKey], orderStats),
// // //             newCustomers: monthlyCustomerAnalytics[monthKey]?.newCustomers || 0,
// // //             repeatedCustomers: monthlyCustomerAnalytics[monthKey]?.repeatedCustomers || 0,
// // //             totalCustomers: monthlyCustomerAnalytics[monthKey]?.totalCustomers || 0
// // //           };
// // //         }
        
// // //         processedCount++;
// // //       });
// // //     }
    
// // //     timing.orderProcessing = performance.now() - orderProcessStart;

// // //     const calculationsStart = performance.now();
// // //     const totalCustomerData = calculateOverallCustomerData(customerOrderMap);
// // //     timing.calculations = performance.now() - calculationsStart;

// // //     const totalLoaderTime = performance.now() - loaderStartTime;
// // //     const cachePerformance = cacheManager.getPerformanceReport();

// // //     const result: CachedAnalyticsData = {
// // //       shop,
// // //       totals,
// // //       dailyTotals,
// // //       weeklyTotals,
// // //       monthlyTotals,
// // //       totalOrders: allOrders.length,
// // //       totalCustomerData,
// // //       monthRanges: monthRanges.map((r) => r.key),
// // //       dailyKeys,
// // //       weeklyKeys,
// // //       lastUpdated: new Date().toISOString(),
// // //       shopTimeZone,
// // //       shopCurrency,
// // //       _cacheInfo: {
// // //         fetchMode,
// // //         apiSuccess,
// // //         cacheHealth: cacheManager.healthReport(),
// // //         cacheStats: cacheManager.getStats(),
// // //         cacheUsed,
// // //         cacheHit,
// // //         fallbackUsed,
// // //         cacheTimestamp: cacheEntry?.timestamp,
// // //         performance: {
// // //           cacheOperationTime: parseFloat(cacheOperationTime.toFixed(2)),
// // //           totalLoaderTime: parseFloat(totalLoaderTime.toFixed(2))
// // //         }
// // //       }
// // //     };

// // //     return json(result);
    
// // //   } catch (error: unknown) {
// // //     const errorMsg = `Loader error: ${error instanceof Error ? error.message : 'Unknown error'}`;
    
// // //     return json({ 
// // //       shop: "unknown", 
// // //       error: errorMsg,
// // //       userMessage: "Sorry for the inconvenience! Please try refreshing the page.",
// // //       timestamp: new Date().toISOString()
// // //     });
// // //   }
// // // };

// // // // ==================== 10.0 PDF EXPORT FUNCTIONALITY ====================

// // // const generatePDFReport = (data: OrderData) => {
// // //   const printWindow = window.open('', '_blank');
// // //   if (!printWindow) return;

// // //   const timestamp = new Date().toLocaleDateString();
// // //   const time = new Date().toLocaleTimeString();
  
// // //   const totalRefunds = data.totalRefunds || 0;
// // //   const totalExchanges = data.totalExchanges || 0;
// // //   const netEventValue = data.netEventValue || 0;
  
// // //   const pdfContent = `
// // //     <!DOCTYPE html>
// // //     <html>
// // //     <head>
// // //       <title>Orders Dashboard Report</title>
// // //       <style>
// // //         .currency-value::before {
// // //           content: '${data.shopCurrency === 'EUR' ? '' : data.shopCurrency === 'GBP' ? '' : data.shopCurrency === 'CAD' ? 'C$' : data.shopCurrency === 'AUD' ? 'A$' : data.shopCurrency === 'JPY' ? '' : '$'}';
// // //         }
// // //         body { 
// // //           font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
// // //           margin: 40px; 
// // //           color: #333;
// // //           line-height: 1.4;
// // //         }
// // //         .header { 
// // //           text-align: center; 
// // //           border-bottom: 3px solid #2c3e50; 
// // //           padding-bottom: 25px; 
// // //           margin-bottom: 35px; 
// // //           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
// // //           color: white;
// // //           padding: 30px;
// // //           margin: -40px -40px 35px -40px;
// // //           border-radius: 0 0 20px 20px;
// // //         }
// // //         .header h1 { 
// // //           margin: 0; 
// // //           color: white;
// // //           font-size: 2.2em;
// // //           font-weight: 700;
// // //         }
// // //         .header .date { 
// // //           color: rgba(255,255,255,0.9); 
// // //           margin-top: 8px;
// // //           font-size: 1.1em;
// // //         }
// // //         .section { 
// // //           margin-bottom: 40px; 
// // //           break-inside: avoid;
// // //           background: white;
// // //           padding: 25px;
// // //           border-radius: 12px;
// // //           box-shadow: 0 2px 10px rgba(0,0,0,0.08);
// // //           border-left: 4px solid #3498db;
// // //         }
// // //         .section h2 { 
// // //           color: #2c3e50; 
// // //           border-bottom: 2px solid #ecf0f1; 
// // //           padding-bottom: 12px; 
// // //           margin-bottom: 20px;
// // //           font-size: 1.4em;
// // //         }
// // //         .metrics-grid { 
// // //           display: grid; 
// // //           grid-template-columns: repeat(3, 1fr); 
// // //           gap: 25px; 
// // //           margin: 25px 0; 
// // //         }
// // //         .metric-card { 
// // //           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
// // //           padding: 25px; 
// // //           border-radius: 10px; 
// // //           text-align: center; 
// // //           border-left: 4px solid #3498db;
// // //           transition: all 0.3s ease;
// // //         }
// // //         .metric-card:hover {
// // //           transform: translateY(-2px);
// // //           box-shadow: 0 5px 15px rgba(0,0,0,0.1);
// // //         }
// // //         .metric-value { 
// // //           font-size: 2em; 
// // //           font-weight: bold; 
// // //           color: #2c3e50; 
// // //           margin-bottom: 8px;
// // //         }
// // //         .metric-label { 
// // //           color: #666; 
// // //           margin-top: 8px;
// // //           font-weight: 600;
// // //         }
// // //         .growth-indicator {
// // //           display: flex;
// // //           align-items: center;
// // //           justify-content: center;
// // //           gap: 5px;
// // //           font-size: 0.9em;
// // //           font-weight: 600;
// // //           margin-top: 10px;
// // //           padding: 4px 12px;
// // //           border-radius: 20px;
// // //           width: fit-content;
// // //           margin: 10px auto 0;
// // //         }
// // //         .growth-positive {
// // //           background: #d4edda;
// // //           color: #155724;
// // //           border: 1px solid #c3e6cb;
// // //         }
// // //         .growth-negative {
// // //           background: #f8d7da;
// // //           color: #721c24;
// // //           border: 1px solid #f5c6cb;
// // //         }
// // //         .growth-arrow {
// // //           font-weight: bold;
// // //         }
// // //         .financial-grid { 
// // //           display: grid; 
// // //           grid-template-columns: repeat(2, 1fr); 
// // //           gap: 20px; 
// // //         }
// // //         .financial-card { 
// // //           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
// // //           padding: 20px; 
// // //           border-radius: 8px; 
// // //           border-left: 4px solid #27ae60;
// // //           transition: all 0.3s ease;
// // //         }
// // //         .financial-card:hover {
// // //           transform: translateY(-2px);
// // //           box-shadow: 0 5px 15px rgba(0,0,0,0.1);
// // //         }
// // //         .financial-value { 
// // //           font-size: 1.5em; 
// // //           font-weight: bold; 
// // //           color: #2c3e50; 
// // //         }
// // //         .financial-label { 
// // //           color: #666; 
// // //           font-size: 0.9em;
// // //           font-weight: 600;
// // //         }
// // //         .summary-table { 
// // //           width: 100%; 
// // //           border-collapse: collapse; 
// // //           margin: 20px 0; 
// // //           box-shadow: 0 1px 3px rgba(0,0,0,0.1);
// // //         }
// // //         .summary-table th, .summary-table td { 
// // //           padding: 15px; 
// // //           text-align: left; 
// // //           border-bottom: 1px solid #ddd; 
// // //         }
// // //         .summary-table th { 
// // //           background: #f8f9fa; 
// // //           font-weight: bold;
// // //           color: #2c3e50;
// // //         }
// // //         .positive { color: #27ae60; }
// // //         .negative { color: #e74c3c; }
// // //         .footer { 
// // //           margin-top: 50px; 
// // //           padding-top: 25px; 
// // //           border-top: 2px solid #ddd; 
// // //           text-align: center; 
// // //           color: #666;
// // //           font-size: 0.9em;
// // //         }
// // //         @media print { 
// // //           body { margin: 20px; } 
// // //           .metric-card, .financial-card { break-inside: avoid; }
// // //           .section { break-inside: avoid; page-break-inside: avoid; }
// // //           .header { margin: -20px -20px 25px -20px; }
// // //         }
// // //         @page {
// // //           margin: 1cm;
// // //           size: A4;
// // //         }
// // //       </style>
// // //     </head>
// // //     <body>
// // //       <div class="header">
// // //         <h1>Orders Dashboard Report</h1>
// // //         <div class="date">Generated: ${timestamp} at ${time}</div>
// // //         <div class="date">Store Timezone: ${data.shopTimezone}</div>
// // //       </div>

// // //       <div class="section">
// // //         <h2>Executive Summary</h2>
// // //         <div class="metrics-grid">
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.totalOrders}</div>
// // //             <div class="metric-label">Total Orders</div>
// // //           </div>
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.totalCustomers}</div>
// // //             <div class="metric-label">Total Customers</div>
// // //           </div>
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.fulfillmentRate.toFixed(1)}%</div>
// // //             <div class="metric-label">Fulfillment Rate</div>
// // //           </div>
// // //         </div>
// // //       </div>

// // //       <div class="section">
// // //         <h2>Financial Overview</h2>
// // //         <div class="financial-grid">
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.totalRevenue.toLocaleString('en-US', { style: 'currency', currency: data.shopCurrency || 'USD' })}</div>
// // //             <div class="financial-label">Total Revenue</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.netRevenue.toLocaleString('en-US', { style: 'currency', currency: data.shopCurrency || 'USD' })}</div>
// // //             <div class="financial-label">Net Revenue</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.averageOrderValue.toLocaleString('en-US', { style: 'currency', currency: data.shopCurrency || 'USD' })}</div>
// // //             <div class="financial-label">Average Order Value</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.totalItems}</div>
// // //             <div class="financial-label">Total Items Sold</div>
// // //           </div>
// // //         </div>
// // //       </div>

// // //       <div class="section">
// // //         <h2>Today's Performance</h2>
// // //         <div class="metrics-grid">
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.todayOrders}</div>
// // //             <div class="metric-label">Today's Orders</div>
// // //             ${data.ordersChangeVsYesterday !== 0 ? `
// // //               <div class="growth-indicator ${data.ordersChangeVsYesterday >= 0 ? 'growth-positive' : 'growth-negative'}">
// // //                 <span class="growth-arrow">${data.ordersChangeVsYesterday >= 0 ? '' : ''}</span>
// // //                 ${Math.abs(data.ordersChangeVsYesterday).toFixed(1)}% vs yesterday
// // //               </div>
// // //             ` : '<div class="growth-indicator" style="visibility: hidden;">-</div>'}
// // //           </div>
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.todayRevenue.toLocaleString('en-US', { style: 'currency', currency: data.shopCurrency || 'USD' })}</div>
// // //             <div class="metric-label">Today's Revenue</div>
// // //             ${data.revenueChangeVsYesterday !== 0 ? `
// // //               <div class="growth-indicator ${data.revenueChangeVsYesterday >= 0 ? 'growth-positive' : 'growth-negative'}">
// // //                 <span class="growth-arrow">${data.revenueChangeVsYesterday >= 0 ? '' : ''}</span>
// // //                 ${Math.abs(data.revenueChangeVsYesterday).toFixed(1)}% vs yesterday
// // //               </div>
// // //             ` : '<div class="growth-indicator" style="visibility: hidden;">-</div>'}
// // //           </div>
// // //           <div class="metric-card">
// // //             <div class="metric-value">${data.todayItems}</div>
// // //             <div class="metric-label">Items Ordered Today</div>
// // //             ${data.itemsChangeVsYesterday !== 0 ? `
// // //               <div class="growth-indicator ${data.itemsChangeVsYesterday >= 0 ? 'growth-positive' : 'growth-negative'}">
// // //                 <span class="growth-arrow">${data.itemsChangeVsYesterday >= 0 ? '' : ''}</span>
// // //                 ${Math.abs(data.itemsChangeVsYesterday).toFixed(1)}% vs yesterday
// // //               </div>
// // //             ` : '<div class="growth-indicator" style="visibility: hidden;">-</div>'}
// // //           </div>
// // //         </div>
// // //       </div>

// // //       <div class="section">
// // //         <h2>Customer Insights</h2>
// // //         <div class="financial-grid">
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.newCustomers}</div>
// // //             <div class="financial-label">New Customers</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.repeatCustomers}</div>
// // //             <div class="financial-label">Repeat Customers</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.customerRetentionRate.toFixed(1)}%</div>
// // //             <div class="financial-label">Retention Rate</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.averageOrderFrequency.toFixed(1)}</div>
// // //             <div class="financial-label">Avg Order Frequency</div>
// // //           </div>
// // //         </div>
// // //       </div>

// // //       <div class="section">
// // //         <h2>Event Summary</h2>
// // //         <div class="financial-grid">
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.totalRefunds || 0}</div>
// // //             <div class="financial-label">Full Refunds</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.totalPartialRefunds || 0}</div>
// // //             <div class="financial-label">Partial Refunds</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${data.totalExchanges || 0}</div>
// // //             <div class="financial-label">Exchanges</div>
// // //           </div>
// // //           <div class="financial-card">
// // //             <div class="financial-value">${(data.netEventValue || 0).toLocaleString('en-US', { style: 'currency', currency: data.shopCurrency || 'USD' })}</div>
// // //             <div class="financial-label">Net Event Impact</div>
// // //           </div>
// // //         </div>
// // //         <div style="text-align: center; margin-top: 16px; color: #666; font-size: 0.9em;">
// // //           Across ${data.totalEvents || 0} total events in ${data.ordersWithEvents || 0} orders
// // //         </div>
// // //       </div>

// // //       <div class="footer">
// // //         <p><strong>Orders Dashboard Summary Report</strong> - Key Business Metrics</p>
// // //         <p>Generated by Nexus | ${timestamp}</p>
// // //       </div>
// // //     </body>
// // //     </html>
// // //   `;

// // //   printWindow.document.write(pdfContent);
// // //   printWindow.document.close();
  
// // //   setTimeout(() => {
// // //     printWindow.print();
// // //     printWindow.onafterprint = () => {
// // //       setTimeout(() => {
// // //         printWindow.close();
// // //       }, 100);
// // //     };
// // //   }, 1000);
// // // };

// // // // ==================== 11.0 ICON COMPONENTS ====================

// // // const Icon = {
// // //   Print: () => (
// // //     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
// // //     </svg>
// // //   ),
// // //   TrendUp: () => (
// // //     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
// // //     </svg>
// // //   ),
// // //   TrendDown: () => (
// // //     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/>
// // //     </svg>
// // //   ),
// // //   Export: () => (
// // //     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
// // //     </svg>
// // //   )
// // // };

// // // const SvgIcons = {
// // //   Chart: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
// // //     </svg>
// // //   ),
// // //   TrendingUp: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
// // //     </svg>
// // //   ),
// // //   Dollar: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.78-1.18 2.73-3.12 3.16z"/>
// // //     </svg>
// // //   ),
// // //   Rocket: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M2.81 14.12L5.64 11.29l-1.41-1.42L1.42 12.7l1.39 1.42zM14.12 2.81L11.29 5.64l1.42 1.41 1.41-1.41-1.41-1.42zm8.03 9.91l-1.39-1.42-2.81 2.81 1.41 1.42 2.79-2.81zM7.34 12.5l4.16-4.16L12.5 7.34 8.34 11.5 7.34 12.5zM19.67 7.34l1.39-1.39c.38-.38.38-1.02 0-1.41l-1.39-1.39c-.38-.38-1.02-.38-1.41 0l-1.39 1.39 1.41 1.41 1.39-1.39zM5.63 19.67l1.39 1.39c.38.38 1.02.38 1.41 0l1.39-1.39-1.41-1.41-1.39 1.39zM3.52 15.62c-.39-.39-.39-1.02 0-1.41l1.39-1.39 1.41 1.41-1.39 1.39c-.38.38-1.02.38-1.41 0z"/>
// // //     </svg>
// // //   ),
// // //   Users: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2.01 2.01 0 0018.06 7h-.12a2 2 0 00-1.9 1.37l-.86 2.58c1.08.6 1.82 1.73 1.82 3.05v8h3zm-7.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4zm6.5 0v-4h1v-4c0-.82-.68-1.5-1.5-1.5h-2c-.82 0-1.5.68-1.5 1.5v4h1v4h3z"/>
// // //     </svg>
// // //   ),
// // //   Activity: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M13 7h-2v6h6v-2h-4V7zM3 3v18h18V3H3zm16 16H5V5h14v14z"/>
// // //     </svg>
// // //   ),
// // //   Warning: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
// // //     </svg>
// // //   ),
// // //   Analytics: () => (
// // //     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
// // //       <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
// // //     </svg>
// // //   )
// // // };

// // // // ==================== 12.0 LOADING COMPONENT ====================

// // // function LoadingProgress() {
// // //   const loadingSteps = [
// // //     "Fetching recent orders...",
// // //     "Analyzing revenue data...", 
// // //     "Processing customer insights...",
// // //     "Calculating fulfillment rates...",
// // //     "Generating sales analytics..."
// // //   ];

// // //   return (
// // //     <div className="loading-progress-container">
// // //       <div className="loading-header">
// // //         <h2>Loading Analytics Dashboard</h2>
// // //         <p>Analyzing your order data and generating insights...</p>
// // //       </div>
      
// // //       <div className="progress-bar-container">
// // //         <div className="progress-bar">
// // //           <div className="progress-fill"></div>
// // //         </div>
// // //       </div>

// // //       <div className="loading-steps">
// // //         {loadingSteps.map((step, index) => (
// // //           <div key={index} className="loading-step">
// // //             <div className="step-indicator"></div>
// // //             <div className="step-text">{step}</div>
// // //           </div>
// // //         ))}
// // //       </div>
// // //     </div>
// // //   );
// // // }

// // // // ==================== 13.0 CHART COMPONENTS ====================

// // // const ChartComponents = {
// // //   formatCurrency: (amount: number, currency: string = 'USD') => {
// // //     return amount.toLocaleString('en-US', { 
// // //       style: 'currency', 
// // //       currency: currency,
// // //       minimumFractionDigits: 2 
// // //     });
// // //   },

// // //   CustomerDistribution: ({ data }: { data: AnalyticsData }) => {
// // //     const chartData = {
// // //       labels: ['New Customers', 'Repeat Customers'],
// // //       datasets: [
// // //         {
// // //           data: [data.totalCustomerData.newCustomers, data.totalCustomerData.repeatedCustomers],
// // //           backgroundColor: ['#f59e0b', '#10b981'],
// // //           borderWidth: 2,
// // //           borderColor: '#fff'
// // //         }
// // //       ]
// // //     };

// // //     const options = {
// // //       responsive: true,
// // //       maintainAspectRatio: false,
// // //       plugins: { legend: { display: false } },
// // //       animation: { duration: 500 }
// // //     };

// // //     return (
// // //       <div className="chart-container">
// // //         <div className="chart-header">
// // //           <div className="chart-title">Customer Distribution</div>
// // //           <div className="chart-legend">
// // //             <div className="legend-item">
// // //               <div className="legend-color new"></div>
// // //               <span>New</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color repeat"></div>
// // //               <span>Repeat</span>
// // //             </div>
// // //           </div>
// // //         </div>
// // //         <Pie data={chartData} options={options} height={120} />
// // //         <div className="mini-stats">
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {data.totalCustomerData.totalCustomers > 0 
// // //                 ? `${((data.totalCustomerData.repeatedCustomers / data.totalCustomerData.totalCustomers) * 100).toFixed(1)}%`
// // //                 : '0.0%'
// // //               }
// // //             </div>
// // //             <div className="mini-stat-label">Repeat Rate</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">{data.totalCustomerData.totalCustomers}</div>
// // //             <div className="mini-stat-label">Total Customers</div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   },

// // //   RevenueTrend: ({ data }: { data: AnalyticsData }) => {
// // //     const weeklyData = data.weeklyKeys.map(week => {
// // //       const weekData = data.weeklyTotals[week];
// // //       return {
// // //         week: week.replace('Week of ', ''),
// // //         revenue: weekData?.total || 0,
// // //         totalSales: weekData?.totalSales || 0
// // //       };
// // //     });

// // //     const totalRevenue = weeklyData.reduce((sum, w) => sum + w.revenue, 0);
// // //     const totalSales = weeklyData.reduce((sum, w) => sum + w.totalSales, 0);
// // //     const avgWeeklyRevenue = totalRevenue / weeklyData.length;

// // //     const chartData = {
// // //       labels: weeklyData.map(w => w.week),
// // //       datasets: [
// // //         {
// // //           label: 'Revenue',
// // //           data: weeklyData.map(w => w.revenue),
// // //           borderColor: '#3b82f6',
// // //           backgroundColor: 'rgba(59, 130, 246, 0.1)',
// // //           tension: 0.4,
// // //           fill: true,
// // //           borderWidth: 2
// // //         }
// // //       ]
// // //     };

// // //     const options = {
// // //       responsive: true,
// // //       maintainAspectRatio: false,
// // //       plugins: { legend: { display: false } },
// // //       scales: {
// // //         x: { grid: { display: false } },
// // //         y: { 
// // //           beginAtZero: true,
// // //           ticks: {
// // //             callback: function(this: any, value: any) {
// // //               return '$' + value;
// // //             }
// // //           }
// // //         }
// // //       }
// // //     };

// // //     return (
// // //       <div className="chart-container">
// // //         <div className="chart-header">
// // //           <div className="chart-title">Weekly Revenue Trend</div>
// // //           <div className="chart-legend">
// // //             <div className="legend-item">
// // //               <div className="legend-color revenue"></div>
// // //               <span>Revenue</span>
// // //             </div>
// // //           </div>
// // //         </div>
// // //         <Line data={chartData} options={options} height={120} />
// // //         <div className="mini-stats">
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(totalRevenue, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Total Revenue</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(avgWeeklyRevenue, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Avg Weekly</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(totalSales, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Total Sales</div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   },

// // //   MonthlyPerformance: ({ data }: { data: AnalyticsData }) => {
// // //     const monthlyData = data.monthRanges.map(month => {
// // //       const monthData = data.monthlyTotals[month];
// // //       return {
// // //         month: month,
// // //         revenue: monthData?.total || 0,
// // //         orders: monthData?.orderCount || 0,
// // //         totalSales: monthData?.totalSales || 0
// // //       };
// // //     });

// // //     const totalRevenue = monthlyData.reduce((sum, m) => sum + m.revenue, 0);
// // //     const totalOrders = monthlyData.reduce((sum, m) => sum + m.orders, 0);
// // //     const totalSales = monthlyData.reduce((sum, m) => sum + m.totalSales, 0);
// // //     const avgMonthlyRevenue = totalRevenue / monthlyData.length;

// // //     const chartData = {
// // //       labels: monthlyData.map(m => m.month),
// // //       datasets: [
// // //         {
// // //           label: 'Revenue',
// // //           data: monthlyData.map(m => m.revenue),
// // //           backgroundColor: 'rgba(59, 130, 246, 0.8)',
// // //           borderRadius: 4
// // //         },
// // //         {
// // //           label: 'Orders',
// // //           data: monthlyData.map(m => m.orders),
// // //           backgroundColor: 'rgba(139, 92, 246, 0.8)',
// // //           borderRadius: 4
// // //         }
// // //       ]
// // //     };

// // //     const options = {
// // //       responsive: true,
// // //       maintainAspectRatio: false,
// // //       plugins: { legend: { display: false } },
// // //       scales: {
// // //         x: { grid: { display: false } },
// // //         y: { beginAtZero: true }
// // //       }
// // //     };

// // //     return (
// // //       <div className="chart-container">
// // //         <div className="chart-header">
// // //           <div className="chart-title">Monthly Performance</div>
// // //           <div className="chart-legend">
// // //             <div className="legend-item">
// // //               <div className="legend-color revenue"></div>
// // //               <span>Revenue</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color orders"></div>
// // //               <span>Orders</span>
// // //             </div>
// // //           </div>
// // //         </div>
// // //         <Bar data={chartData} options={options} height={120} />
// // //         <div className="mini-stats">
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(totalRevenue, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Total Revenue</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {totalOrders}
// // //             </div>
// // //             <div className="mini-stat-label">Total Orders</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(totalSales, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Total Sales</div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   },

// // //   FinancialBreakdown: ({ data }: { data: AnalyticsData }) => {
// // //     const financialData = {
// // //       grossRevenue: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.total, 0),
// // //       netRevenue: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.totalSales, 0),
// // //       discounts: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.discounts, 0),
// // //       shipping: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.shipping, 0),
// // //       taxes: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.taxes, 0),
// // //       returns: Object.values(data.totals).reduce((sum: number, month: OrderStats) => sum + month.returns, 0)
// // //     };

// // //     const chartData = {
// // //       labels: ['Gross Revenue', 'Discounts', 'Shipping', 'Taxes', 'Returns'],
// // //       datasets: [
// // //         {
// // //           data: [
// // //             financialData.grossRevenue,
// // //             financialData.discounts,
// // //             financialData.shipping,
// // //             financialData.taxes,
// // //             financialData.returns
// // //           ],
// // //           backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#ef4444'],
// // //           borderWidth: 2,
// // //           borderColor: '#fff'
// // //         }
// // //       ]
// // //     };

// // //     const options = {
// // //       responsive: true,
// // //       maintainAspectRatio: false,
// // //       plugins: { legend: { display: false } }
// // //     };

// // //     return (
// // //       <div className="chart-container">
// // //         <div className="chart-header">
// // //           <div className="chart-title">Financial Breakdown</div>
// // //           <div className="chart-legend">
// // //             <div className="legend-item">
// // //               <div className="legend-color revenue"></div>
// // //               <span>Revenue</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color discounts"></div>
// // //               <span>Discounts</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color shipping"></div>
// // //               <span>Shipping</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color taxes"></div>
// // //               <span>Taxes</span>
// // //             </div>
// // //             <div className="legend-item">
// // //               <div className="legend-color returns"></div>
// // //               <span>Returns</span>
// // //             </div>
// // //           </div>
// // //         </div>
// // //         <Pie data={chartData} options={options} height={120} />
// // //         <div className="mini-stats">
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {ChartComponents.formatCurrency(financialData.netRevenue, data.shopCurrency)}
// // //             </div>
// // //             <div className="mini-stat-label">Net Revenue</div>
// // //           </div>
// // //           <div className="mini-stat-card">
// // //             <div className="mini-stat-value">
// // //               {financialData.grossRevenue > 0 
// // //                 ? `${((Math.abs(financialData.returns) / financialData.grossRevenue) * 100).toFixed(1)}%`
// // //                 : '0.0%'
// // //               }
// // //             </div>
// // //             <div className="mini-stat-label">Return Rate</div>
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   }
// // // };

// // // // ==================== 14.0 EVENT SUMMARY COMPONENT ====================

// // // function EventSummaryDisplay({ eventSummary, title }: { eventSummary: EventSummary, title: string }) {
// // //   if (!eventSummary || eventSummary.totalEvents === 0) {
// // //     return null;
// // //   }

// // //   const formatValue = (value: number) => {
// // //     const absValue = Math.abs(value);
// // //     const sign = value < 0 ? '-' : value > 0 ? '+' : '';
// // //     return `${sign}$${absValue.toFixed(2)}`;
// // //   };

// // //   return (
// // //     <section className="event-summary-display">
// // //       <h3>{title} ({eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''})</h3>
      
// // //       <div className="event-summary-grid">
// // //         {eventSummary.refunds.count > 0 && (
// // //           <div className="event-card refunds">
// // //             <div className="event-label">Full Refunds</div>
// // //             <div className="event-value">{formatValue(eventSummary.refunds.value)}</div>
// // //             <div className="event-count">
// // //               {eventSummary.refunds.count} refund{eventSummary.refunds.count !== 1 ? 's' : ''}
// // //             </div>
// // //           </div>
// // //         )}

// // //         {eventSummary.partialRefunds.count > 0 && (
// // //           <div className="event-card partial-refunds">
// // //             <div className="event-label">Partial Refunds</div>
// // //             <div className="event-value">{formatValue(eventSummary.partialRefunds.value)}</div>
// // //             <div className="event-count">
// // //               {eventSummary.partialRefunds.count} refund{eventSummary.partialRefunds.count !== 1 ? 's' : ''}
// // //             </div>
// // //           </div>
// // //         )}

// // //         {eventSummary.exchanges.count > 0 && (
// // //           <div className="event-card exchanges">
// // //             <div className="event-label">Exchanges</div>
// // //             <div className="event-value">{formatValue(eventSummary.exchanges.value)}</div>
// // //             <div className="event-count">
// // //               {eventSummary.exchanges.count} exchange{eventSummary.exchanges.count !== 1 ? 's' : ''}
// // //             </div>
// // //           </div>
// // //         )}

// // //         <div className="event-card net-summary">
// // //           <div className="event-label">Net Impact</div>
// // //           <div className="event-value">{formatValue(eventSummary.netValue)}</div>
// // //           <div className="event-count">
// // //             across {eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''}
// // //           </div>
// // //         </div>
// // //       </div>
// // //     </section>
// // //   );
// // // }

// // // // ==================== 15.0 MISMATCH SUMMARY COMPONENT ====================

// // // function MismatchSummaryCard({ mismatchSummary, periodType }: { 
// // //   mismatchSummary: { 
// // //     totalMismatches: number; 
// // //     totalDifference: number; 
// // //     hasMismatches: boolean; 
// // //   };
// // //   periodType: 'day' | 'week' | 'month';
// // // }) {
// // //   if (!mismatchSummary.hasMismatches) {
// // //     return null;
// // //   }

// // //   const getPeriodLabel = () => {
// // //     switch (periodType) {
// // //       case 'day': return 'Days';
// // //       case 'week': return 'Weeks'; 
// // //       case 'month': return 'Months';
// // //       default: return 'Periods';
// // //     }
// // //   };

// // //   const getDifferenceColor = (difference: number) => {
// // //     return Math.abs(difference) > 0.01 ? '#dc2626' : '#059669';
// // //   };

// // //   const getDifferenceText = (difference: number) => {
// // //     const absDiff = Math.abs(difference);
// // //     if (absDiff <= 0.01) return 'Perfect Match';
// // //     return `$${absDiff.toFixed(2)}`;
// // //   };

// // //   return (
// // //     <section className="mismatch-summary-card">
// // //       <h3>Calculation Verification</h3>
      
// // //       <div className="mismatch-summary-content">
// // //         <div className="mismatch-metric">
// // //           <div className="mismatch-value">{mismatchSummary.totalMismatches}</div>
// // //           <div className="mismatch-label">{getPeriodLabel()} with Mismatches</div>
// // //         </div>
        
// // //         <div className="mismatch-metric">
// // //           <div 
// // //             className="mismatch-value" 
// // //             style={{ color: getDifferenceColor(mismatchSummary.totalDifference) }}
// // //           >
// // //             {getDifferenceText(mismatchSummary.totalDifference)}
// // //           </div>
// // //           <div className="mismatch-label">Total Difference</div>
// // //         </div>
// // //       </div>
      
// // //       <div className="mismatch-note">
// // //         {mismatchSummary.totalMismatches > 0 ? (
// // //           <span style={{ color: '#dc2626' }}>
// // //             Found {mismatchSummary.totalMismatches} {getPeriodLabel().toLowerCase()} with calculation discrepancies
// // //           </span>
// // //         ) : (
// // //           <span style={{ color: '#059669' }}>
// // //             All calculations match perfectly!
// // //           </span>
// // //         )}
// // //       </div>
// // //     </section>
// // //   );
// // // }

// // // // ==================== 16.0 MAIN REACT COMPONENT ====================

// // // function ShopifyAnalyticsPage() {
// // //   const data = useLoaderData<typeof loader>();
// // //   const [isLoading, setIsLoading] = useState(true);
// // //   const [isExporting, setIsExporting] = useState(false);
// // //   const [isManualRefresh, setIsManualRefresh] = useState(false);

// // //   const handleManualRefresh = () => {
// // //     setIsManualRefresh(true);
// // //     setIsLoading(true);
// // //     window.location.reload();
// // //   }

// // //   useEffect(() => {
// // //     if (data && !("error" in data)) {
// // //       setIsLoading(false);
// // //     }
// // //   }, [data]);

// // //   if (isLoading && isManualRefresh) {
// // //     return (
// // //       <div className="orders-dashboard">
// // //         <div className="dashboard-header">
// // //           <h1>Analytics Dashboard</h1>
// // //         </div>
// // //         <div className="loading-progress-container">
// // //           <div className="loading-header">
// // //             <h2>Refreshing Your Data</h2>
// // //             <p>Please wait while we update your analytics...</p>
// // //           </div>
          
// // //           <div className="progress-bar-container">
// // //             <div className="progress-bar">
// // //               <div className="progress-fill"></div>
// // //             </div>
// // //           </div>

// // //           <div className="loading-steps">
// // //             {[
// // //               "Refreshing order data...",
// // //               "Updating revenue calculations...", 
// // //               "Processing customer insights...",
// // //               "Recalculating metrics...",
// // //               "Finalizing your dashboard..."
// // //             ].map((step, index) => (
// // //               <div key={index} className="loading-step">
// // //                 <div className="step-indicator"></div>
// // //                 <div className="step-text">{step}</div>
// // //               </div>
// // //             ))}
// // //           </div>
// // //         </div>
// // //       </div>
// // //     );
// // //   }

// // //   if (isLoading) {
// // //     return (
// // //       <div className="orders-dashboard">
// // //         <div className="dashboard-header">
// // //           <h1>Analytics Dashboard</h1>
// // //         </div>
// // //         <LoadingProgress />
// // //       </div>
// // //     );
// // //   }

// // //   const getSafeData = (data: any): CachedAnalyticsData | null => {
// // //     if (!data || typeof data !== 'object') return null;
    
// // //     const safeData: CachedAnalyticsData = {
// // //       shop: data.shop || 'unknown',
// // //       totals: data.totals || {},
// // //       dailyTotals: data.dailyTotals || {},
// // //       weeklyTotals: data.weeklyTotals || {},
// // //       monthlyTotals: data.monthlyTotals || {},
// // //       totalOrders: typeof data.totalOrders === 'number' ? data.totalOrders : 0,
// // //       totalCustomerData: data.totalCustomerData || { newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 },
// // //       monthRanges: Array.isArray(data.monthRanges) ? data.monthRanges : [],
// // //       dailyKeys: Array.isArray(data.dailyKeys) ? data.dailyKeys : [],
// // //       weeklyKeys: Array.isArray(data.weeklyKeys) ? data.weeklyKeys : [],
// // //       lastUpdated: data.lastUpdated || new Date().toISOString(),
// // //       shopTimeZone: data.shopTimeZone || 'UTC',
// // //       shopCurrency: data.shopCurrency || 'USD',
// // //       _cacheInfo: data._cacheInfo || undefined
// // //     };

// // //     return safeData;
// // //   };

// // //   const safeNumber = (value: unknown) => (typeof value === "number" ? value : 0);
  
// // //   const getSafeCustomerStats = (stats: Record<string, OrderStats & CustomerData>, key: string): OrderStats & CustomerData => {
// // //     const stat = stats[key];
// // //     if (!stat) {
// // //       return {
// // //         total: 0,
// // //         discounts: 0,
// // //         returns: 0,
// // //         netSales: 0,
// // //         shipping: 0,
// // //         taxes: 0,
// // //         extraFees: 0,
// // //         totalSales: 0,
// // //         shippingRefunds: 0,
// // //         netReturns: 0,
// // //         totalRefund: 0,
// // //         items: 0,
// // //         fulfilled: 0,
// // //         unfulfilled: 0,
// // //         orderCount: 0,
// // //         hasSubsequentEvents: false,
// // //         eventSummary: null,
// // //         refundsCount: 0,
// // //         financialStatus: 'pending',
// // //         newCustomers: 0,
// // //         repeatedCustomers: 0,
// // //         totalCustomers: 0,
// // //         discountsReturned: 0,
// // //         netDiscounts: 0,
// // //         returnShippingCharges: 0,
// // //         restockingFees: 0,
// // //         returnFees: 0,
// // //         refundDiscrepancy: 0
// // //       };
// // //     }
// // //     return stat;
// // //   };

// // //   const getCalculationMismatchSummary = (data: AnalyticsData) => {
// // //     let totalMismatches = 0;
// // //     let totalDifference = 0;

// // //     Object.values(data.dailyTotals).forEach(dayData => {
// // //       const calculatedTotal = dayData.netSales + dayData.shipping + dayData.taxes + dayData.extraFees;
// // //       const mismatch = Math.abs(dayData.totalSales - calculatedTotal) > 0.01;
      
// // //       if (mismatch) {
// // //         totalMismatches++;
// // //         const difference = calculatedTotal - dayData.totalSales;
// // //         totalDifference += difference;
// // //       }
// // //     });

// // //     return {
// // //       totalMismatches,
// // //       totalDifference: parseFloat(totalDifference.toFixed(2)),
// // //       hasMismatches: totalMismatches > 0
// // //     };
// // //   };

// // //   const getTodayMismatchSummary = (data: AnalyticsData) => {
// // //     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: data.shopTimeZone });
// // //     const todayData = getSafeCustomerStats(data.dailyTotals, todayKey);
    
// // //     const calculatedTotal = todayData.netSales + todayData.shipping + todayData.taxes + todayData.extraFees;
// // //     const mismatch = Math.abs(todayData.totalSales - calculatedTotal) > 0.01;
    
// // //     return {
// // //       totalMismatches: mismatch ? 1 : 0,
// // //       totalDifference: mismatch ? (calculatedTotal - todayData.totalSales) : 0,
// // //       hasMismatches: mismatch
// // //     };
// // //   };

// // //   const getWeeklyMismatchSummary = (data: AnalyticsData) => {
// // //     let totalMismatches = 0;
// // //     let totalDifference = 0;

// // //     Object.values(data.weeklyTotals).forEach(weekData => {
// // //       const calculatedTotal = weekData.netSales + weekData.shipping + weekData.taxes + weekData.extraFees;
// // //       const mismatch = Math.abs(weekData.totalSales - calculatedTotal) > 0.01;
      
// // //       if (mismatch) {
// // //         totalMismatches++;
// // //         totalDifference += (calculatedTotal - weekData.totalSales);
// // //       }
// // //     });

// // //     return {
// // //       totalMismatches,
// // //       totalDifference: parseFloat(totalDifference.toFixed(2)),
// // //       hasMismatches: totalMismatches > 0
// // //     };
// // //   };

// // //   const getMonthlyMismatchSummary = (data: AnalyticsData) => {
// // //     let totalMismatches = 0;
// // //     let totalDifference = 0;

// // //     Object.values(data.monthlyTotals).forEach(monthData => {
// // //       const calculatedTotal = monthData.netSales + monthData.shipping + monthData.taxes + monthData.extraFees;
// // //       const mismatch = Math.abs(monthData.totalSales - calculatedTotal) > 0.01;
      
// // //       if (mismatch) {
// // //         totalMismatches++;
// // //         totalDifference += (calculatedTotal - monthData.totalSales);
// // //       }
// // //     });

// // //     return {
// // //       totalMismatches,
// // //       totalDifference: parseFloat(totalDifference.toFixed(2)),
// // //       hasMismatches: totalMismatches > 0
// // //     };
// // //   };

// // //   const getTodayData = () => {
// // //     const safeData = getSafeData(data);
// // //     if (!safeData) return null;
    
// // //     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: safeData.shopTimeZone });
// // //     const todayData = getSafeCustomerStats(safeData.dailyTotals, todayKey);
    
// // //     return {
// // //       ...todayData,
// // //       ordersWithSubsequentEvents: todayData.hasSubsequentEvents ? 1 : 0,
// // //       subsequentEventsCount: todayData.eventSummary?.totalEvents || 0,
// // //       subsequentEventsValue: todayData.eventSummary ? Math.abs(todayData.eventSummary.netValue) : 0
// // //     };
// // //   };

// // //   const getLast7DaysData = () => {
// // //     const safeData = getSafeData(data);
// // //     if (!safeData) return null;

// // //     let totalRevenue = 0;
// // //     let totalOrders = 0;
// // //     let totalItems = 0;
// // //     let totalNewCustomers = 0;
// // //     let totalRepeatCustomers = 0;
// // //     let totalFulfilled = 0;
// // //     let totalUnfulfilled = 0;
// // //     let totalDiscounts = 0;
// // //     let totalReturns = 0;
// // //     let totalNetSales = 0;
// // //     let totalShipping = 0;
// // //     let totalTaxes = 0;
// // //     let totalExtraFees = 0;
// // //     let totalTotalSales = 0;
// // //     let totalShippingRefunds = 0;
// // //     let totalNetReturns = 0;
// // //     let totalTotalRefund = 0;

// // //     const periodEventSummary: EventSummary = {
// // //       refunds: { count: 0, value: 0 },
// // //       exchanges: { count: 0, value: 0 },
// // //       partialRefunds: { count: 0, value: 0 },
// // //       totalEvents: 0,
// // //       netValue: 0
// // //     };

// // //     let ordersWithEventsCount = 0;
// // //     let totalEventsValue = 0;

// // //     safeData.dailyKeys.forEach(day => {
// // //       const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
// // //       totalRevenue += dayData.total;
// // //       totalOrders += dayData.orderCount;
// // //       totalItems += dayData.items;
// // //       totalNewCustomers += dayData.newCustomers;
// // //       totalRepeatCustomers += dayData.repeatedCustomers;
// // //       totalFulfilled += dayData.fulfilled;
// // //       totalUnfulfilled += dayData.unfulfilled;
// // //       totalDiscounts += dayData.discounts;
// // //       totalReturns += dayData.returns;
// // //       totalNetSales += dayData.netSales;
// // //       totalShipping += dayData.shipping;
// // //       totalTaxes += dayData.taxes;
// // //       totalExtraFees += dayData.extraFees;
// // //       totalTotalSales += dayData.totalSales;
// // //       totalShippingRefunds += dayData.shippingRefunds;
// // //       totalNetReturns += dayData.netReturns;
// // //       totalTotalRefund += dayData.totalRefund;
      
// // //       if (dayData.eventSummary) {
// // //         ordersWithEventsCount += dayData.hasSubsequentEvents ? 1 : 0;
        
// // //         periodEventSummary.refunds.count += dayData.eventSummary.refunds.count;
// // //         periodEventSummary.refunds.value += dayData.eventSummary.refunds.value;
// // //         periodEventSummary.exchanges.count += dayData.eventSummary.exchanges.count;
// // //         periodEventSummary.exchanges.value += dayData.eventSummary.exchanges.value;
// // //         periodEventSummary.partialRefunds.count += dayData.eventSummary.partialRefunds.count;
// // //         periodEventSummary.partialRefunds.value += dayData.eventSummary.partialRefunds.value;
// // //         periodEventSummary.totalEvents += dayData.eventSummary.totalEvents;
// // //         periodEventSummary.netValue += dayData.eventSummary.netValue;

// // //         totalEventsValue += Math.abs(dayData.eventSummary.netValue);
// // //       }
// // //     });

// // //     return {
// // //       totalRevenue,
// // //       totalOrders,
// // //       totalItems,
// // //       totalNewCustomers,
// // //       totalRepeatCustomers,
// // //       totalFulfilled,
// // //       totalUnfulfilled,
// // //       totalDiscounts,
// // //       totalReturns,
// // //       totalNetSales,
// // //       totalShipping,
// // //       totalTaxes,
// // //       totalExtraFees,
// // //       totalTotalSales,
// // //       totalShippingRefunds,
// // //       totalNetReturns,
// // //       totalTotalRefund,
// // //       eventSummary: periodEventSummary,
// // //       ordersWithSubsequentEvents: ordersWithEventsCount,
// // //       subsequentEventsCount: periodEventSummary.totalEvents,
// // //       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
// // //       avgDailyRevenue: totalRevenue / 7,
// // //       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
// // //       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
// // //       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
// // //       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
// // //     };
// // //   };

// // //   const getWeeklyFinancials = () => {
// // //     const safeData = getSafeData(data);
// // //     if (!safeData) return null;

// // //     let totalRevenue = 0;
// // //     let totalOrders = 0;
// // //     let totalItems = 0;
// // //     let totalDiscounts = 0;
// // //     let totalReturns = 0;
// // //     let totalNetSales = 0;
// // //     let totalShipping = 0;
// // //     let totalTaxes = 0;
// // //     let totalExtraFees = 0;
// // //     let totalTotalSales = 0;
// // //     let totalShippingRefunds = 0;
// // //     let totalNetReturns = 0;
// // //     let totalTotalRefund = 0;

// // //     const periodEventSummary: EventSummary = {
// // //       refunds: { count: 0, value: 0 },
// // //       exchanges: { count: 0, value: 0 },
// // //       partialRefunds: { count: 0, value: 0 },
// // //       totalEvents: 0,
// // //       netValue: 0
// // //     };

// // //     let ordersWithEventsCount = 0;
// // //     let totalEventsValue = 0;

// // //     safeData.weeklyKeys.forEach(week => {
// // //       const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
// // //       totalRevenue += weekData.total;
// // //       totalOrders += weekData.orderCount;
// // //       totalItems += weekData.items;
// // //       totalDiscounts += weekData.discounts;
// // //       totalReturns += weekData.returns;
// // //       totalNetSales += weekData.netSales;
// // //       totalShipping += weekData.shipping;
// // //       totalTaxes += weekData.taxes;
// // //       totalExtraFees += weekData.extraFees;
// // //       totalTotalSales += weekData.totalSales;
// // //       totalShippingRefunds += weekData.shippingRefunds;
// // //       totalNetReturns += weekData.netReturns;
// // //       totalTotalRefund += weekData.totalRefund;
      
// // //       if (weekData.eventSummary) {
// // //         ordersWithEventsCount += weekData.hasSubsequentEvents ? 1 : 0;
        
// // //         periodEventSummary.refunds.count += weekData.eventSummary.refunds.count;
// // //         periodEventSummary.refunds.value += weekData.eventSummary.refunds.value;
// // //         periodEventSummary.exchanges.count += weekData.eventSummary.exchanges.count;
// // //         periodEventSummary.exchanges.value += weekData.eventSummary.exchanges.value;
// // //         periodEventSummary.partialRefunds.count += weekData.eventSummary.partialRefunds.count;
// // //         periodEventSummary.partialRefunds.value += weekData.eventSummary.partialRefunds.value;
// // //         periodEventSummary.totalEvents += weekData.eventSummary.totalEvents;
// // //         periodEventSummary.netValue += weekData.eventSummary.netValue;

// // //         totalEventsValue += Math.abs(weekData.eventSummary.netValue);
// // //       }
// // //     });

// // //     return {
// // //       totalRevenue,
// // //       totalOrders,
// // //       totalItems,
// // //       totalDiscounts,
// // //       totalReturns,
// // //       totalNetSales,
// // //       totalShipping,
// // //       totalTaxes,
// // //       totalExtraFees,
// // //       totalTotalSales,
// // //       totalShippingRefunds,
// // //       totalNetReturns,
// // //       totalTotalRefund,
// // //       eventSummary: periodEventSummary,
// // //       ordersWithSubsequentEvents: ordersWithEventsCount,
// // //       subsequentEventsCount: periodEventSummary.totalEvents,
// // //       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
// // //       netRevenue: totalTotalSales,
// // //       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
// // //       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
// // //       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
// // //       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
// // //     };
// // //   };

// // //   const getMonthlyFinancials = () => {
// // //     const safeData = getSafeData(data);
// // //     if (!safeData) return null;

// // //     let totalRevenue = 0;
// // //     let totalOrders = 0;
// // //     let totalItems = 0;
// // //     let totalDiscounts = 0;
// // //     let totalReturns = 0;
// // //     let totalNetSales = 0;
// // //     let totalShipping = 0;
// // //     let totalTaxes = 0;
// // //     let totalExtraFees = 0;
// // //     let totalTotalSales = 0;
// // //     let totalShippingRefunds = 0;
// // //     let totalNetReturns = 0;
// // //     let totalTotalRefund = 0;

// // //     const periodEventSummary: EventSummary = {
// // //       refunds: { count: 0, value: 0 },
// // //       exchanges: { count: 0, value: 0 },
// // //       partialRefunds: { count: 0, value: 0 },
// // //       totalEvents: 0,
// // //       netValue: 0
// // //     };

// // //     let ordersWithEventsCount = 0;
// // //     let totalEventsValue = 0;

// // //     safeData.monthRanges.forEach(month => {
// // //       const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
// // //       totalRevenue += monthData.total;
// // //       totalOrders += monthData.orderCount;
// // //       totalItems += monthData.items;
// // //       totalDiscounts += monthData.discounts;
// // //       totalReturns += monthData.returns;
// // //       totalNetSales += monthData.netSales;
// // //       totalShipping += monthData.shipping;
// // //       totalTaxes += monthData.taxes;
// // //       totalExtraFees += monthData.extraFees;
// // //       totalTotalSales += monthData.totalSales;
// // //       totalShippingRefunds += monthData.shippingRefunds;
// // //       totalNetReturns += monthData.netReturns;
// // //       totalTotalRefund += monthData.totalRefund;
      
// // //       if (monthData.eventSummary) {
// // //         ordersWithEventsCount += monthData.hasSubsequentEvents ? 1 : 0;
        
// // //         periodEventSummary.refunds.count += monthData.eventSummary.refunds.count;
// // //         periodEventSummary.refunds.value += monthData.eventSummary.refunds.value;
// // //         periodEventSummary.exchanges.count += monthData.eventSummary.exchanges.count;
// // //         periodEventSummary.exchanges.value += monthData.eventSummary.exchanges.value;
// // //         periodEventSummary.partialRefunds.count += monthData.eventSummary.partialRefunds.count;
// // //         periodEventSummary.partialRefunds.value += monthData.eventSummary.partialRefunds.value;
// // //         periodEventSummary.totalEvents += monthData.eventSummary.totalEvents;
// // //         periodEventSummary.netValue += monthData.eventSummary.netValue;

// // //         totalEventsValue += Math.abs(monthData.eventSummary.netValue);
// // //       }
// // //     });

// // //     return {
// // //       totalRevenue,
// // //       totalOrders,
// // //       totalItems,
// // //       totalDiscounts,
// // //       totalReturns,
// // //       totalNetSales,
// // //       totalShipping,
// // //       totalTaxes,
// // //       totalExtraFees,
// // //       totalTotalSales,
// // //       totalShippingRefunds,
// // //       totalNetReturns,
// // //       totalTotalRefund,
// // //       eventSummary: periodEventSummary,
// // //       ordersWithSubsequentEvents: ordersWithEventsCount,
// // //       subsequentEventsCount: periodEventSummary.totalEvents,
// // //       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
// // //       netRevenue: totalTotalSales,
// // //       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
// // //       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
// // //       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
// // //       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
// // //     };
// // //   };

// // //   const formatNumber = (num: number) => num.toLocaleString('en-US');
// // //   const formatPercent = (num: number) => `${num.toFixed(1)}%`;
// // //   const formatCurrency = (amount: number) => {
// // //     const currency = safeData?.shopCurrency || 'USD';
// // //     return amount.toLocaleString('en-US', { 
// // //       style: 'currency', 
// // //       currency: currency,
// // //       minimumFractionDigits: 2 
// // //     });
// // //   };

// // //   const exportToPDF = () => {
// // //     setIsExporting(true);
    
// // //     const safeData = getSafeData(data);
// // //     const todayData = getTodayData();
// // //     const last7DaysData = getLast7DaysData();
// // //     const weeklyFinancials = getWeeklyFinancials();
// // //     const monthlyFinancials = getMonthlyFinancials();
    
// // //     if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
// // //       setIsExporting(false);
// // //       return;
// // //     }

// // //     const eventData = monthlyFinancials.eventSummary || weeklyFinancials.eventSummary || last7DaysData.eventSummary;
    
// // //     const totalEvents = eventData ? 
// // //       (eventData.refunds.count + eventData.exchanges.count + eventData.partialRefunds.count) : 0;
    
// // //     const ordersWithEvents = monthlyFinancials.ordersWithSubsequentEvents || 
// // //                             weeklyFinancials.ordersWithSubsequentEvents || 
// // //                             last7DaysData.ordersWithSubsequentEvents || 0;

// // //     const pdfData: OrderData = {
// // //       totalOrders: safeData.totalOrders,
// // //       totalCustomers: safeData.totalCustomerData.totalCustomers,
// // //       fulfillmentRate: safeData.totalOrders > 0 ? 
// // //         ((last7DaysData.totalFulfilled / last7DaysData.totalOrders) * 100) : 0,
// // //       totalRevenue: monthlyFinancials.totalRevenue,
// // //       netRevenue: monthlyFinancials.netRevenue,
// // //       averageOrderValue: safeData.totalOrders > 0 ? 
// // //         (monthlyFinancials.totalRevenue / safeData.totalOrders) : 0,
// // //       totalItems: monthlyFinancials.totalItems,
// // //       todayOrders: todayData.orderCount,
// // //       todayRevenue: todayData.total,
// // //       todayItems: todayData.items,
// // //       ordersChangeVsYesterday: 100.0,
// // //       revenueChangeVsYesterday: 100.0,
// // //       itemsChangeVsYesterday: 100.0,
// // //       newCustomers: safeData.totalCustomerData.newCustomers,
// // //       repeatCustomers: safeData.totalCustomerData.repeatedCustomers,
// // //       customerRetentionRate: safeData.totalCustomerData.totalCustomers > 0 ? 
// // //         ((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100) : 0,
// // //       averageOrderFrequency: 1.0,
// // //       shopTimezone: safeData.shopTimeZone,
// // //       shopCurrency: safeData.shopCurrency,
// // //       totalRefunds: eventData?.refunds.count || 0,
// // //       totalExchanges: eventData?.exchanges.count || 0,
// // //       totalPartialRefunds: eventData?.partialRefunds.count || 0,
// // //       totalEvents: totalEvents,
// // //       ordersWithEvents: ordersWithEvents,
// // //       netEventValue: eventData?.netValue || 0
// // //     };

// // //     generatePDFReport(pdfData);
// // //     setIsExporting(false);
// // //   };

// // //   if ("error" in data) {
// // //     return (
// // //       <div className="orders-dashboard">
// // //         <div style={{ padding: "40px", textAlign: "center", background: "#fff5f5", borderRadius: "8px" }}>
// // //           <h1>We're Sorry</h1>
// // //           <p>{data.userMessage}</p>
// // //           <button className="print-button" onClick={handleManualRefresh}>
// // //             Refresh Page
// // //           </button>
// // //         </div>
// // //       </div>
// // //     );
// // //   }

// // //   const safeData = getSafeData(data);
// // //   const todayData = getTodayData();
// // //   const last7DaysData = getLast7DaysData();
// // //   const weeklyFinancials = getWeeklyFinancials();
// // //   const monthlyFinancials = getMonthlyFinancials();

// // //   if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
// // //     return (
// // //       <div className="orders-dashboard">
// // //         <div style={{ padding: "20px", color: "red", textAlign: "center" }}>
// // //           <h1>Data Validation Failed</h1>
// // //           <p>Please refresh the page.</p>
// // //         </div>
// // //       </div>
// // //     );
// // //   }

// // //   const formatDateDisplay = (dateStr: string) => {
// // //     const date = new Date(dateStr + 'T00:00:00');
// // //     return date.toLocaleDateString('en-US', { 
// // //       month: 'short', 
// // //       day: 'numeric',
// // //       timeZone: safeData.shopTimeZone 
// // //     });
// // //   };

// // //   const getDayName = (dateStr: string) => {
// // //     const date = new Date(dateStr + 'T00:00:00');
// // //     return date.toLocaleDateString('en-US', { 
// // //       weekday: 'short',
// // //       timeZone: safeData.shopTimeZone 
// // //     });
// // //   };

// // //   return (
// // //     <div className="orders-dashboard">
// // //       <div className="dashboard-header">
// // //         <h1>Orders Dashboard</h1>
// // //         <div className="header-controls">
// // //           <button 
// // //             className="export-button"
// // //             onClick={exportToPDF}
// // //             disabled={isExporting}
// // //             title="Export summary PDF report with key metrics"
// // //           >
// // //             <Icon.Export />
// // //             {isExporting ? 'Generating PDF...' : 'Export Summary'}
// // //           </button>
// // //         </div>
// // //       </div>

// // //       <div id="dashboard-content">
// // //         {/* Today's Performance Section */}
// // //         <section className="today-performance">
// // //           <h2>Today's Performance</h2>
// // //           <MismatchSummaryCard 
// // //             mismatchSummary={getTodayMismatchSummary(safeData)} 
// // //             periodType="day" 
// // //           />
          
// // //           <div className="primary-metrics-grid">
// // //             <div className="metric-card orders">
// // //               <div className="metric-value">{safeNumber(todayData.orderCount)}</div>
// // //               <div className="metric-label">Today's Orders</div>
// // //               <div className="metric-change positive">
// // //                 <Icon.TrendUp />
// // //                 100.0% vs yesterday
// // //               </div>
// // //             </div>
            
// // //             <div className="metric-card revenue">
// // //               <div className="metric-value">{formatCurrency(safeNumber(todayData.totalSales))}</div>
// // //               <div className="metric-label">Today's Total Sales</div>
// // //               <div className="metric-change positive">
// // //                 <Icon.TrendUp />
// // //                 100.0% vs yesterday
// // //               </div>
// // //             </div>
            
// // //             <div className="metric-card items">
// // //               <div className="metric-value">{safeNumber(todayData.items)}</div>
// // //               <div className="metric-label">Items Ordered</div>
// // //               <div className="metric-change positive">
// // //                 <Icon.TrendUp />
// // //                 100.0% vs yesterday
// // //               </div>
// // //             </div>
// // //           </div>

// // //           <div className="fulfillment-metrics-grid">
// // //             <div className="fulfillment-metric-card today-fulfilled">
// // //               <div className="fulfillment-metric-value">{safeNumber(todayData.fulfilled)}</div>
// // //               <div className="fulfillment-metric-label">FULFILLED TODAY</div>
// // //               <div className="fulfillment-metric-period">Today</div>
// // //             </div>
            
// // //             <div className="fulfillment-metric-card today-unfulfilled">
// // //               <div className="fulfillment-metric-value">{safeNumber(todayData.unfulfilled)}</div>
// // //               <div className="fulfillment-metric-label">UNFULFILLED TODAY</div>
// // //               <div className="fulfillment-metric-period">Today</div>
// // //             </div>
            
// // //             <div className="fulfillment-metric-card week-fulfilled">
// // //               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalFulfilled)}</div>
// // //               <div className="fulfillment-metric-label">FULFILLED</div>
// // //               <div className="fulfillment-metric-period">Last 7 Days</div>
// // //             </div>
            
// // //             <div className="fulfillment-metric-card week-unfulfilled">
// // //               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalUnfulfilled)}</div>
// // //               <div className="fulfillment-metric-label">UNFULFILLED</div>
// // //               <div className="fulfillment-metric-period">Last 7 Days</div>
// // //             </div>
// // //           </div>

// // //           {todayData?.eventSummary && todayData.eventSummary.totalEvents > 0 && (
// // //             <EventSummaryDisplay 
// // //               eventSummary={todayData.eventSummary} 
// // //               title="Today's Order Activity & Adjustments"
// // //             />
// // //           )}
// // //         </section>

// // //         {/* Last 7 Days Performance Section */}
// // //         <section className="last7days-section">
// // //           <h3>Last 7 Days Performance</h3>
          
// // //           <div className="last7days-grid">
// // //             <div className="last7days-total-card">
// // //               <div className="last7days-total-value">{safeNumber(last7DaysData.totalOrders)}</div>
// // //               <div className="last7days-total-label">TOTAL ORDERS</div>
// // //             </div>
            
// // //             <div className="last7days-total-card">
// // //               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales))}</div>
// // //               <div className="last7days-total-label">TOTAL SALES</div>
// // //             </div>
            
// // //             <div className="last7days-total-card">
// // //               <div className="last7days-total-value">{safeNumber(last7DaysData.totalItems)}</div>
// // //               <div className="last7days-total-label">TOTAL ITEMS</div>
// // //             </div>
            
// // //             <div className="last7days-total-card">
// // //               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales / 7))}</div>
// // //               <div className="last7days-total-label">AVG DAILY SALES</div>
// // //             </div>
// // //           </div>

// // //           {/* Daily Breakdown Table */}
// // //           <div className="daily-breakdown">
// // //             <h4>Daily Breakdown</h4>
// // //             <div className="daily-cards-container">
// // //               {safeData.dailyKeys.map((day, index) => {
// // //                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
// // //                 const isToday = index === safeData.dailyKeys.length - 1;
                
// // //                 return (
// // //                   <div key={day} className={`daily-card ${isToday ? 'current-day' : ''}`}>
// // //                     <div className="daily-card-header">
// // //                       <div className="daily-date">{formatDateDisplay(day)}</div>
// // //                       <div className="daily-day">{getDayName(day)}</div>
// // //                     </div>
                    
// // //                     <div className="daily-metrics">
// // //                       <div className="daily-metric">
// // //                         <span className="daily-metric-label">ORDERS</span>
// // //                         <span className="daily-metric-value">{safeNumber(dayData.orderCount)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-metric">
// // //                         <span className="daily-metric-label">TOTAL SALES</span>
// // //                         <span className="daily-metric-value">{formatCurrency(safeNumber(dayData.totalSales))}</span>
// // //                       </div>
                      
// // //                       <div className="daily-metric">
// // //                         <span className="daily-metric-label">ITEMS</span>
// // //                         <span className="daily-metric-value">{safeNumber(dayData.items)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>

// // //           {last7DaysData?.eventSummary && last7DaysData.eventSummary.totalEvents > 0 && (
// // //             <EventSummaryDisplay 
// // //               eventSummary={last7DaysData.eventSummary} 
// // //               title="Last 7 Days: Refunds, Exchanges & Adjustments"
// // //             />
// // //           )}
// // //         </section>

// // //         {/* Week-over-Week Insight */}
// // //         <div className="secondary-metrics">
// // //           <div className="insight-card">
// // //             <h4>Week-over-Week Revenue Change</h4>
// // //             <p className="insight-value text-positive">
// // //               <Icon.TrendUp /> 
// // //               100.0%
// // //             </p>
// // //           </div>
// // //         </div>

// // //         {/* Customer Insights Section */}
// // //         <section className="customer-metrics">
// // //           <h3>Customer Insights</h3>
          
// // //           <div className="customer-metrics-grid">
// // //             <div className="customer-metric-card total-customers">
// // //               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.totalCustomers)}</div>
// // //               <div className="customer-metric-label">TOTAL CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card new-customers">
// // //               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.newCustomers)}</div>
// // //               <div className="customer-metric-label">NEW CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card repeat-customers">
// // //               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.repeatedCustomers)}</div>
// // //               <div className="customer-metric-label">REPEAT CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card loyalty-rate">
// // //               <div className="customer-metric-value">
// // //                 {safeData.totalCustomerData.totalCustomers > 0 
// // //                   ? formatPercent((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100)
// // //                   : '0.0%'
// // //                 }
// // //               </div>
// // //               <div className="customer-metric-label">REPEAT CUSTOMER RATE</div>
// // //             </div>
// // //           </div>
// // //         </section>

// // //         {/* Last 7 Days Customer Insights */}
// // //         <section className="customer-metrics">
// // //           <h3>Last 7 Days Customer Insights</h3>
          
// // //           <div className="customer-metrics-grid">
// // //             <div className="customer-metric-card total-customers">
// // //               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)}</div>
// // //               <div className="customer-metric-label">7-DAY TOTAL CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card new-customers">
// // //               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers)}</div>
// // //               <div className="customer-metric-label">7-DAY NEW CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card repeat-customers">
// // //               <div className="customer-metric-value">{safeNumber(last7DaysData.totalRepeatCustomers)}</div>
// // //               <div className="customer-metric-label">7-DAY REPEAT CUSTOMERS</div>
// // //             </div>
            
// // //             <div className="customer-metric-card loyalty-rate">
// // //               <div className="customer-metric-value">
// // //                 {(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers) > 0
// // //                   ? formatPercent((last7DaysData.totalRepeatCustomers / (last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)) * 100)
// // //                   : '0.0%'
// // //                 }
// // //               </div>
// // //               <div className="customer-metric-label">7-DAY REPEAT RATE</div>
// // //             </div>
// // //           </div>
// // //         </section>

// // //         {/* Last 7 Days Financial Breakdown */}
// // //         <section className="financial-metrics">
// // //           <h3>Last 7 Days Financial Breakdown</h3>

// // //           <MismatchSummaryCard 
// // //             mismatchSummary={getCalculationMismatchSummary(safeData)} 
// // //             periodType="day"
// // //           />

// // //           <div className="financial-metrics-grid">
// // //             <div className="financial-metric-card revenue">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalRevenue)}</div>
// // //               <div className="financial-metric-label">Gross Sales</div>
// // //               <div className="financial-metric-period">7 Days</div>
// // //             </div>
            
// // //             <div className="financial-metric-card discounts">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalDiscounts)}</div>
// // //               <div className="financial-metric-label">Total Discounts</div>
// // //               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalDiscounts / last7DaysData.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card returns">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalReturns)}</div>
// // //               <div className="financial-metric-label">Returns & Refunds</div>
// // //               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalReturns / last7DaysData.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card return-fees">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalExtraFees)}</div>
// // //               <div className="financial-metric-label">Return Fees</div>
// // //               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalExtraFees / last7DaysData.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card net-sales">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalNetSales)}</div>
// // //               <div className="financial-metric-label">Net Sales</div>
// // //               <div className="financial-metric-period">After ALL deductions</div>
// // //             </div>
            
// // //             <div className="financial-metric-card shipping">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalShipping)}</div>
// // //               <div className="financial-metric-label">Shipping Charges</div>
// // //               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalShipping / last7DaysData.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card taxes">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTaxes)}</div>
// // //               <div className="financial-metric-label">Taxes Collected</div>
// // //               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalTaxes / last7DaysData.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card total-sales">
// // //               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTotalSales)}</div>
// // //               <div className="financial-metric-label">Total Sales</div>
// // //               <div className="financial-metric-period">Final amount</div>
// // //             </div>
// // //           </div>

// // //           {/* Daily Financial Details */}
// // //           <div className="daily-financial-breakdown">
// // //             <h4>Daily Financial Details</h4>
// // //             <div className="daily-financial-cards">
// // //               {safeData.dailyKeys.map((day, index) => {
// // //                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
// // //                 const isToday = index === safeData.dailyKeys.length - 1;
                
// // //                 return (
// // //                   <div key={day} className={`daily-financial-card ${isToday ? 'current-day' : ''}`}>
// // //                     <div className="daily-financial-header">
// // //                       <div className="daily-financial-date">{formatDateDisplay(day)}</div>
// // //                       <div className="daily-financial-day">{getDayName(day)}</div>
// // //                     </div>
                    
// // //                     <div className="daily-financial-metrics">
// // //                       <div className="daily-financial-metric gross-revenue">
// // //                         <span className="daily-financial-label">Gross Sales</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.total)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric discounts">
// // //                         <span className="daily-financial-label">Discounts</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.discounts)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric returns">
// // //                         <span className="daily-financial-label">Returns</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.returns)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric net-sales">
// // //                         <span className="daily-financial-label">Net Sales</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.netSales)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric shipping">
// // //                         <span className="daily-financial-label">Shipping Charges</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.shipping)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric return-fees">
// // //                         <span className="daily-financial-label">Return Fees</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.extraFees)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric taxes">
// // //                         <span className="daily-financial-label">Taxes</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.taxes)}</span>
// // //                       </div>
                      
// // //                       <div className="daily-financial-metric total-sales">
// // //                         <span className="daily-financial-label">Total Sales</span>
// // //                         <span className="daily-financial-value">{formatCurrency(dayData.totalSales)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>
// // //         </section>

// // //         {/* Weekly Performance */}
// // //         <section className="weekly-performance">
// // //           <h3>Weekly Performance (Last 8 Weeks)</h3>
// // //           <MismatchSummaryCard 
// // //             mismatchSummary={getWeeklyMismatchSummary(safeData)} 
// // //             periodType="week"
// // //           />
// // //           <div className="weekly-grid">
// // //             <div className="weekly-card">
// // //               <div className="weekly-value">{safeNumber(weeklyFinancials.totalOrders)}</div>
// // //               <div className="weekly-label">Total Orders</div>
// // //             </div>
            
// // //             <div className="weekly-card">
// // //               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
// // //               <div className="weekly-label">Total Revenue</div>
// // //             </div>
            
// // //             <div className="weekly-card">
// // //               <div className="weekly-value">{safeNumber(weeklyFinancials.totalItems)}</div>
// // //               <div className="weekly-label">Total Items</div>
// // //             </div>
            
// // //             <div className="weekly-card">
// // //               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue / safeData.weeklyKeys.length)}</div>
// // //               <div className="weekly-label">Avg Weekly Revenue</div>
// // //             </div>
// // //           </div>

// // //           {/* Weekly Breakdown */}
// // //           <div className="weekly-breakdown">
// // //             <h4>Weekly Breakdown</h4>
// // //             <div className="weekly-cards-container">
// // //               {safeData.weeklyKeys.map((week, index) => {
// // //                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
// // //                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
// // //                 return (
// // //                   <div key={week} className={`week-card ${isCurrentWeek ? 'current-week' : ''}`}>
// // //                     <div className="week-header">
// // //   <div className="week-label">{formatWeekDisplay(week)}</div>
// // // </div>
                    
// // //                     <div className="week-metrics">
// // //                       <div className="week-metric orders">
// // //                         <span className="week-metric-label">Orders</span>
// // //                         <span className="week-metric-value">{safeNumber(weekData.orderCount)}</span>
// // //                       </div>
                      
// // //                       <div className="week-metric revenue">
// // //                         <span className="week-metric-label">Total Sales</span>
// // //                         <span className="week-metric-value">{formatCurrency(weekData.totalSales)}</span>
// // //                       </div>
                      
// // //                       <div className="week-metric items">
// // //                         <span className="week-metric-label">Items</span>
// // //                         <span className="week-metric-value">{safeNumber(weekData.items)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>

// // //           {weeklyFinancials?.eventSummary && weeklyFinancials.eventSummary.totalEvents > 0 && (
// // //             <EventSummaryDisplay 
// // //               eventSummary={weeklyFinancials.eventSummary} 
// // //               title="8-Week Period: Order Events & Financial Adjustments"
// // //             />
// // //           )}
// // //         </section>

// // //         {/* Weekly Financial Breakdown */}
// // //         <section className="financial-metrics">
// // //           <h3>Weekly Financial Breakdown (Last 8 Weeks)</h3>
// // //           <div className="financial-metrics-grid">
// // //             <div className="financial-metric-card revenue">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
// // //               <div className="financial-metric-label">Gross Sales</div>
// // //               <div className="financial-metric-period">8 Weeks</div>
// // //             </div>
            
// // //             <div className="financial-metric-card discounts">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalDiscounts)}</div>
// // //               <div className="financial-metric-label">Total Discounts</div>
// // //               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalDiscounts / weeklyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card returns">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalReturns)}</div>
// // //               <div className="financial-metric-label">Returns & Refunds</div>
// // //               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalReturns / weeklyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card return-fees">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalExtraFees)}</div>
// // //               <div className="financial-metric-label">Return Fees</div>
// // //               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalExtraFees / weeklyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card net-sales">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalNetSales)}</div>
// // //               <div className="financial-metric-label">Net Sales</div>
// // //               <div className="financial-metric-period">After ALL deductions</div>
// // //             </div>
            
// // //             <div className="financial-metric-card shipping">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalShipping)}</div>
// // //               <div className="financial-metric-label">Shipping Charges</div>
// // //               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalShipping / weeklyFinancials.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card taxes">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTaxes)}</div>
// // //               <div className="financial-metric-label">Taxes Collected</div>
// // //               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalTaxes / weeklyFinancials.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card total-sales">
// // //               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTotalSales)}</div>
// // //               <div className="financial-metric-label">Total Sales</div>
// // //               <div className="financial-metric-period">Final amount</div>
// // //             </div>
// // //           </div>

// // //           {/* Weekly Financial Details */}
// // //           <div className="weekly-financial-breakdown">
// // //             <h4>Weekly Financial Details</h4>
// // //             <div className="weekly-financial-cards">
// // //               {safeData.weeklyKeys.map((week, index) => {
// // //                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
// // //                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
// // //                 return (
// // //                   <div key={week} className={`weekly-financial-card ${isCurrentWeek ? 'current-week' : ''}`}>
// // //                     <div className="weekly-financial-header">
// // //   <div className="weekly-financial-label">{formatWeekDisplay(week)}</div>
// // // </div>
                    
// // //                     <div className="weekly-financial-metrics">
// // //                       <div className="weekly-financial-metric gross-revenue">
// // //                         <span className="weekly-financial-label">Gross Sales</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.total)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric discounts">
// // //                         <span className="weekly-financial-label">Discounts</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.discounts)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric returns">
// // //                         <span className="weekly-financial-label">Returns</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.returns)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric net-sales">
// // //                         <span className="weekly-financial-label">Net Sales</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.netSales)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric shipping">
// // //                         <span className="weekly-financial-label">Shipping Charges</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.shipping)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric return-fees">
// // //                         <span className="weekly-financial-label">Return Fees</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.extraFees)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric taxes">
// // //                         <span className="weekly-financial-label">Taxes</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.taxes)}</span>
// // //                       </div>
                      
// // //                       <div className="weekly-financial-metric total-sales">
// // //                         <span className="weekly-financial-label">Total Sales</span>
// // //                         <span className="weekly-financial-value">{formatCurrency(weekData.totalSales)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>
// // //         </section>

// // //         {/* Monthly Performance */}
// // //         <section className="monthly-performance">
// // //           <h3>Monthly Performance (Last 6 Months)</h3>
// // //           <MismatchSummaryCard 
// // //             mismatchSummary={getMonthlyMismatchSummary(safeData)} 
// // //             periodType="month"
// // //           />
// // //           <div className="monthly-grid">
// // //             <div className="monthly-card">
// // //               <div className="monthly-value">{safeNumber(monthlyFinancials.totalOrders)}</div>
// // //               <div className="monthly-label">Total Orders</div>
// // //             </div>
            
// // //             <div className="monthly-card">
// // //               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
// // //               <div className="monthly-label">Total Revenue</div>
// // //             </div>
            
// // //             <div className="monthly-card">
// // //               <div className="monthly-value">{safeNumber(monthlyFinancials.totalItems)}</div>
// // //               <div className="monthly-label">Total Items</div>
// // //             </div>
            
// // //             <div className="monthly-card">
// // //               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue / safeData.monthRanges.length)}</div>
// // //               <div className="monthly-label">Avg Monthly Revenue</div>
// // //             </div>
// // //           </div>

// // //           {/* Monthly Breakdown */}
// // //           <div className="monthly-breakdown">
// // //             <h4>Monthly Breakdown</h4>
// // //             <div className="monthly-cards-container">
// // //               {safeData.monthRanges.map((month, index) => {
// // //                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
// // //                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
// // //                 const isCurrentMonth = month === currentMonth;
                
// // //                 const avgRevenue = safeData.monthRanges.reduce((sum, m) => {
// // //                   const mData = getSafeCustomerStats(safeData.monthlyTotals, m);
// // //                   return sum + mData.total;
// // //                 }, 0) / safeData.monthRanges.length;
// // //                 const performanceLevel = monthData.total > avgRevenue * 1.2 ? 'high' : 
// // //                                        monthData.total > avgRevenue * 0.8 ? 'medium' : 'low';
                
// // //                 return (
// // //                   <div key={month} className={`month-card ${isCurrentMonth ? 'current-month' : ''}`}>
// // //                     {isCurrentMonth && <div className="current-badge">Current</div>}
// // //                     <div className="month-header">
// // //                       <div className="month-label">{month.split(' ')[0]}</div>
// // //                       <div className="month-period">{month.split(' ')[1]}</div>
// // //                     </div>
                    
// // //                     <div className="month-metrics">
// // //                       <div className="month-metric orders">
// // //                         <span className="month-metric-label">Orders</span>
// // //                         <span className="month-metric-value">{safeNumber(monthData.orderCount)}</span>
// // //                       </div>
                      
// // //                       <div className="month-metric revenue">
// // //                         <span className="month-metric-label">Total Sales</span>
// // //                         <span className="month-metric-value">{formatCurrency(monthData.totalSales)}</span>
// // //                       </div>
                      
// // //                       <div className="month-metric items">
// // //                         <span className="month-metric-label">Items</span>
// // //                         <span className="month-metric-value">{safeNumber(monthData.items)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>

// // //           {monthlyFinancials?.eventSummary && monthlyFinancials.eventSummary.totalEvents > 0 && (
// // //             <EventSummaryDisplay 
// // //               eventSummary={monthlyFinancials.eventSummary} 
// // //               title="6-Month Overview: All Order Events & Adjustments"
// // //             />
// // //           )}
// // //         </section>

// // //         {/* Monthly Financial Breakdown */}
// // //         <section className="financial-metrics">
// // //           <h3>Monthly Financial Breakdown (Last 6 Months)</h3>
// // //           <div className="financial-metrics-grid">
// // //             <div className="financial-metric-card revenue">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
// // //               <div className="financial-metric-label">Gross Sales</div>
// // //               <div className="financial-metric-period">6 Months</div>
// // //             </div>
            
// // //             <div className="financial-metric-card discounts">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalDiscounts)}</div>
// // //               <div className="financial-metric-label">Total Discounts</div>
// // //               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalDiscounts / monthlyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card returns">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalReturns)}</div>
// // //               <div className="financial-metric-label">Returns & Refunds</div>
// // //               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalReturns / monthlyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card return-fees">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalExtraFees)}</div>
// // //               <div className="financial-metric-label">Return Fees</div>
// // //               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalExtraFees / monthlyFinancials.totalRevenue * 100)} of gross</div>
// // //             </div>
            
// // //             <div className="financial-metric-card net-sales">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalNetSales)}</div>
// // //               <div className="financial-metric-label">Net Sales</div>
// // //               <div className="financial-metric-period">After ALL deductions</div>
// // //             </div>
            
// // //             <div className="financial-metric-card shipping">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalShipping)}</div>
// // //               <div className="financial-metric-label">Shipping Charges</div>
// // //               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalShipping / monthlyFinancials.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card taxes">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTaxes)}</div>
// // //               <div className="financial-metric-label">Taxes Collected</div>
// // //               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalTaxes / monthlyFinancials.totalNetSales * 100)} of net sales</div>
// // //             </div>
            
// // //             <div className="financial-metric-card total-sales">
// // //               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTotalSales)}</div>
// // //               <div className="financial-metric-label">Total Sales</div>
// // //               <div className="financial-metric-period">Final amount</div>
// // //             </div>
// // //           </div>

// // //           {/* Monthly Financial Details */}
// // //           <div className="monthly-financial-breakdown">
// // //             <h4>Monthly Financial Details</h4>
// // //             <div className="monthly-financial-cards">
// // //               {safeData.monthRanges.map((month, index) => {
// // //                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
// // //                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
// // //                 const isCurrentMonth = month === currentMonth;
                
// // //                 return (
// // //                   <div key={month} className={`monthly-financial-card ${isCurrentMonth ? 'current-month' : ''}`}>
// // //                     {isCurrentMonth && <div className="current-badge">Current</div>}
// // //                     <div className="monthly-financial-header">
// // //                       <div className="monthly-financial-label">{month.split(' ')[0]}</div>
// // //                       <div className="monthly-financial-period">{month.split(' ')[1]}</div>
// // //                     </div>
                    
// // //                     <div className="monthly-financial-metrics">
// // //                       <div className="monthly-financial-metric gross-revenue">
// // //                         <span className="monthly-financial-label">Gross Sales</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.total)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric discounts">
// // //                         <span className="monthly-financial-label">Discounts</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.discounts)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric returns">
// // //                         <span className="monthly-financial-label">Returns</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.returns)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric net-sales">
// // //                         <span className="monthly-financial-label">Net Sales</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.netSales)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric shipping">
// // //                         <span className="monthly-financial-label">Shipping Charges</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.shipping)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric return-fees">
// // //                         <span className="monthly-financial-label">Return Fees</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.extraFees)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric taxes">
// // //                         <span className="monthly-financial-label">Taxes</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.taxes)}</span>
// // //                       </div>
                      
// // //                       <div className="monthly-financial-metric total-sales">
// // //                         <span className="monthly-financial-label">Total Sales</span>
// // //                         <span className="monthly-financial-value">{formatCurrency(monthData.totalSales)}</span>
// // //                       </div>
// // //                     </div>
// // //                   </div>
// // //                 );
// // //               })}
// // //             </div>
// // //           </div>
// // //         </section>

// // //         {/* Charts & Analytics Section */}
// // //         <section className="charts-section">
// // //           <h2>Analytics & Insights Visualization</h2>
          
// // //           <div className="charts-grid">
// // //             <ChartComponents.CustomerDistribution data={safeData} />
// // //             <ChartComponents.RevenueTrend data={safeData} />
// // //             <ChartComponents.MonthlyPerformance data={safeData} />
// // //             <ChartComponents.FinancialBreakdown data={safeData} />
// // //           </div>
// // //         </section>

// // //         {/* Footer */}
// // //         <footer className="app-footer">
// // //           <div className="footer-content">
// // //             <p>
// // //               <strong>Orders Analyzed:</strong> {safeData.totalOrders} orders  
// // //               <strong> Net Revenue:</strong> {formatCurrency(monthlyFinancials.netRevenue)}  
// // //               <strong> Data Updated:</strong> {new Date(safeData.lastUpdated).toLocaleDateString()}
// // //             </p>
// // //             <p className="footer-brand">Analytics Dashboard - Nexus Powering Your Business Insights</p>
// // //           </div>
// // //         </footer>
// // //       </div>
// // //     </div>
// // //   );
// // // }

// // // // ====================  17.0 EXPORT COMPONENT ====================

// // // export default function AnalyticsApp() {
// // //   return <ShopifyAnalyticsPage />;
// // // }































// // ==================== 1.0 IMPORTS & SETUP ====================

// import { json, type LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import { useState, useEffect, useMemo } from "react";
// import "../styles/orders.css";

// import {
//   Chart as ChartJS,
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   LineElement,
//   PointElement,
//   ArcElement,
//   Title,
//   Tooltip,
//   Legend,
//   Filler,
// } from 'chart.js';
// import { Bar, Line, Pie, Doughnut } from 'react-chartjs-2';

// // Import types
// import type {
//   Order,
//   OrderStats,
//   CustomerData,
//   AnalyticsData,
//   CachedAnalyticsData,
//   OrderData,
//   EventSummary
// } from '../types/analytics';

// // Import core functionality
// import { analyticsLoader } from '../core/analyticsLoader.server';
// import { generatePDFReport } from '../components/analytics/pdfExport';
// import { ChartComponents } from '../components/analytics/charts';

// ChartJS.register(
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   LineElement,
//   PointElement,
//   ArcElement,
//   Title,
//   Tooltip,
//   Legend,
//   Filler
// );

// // ==================== 2.0 ICON COMPONENTS ====================

// const Icon = {
//   Print: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
//     </svg>
//   ),
//   TrendUp: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
//     </svg>
//   ),
//   TrendDown: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/>
//     </svg>
//   ),
//   Export: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
//     </svg>
//   )
// };

// const SvgIcons = {
//   Chart: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
//     </svg>
//   ),
//   TrendingUp: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
//     </svg>
//   ),
//   Dollar: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.78-1.18 2.73-3.12 3.16z"/>
//     </svg>
//   ),
//   Rocket: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M2.81 14.12L5.64 11.29l-1.41-1.42L1.42 12.7l1.39 1.42zM14.12 2.81L11.29 5.64l1.42 1.41 1.41-1.41-1.41-1.42zm8.03 9.91l-1.39-1.42-2.81 2.81 1.41 1.42 2.79-2.81zM7.34 12.5l4.16-4.16L12.5 7.34 8.34 11.5 7.34 12.5zM19.67 7.34l1.39-1.39c.38-.38.38-1.02 0-1.41l-1.39-1.39c-.38-.38-1.02-.38-1.41 0l-1.39 1.39 1.41 1.41 1.39-1.39zM5.63 19.67l1.39 1.39c.38.38 1.02.38 1.41 0l1.39-1.39-1.41-1.41-1.39 1.39zM3.52 15.62c-.39-.39-.39-1.02 0-1.41l1.39-1.39 1.41 1.41-1.39 1.39c-.38.38-1.02.38-1.41 0z"/>
//     </svg>
//   ),
//   Users: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2.01 2.01 0 0018.06 7h-.12a2 2 0 00-1.9 1.37l-.86 2.58c1.08.6 1.82 1.73 1.82 3.05v8h3zm-7.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4zm6.5 0v-4h1v-4c0-.82-.68-1.5-1.5-1.5h-2c-.82 0-1.5.68-1.5 1.5v4h1v4h3z"/>
//     </svg>
//   ),
//   Activity: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M13 7h-2v6h6v-2h-4V7zM3 3v18h18V3H3zm16 16H5V5h14v14z"/>
//     </svg>
//   ),
//   Warning: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
//     </svg>
//   ),
//   Analytics: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
//     </svg>
//   )
// };

// // ==================== 3.0 LOADING COMPONENT ====================

// function LoadingProgress() {
//   const loadingSteps = [
//     "Fetching recent orders...",
//     "Analyzing revenue data...", 
//     "Processing customer insights...",
//     "Calculating fulfillment rates...",
//     "Generating sales analytics..."
//   ];

//   return (
//     <div className="loading-progress-container">
//       <div className="loading-header">
//         <h2>Loading Analytics Dashboard</h2>
//         <p>Analyzing your order data and generating insights...</p>
//       </div>
      
//       <div className="progress-bar-container">
//         <div className="progress-bar">
//           <div className="progress-fill"></div>
//         </div>
//       </div>

//       <div className="loading-steps">
//         {loadingSteps.map((step, index) => (
//           <div key={index} className="loading-step">
//             <div className="step-indicator"></div>
//             <div className="step-text">{step}</div>
//           </div>
//         ))}
//       </div>
//     </div>
//   );
// }

// // ==================== 4.0 EVENT SUMMARY COMPONENT ====================

// function EventSummaryDisplay({ eventSummary, title }: { eventSummary: EventSummary, title: string }) {
//   if (!eventSummary || eventSummary.totalEvents === 0) {
//     return null;
//   }

//   const formatValue = (value: number) => {
//     const absValue = Math.abs(value);
//     const sign = value < 0 ? '-' : value > 0 ? '+' : '';
//     return `${sign}$${absValue.toFixed(2)}`;
//   };

//   return (
//     <section className="event-summary-display">
//       <h3>{title} ({eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''})</h3>
      
//       <div className="event-summary-grid">
//         {eventSummary.refunds.count > 0 && (
//           <div className="event-card refunds">
//             <div className="event-label">Full Refunds</div>
//             <div className="event-value">{formatValue(eventSummary.refunds.value)}</div>
//             <div className="event-count">
//               {eventSummary.refunds.count} refund{eventSummary.refunds.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         {eventSummary.partialRefunds.count > 0 && (
//           <div className="event-card partial-refunds">
//             <div className="event-label">Partial Refunds</div>
//             <div className="event-value">{formatValue(eventSummary.partialRefunds.value)}</div>
//             <div className="event-count">
//               {eventSummary.partialRefunds.count} refund{eventSummary.partialRefunds.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         {eventSummary.exchanges.count > 0 && (
//           <div className="event-card exchanges">
//             <div className="event-label">Exchanges</div>
//             <div className="event-value">{formatValue(eventSummary.exchanges.value)}</div>
//             <div className="event-count">
//               {eventSummary.exchanges.count} exchange{eventSummary.exchanges.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         <div className="event-card net-summary">
//           <div className="event-label">Net Impact</div>
//           <div className="event-value">{formatValue(eventSummary.netValue)}</div>
//           <div className="event-count">
//             across {eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''}
//           </div>
//         </div>
//       </div>
//     </section>
//   );
// }

// // ==================== 5.0 MISMATCH SUMMARY COMPONENT ====================

// function MismatchSummaryCard({ mismatchSummary, periodType }: { 
//   mismatchSummary: { 
//     totalMismatches: number; 
//     totalDifference: number; 
//     hasMismatches: boolean; 
//   };
//   periodType: 'day' | 'week' | 'month';
// }) {
//   if (!mismatchSummary.hasMismatches) {
//     return null;
//   }

//   const getPeriodLabel = () => {
//     switch (periodType) {
//       case 'day': return 'Days';
//       case 'week': return 'Weeks'; 
//       case 'month': return 'Months';
//       default: return 'Periods';
//     }
//   };

//   const getDifferenceColor = (difference: number) => {
//     return Math.abs(difference) > 0.01 ? '#dc2626' : '#059669';
//   };

//   const getDifferenceText = (difference: number) => {
//     const absDiff = Math.abs(difference);
//     if (absDiff <= 0.01) return 'Perfect Match';
//     return `$${absDiff.toFixed(2)}`;
//   };

//   return (
//     <section className="mismatch-summary-card">
//       <h3>Calculation Verification</h3>
      
//       <div className="mismatch-summary-content">
//         <div className="mismatch-metric">
//           <div className="mismatch-value">{mismatchSummary.totalMismatches}</div>
//           <div className="mismatch-label">{getPeriodLabel()} with Mismatches</div>
//         </div>
        
//         <div className="mismatch-metric">
//           <div 
//             className="mismatch-value" 
//             style={{ color: getDifferenceColor(mismatchSummary.totalDifference) }}
//           >
//             {getDifferenceText(mismatchSummary.totalDifference)}
//           </div>
//           <div className="mismatch-label">Total Difference</div>
//         </div>
//       </div>
      
//       <div className="mismatch-note">
//         {mismatchSummary.totalMismatches > 0 ? (
//           <span style={{ color: '#dc2626' }}>
//             Found {mismatchSummary.totalMismatches} {getPeriodLabel().toLowerCase()} with calculation discrepancies
//           </span>
//         ) : (
//           <span style={{ color: '#059669' }}>
//             All calculations match perfectly!
//           </span>
//         )}
//       </div>
//     </section>
//   );
// }

// // ==================== 6.0 MAIN REACT COMPONENT ====================

// function ShopifyAnalyticsPage() {
//   const data = useLoaderData<typeof loader>();
//   const [isLoading, setIsLoading] = useState(true);
//   const [isExporting, setIsExporting] = useState(false);
//   const [isManualRefresh, setIsManualRefresh] = useState(false);


//   const getWeekOverWeekChange = () => {
//     try {
//       const safeData = getSafeData(data);
//       if (!safeData) return 0;

//       // Get the weekly data keys and reverse to get most recent first
//       const weeklyKeys = [...safeData.weeklyKeys].reverse();
      
//       if (weeklyKeys.length < 2) {
//         console.log(' Not enough weekly data available for week-over-week calculation');
//         return 0;
//       }

//       // Current week (most recent week)
//       const currentWeekKey = weeklyKeys[0];
//       const currentWeekData = getSafeCustomerStats(safeData.weeklyTotals, currentWeekKey);
//       const currentWeekRevenue = currentWeekData.totalSales || 0;

//       // Previous week (week before current week)
//       const previousWeekKey = weeklyKeys[1];
//       const previousWeekData = getSafeCustomerStats(safeData.weeklyTotals, previousWeekKey);
//       const previousWeekRevenue = previousWeekData.totalSales || 0;

//       console.log(' Week-over-Week Calculation:');
//       console.log(`   Current Week (${currentWeekKey}): ${formatCurrency(currentWeekRevenue)}`);
//       console.log(`   Previous Week (${previousWeekKey}): ${formatCurrency(previousWeekRevenue)}`);

//       // Calculate percentage change
//       if (previousWeekRevenue > 0 && currentWeekRevenue > 0) {
//         const change = ((currentWeekRevenue - previousWeekRevenue) / previousWeekRevenue) * 100;
//         console.log(`   Change: ${change.toFixed(1)}%`);
//         return change;
//       } else if (currentWeekRevenue > 0 && previousWeekRevenue === 0) {
//         console.log(`   Change: 100% (current week has revenue, previous week has none)`);
//         return 100;
//       } else if (currentWeekRevenue === 0 && previousWeekRevenue > 0) {
//         const change = -100;
//         console.log(`   Change: ${change}% (current week has no revenue, previous week had revenue)`);
//         return change;
//       } else {
//         console.log(`   Change: 0% (both weeks have no revenue)`);
//         return 0;
//       }
//     } catch (error) {
//       console.error(' Error calculating week-over-week change:', error);
//       return 0;
//     }
//   };

//   const getDaysLeftInWeek = () => {
//     try {
//       const safeData = getSafeData(data);
//       if (!safeData) return 0;

//       const today = new Date();
//       const dayOfWeek = today.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday

//       // If it's Sunday (0), 0 days left. Otherwise, 7 - dayOfWeek
//       const daysLeftInWeek = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);

//       console.log(` Days left in current week: ${daysLeftInWeek} (today: ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]})`);
//       return daysLeftInWeek;
//     } catch (error) {
//       console.error(' Error calculating days left in week:', error);
//       return 0;
//     }
//   };

//   const handleManualRefresh = () => {
//     setIsManualRefresh(true);
//     setIsLoading(true);
//     window.location.reload();
//   }

//   useEffect(() => {
//     if (data && !("error" in data)) {
//       setIsLoading(false);
//     }
//   }, [data]);

//   if (isLoading && isManualRefresh) {
//     return (
//       <div className="orders-dashboard">
//         <div className="dashboard-header">
//           <h1>Analytics Dashboard</h1>
//         </div>
//         <div className="loading-progress-container">
//           <div className="loading-header">
//             <h2>Refreshing Your Data</h2>
//             <p>Please wait while we update your analytics...</p>
//           </div>
          
//           <div className="progress-bar-container">
//             <div className="progress-bar">
//               <div className="progress-fill"></div>
//             </div>
//           </div>

//           <div className="loading-steps">
//             {[
//               "Refreshing order data...",
//               "Updating revenue calculations...", 
//               "Processing customer insights...",
//               "Recalculating metrics...",
//               "Finalizing your dashboard..."
//             ].map((step, index) => (
//               <div key={index} className="loading-step">
//                 <div className="step-indicator"></div>
//                 <div className="step-text">{step}</div>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>
//     );
//   }

//   if (isLoading) {
//     return (
//       <div className="orders-dashboard">
//         <div className="dashboard-header">
//           <h1>Analytics Dashboard</h1>
//         </div>
//         <LoadingProgress />
//       </div>
//     );
//   }

//   const getSafeData = (data: any): CachedAnalyticsData | null => {
//     if (!data || typeof data !== 'object') return null;
    
//     const safeData: CachedAnalyticsData = {
//       shop: data.shop || 'unknown',
//       totals: data.totals || {},
//       dailyTotals: data.dailyTotals || {},
//       weeklyTotals: data.weeklyTotals || {},
//       monthlyTotals: data.monthlyTotals || {},
//       totalOrders: typeof data.totalOrders === 'number' ? data.totalOrders : 0,
//       totalCustomerData: data.totalCustomerData || { newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 },
//       monthRanges: Array.isArray(data.monthRanges) ? data.monthRanges : [],
//       dailyKeys: Array.isArray(data.dailyKeys) ? data.dailyKeys : [],
//       weeklyKeys: Array.isArray(data.weeklyKeys) ? data.weeklyKeys : [],
//       lastUpdated: data.lastUpdated || new Date().toISOString(),
//       shopTimeZone: data.shopTimeZone || 'UTC',
//       shopCurrency: data.shopCurrency || 'USD',
//       _cacheInfo: data._cacheInfo || undefined
//     };

//     return safeData;
//   };

//   const safeNumber = (value: unknown) => (typeof value === "number" ? value : 0);
  
//   const getSafeCustomerStats = (stats: Record<string, OrderStats & CustomerData>, key: string): OrderStats & CustomerData => {
//     const stat = stats[key];
//     if (!stat) {
//       return {
//         total: 0,
//         discounts: 0,
//         returns: 0,
//         netSales: 0,
//         shipping: 0,
//         taxes: 0,
//         extraFees: 0,
//         totalSales: 0,
//         shippingRefunds: 0,
//         netReturns: 0,
//         totalRefund: 0,
//         items: 0,
//         fulfilled: 0,
//         unfulfilled: 0,
//         orderCount: 0,
//         hasSubsequentEvents: false,
//         eventSummary: null,
//         refundsCount: 0,
//         financialStatus: 'pending',
//         newCustomers: 0,
//         repeatedCustomers: 0,
//         totalCustomers: 0,
//         discountsReturned: 0,
//         netDiscounts: 0,
//         returnShippingCharges: 0,
//         restockingFees: 0,
//         returnFees: 0,
//         refundDiscrepancy: 0
//       };
//     }
//     return stat;
//   };

//   const getCalculationMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.dailyTotals).forEach(dayData => {
//       const calculatedTotal = dayData.netSales + dayData.shipping + dayData.taxes + dayData.extraFees;
//       const mismatch = Math.abs(dayData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         const difference = calculatedTotal - dayData.totalSales;
//         totalDifference += difference;
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getTodayMismatchSummary = (data: AnalyticsData) => {
//     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: data.shopTimeZone });
//     const todayData = getSafeCustomerStats(data.dailyTotals, todayKey);
    
//     const calculatedTotal = todayData.netSales + todayData.shipping + todayData.taxes + todayData.extraFees;
//     const mismatch = Math.abs(todayData.totalSales - calculatedTotal) > 0.01;
    
//     return {
//       totalMismatches: mismatch ? 1 : 0,
//       totalDifference: mismatch ? (calculatedTotal - todayData.totalSales) : 0,
//       hasMismatches: mismatch
//     };
//   };

//   const getWeeklyMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.weeklyTotals).forEach(weekData => {
//       const calculatedTotal = weekData.netSales + weekData.shipping + weekData.taxes + weekData.extraFees;
//       const mismatch = Math.abs(weekData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         totalDifference += (calculatedTotal - weekData.totalSales);
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getMonthlyMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.monthlyTotals).forEach(monthData => {
//       const calculatedTotal = monthData.netSales + monthData.shipping + monthData.taxes + monthData.extraFees;
//       const mismatch = Math.abs(monthData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         totalDifference += (calculatedTotal - monthData.totalSales);
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getTodayData = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;
    
//     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: safeData.shopTimeZone });
//     const todayData = getSafeCustomerStats(safeData.dailyTotals, todayKey);
    
//     return {
//       ...todayData,
//       ordersWithSubsequentEvents: todayData.hasSubsequentEvents ? 1 : 0,
//       subsequentEventsCount: todayData.eventSummary?.totalEvents || 0,
//       subsequentEventsValue: todayData.eventSummary ? Math.abs(todayData.eventSummary.netValue) : 0
//     };
//   };

//   const getLast7DaysData = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalNewCustomers = 0;
//     let totalRepeatCustomers = 0;
//     let totalFulfilled = 0;
//     let totalUnfulfilled = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;


//     const getWeekOverWeekChange = () => {
//   try {
//     const safeData = getSafeData(data);
//     if (!safeData) return 0;

//     // Get the weekly data keys and reverse to get most recent first
//     const weeklyKeys = [...safeData.weeklyKeys].reverse();
    
//     if (weeklyKeys.length < 2) {
//       console.log(' Not enough weekly data available for week-over-week calculation');
//       return 0;
//     }

//     // Current week (most recent week)
//     const currentWeekKey = weeklyKeys[0];
//     const currentWeekData = getSafeCustomerStats(safeData.weeklyTotals, currentWeekKey);
//     const currentWeekRevenue = currentWeekData.totalSales || 0;

//     // Previous week (week before current week)
//     const previousWeekKey = weeklyKeys[1];
//     const previousWeekData = getSafeCustomerStats(safeData.weeklyTotals, previousWeekKey);
//     const previousWeekRevenue = previousWeekData.totalSales || 0;

//     console.log(' Week-over-Week Calculation:');
//     console.log(`   Current Week (${currentWeekKey}): ${formatCurrency(currentWeekRevenue)}`);
//     console.log(`   Previous Week (${previousWeekKey}): ${formatCurrency(previousWeekRevenue)}`);

//     // Calculate percentage change
//     if (previousWeekRevenue > 0 && currentWeekRevenue > 0) {
//       const change = ((currentWeekRevenue - previousWeekRevenue) / previousWeekRevenue) * 100;
//       console.log(`   Change: ${change.toFixed(1)}%`);
//       return change;
//     } else if (currentWeekRevenue > 0 && previousWeekRevenue === 0) {
//       console.log(`   Change: 100% (current week has revenue, previous week has none)`);
//       return 100;
//     } else if (currentWeekRevenue === 0 && previousWeekRevenue > 0) {
//       const change = -100;
//       console.log(`   Change: ${change}% (current week has no revenue, previous week had revenue)`);
//       return change;
//     } else {
//       console.log(`   Change: 0% (both weeks have no revenue)`);
//       return 0;
//     }
//   } catch (error) {
//     console.error(' Error calculating week-over-week change:', error);
//     return 0;
//   }
// };

// const getDaysLeftInWeek = () => {
//   try {
//     const safeData = getSafeData(data);
//     if (!safeData) return 0;

//     const today = new Date();
//     const dayOfWeek = today.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday

//     // If it's Sunday (0), 0 days left. Otherwise, 7 - dayOfWeek
//     const daysLeftInWeek = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);

//     console.log(` Days left in current week: ${daysLeftInWeek} (today: ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]})`);
//     return daysLeftInWeek;
//   } catch (error) {
//     console.error(' Error calculating days left in week:', error);
//     return 0;
//   }
// };


//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.dailyKeys.forEach(day => {
//       const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//       totalRevenue += dayData.total;
//       totalOrders += dayData.orderCount;
//       totalItems += dayData.items;
//       totalNewCustomers += dayData.newCustomers;
//       totalRepeatCustomers += dayData.repeatedCustomers;
//       totalFulfilled += dayData.fulfilled;
//       totalUnfulfilled += dayData.unfulfilled;
//       totalDiscounts += dayData.discounts;
//       totalReturns += dayData.returns;
//       totalNetSales += dayData.netSales;
//       totalShipping += dayData.shipping;
//       totalTaxes += dayData.taxes;
//       totalExtraFees += dayData.extraFees;
//       totalTotalSales += dayData.totalSales;
//       totalShippingRefunds += dayData.shippingRefunds;
//       totalNetReturns += dayData.netReturns;
//       totalTotalRefund += dayData.totalRefund;
      
//       if (dayData.eventSummary) {
//         ordersWithEventsCount += dayData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += dayData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += dayData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += dayData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += dayData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += dayData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += dayData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += dayData.eventSummary.totalEvents;
//         periodEventSummary.netValue += dayData.eventSummary.netValue;

//         totalEventsValue += Math.abs(dayData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalNewCustomers,
//       totalRepeatCustomers,
//       totalFulfilled,
//       totalUnfulfilled,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       avgDailyRevenue: totalRevenue / 7,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const getWeeklyFinancials = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;

//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.weeklyKeys.forEach(week => {
//       const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//       totalRevenue += weekData.total;
//       totalOrders += weekData.orderCount;
//       totalItems += weekData.items;
//       totalDiscounts += weekData.discounts;
//       totalReturns += weekData.returns;
//       totalNetSales += weekData.netSales;
//       totalShipping += weekData.shipping;
//       totalTaxes += weekData.taxes;
//       totalExtraFees += weekData.extraFees;
//       totalTotalSales += weekData.totalSales;
//       totalShippingRefunds += weekData.shippingRefunds;
//       totalNetReturns += weekData.netReturns;
//       totalTotalRefund += weekData.totalRefund;
      
//       if (weekData.eventSummary) {
//         ordersWithEventsCount += weekData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += weekData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += weekData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += weekData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += weekData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += weekData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += weekData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += weekData.eventSummary.totalEvents;
//         periodEventSummary.netValue += weekData.eventSummary.netValue;

//         totalEventsValue += Math.abs(weekData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       netRevenue: totalTotalSales,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const getMonthlyFinancials = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;

//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.monthRanges.forEach(month => {
//       const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//       totalRevenue += monthData.total;
//       totalOrders += monthData.orderCount;
//       totalItems += monthData.items;
//       totalDiscounts += monthData.discounts;
//       totalReturns += monthData.returns;
//       totalNetSales += monthData.netSales;
//       totalShipping += monthData.shipping;
//       totalTaxes += monthData.taxes;
//       totalExtraFees += monthData.extraFees;
//       totalTotalSales += monthData.totalSales;
//       totalShippingRefunds += monthData.shippingRefunds;
//       totalNetReturns += monthData.netReturns;
//       totalTotalRefund += monthData.totalRefund;
      
//       if (monthData.eventSummary) {
//         ordersWithEventsCount += monthData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += monthData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += monthData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += monthData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += monthData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += monthData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += monthData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += monthData.eventSummary.totalEvents;
//         periodEventSummary.netValue += monthData.eventSummary.netValue;

//         totalEventsValue += Math.abs(monthData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       netRevenue: totalTotalSales,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const formatNumber = (num: number) => num.toLocaleString('en-US');
//   const formatPercent = (num: number) => `${num.toFixed(1)}%`;
//   const formatCurrency = (amount: number) => {
//     const currency = safeData?.shopCurrency || 'USD';
//     return amount.toLocaleString('en-US', { 
//       style: 'currency', 
//       currency: currency,
//       minimumFractionDigits: 2 
//     });
//   };

//   const exportToPDF = () => {
//     setIsExporting(true);
    
//     const safeData = getSafeData(data);
//     const todayData = getTodayData();
//     const last7DaysData = getLast7DaysData();
//     const weeklyFinancials = getWeeklyFinancials();
//     const monthlyFinancials = getMonthlyFinancials();
    
//     if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
//       setIsExporting(false);
//       return;
//     }

//     const eventData = monthlyFinancials.eventSummary || weeklyFinancials.eventSummary || last7DaysData.eventSummary;
    
//     const totalEvents = eventData ? 
//       (eventData.refunds.count + eventData.exchanges.count + eventData.partialRefunds.count) : 0;
    
//     const ordersWithEvents = monthlyFinancials.ordersWithSubsequentEvents || 
//                             weeklyFinancials.ordersWithSubsequentEvents || 
//                             last7DaysData.ordersWithSubsequentEvents || 0;

//     const pdfData: OrderData = {
//       totalOrders: safeData.totalOrders,
//       totalCustomers: safeData.totalCustomerData.totalCustomers,
//       fulfillmentRate: safeData.totalOrders > 0 ? 
//         ((last7DaysData.totalFulfilled / last7DaysData.totalOrders) * 100) : 0,
//       totalRevenue: monthlyFinancials.totalRevenue,
//       netRevenue: monthlyFinancials.netRevenue,
//       averageOrderValue: safeData.totalOrders > 0 ? 
//         (monthlyFinancials.totalRevenue / safeData.totalOrders) : 0,
//       totalItems: monthlyFinancials.totalItems,
//       todayOrders: todayData.orderCount,
//       todayRevenue: todayData.total,
//       todayItems: todayData.items,
//       ordersChangeVsYesterday: 100.0,
//       revenueChangeVsYesterday: 100.0,
//       itemsChangeVsYesterday: 100.0,
//       newCustomers: safeData.totalCustomerData.newCustomers,
//       repeatCustomers: safeData.totalCustomerData.repeatedCustomers,
//       customerRetentionRate: safeData.totalCustomerData.totalCustomers > 0 ? 
//         ((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100) : 0,
//       averageOrderFrequency: 1.0,
//       shopTimezone: safeData.shopTimeZone,
//       shopCurrency: safeData.shopCurrency,
//       totalRefunds: eventData?.refunds.count || 0,
//       totalExchanges: eventData?.exchanges.count || 0,
//       totalPartialRefunds: eventData?.partialRefunds.count || 0,
//       totalEvents: totalEvents,
//       ordersWithEvents: ordersWithEvents,
//       netEventValue: eventData?.netValue || 0
//     };

//     generatePDFReport(pdfData);
//     setIsExporting(false);
//   };

//   if ("error" in data) {
//     return (
//       <div className="orders-dashboard">
//         <div style={{ padding: "40px", textAlign: "center", background: "#fff5f5", borderRadius: "8px" }}>
//           <h1>We're Sorry</h1>
//           <p>{data.userMessage}</p>
//           <button className="print-button" onClick={handleManualRefresh}>
//             Refresh Page
//           </button>
//         </div>
//       </div>
//     );
//   }

//   const safeData = getSafeData(data);
//   const todayData = getTodayData();
//   const last7DaysData = getLast7DaysData();
//   const weeklyFinancials = getWeeklyFinancials();
//   const monthlyFinancials = getMonthlyFinancials();

//   if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
//     return (
//       <div className="orders-dashboard">
//         <div style={{ padding: "20px", color: "red", textAlign: "center" }}>
//           <h1>Data Validation Failed</h1>
//           <p>Please refresh the page.</p>
//         </div>
//       </div>
//     );
//   }

//   const formatDateDisplay = (dateStr: string) => {
//     const date = new Date(dateStr + 'T00:00:00');
//     return date.toLocaleDateString('en-US', { 
//       month: 'short', 
//       day: 'numeric',
//       timeZone: safeData.shopTimeZone 
//     });
//   };

//   const getDayName = (dateStr: string) => {
//     const date = new Date(dateStr + 'T00:00:00');
//     return date.toLocaleDateString('en-US', { 
//       weekday: 'short',
//       timeZone: safeData.shopTimeZone 
//     });
//   };

//   return (
//     <div className="orders-dashboard">
//       <div className="dashboard-header">
//         <h1>Orders Dashboard</h1>
//         <div className="header-controls">
//           <button 
//             className="export-button"
//             onClick={exportToPDF}
//             disabled={isExporting}
//             title="Export summary PDF report with key metrics"
//           >
//             <Icon.Export />
//             {isExporting ? 'Generating PDF...' : 'Export Summary'}
//           </button>
//         </div>
//       </div>

//       <div id="dashboard-content">
//         {/* Today's Performance Section */}
//         <section className="today-performance">
//           <h2>Today's Performance</h2>
//           <MismatchSummaryCard 
//             mismatchSummary={getTodayMismatchSummary(safeData)} 
//             periodType="day" 
//           />
          
//           <div className="primary-metrics-grid">
//             <div className="metric-card orders">
//               <div className="metric-value">{safeNumber(todayData.orderCount)}</div>
//               <div className="metric-label">Today's Orders</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
            
//             <div className="metric-card revenue">
//               <div className="metric-value">{formatCurrency(safeNumber(todayData.totalSales))}</div>
//               <div className="metric-label">Today's Total Sales</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
            
//             <div className="metric-card items">
//               <div className="metric-value">{safeNumber(todayData.items)}</div>
//               <div className="metric-label">Items Ordered</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
//           </div>

//           <div className="fulfillment-metrics-grid">
//             <div className="fulfillment-metric-card today-fulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(todayData.fulfilled)}</div>
//               <div className="fulfillment-metric-label">FULFILLED TODAY</div>
//               <div className="fulfillment-metric-period">Today</div>
//             </div>
            
//             <div className="fulfillment-metric-card today-unfulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(todayData.unfulfilled)}</div>
//               <div className="fulfillment-metric-label">UNFULFILLED TODAY</div>
//               <div className="fulfillment-metric-period">Today</div>
//             </div>
            
//             <div className="fulfillment-metric-card week-fulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalFulfilled)}</div>
//               <div className="fulfillment-metric-label">FULFILLED</div>
//               <div className="fulfillment-metric-period">Last 7 Days</div>
//             </div>
            
//             <div className="fulfillment-metric-card week-unfulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalUnfulfilled)}</div>
//               <div className="fulfillment-metric-label">UNFULFILLED</div>
//               <div className="fulfillment-metric-period">Last 7 Days</div>
//             </div>
//           </div>

//           {todayData?.eventSummary && todayData.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={todayData.eventSummary} 
//               title="Today's Order Activity & Adjustments"
//             />
//           )}
//         </section>

//         {/* Last 7 Days Performance Section */}
//         <section className="last7days-section">
//           <h3>Last 7 Days Performance</h3>
          
//           <div className="last7days-grid">
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{safeNumber(last7DaysData.totalOrders)}</div>
//               <div className="last7days-total-label">TOTAL ORDERS</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales))}</div>
//               <div className="last7days-total-label">TOTAL SALES</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{safeNumber(last7DaysData.totalItems)}</div>
//               <div className="last7days-total-label">TOTAL ITEMS</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales / 7))}</div>
//               <div className="last7days-total-label">AVG DAILY SALES</div>
//             </div>
//           </div>

//           {/* Daily Breakdown Table */}
//           <div className="daily-breakdown">
//             <h4>Daily Breakdown</h4>
//             <div className="daily-cards-container">
//               {safeData.dailyKeys.map((day, index) => {
//                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//                 const isToday = index === safeData.dailyKeys.length - 1;
                
//                 return (
//                   <div key={day} className={`daily-card ${isToday ? 'current-day' : ''}`}>
//                     <div className="daily-card-header">
//                       <div className="daily-date">{formatDateDisplay(day)}</div>
//                       <div className="daily-day">{getDayName(day)}</div>
//                     </div>
                    
//                     <div className="daily-metrics">
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">ORDERS</span>
//                         <span className="daily-metric-value">{safeNumber(dayData.orderCount)}</span>
//                       </div>
                      
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">TOTAL SALES</span>
//                         <span className="daily-metric-value">{formatCurrency(safeNumber(dayData.totalSales))}</span>
//                       </div>
                      
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">ITEMS</span>
//                         <span className="daily-metric-value">{safeNumber(dayData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {last7DaysData?.eventSummary && last7DaysData.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={last7DaysData.eventSummary} 
//               title="Last 7 Days: Refunds, Exchanges & Adjustments"
//             />
//           )}
//         </section>

//         {/* Week-over-Week Insight */}
//         {/* Week-over-Week Insight */}
// {/* Week-over-Week Insight */}
// <div className="secondary-metrics">
//   <div className={`insight-card ${getWeekOverWeekChange() >= 0 ? 'positive' : 'negative'}`}>
//     <h4>Week-over-Week Revenue</h4>
//     <div className="insight-value">
//       {getWeekOverWeekChange() >= 0 ? <Icon.TrendUp /> : <Icon.TrendDown />}
//       {Math.abs(getWeekOverWeekChange()).toFixed(1)}%
//     </div>
//     <div className="insight-label">
//       {getWeekOverWeekChange() >= 0 ? 'Increase' : 'Decrease'} from last week
//     </div>
//     {getDaysLeftInWeek() > 0 && (
//       <div className="insight-note">
//         {getDaysLeftInWeek()} days left in current week
//       </div>
//     )}
//   </div>
// </div>

//         {/* Customer Insights Section */}
//         <section className="customer-metrics">
//           <h3>Customer Insights</h3>
          
//           <div className="customer-metrics-grid">
//             <div className="customer-metric-card total-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.totalCustomers)}</div>
//               <div className="customer-metric-label">TOTAL CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card new-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.newCustomers)}</div>
//               <div className="customer-metric-label">NEW CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card repeat-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.repeatedCustomers)}</div>
//               <div className="customer-metric-label">REPEAT CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card loyalty-rate">
//               <div className="customer-metric-value">
//                 {safeData.totalCustomerData.totalCustomers > 0 
//                   ? formatPercent((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100)
//                   : '0.0%'
//                 }
//               </div>
//               <div className="customer-metric-label">REPEAT CUSTOMER RATE</div>
//             </div>
//           </div>
//         </section>

//         {/* Last 7 Days Customer Insights */}
//         <section className="customer-metrics">
//           <h3>Last 7 Days Customer Insights</h3>
          
//           <div className="customer-metrics-grid">
//             <div className="customer-metric-card total-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)}</div>
//               <div className="customer-metric-label">7-DAY TOTAL CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card new-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers)}</div>
//               <div className="customer-metric-label">7-DAY NEW CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card repeat-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalRepeatCustomers)}</div>
//               <div className="customer-metric-label">7-DAY REPEAT CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card loyalty-rate">
//               <div className="customer-metric-value">
//                 {(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers) > 0
//                   ? formatPercent((last7DaysData.totalRepeatCustomers / (last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)) * 100)
//                   : '0.0%'
//                 }
//               </div>
//               <div className="customer-metric-label">7-DAY REPEAT RATE</div>
//             </div>
//           </div>
//         </section>

//         {/* Last 7 Days Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Last 7 Days Financial Breakdown</h3>

//           <MismatchSummaryCard 
//             mismatchSummary={getCalculationMismatchSummary(safeData)} 
//             periodType="day"
//           />

//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">7 Days</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalDiscounts / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalReturns / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalExtraFees / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalShipping / last7DaysData.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalTaxes / last7DaysData.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Daily Financial Details */}
//           <div className="daily-financial-breakdown">
//             <h4>Daily Financial Details</h4>
//             <div className="daily-financial-cards">
//               {safeData.dailyKeys.map((day, index) => {
//                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//                 const isToday = index === safeData.dailyKeys.length - 1;
                
//                 return (
//                   <div key={day} className={`daily-financial-card ${isToday ? 'current-day' : ''}`}>
//                     <div className="daily-financial-header">
//                       <div className="daily-financial-date">{formatDateDisplay(day)}</div>
//                       <div className="daily-financial-day">{getDayName(day)}</div>
//                     </div>
                    
//                     <div className="daily-financial-metrics">
//                       <div className="daily-financial-metric gross-revenue">
//                         <span className="daily-financial-label">Gross Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.total)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric discounts">
//                         <span className="daily-financial-label">Discounts</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.discounts)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric returns">
//                         <span className="daily-financial-label">Returns</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.returns)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric net-sales">
//                         <span className="daily-financial-label">Net Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.netSales)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric shipping">
//                         <span className="daily-financial-label">Shipping Charges</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.shipping)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric return-fees">
//                         <span className="daily-financial-label">Return Fees</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.extraFees)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric taxes">
//                         <span className="daily-financial-label">Taxes</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.taxes)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric total-sales">
//                         <span className="daily-financial-label">Total Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Weekly Performance */}
//         <section className="weekly-performance">
//           <h3>Weekly Performance (Last 8 Weeks)</h3>
//           <MismatchSummaryCard 
//             mismatchSummary={getWeeklyMismatchSummary(safeData)} 
//             periodType="week"
//           />
//           <div className="weekly-grid">
//             <div className="weekly-card">
//               <div className="weekly-value">{safeNumber(weeklyFinancials.totalOrders)}</div>
//               <div className="weekly-label">Total Orders</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
//               <div className="weekly-label">Total Revenue</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{safeNumber(weeklyFinancials.totalItems)}</div>
//               <div className="weekly-label">Total Items</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue / safeData.weeklyKeys.length)}</div>
//               <div className="weekly-label">Avg Weekly Revenue</div>
//             </div>
//           </div>

//           {/* Weekly Breakdown */}
//           <div className="weekly-breakdown">
//             <h4>Weekly Breakdown</h4>
//             <div className="weekly-cards-container">
//               {safeData.weeklyKeys.map((week, index) => {
//                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
//                 return (
//                   <div key={week} className={`week-card ${isCurrentWeek ? 'current-week' : ''}`}>
//                     <div className="week-header">
//                       <div className="week-label">{week.replace('Week of ', '')}</div>
//                     </div>
                    
//                     <div className="week-metrics">
//                       <div className="week-metric orders">
//                         <span className="week-metric-label">Orders</span>
//                         <span className="week-metric-value">{safeNumber(weekData.orderCount)}</span>
//                       </div>
                      
//                       <div className="week-metric revenue">
//                         <span className="week-metric-label">Total Sales</span>
//                         <span className="week-metric-value">{formatCurrency(weekData.totalSales)}</span>
//                       </div>
                      
//                       <div className="week-metric items">
//                         <span className="week-metric-label">Items</span>
//                         <span className="week-metric-value">{safeNumber(weekData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {weeklyFinancials?.eventSummary && weeklyFinancials.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={weeklyFinancials.eventSummary} 
//               title="8-Week Period: Order Events & Financial Adjustments"
//             />
//           )}
//         </section>

//         {/* Weekly Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Weekly Financial Breakdown (Last 8 Weeks)</h3>
//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">8 Weeks</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalDiscounts / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalReturns / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalExtraFees / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalShipping / weeklyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalTaxes / weeklyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Weekly Financial Details */}
//           <div className="weekly-financial-breakdown">
//             <h4>Weekly Financial Details</h4>
//             <div className="weekly-financial-cards">
//               {safeData.weeklyKeys.map((week, index) => {
//                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
//                 return (
//                   <div key={week} className={`weekly-financial-card ${isCurrentWeek ? 'current-week' : ''}`}>
//                     <div className="weekly-financial-header">
//                       <div className="weekly-financial-label">{week.replace('Week of ', '')}</div>
//                     </div>
                    
//                     <div className="weekly-financial-metrics">
//                       <div className="weekly-financial-metric gross-revenue">
//                         <span className="weekly-financial-label">Gross Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.total)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric discounts">
//                         <span className="weekly-financial-label">Discounts</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.discounts)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric returns">
//                         <span className="weekly-financial-label">Returns</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.returns)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric net-sales">
//                         <span className="weekly-financial-label">Net Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.netSales)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric shipping">
//                         <span className="weekly-financial-label">Shipping Charges</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.shipping)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric return-fees">
//                         <span className="weekly-financial-label">Return Fees</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.extraFees)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric taxes">
//                         <span className="weekly-financial-label">Taxes</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.taxes)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric total-sales">
//                         <span className="weekly-financial-label">Total Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Monthly Performance */}
//         <section className="monthly-performance">
//           <h3>Monthly Performance (Last 6 Months)</h3>
//           <MismatchSummaryCard 
//             mismatchSummary={getMonthlyMismatchSummary(safeData)} 
//             periodType="month"
//           />
//           <div className="monthly-grid">
//             <div className="monthly-card">
//               <div className="monthly-value">{safeNumber(monthlyFinancials.totalOrders)}</div>
//               <div className="monthly-label">Total Orders</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
//               <div className="monthly-label">Total Revenue</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{safeNumber(monthlyFinancials.totalItems)}</div>
//               <div className="monthly-label">Total Items</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue / safeData.monthRanges.length)}</div>
//               <div className="monthly-label">Avg Monthly Revenue</div>
//             </div>
//           </div>

//           {/* Monthly Breakdown */}
//           <div className="monthly-breakdown">
//             <h4>Monthly Breakdown</h4>
//             <div className="monthly-cards-container">
//               {safeData.monthRanges.map((month, index) => {
//                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
//                 const isCurrentMonth = month === currentMonth;
                
//                 const avgRevenue = safeData.monthRanges.reduce((sum, m) => {
//                   const mData = getSafeCustomerStats(safeData.monthlyTotals, m);
//                   return sum + mData.total;
//                 }, 0) / safeData.monthRanges.length;
//                 const performanceLevel = monthData.total > avgRevenue * 1.2 ? 'high' : 
//                                        monthData.total > avgRevenue * 0.8 ? 'medium' : 'low';
                
//                 return (
//                   <div key={month} className={`month-card ${isCurrentMonth ? 'current-month' : ''}`}>
//                     {isCurrentMonth && <div className="current-badge">Current</div>}
//                     <div className="month-header">
//                       <div className="month-label">{month.split(' ')[0]}</div>
//                       <div className="month-period">{month.split(' ')[1]}</div>
//                     </div>
                    
//                     <div className="month-metrics">
//                       <div className="month-metric orders">
//                         <span className="month-metric-label">Orders</span>
//                         <span className="month-metric-value">{safeNumber(monthData.orderCount)}</span>
//                       </div>
                      
//                       <div className="month-metric revenue">
//                         <span className="month-metric-label">Total Sales</span>
//                         <span className="month-metric-value">{formatCurrency(monthData.totalSales)}</span>
//                       </div>
                      
//                       <div className="month-metric items">
//                         <span className="month-metric-label">Items</span>
//                         <span className="month-metric-value">{safeNumber(monthData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {monthlyFinancials?.eventSummary && monthlyFinancials.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={monthlyFinancials.eventSummary} 
//               title="6-Month Overview: All Order Events & Adjustments"
//             />
//           )}
//         </section>

//         {/* Monthly Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Monthly Financial Breakdown (Last 6 Months)</h3>
//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">6 Months</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalDiscounts / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalReturns / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalExtraFees / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalShipping / monthlyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalTaxes / monthlyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Monthly Financial Details */}
//           <div className="monthly-financial-breakdown">
//             <h4>Monthly Financial Details</h4>
//             <div className="monthly-financial-cards">
//               {safeData.monthRanges.map((month, index) => {
//                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
//                 const isCurrentMonth = month === currentMonth;
                
//                 return (
//                   <div key={month} className={`monthly-financial-card ${isCurrentMonth ? 'current-month' : ''}`}>
//                     {isCurrentMonth && <div className="current-badge">Current</div>}
//                     <div className="monthly-financial-header">
//                       <div className="monthly-financial-label">{month.split(' ')[0]}</div>
//                       <div className="monthly-financial-period">{month.split(' ')[1]}</div>
//                     </div>
                    
//                     <div className="monthly-financial-metrics">
//                       <div className="monthly-financial-metric gross-revenue">
//                         <span className="monthly-financial-label">Gross Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.total)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric discounts">
//                         <span className="monthly-financial-label">Discounts</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.discounts)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric returns">
//                         <span className="monthly-financial-label">Returns</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.returns)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric net-sales">
//                         <span className="monthly-financial-label">Net Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.netSales)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric shipping">
//                         <span className="monthly-financial-label">Shipping Charges</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.shipping)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric return-fees">
//                         <span className="monthly-financial-label">Return Fees</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.extraFees)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric taxes">
//                         <span className="monthly-financial-label">Taxes</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.taxes)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric total-sales">
//                         <span className="monthly-financial-label">Total Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Charts & Analytics Section */}
//         <section className="charts-section">
//           <h2>Analytics & Insights Visualization</h2>
          
//           <div className="charts-grid">
//             <ChartComponents.CustomerDistribution data={safeData} />
//             <ChartComponents.RevenueTrend data={safeData} />
//             <ChartComponents.MonthlyPerformance data={safeData} />
//             <ChartComponents.FinancialBreakdown data={safeData} />
//           </div>
//         </section>

//         {/* Footer */}
//         <footer className="app-footer">
//           <div className="footer-content">
//             <p>
//               <strong>Orders Analyzed:</strong> {safeData.totalOrders} orders  
//               <strong> Net Revenue:</strong> {formatCurrency(monthlyFinancials.netRevenue)}  
//               <strong> Data Updated:</strong> {new Date(safeData.lastUpdated).toLocaleDateString()}
//             </p>
//             <p className="footer-brand">Analytics Dashboard - Nexus Powering Your Business Insights</p>
//           </div>
//         </footer>
//       </div>
//     </div>
//   );
// }

// // ==================== 7.0 LOADER FUNCTION ====================

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   return analyticsLoader({ request });
// };

// // ==================== 8.0 EXPORT COMPONENT ====================

// export default function AnalyticsApp() {
//   return <ShopifyAnalyticsPage />;
// }







// //=========================================================================================10/27/2025==========================================================================//





// // // app/routes/analytics.tsx
// // import { json, LoaderFunctionArgs } from "@remix-run/node";
// // import { useLoaderData } from "@remix-run/react";
// // import { authenticate } from "../shopify.server";

// // interface Order {
// //   id: string;
// //   name: string;
// //   createdAt: string;
// //   displayFinancialStatus: string;
// //   totalPriceSet: {
// //     shopMoney: {
// //       amount: string;
// //       currencyCode: string;
// //     };
// //   };
// //   subtotalPriceSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   totalShippingPriceSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   totalTaxSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   totalDiscountsSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   totalRefundedSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   totalRefundedShippingSet: {
// //     shopMoney: {
// //       amount: string;
// //     };
// //   };
// //   refunds: Array<{
// //     id: string;
// //     totalRefundedSet: {
// //       shopMoney: {
// //         amount: string;
// //       };
// //     };
// //   }>;
// // }

// // interface PeriodSummary {
// //   period: string;
// //   grossSales: number;
// //   discounts: number;
// //   returns: number;
// //   netSales: number;
// //   shipping: number;
// //   returnFees: number;
// //   taxes: number;
// //   totalSales: number;
// //   ordersCount: number;
// // }

// // interface LoaderData {
// //   todaySummary: PeriodSummary;
// //   last7DaysSummary: PeriodSummary;
// //   dailySummaries: PeriodSummary[];
// //   recentOrders: Order[];
// //   storeTimeZone: string;
// //   errors?: string[];
// // }

// // const ORDERS_QUERY = `
// //   query OrdersAnalytics($first: Int!, $query: String) {
// //     orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true) {
// //       nodes {
// //         id
// //         name
// //         createdAt
// //         displayFinancialStatus
// //         totalPriceSet {
// //           shopMoney {
// //             amount
// //             currencyCode
// //           }
// //         }
// //         subtotalPriceSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         totalShippingPriceSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         totalTaxSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         totalDiscountsSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         totalRefundedSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         totalRefundedShippingSet {
// //           shopMoney {
// //             amount
// //           }
// //         }
// //         refunds {
// //           id
// //           totalRefundedSet {
// //             shopMoney {
// //               amount
// //             }
// //           }
// //         }
// //       }
// //     }
// //   }
// // `;

// // // Get store timezone - you might need to fetch this from shop meta or use a default
// // const STORE_TIMEZONE = 'America/New_York'; // Change this to your store's timezone

// // function getStoreLocalDate(): Date {
// //   return new Date(new Date().toLocaleString("en-US", { timeZone: STORE_TIMEZONE }));
// // }

// // function getDateRanges() {
// //   const storeNow = getStoreLocalDate();
  
// //   // Today in store timezone
// //   const todayStart = new Date(storeNow.getFullYear(), storeNow.getMonth(), storeNow.getDate());
// //   const todayEnd = new Date(todayStart);
// //   todayEnd.setDate(todayStart.getDate() + 1);

// //   // Last 7 days in store timezone
// //   const sevenDaysAgo = new Date(storeNow);
// //   sevenDaysAgo.setDate(storeNow.getDate() - 7);
// //   const sevenDaysAgoStart = new Date(sevenDaysAgo.getFullYear(), sevenDaysAgo.getMonth(), sevenDaysAgo.getDate());

// //   return {
// //     today: { start: todayStart, end: todayEnd },
// //     last7Days: { start: sevenDaysAgoStart, end: todayEnd }
// //   };
// // }

// // function convertToStoreTime(utcDate: string): Date {
// //   const date = new Date(utcDate);
// //   return new Date(date.toLocaleString("en-US", { timeZone: STORE_TIMEZONE }));
// // }

// // function calculatePeriodSummary(orders: Order[], startDate: Date, endDate: Date, periodLabel: string): PeriodSummary {
// //   const filteredOrders = orders.filter(order => {
// //     const orderDate = convertToStoreTime(order.createdAt);
// //     return orderDate >= startDate && orderDate < endDate;
// //   });

// //   const summary = filteredOrders.reduce((acc, order) => {
// //     const grossSales = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || '0');
// //     const discounts = Math.abs(parseFloat(order.totalDiscountsSet?.shopMoney?.amount || '0'));
// //     const shipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || '0');
// //     const taxes = parseFloat(order.totalTaxSet?.shopMoney?.amount || '0');
// //     const totalSales = parseFloat(order.totalPriceSet?.shopMoney?.amount || '0');
// //     const returns = parseFloat(order.totalRefundedSet?.shopMoney?.amount || '0');
// //     const returnFees = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || '0');
// //     const netSales = grossSales - discounts - returns;

// //     return {
// //       grossSales: acc.grossSales + grossSales,
// //       discounts: acc.discounts + discounts,
// //       returns: acc.returns + returns,
// //       netSales: acc.netSales + netSales,
// //       shipping: acc.shipping + shipping,
// //       returnFees: acc.returnFees + returnFees,
// //       taxes: acc.taxes + taxes,
// //       totalSales: acc.totalSales + totalSales,
// //       ordersCount: acc.ordersCount + 1
// //     };
// //   }, {
// //     grossSales: 0, discounts: 0, returns: 0, netSales: 0,
// //     shipping: 0, returnFees: 0, taxes: 0, totalSales: 0, ordersCount: 0
// //   });

// //   return {
// //     period: periodLabel,
// //     ...summary
// //   };
// // }

// // function calculateDailySummaries(orders: Order[]): PeriodSummary[] {
// //   const dailyMap = new Map<string, PeriodSummary>();
  
// //   orders.forEach(order => {
// //     const orderDate = convertToStoreTime(order.createdAt);
// //     const dateKey = orderDate.toISOString().split('T')[0];
// //     const periodLabel = orderDate.toLocaleDateString("en-US", { 
// //       timeZone: STORE_TIMEZONE,
// //       month: 'short',
// //       day: 'numeric'
// //     });
    
// //     const grossSales = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || '0');
// //     const discounts = Math.abs(parseFloat(order.totalDiscountsSet?.shopMoney?.amount || '0'));
// //     const shipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || '0');
// //     const taxes = parseFloat(order.totalTaxSet?.shopMoney?.amount || '0');
// //     const totalSales = parseFloat(order.totalPriceSet?.shopMoney?.amount || '0');
// //     const returns = parseFloat(order.totalRefundedSet?.shopMoney?.amount || '0');
// //     const returnFees = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || '0');
// //     const netSales = grossSales - discounts - returns;

// //     const existing = dailyMap.get(dateKey);
    
// //     if (existing) {
// //       existing.grossSales += grossSales;
// //       existing.discounts += discounts;
// //       existing.returns += returns;
// //       existing.netSales += netSales;
// //       existing.shipping += shipping;
// //       existing.returnFees += returnFees;
// //       existing.taxes += taxes;
// //       existing.totalSales += totalSales;
// //       existing.ordersCount += 1;
// //     } else {
// //       dailyMap.set(dateKey, {
// //         period: periodLabel,
// //         grossSales,
// //         discounts,
// //         returns,
// //         netSales,
// //         shipping,
// //         returnFees,
// //         taxes,
// //         totalSales,
// //         ordersCount: 1
// //       });
// //     }
// //   });

// //   return Array.from(dailyMap.values())
// //     .sort((a, b) => new Date(a.period).getTime() - new Date(b.period).getTime())
// //     .slice(-7); // Last 7 days only
// // }

// // export async function loader({ request }: LoaderFunctionArgs) {
// //   const { admin } = await authenticate.admin(request);

// //   try {
// //     console.log('Starting analytics loader...');

// //     const dateRanges = getDateRanges();
// //     const thirtyDaysAgo = getStoreLocalDate();
// //     thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
// //     // Convert store local date to UTC for Shopify query
// //     const queryStartDate = new Date(thirtyDaysAgo.getTime() - (thirtyDaysAgo.getTimezoneOffset() * 60000));
// //     const query = `created_at:>=${queryStartDate.toISOString().split('T')[0]}`;

// //     console.log('Store timezone:', STORE_TIMEZONE);
// //     console.log('Query date range:', query);
// //     console.log('Today in store time:', dateRanges.today.start.toLocaleString("en-US", { timeZone: STORE_TIMEZONE }));

// //     const response = await admin.graphql(ORDERS_QUERY, {
// //       variables: {
// //         first: 250,
// //         query: query
// //       }
// //     });

// //     const data = await response.json();
// //     console.log('Query executed successfully');

// //     const graphqlErrors = (data as any).errors;
// //     if (graphqlErrors) {
// //       console.error('Query Errors:', graphqlErrors);
// //       const errorMessages = graphqlErrors.map((error: any) => error.message);
// //       return json({
// //         todaySummary: createEmptySummary('Today'),
// //         last7DaysSummary: createEmptySummary('Last 7 Days'),
// //         dailySummaries: [],
// //         recentOrders: [],
// //         storeTimeZone: STORE_TIMEZONE,
// //         errors: errorMessages
// //       });
// //     }

// //     const orders: Order[] = (data as any).data?.orders?.nodes || [];
// //     console.log(`Successfully fetched ${orders.length} orders`);

// //     // Calculate summaries for different periods
// //     const todaySummary = calculatePeriodSummary(orders, dateRanges.today.start, dateRanges.today.end, 'Today');
// //     const last7DaysSummary = calculatePeriodSummary(orders, dateRanges.last7Days.start, dateRanges.last7Days.end, 'Last 7 Days');
// //     const dailySummaries = calculateDailySummaries(orders);

// //     const loaderData: LoaderData = {
// //       todaySummary,
// //       last7DaysSummary,
// //       dailySummaries,
// //       recentOrders: orders.slice(0, 10), // Show recent 10 orders
// //       storeTimeZone: STORE_TIMEZONE
// //     };

// //     return json(loaderData);

// //   } catch (error) {
// //     console.error('Analytics loader error:', error);
// //     const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';
// //     return json({
// //       todaySummary: createEmptySummary('Today'),
// //       last7DaysSummary: createEmptySummary('Last 7 Days'),
// //       dailySummaries: [],
// //       recentOrders: [],
// //       storeTimeZone: STORE_TIMEZONE,
// //       errors: [errorMessage]
// //     });
// //   }
// // }

// // function createEmptySummary(period: string): PeriodSummary {
// //   return {
// //     period,
// //     grossSales: 0,
// //     discounts: 0,
// //     returns: 0,
// //     netSales: 0,
// //     shipping: 0,
// //     returnFees: 0,
// //     taxes: 0,
// //     totalSales: 0,
// //     ordersCount: 0
// //   };
// // }

// // type LoaderDataWithJsonify = {
// //   todaySummary: PeriodSummary;
// //   last7DaysSummary: PeriodSummary;
// //   dailySummaries: PeriodSummary[];
// //   recentOrders: Array<{
// //     id: string;
// //     name: string;
// //     createdAt: string;
// //     displayFinancialStatus: string;
// //     totalPriceSet: { shopMoney: { amount: string; currencyCode: string } };
// //     subtotalPriceSet: { shopMoney: { amount: string } };
// //     totalShippingPriceSet: { shopMoney: { amount: string } };
// //     totalTaxSet: { shopMoney: { amount: string } };
// //     totalDiscountsSet: { shopMoney: { amount: string } };
// //     totalRefundedSet: { shopMoney: { amount: string } };
// //     totalRefundedShippingSet: { shopMoney: { amount: string } };
// //     refunds: Array<{ id: string; totalRefundedSet: { shopMoney: { amount: string } } }>;
// //   }>;
// //   storeTimeZone: string;
// //   errors?: string[];
// // };

// // export default function Analytics() {
// //   const data = useLoaderData<LoaderDataWithJsonify>();

// //   const SummaryCard = ({ summary, title }: { summary: PeriodSummary; title: string }) => (
// //     <div style={{ border: '1px solid #ddd', padding: '20px', borderRadius: '8px', marginBottom: '20px' }}>
// //       <h3>{title}</h3>
// //       <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px' }}>
// //         <div>
// //           <strong>Gross Sales</strong>
// //           <p>${summary.grossSales.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Discounts</strong>
// //           <p style={{ color: 'red' }}>${summary.discounts.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Returns</strong>
// //           <p style={{ color: 'orange' }}>${summary.returns.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Net Sales</strong>
// //           <p style={{ color: 'green' }}>${summary.netSales.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Shipping</strong>
// //           <p>${summary.shipping.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Return Fees</strong>
// //           <p>${summary.returnFees.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Taxes</strong>
// //           <p>${summary.taxes.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Total Sales</strong>
// //           <p style={{ fontWeight: 'bold' }}>${summary.totalSales.toFixed(2)}</p>
// //         </div>
// //         <div>
// //           <strong>Orders</strong>
// //           <p>{summary.ordersCount}</p>
// //         </div>
// //       </div>
// //     </div>
// //   );

// //   return (
// //     <div style={{ padding: '20px', maxWidth: '1200px', margin: '0 auto' }}>
// //       <h1>Shopify Analytics Dashboard</h1>
// //       <p style={{ color: '#666', marginBottom: '20px' }}>
// //         Data shown in store timezone: <strong>{data.storeTimeZone}</strong>
// //       </p>
      
// //       {data.errors && data.errors.length > 0 && (
// //         <div style={{ color: 'red', marginBottom: '20px' }}>
// //           <h3>GraphQL Errors:</h3>
// //           <ul>
// //             {data.errors.map((error: string, index: number) => (
// //               <li key={index}>{error}</li>
// //             ))}
// //           </ul>
// //         </div>
// //       )}

// //       <section style={{ marginBottom: '40px' }}>
// //         <h2>Quick Overview</h2>
// //         <SummaryCard summary={data.todaySummary} title="Today" />
// //         <SummaryCard summary={data.last7DaysSummary} title="Last 7 Days" />
// //       </section>

// //       <section style={{ marginBottom: '40px' }}>
// //         <h2>Daily Breakdown (Last 7 Days)</h2>
// //         {data.dailySummaries.length === 0 ? (
// //           <p>No daily data available</p>
// //         ) : (
// //           <table border={1} style={{ width: '100%', borderCollapse: 'collapse' }}>
// //             <thead>
// //               <tr style={{ backgroundColor: '#f5f5f5' }}>
// //                 <th style={{ padding: '12px', textAlign: 'left' }}>Date</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Gross Sales</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Discounts</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Returns</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Net Sales</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Shipping</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Taxes</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Total Sales</th>
// //                 <th style={{ padding: '12px', textAlign: 'right' }}>Orders</th>
// //               </tr>
// //             </thead>
// //             <tbody>
// //               {data.dailySummaries.map((day, index) => (
// //                 <tr key={index}>
// //                   <td style={{ padding: '10px' }}>{day.period}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right' }}>${day.grossSales.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right', color: 'red' }}>${day.discounts.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right', color: 'orange' }}>${day.returns.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right', color: 'green' }}>${day.netSales.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right' }}>${day.shipping.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right' }}>${day.taxes.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right', fontWeight: 'bold' }}>${day.totalSales.toFixed(2)}</td>
// //                   <td style={{ padding: '10px', textAlign: 'right' }}>{day.ordersCount}</td>
// //                 </tr>
// //               ))}
// //             </tbody>
// //           </table>
// //         )}
// //       </section>

// //       <section>
// //         <h2>Recent Orders ({data.recentOrders.length})</h2>
// //         {data.recentOrders.length === 0 ? (
// //           <p>No orders available</p>
// //         ) : (
// //           <table border={1} style={{ width: '100%', borderCollapse: 'collapse' }}>
// //             <thead>
// //               <tr style={{ backgroundColor: '#f5f5f5' }}>
// //                 <th style={{ padding: '10px', textAlign: 'left' }}>Order</th>
// //                 <th style={{ padding: '10px', textAlign: 'left' }}>Date</th>
// //                 <th style={{ padding: '10px', textAlign: 'left' }}>Status</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Gross</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Discounts</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Shipping</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Taxes</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Total</th>
// //                 <th style={{ padding: '10px', textAlign: 'right' }}>Refunds</th>
// //               </tr>
// //             </thead>
// //             <tbody>
// //               {data.recentOrders.map((order) => (
// //                 <tr key={order.id}>
// //                   <td style={{ padding: '8px' }}>{order.name}</td>
// //                   <td style={{ padding: '8px' }}>{convertToStoreTime(order.createdAt).toLocaleDateString("en-US", { timeZone: STORE_TIMEZONE })}</td>
// //                   <td style={{ padding: '8px' }}>{order.displayFinancialStatus}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right' }}>${parseFloat(order.subtotalPriceSet?.shopMoney?.amount || '0').toFixed(2)}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right', color: 'red' }}>${Math.abs(parseFloat(order.totalDiscountsSet?.shopMoney?.amount || '0')).toFixed(2)}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right' }}>${parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || '0').toFixed(2)}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right' }}>${parseFloat(order.totalTaxSet?.shopMoney?.amount || '0').toFixed(2)}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right', fontWeight: 'bold' }}>${parseFloat(order.totalPriceSet?.shopMoney?.amount || '0').toFixed(2)}</td>
// //                   <td style={{ padding: '8px', textAlign: 'right', color: 'orange' }}>${parseFloat(order.totalRefundedSet?.shopMoney?.amount || '0').toFixed(2)}</td>
// //                 </tr>
// //               ))}
// //             </tbody>
// //           </table>
// //         )}
// //       </section>
// //     </div>
// //   );
// // }

// // export function meta() {
// //   return [
// //     { title: "Shopify Analytics Dashboard" },
// //     { name: "description", content: "Real-time Shopify analytics with Today and Last 7 Days overview" },
// //   ];
// // }





































































































































// import { json, type LoaderFunctionArgs } from "@remix-run/node";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { session } = await authenticate.admin(request);
//   const shop = session.shop;
//   const accessToken = session.accessToken!;

//   const graphqlUrl = `https://${shop}/admin/api/2024-01/graphql.json`;

//   const graphQLFetch = async (query: string, variables: Record<string, any> = {}) => {
//     const res = await fetch(graphqlUrl, {
//       method: "POST",
//       headers: {
//         "X-Shopify-Access-Token": accessToken,
//         "Content-Type": "application/json",
//       },
//       body: JSON.stringify({ query, variables }),
//     });
    
//     if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
//     const data = await res.json();
//     if (data.errors) throw new Error(`GraphQL Error: ${data.errors[0]?.message}`);
    
//     return data.data;
//   };

//   try {
//     // timezone
//     const shopInfoQuery = `
//       query GetShopInfo {
//         shop {
//           timezoneOffset
//           timezoneAbbreviation
//           ianaTimezone
//         }
//       }
//     `;
//     const shopData = await graphQLFetch(shopInfoQuery);
//     const shopTimezone = shopData.shop.ianaTimezone || 'UTC';

//     const now = new Date();
//     const todayStart = new Date(now.toLocaleString("en-US", { timeZone: shopTimezone }));
//     todayStart.setHours(0, 0, 0, 0);

//     const todayEnd = new Date(todayStart);
//     todayEnd.setDate(todayEnd.getDate() + 1);

//     const todayStartUTC = todayStart.toISOString();
//     const todayEndUTC = todayEnd.toISOString();

//     // find orders today
//     const findOrdersQuery = `
//       query FindTodaysOrders($query: String!) {
//         orders(first: 100, query: $query, sortKey: CREATED_AT) {
//           edges {
//             node {
//               id
//               name
//               createdAt
//               displayFinancialStatus
//               totalPriceSet { shopMoney { amount currencyCode } }
//               totalRefundedSet { shopMoney { amount currencyCode } }
//             }
//           }
//         }
//       }
//     `;

//     const orderQuery = `created_at:>=${todayStartUTC} AND created_at:<${todayEndUTC}`;
//     const findData = await graphQLFetch(findOrdersQuery, { query: orderQuery });

//     const orders = findData.orders.edges;
//     if (!orders || orders.length === 0) {
//       return json({ orders: [], message: "No orders today", shop });
//     }

//     const publicQuery = `
//       query GetOrderData($orderId: ID!) {
//         order(id: $orderId) {
//           id
//           name
//           createdAt
//           updatedAt
//           displayFinancialStatus
//           displayFulfillmentStatus
//           note
//           tags
//           sourceName
//           customerLocale
          
//           totalPriceSet { shopMoney { amount currencyCode } }
//           currentTotalPriceSet { shopMoney { amount currencyCode } }
//           subtotalPriceSet { shopMoney { amount currencyCode } }
//           totalShippingPriceSet { shopMoney { amount currencyCode } }
//           totalRefundedSet { shopMoney { amount currencyCode } }
//           totalRefundedShippingSet { shopMoney { amount currencyCode } }
//           totalDiscountsSet { shopMoney { amount currencyCode } }
//           netPaymentSet { shopMoney { amount currencyCode } }

//           lineItems(first: 100) {
//             edges {
//               node {
//                 id
//                 title
//                 quantity
//                 sku
//                 variant { id sku title }
//                 originalUnitPriceSet { shopMoney { amount currencyCode } }
//                 discountedUnitPriceSet { shopMoney { amount currencyCode } }
//               }
//             }
//           }

//           refunds {
//             id
//             note
//             createdAt
//             totalRefundedSet { shopMoney { amount currencyCode } }
//             refundLineItems(first: 50) {
//               edges {
//                 node {
//                   lineItem { id title variant { id title sku } }
//                   quantity
//                   subtotalSet { shopMoney { amount currencyCode } }
//                   totalTaxSet { shopMoney { amount currencyCode } }
//                 }
//               }
//             }
//           }

//           transactions {
//             id
//             kind
//             status
//             gateway
//             createdAt
//             amountSet { shopMoney { amount currencyCode } }
//           }

//           fulfillments {
//             id
//             status
//             createdAt
//             updatedAt
//             trackingInfo { number url company }
//           }

//           metafields(first: 30) {
//             edges {
//               node { id namespace key value type }
//             }
//           }

//           fullyPaid
//           fulfillable
//           refundable
//           edited
//           closed
//           cancelledAt
//           cancelReason
//         }
//       }
//     `;

//     // ---- Process orders with comprehensive financial calculations ----
//     const processedOrders = await Promise.all(
//       orders.map(async ({ node: order }: any) => {
//         try {
//           const orderId = order.id;
//           const comprehensiveData = await graphQLFetch(publicQuery, { orderId });
//           const orderData = comprehensiveData.order;

//           // Extract financial values
//           const subtotal = parseFloat(orderData.subtotalPriceSet.shopMoney.amount);
//           const discounts = parseFloat(orderData.totalDiscountsSet?.shopMoney.amount || 0);
//           const totalRefunded = parseFloat(orderData.totalRefundedSet?.shopMoney.amount || 0);
//           const refundedShipping = parseFloat(orderData.totalRefundedShippingSet?.shopMoney.amount || 0);
//           const originalShipping = parseFloat(orderData.totalShippingPriceSet?.shopMoney.amount || 0);

//           // Calculate gross returns from refund line items
//           let grossReturns = 0;
//           orderData.refunds?.forEach((refund: any) => {
//             refund.refundLineItems?.edges?.forEach((edge: any) => {
//               grossReturns += parseFloat(edge.node.subtotalSet.shopMoney.amount);
//             });
//           });

//           //  COMPREHENSIVE FINANCIAL CALCULATIONS 

//           // 1. Gross Sales (subtotal + discounts that were applied)
//           const grossSales = subtotal + discounts;

//           // 2. Net Sales Calculations
//           // Option A: Net Sales excluding refunded shipping
//           const netSalesExcludingShipping = subtotal - discounts - (totalRefunded - refundedShipping);
          
//           // Option B: Net Sales including refunded shipping (more conservative)
//           const netSalesIncludingShipping = subtotal - discounts - totalRefunded;

//           // 3. Net Returns Calculations
//           // Net Returns = Gross Returns - Restocking Fees (if any)
//           // Since we don't have restocking fees in this data, net returns = gross returns
//           const netReturns = grossReturns;

//           // 4. Shipping Calculations
//           const netShipping = originalShipping - refundedShipping;

//           // 5. Return Rate
//           const returnRate = grossSales > 0 ? (grossReturns / grossSales) * 100 : 0;

//           const normalizeEdges = (edges: any[]) => edges?.map(e => e.node) || [];

//           return {
//             ...orderData,
//             lineItems: normalizeEdges(orderData.lineItems.edges),
//             metafields: normalizeEdges(orderData.metafields.edges),
//             refunds: orderData.refunds || [],
            
//             //  FINANCIAL METRICS 
//             financialMetrics: {
//               // Sales Metrics
//               grossSales: parseFloat(grossSales.toFixed(2)),
//               netSalesExcludingShipping: parseFloat(netSalesExcludingShipping.toFixed(2)),
//               netSalesIncludingShipping: parseFloat(netSalesIncludingShipping.toFixed(2)),
              
//               // Returns Metrics
//               grossReturns: parseFloat(grossReturns.toFixed(2)),
//               netReturns: parseFloat(netReturns.toFixed(2)),
//               returnRate: parseFloat(returnRate.toFixed(2)),
              
//               // Shipping Metrics
//               originalShipping: parseFloat(originalShipping.toFixed(2)),
//               refundedShipping: parseFloat(refundedShipping.toFixed(2)),
//               netShipping: parseFloat(netShipping.toFixed(2)),
              
//               // Component Breakdown
//               subtotal: parseFloat(subtotal.toFixed(2)),
//               discounts: parseFloat(discounts.toFixed(2)),
//               totalRefunded: parseFloat(totalRefunded.toFixed(2))
//             },
            
//             // Legacy fields (for backward compatibility)
//             calculatedGrossSales: parseFloat(grossSales.toFixed(2)),
//             calculatedGrossReturns: parseFloat(grossReturns.toFixed(2)),
//             calculatedRefundedShipping: parseFloat(refundedShipping.toFixed(2)),
//             calculatedNetSales: parseFloat(netSalesExcludingShipping.toFixed(2))
//           };
//         } catch (err: any) {
//           return { 
//             id: order.id, 
//             name: order.name, 
//             error: err.message 
//           };
//         }
//       })
//     );

//     // Calculate aggregate totals across all orders
//     const aggregateMetrics = processedOrders.reduce((acc, order) => {
//       if (!order.error && order.financialMetrics) {
//         acc.totalGrossSales += order.financialMetrics.grossSales;
//         acc.totalNetSales += order.financialMetrics.netSalesExcludingShipping;
//         acc.totalGrossReturns += order.financialMetrics.grossReturns;
//         acc.totalRefundedShipping += order.financialMetrics.refundedShipping;
//         acc.totalOrdersWithReturns += order.financialMetrics.grossReturns > 0 ? 1 : 0;
//       }
//       return acc;
//     }, {
//       totalGrossSales: 0,
//       totalNetSales: 0,
//       totalGrossReturns: 0,
//       totalRefundedShipping: 0,
//       totalOrdersWithReturns: 0
//     });

//     return json({
//       orders: processedOrders,
//       totalOrders: processedOrders.length,
//       aggregateMetrics,
//       shop,
//       dateRange: { 
//         start: todayStartUTC, 
//         end: todayEndUTC,
//         localDate: todayStart.toLocaleDateString("en-US", { timeZone: shopTimezone })
//       }
//     });

//   } catch (error: any) {
//     return json({ error: error.message }, { status: 500 });
//   }
// };


















// import { json, type LoaderFunctionArgs } from "@remix-run/node";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { session } = await authenticate.admin(request);
//   const shop = session.shop;
//   const accessToken = session.accessToken!;

//   const orderName = "#8861";

//   // 1. First get the order ID from the order name
//   const findOrderUrl = `https://${shop}/admin/api/2024-01/orders.json?name=${encodeURIComponent(orderName)}&status=any&limit=1`;

//   const findRes = await fetch(findOrderUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });

//   if (!findRes.ok) {
//     return json({ error: "Failed to find order" });
//   }

//   const findData = await findRes.json();
//   const order = findData.orders?.[0];

//   if (!order) {
//     return json({ error: "Order not found" });
//   }

//   const orderId = order.id;

//   // 2. Get COMPLETE order details with all fields
//   const orderUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}.json`;
//   const orderRes = await fetch(orderUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const orderData = await orderRes.json();

//   // 3. Get detailed refund information
//   const refundsUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/refunds.json`;
//   const refundsRes = await fetch(refundsUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const refundsData = await refundsRes.ok ? await refundsRes.json() : { refunds: [] };

//   // 4. Get order transactions (payment history)
//   const transactionsUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/transactions.json`;
//   const transactionsRes = await fetch(transactionsUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const transactionsData = await transactionsRes.ok ? await transactionsRes.json() : { transactions: [] };

//   // 5. Get fulfillment orders
//   const fulfillmentOrdersUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/fulfillment_orders.json`;
//   const fulfillmentOrdersRes = await fetch(fulfillmentOrdersUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const fulfillmentOrdersData = await fulfillmentOrdersRes.ok ? await fulfillmentOrdersRes.json() : { fulfillment_orders: [] };

//   // 6. Get ACTUAL fulfillments (tracking, dates, items)
//   const fulfillmentsUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/fulfillments.json`;
//   const fulfillmentsRes = await fetch(fulfillmentsUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const fulfillmentsData = await fulfillmentsRes.ok ? await fulfillmentsRes.json() : { fulfillments: [] };

//   // 7. Get Order Events (audit log)
//   const eventsUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/events.json`;
//   const eventsRes = await fetch(eventsUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const eventsData = await eventsRes.ok ? await eventsRes.json() : { events: [] };

//   // 8. Get Metafields (custom fields for return reasons, exchange notes)
//   const metafieldsUrl = `https://${shop}/admin/api/2024-01/orders/${orderId}/metafields.json`;
//   const metafieldsRes = await fetch(metafieldsUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const metafieldsData = await metafieldsRes.ok ? await metafieldsRes.json() : { metafields: [] };

//   // 9. EXCHANGE-SPECIFIC: Get draft orders (exchanges often created as draft orders)
//   const draftOrdersUrl = `https://${shop}/admin/api/2024-01/draft_orders.json?source_order_id=${orderId}`;
//   const draftOrdersRes = await fetch(draftOrdersUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const draftOrdersData = await draftOrdersRes.ok ? await draftOrdersRes.json() : { draft_orders: [] };

//   // 10. EXCHANGE-SPECIFIC: Search for related orders (exchanges might be new orders)
//   const relatedOrdersUrl = `https://${shop}/admin/api/2024-01/orders.json?source_name=exchange&limit=10`;
//   const relatedOrdersRes = await fetch(relatedOrdersUrl, {
//     headers: {
//       "X-Shopify-Access-Token": accessToken,
//       "Content-Type": "application/json",
//     },
//   });
//   const relatedOrdersData = await relatedOrdersRes.ok ? await relatedOrdersRes.json() : { orders: [] };

//   return json({
//     order: orderData.order,
//     refunds: refundsData.refunds,
//     transactions: transactionsData.transactions,
//     fulfillmentOrders: fulfillmentOrdersData.fulfillment_orders,
//     fulfillments: fulfillmentsData.fulfillments,
//     events: eventsData.events,
//     metafields: metafieldsData.metafields,
//     draftOrders: draftOrdersData.draft_orders, // Exchange orders as drafts
//     relatedOrders: relatedOrdersData.orders, // Potential exchange orders
//     orderId,
//     orderName,
//     // Return the raw JSON for debugging
//     raw: {
//       order: orderData,
//       refunds: refundsData,
//       transactions: transactionsData,
//       fulfillmentOrders: fulfillmentOrdersData,
//       fulfillments: fulfillmentsData,
//       events: eventsData,
//       metafields: metafieldsData,
//       draftOrders: draftOrdersData,
//       relatedOrders: relatedOrdersData
//     }
//   });
// };

















// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin } = await authenticate.admin(request);

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   return json({ orders });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate refund discrepancy using actual shipping refunds
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//       const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//         return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;
//       const shippingRefunded = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0) / (order.refunds?.length || 1);
      
//       // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//       const calculatedTotal = lineItemsRefunded + shippingRefunded;
//       return discrepancySum + (totalRefunded - calculatedTotal);
//     }, 0) || 0;
//     return sum + orderRefundDiscrepancy;
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Shipping</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${totalShipping.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             ${totalShippingRefunds.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalShipping > 0 ? `${((totalShippingRefunds / totalShipping) * 100).toFixed(1)}% of shipping` : 'N/A'}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Calculate refund statistics for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//           const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//           const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//             return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//           }, 0) || 0;
//           const shippingRefunded = orderShippingRefunds / (order.refunds?.length || 1);
          
//           // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//           const calculatedTotal = lineItemsRefunded + shippingRefunded;
//           return discrepancySum + (totalRefunded - calculatedTotal);
//         }, 0) || 0;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
//                   {orderShippingRefunds > 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Shipping Refunds:</span>
//                       <span style={{ fontWeight: "bold", color: "#e83e8c" }}>
//                         ${orderShippingRefunds.toFixed(2)}
//                       </span>
//                     </div>
//                   )}
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Shipping:</span>
//                     <span>{formatMoney(order.totalShippingPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px", fontWeight: "bold" }}>
//                     <span>Total:</span>
//                     <span>{formatMoney(order.totalPriceSet || order.currentTotalPriceSet)}</span>
//                   </div>
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;
//                   const shippingRefunded = orderShippingRefunds / order.refunds.length;
//                   const calculatedTotal = lineItemsRefunded + shippingRefunded;
//                   const refundDiscrepancy = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0) - calculatedTotal;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                           {refundDiscrepancy !== 0 && (
//                             <p style={{ 
//                               margin: "4px 0 0 0", 
//                               fontSize: "11px", 
//                               color: refundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                               backgroundColor: refundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                               padding: "2px 6px",
//                               borderRadius: "4px"
//                             }}>
//                               Discrepancy: ${Math.abs(refundDiscrepancy).toFixed(2)}
//                             </p>
//                           )}
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                         {shippingRefunded > 0 && (
//                           <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                             <span>Shipping Refunded:</span>
//                             <span>${shippingRefunded.toFixed(2)}</span>
//                           </div>
//                         )}
//                         <div style={{ display: "flex", justifyContent: "space-between", fontWeight: "bold", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                           <span>Calculated Total:</span>
//                           <span>${calculatedTotal.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }

















































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin } = await authenticate.admin(request);

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   return json({ orders });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics using currentTotalPriceSet for revenue
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate refund discrepancy using actual shipping refunds
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//       const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//         return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;
//       const shippingRefunded = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0) / (order.refunds?.length || 1);
      
//       // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//       const calculatedTotal = lineItemsRefunded + shippingRefunded;
//       return discrepancySum + (totalRefunded - calculatedTotal);
//     }, 0) || 0;
//     return sum + orderRefundDiscrepancy;
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Using current total prices
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Shipping</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${totalShipping.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             ${totalShippingRefunds.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalShipping > 0 ? `${((totalShippingRefunds / totalShipping) * 100).toFixed(1)}% of shipping` : 'N/A'}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Calculate refund statistics for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//           const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//           const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//             return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//           }, 0) || 0;
//           const shippingRefunded = orderShippingRefunds / (order.refunds?.length || 1);
          
//           // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//           const calculatedTotal = lineItemsRefunded + shippingRefunded;
//           return discrepancySum + (totalRefunded - calculatedTotal);
//         }, 0) || 0;

//         // Check if current total differs from original total
//         const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}
//                   {hasPriceAdjustment && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#ffc107", 
//                       color: "#212529", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Price Adjusted
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
//                   {orderShippingRefunds > 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Shipping Refunds:</span>
//                       <span style={{ fontWeight: "bold", color: "#e83e8c" }}>
//                         ${orderShippingRefunds.toFixed(2)}
//                       </span>
//                     </div>
//                   )}
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Shipping:</span>
//                     <span>{formatMoney(order.totalShippingPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Original Total:</span>
//                     <span>{formatMoney(order.totalPriceSet)}</span>
//                   </div>
//                   <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     borderTop: "1px solid #ddd", 
//                     marginTop: "4px", 
//                     paddingTop: "4px", 
//                     fontWeight: "bold",
//                     backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                     padding: '4px',
//                     borderRadius: '4px'
//                   }}>
//                     <span>Current Total:</span>
//                     <span style={{ 
//                       color: hasPriceAdjustment ? "#856404" : "inherit"
//                     }}>
//                       {formatMoney(order.currentTotalPriceSet)}
//                       {hasPriceAdjustment && (
//                         <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                           (adjusted)
//                         </span>
//                       )}
//                     </span>
//                   </div>
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;
//                   const shippingRefunded = orderShippingRefunds / order.refunds.length;
//                   const calculatedTotal = lineItemsRefunded + shippingRefunded;
//                   const refundDiscrepancy = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0) - calculatedTotal;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                           {refundDiscrepancy !== 0 && (
//                             <p style={{ 
//                               margin: "4px 0 0 0", 
//                               fontSize: "11px", 
//                               color: refundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                               backgroundColor: refundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                               padding: "2px 6px",
//                               borderRadius: "4px"
//                             }}>
//                               Discrepancy: ${Math.abs(refundDiscrepancy).toFixed(2)}
//                             </p>
//                           )}
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                         {shippingRefunded > 0 && (
//                           <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                             <span>Shipping Refunded:</span>
//                             <span>${shippingRefunded.toFixed(2)}</span>
//                           </div>
//                         )}
//                         <div style={{ display: "flex", justifyContent: "space-between", fontWeight: "bold", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                           <span>Calculated Total:</span>
//                           <span>${calculatedTotal.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }

























// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders to calculate gross returns and other metrics
//   const processedOrders = orders.map((order: any) => {
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items)
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate refunded shipping
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Calculate sales metrics
//     const grossSales = subtotal + discounts;
//     const netSales = grossSales - discounts - grossReturns - refundedShipping;

//     return {
//       ...order,
//       calculatedGrossSales: grossSales,
//       calculatedGrossReturns: grossReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales
//     };
//   });

//   return json({ 
//     orders: processedOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics using currentTotalPriceSet for revenue
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate gross returns (sum of all refunded line items)
//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // Calculate gross sales (subtotal + discounts)
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   // Calculate net sales (gross sales - discounts - gross returns - refunded shipping)
//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   // Calculate refund discrepancy using actual shipping refunds
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//       const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//         return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;
//       const shippingRefunded = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0) / (order.refunds?.length || 1);
      
//       // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//       const calculatedTotal = lineItemsRefunded + shippingRefunded;
//       return discrepancySum + (totalRefunded - calculatedTotal);
//     }, 0) || 0;
//     return sum + orderRefundDiscrepancy;
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Using current total prices
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Sales Metrics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalGrossSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalGrossReturns.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Net Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             ${totalNetSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Shipping</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${totalShipping.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             ${totalShippingRefunds.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalShipping > 0 ? `${((totalShippingRefunds / totalShipping) * 100).toFixed(1)}% of shipping` : 'N/A'}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Calculate refund statistics for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         const orderRefundDiscrepancy = order.refunds?.reduce((discrepancySum: number, refund: any) => {
//           const totalRefunded = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0);
//           const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((lineSum: number, line: any) => {
//             return lineSum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//           }, 0) || 0;
//           const shippingRefunded = orderShippingRefunds / (order.refunds?.length || 1);
          
//           // Calculate discrepancy (difference between total refunded and sum of line items + shipping)
//           const calculatedTotal = lineItemsRefunded + shippingRefunded;
//           return discrepancySum + (totalRefunded - calculatedTotal);
//         }, 0) || 0;

//         // Check if current total differs from original total
//         const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}
//                   {hasPriceAdjustment && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#ffc107", 
//                       color: "#212529", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Price Adjusted
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
//                   {orderShippingRefunds > 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Shipping Refunds:</span>
//                       <span style={{ fontWeight: "bold", color: "#e83e8c" }}>
//                         ${orderShippingRefunds.toFixed(2)}
//                       </span>
//                     </div>
//                   )}
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Shipping:</span>
//                     <span>{formatMoney(order.totalShippingPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Original Total:</span>
//                     <span>{formatMoney(order.totalPriceSet)}</span>
//                   </div>
//                   <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     borderTop: "1px solid #ddd", 
//                     marginTop: "4px", 
//                     paddingTop: "4px", 
//                     fontWeight: "bold",
//                     backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                     padding: '4px',
//                     borderRadius: '4px'
//                   }}>
//                     <span>Current Total:</span>
//                     <span style={{ 
//                       color: hasPriceAdjustment ? "#856404" : "inherit"
//                     }}>
//                       {formatMoney(order.currentTotalPriceSet)}
//                       {hasPriceAdjustment && (
//                         <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                           (adjusted)
//                         </span>
//                       )}
//                     </span>
//                   </div>
                  
//                   {/* Gross Returns Calculation */}
//                   {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                     <>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginTop: "8px", 
//                         paddingTop: "8px", 
//                         borderTop: "1px solid #ddd",
//                         fontSize: "13px"
//                       }}>
//                         <span>Gross Sales:</span>
//                         <span style={{ fontWeight: "bold", color: "#155724" }}>
//                           ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                       {order.calculatedGrossReturns > 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                           <span>Gross Returns:</span>
//                           <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                             -${order.calculatedGrossReturns?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         fontSize: "13px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Net Sales:</span>
//                         <span style={{ color: "#004085" }}>
//                           ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                     </>
//                   )}
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;
//                   const shippingRefunded = orderShippingRefunds / order.refunds.length;
//                   const calculatedTotal = lineItemsRefunded + shippingRefunded;
//                   const refundDiscrepancy = parseFloat(refund.totalRefundedSet?.shopMoney?.amount || 0) - calculatedTotal;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                           {refundDiscrepancy !== 0 && (
//                             <p style={{ 
//                               margin: "4px 0 0 0", 
//                               fontSize: "11px", 
//                               color: refundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                               backgroundColor: refundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                               padding: "2px 6px",
//                               borderRadius: "4px"
//                             }}>
//                               Discrepancy: ${Math.abs(refundDiscrepancy).toFixed(2)}
//                             </p>
//                           )}
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                         {shippingRefunded > 0 && (
//                           <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                             <span>Shipping Refunded:</span>
//                             <span>${shippingRefunded.toFixed(2)}</span>
//                           </div>
//                         )}
//                         <div style={{ display: "flex", justifyContent: "space-between", fontWeight: "bold", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                           <span>Calculated Total:</span>
//                           <span>${calculatedTotal.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }



















































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders to calculate gross returns and other metrics
//   const processedOrders = orders.map((order: any) => {
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items)
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate refunded shipping
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Get refund discrepancy directly from Shopify
//     const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//     // Calculate sales metrics
//     const grossSales = subtotal + discounts;
//     const netSales = grossSales - discounts - grossReturns - refundedShipping;

//     return {
//       ...order,
//       calculatedGrossSales: grossSales,
//       calculatedGrossReturns: grossReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales,
//       calculatedRefundDiscrepancy: refundDiscrepancy
//     };
//   });

//   return json({ 
//     orders: processedOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics using currentTotalPriceSet for revenue
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate gross returns (sum of all refunded line items)
//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // Calculate gross sales (subtotal + discounts)
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   // Calculate net sales (gross sales - discounts - gross returns - refunded shipping)
//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   // Calculate total refund discrepancy using Shopify's direct field
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Using current total prices
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Sales Metrics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalGrossSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalGrossReturns.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Net Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             ${totalNetSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Shipping</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${totalShipping.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             ${totalShippingRefunds.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalShipping > 0 ? `${((totalShippingRefunds / totalShipping) * 100).toFixed(1)}% of shipping` : 'N/A'}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "10px", color: "#666", fontStyle: "italic" }}>
//             Direct from Shopify API
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Get refund discrepancy directly from Shopify
//         const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//         // Calculate refunded shipping for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         // Check if current total differs from original total
//         const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}
//                   {hasPriceAdjustment && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#ffc107", 
//                       color: "#212529", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Price Adjusted
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
//                   {orderShippingRefunds > 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Shipping Refunds:</span>
//                       <span style={{ fontWeight: "bold", color: "#e83e8c" }}>
//                         ${orderShippingRefunds.toFixed(2)}
//                       </span>
//                     </div>
//                   )}
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                         <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                           (Shopify)
//                         </span>
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Shipping:</span>
//                     <span>{formatMoney(order.totalShippingPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Original Total:</span>
//                     <span>{formatMoney(order.totalPriceSet)}</span>
//                   </div>
//                   <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     borderTop: "1px solid #ddd", 
//                     marginTop: "4px", 
//                     paddingTop: "4px", 
//                     fontWeight: "bold",
//                     backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                     padding: '4px',
//                     borderRadius: '4px'
//                   }}>
//                     <span>Current Total:</span>
//                     <span style={{ 
//                       color: hasPriceAdjustment ? "#856404" : "inherit"
//                     }}>
//                       {formatMoney(order.currentTotalPriceSet)}
//                       {hasPriceAdjustment && (
//                         <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                           (adjusted)
//                         </span>
//                       )}
//                     </span>
//                   </div>
                  
//                   {/* Gross Returns Calculation */}
//                   {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                     <>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginTop: "8px", 
//                         paddingTop: "8px", 
//                         borderTop: "1px solid #ddd",
//                         fontSize: "13px"
//                       }}>
//                         <span>Gross Sales:</span>
//                         <span style={{ fontWeight: "bold", color: "#155724" }}>
//                           ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                       {order.calculatedGrossReturns > 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                           <span>Gross Returns:</span>
//                           <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                             -${order.calculatedGrossReturns?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         fontSize: "13px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Net Sales:</span>
//                         <span style={{ color: "#004085" }}>
//                           ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                     </>
//                   )}
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }







































































































































































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }


//             # Returns Information with Restocking Fees
//                     # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders to calculate gross returns and other metrics
//   const processedOrders = orders.map((order: any) => {
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items)
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate refunded shipping
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Get refund discrepancy directly from Shopify
//     const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);


//         // Calculate restocking fees and return shipping fees
//        // Calculate restocking fees and return shipping fees
//     let totalRestockingFees = 0;
//     let totalReturnShippingFees = 0;

//     order.returns?.nodes?.forEach((returnItem: any) => {
//       // Calculate restocking fees from return line items
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//           totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//         }
//       });

//       // Calculate return shipping fees - it's an array!
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         if (shippingFee?.amountSet?.shopMoney?.amount) {
//           totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//         }
//       });
//     });



//     console.log('Order:', order.name);
//     console.log('Returns nodes:', order.returns?.nodes);
//     if (order.returns?.nodes) {
//       order.returns.nodes.forEach((returnItem: any, index: number) => {
//         console.log(`Return ${index} shipping fees:`, returnItem.returnShippingFees);
//       });
//     }
//     console.log('Total return shipping fees calculated:', totalReturnShippingFees);

//     // Calculate sales metrics
//     const grossSales = subtotal + discounts;
//         const netSales = grossSales - discounts - grossReturns - refundedShipping - totalRestockingFees;

//     return {
//       ...order,
//       calculatedGrossSales: grossSales,
//       calculatedGrossReturns: grossReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales,
//       calculatedRefundDiscrepancy: refundDiscrepancy,
//       calculatedRestockingFees: totalRestockingFees,
//       calculatedReturnShippingFees: totalReturnShippingFees
//     };
//   });

//   return json({ 
//     orders: processedOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics using currentTotalPriceSet for revenue
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate gross returns (sum of all refunded line items)
//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // Calculate gross sales (subtotal + discounts)
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   // Calculate net sales (gross sales - discounts - gross returns - refunded shipping)
//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   // Calculate total refund discrepancy using Shopify's direct field
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;




//   // Calculate total restocking fees and return shipping fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   // Orders with returns
//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;



//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Using current total prices
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Sales Metrics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalGrossSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalGrossReturns.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Net Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             ${totalNetSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Shipping</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${totalShipping.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>



//       {/* Return Fees Section */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             {ordersWithReturns}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Restocking Fees</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalRestockingFees.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f7fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2ebf2"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Return Shipping Fees</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#006064" }}>
//             ${totalReturnShippingFees.toFixed(2)}
//           </p>
//         </div>
//       </div>


//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             ${totalShippingRefunds.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalShipping > 0 ? `${((totalShippingRefunds / totalShipping) * 100).toFixed(1)}% of shipping` : 'N/A'}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "10px", color: "#666", fontStyle: "italic" }}>
//             Direct from Shopify API
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Get refund discrepancy directly from Shopify
//         const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//         // Calculate refunded shipping for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         // Check if current total differs from original total
//         const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}



//                 {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                   <span style={{ 
//                     marginLeft: "8px", 
//                     backgroundColor: "#ffc107", 
//                     color: "#212529", 
//                     padding: "2px 8px", 
//                     borderRadius: "12px", 
//                     fontSize: "12px",
//                     fontWeight: "normal"
//                   }}>
//                     {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                   </span>
//                 )}


//                   {hasPriceAdjustment && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#ffc107", 
//                       color: "#212529", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Price Adjusted
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
//                   {orderShippingRefunds > 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Shipping Refunds:</span>
//                       <span style={{ fontWeight: "bold", color: "#e83e8c" }}>
//                         ${orderShippingRefunds.toFixed(2)}
//                       </span>
//                     </div>
//                   )}
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                         <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                           (Shopify)
//                         </span>
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Shipping:</span>
//                     <span>{formatMoney(order.totalShippingPriceSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>

//                                     {/* Return Fees */}
//                   {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                     <>
//                       {order.calculatedRestockingFees > 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Restocking Fees:</span>
//                           <span style={{ color: "#856404" }}>-${order.calculatedRestockingFees.toFixed(2)}</span>
//                         </div>
//                       )}
//                       {order.calculatedReturnShippingFees > 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Return Shipping:</span>
//                           <span style={{ color: "#006064" }}>-${order.calculatedReturnShippingFees.toFixed(2)}</span>
//                         </div>
//                       )}
//                     </>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Original Total:</span>
//                     <span>{formatMoney(order.totalPriceSet)}</span>
//                   </div>
//                   <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     borderTop: "1px solid #ddd", 
//                     marginTop: "4px", 
//                     paddingTop: "4px", 
//                     fontWeight: "bold",
//                     backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                     padding: '4px',
//                     borderRadius: '4px'
//                   }}>
//                     <span>Current Total:</span>
//                     <span style={{ 
//                       color: hasPriceAdjustment ? "#856404" : "inherit"
//                     }}>
//                       {formatMoney(order.currentTotalPriceSet)}
//                       {hasPriceAdjustment && (
//                         <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                           (adjusted)
//                         </span>
//                       )}
//                     </span>
//                   </div>
                  
//                   {/* Gross Returns Calculation */}
//                   {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                     <>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginTop: "8px", 
//                         paddingTop: "8px", 
//                         borderTop: "1px solid #ddd",
//                         fontSize: "13px"
//                       }}>
//                         <span>Gross Sales:</span>
//                         <span style={{ fontWeight: "bold", color: "#155724" }}>
//                           ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                       {order.calculatedGrossReturns > 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                           <span>Gross Returns:</span>
//                           <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                             -${order.calculatedGrossReturns?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         fontSize: "13px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Net Sales:</span>
//                         <span style={{ color: "#004085" }}>
//                           ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                     </>
//                   )}
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }















































































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }


//             # Returns Information with Restocking Fees
//                     # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders to calculate gross returns and other metrics
//     // Process orders to calculate gross returns and other metrics
//   const processedOrders = orders.map((order: any) => {
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Get refund discrepancy directly from Shopify (DECLARE FIRST)
//     const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items)
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate net returns (gross returns minus over-refunds only)
//     const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//     // Calculate refunded shipping
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Calculate shipping charges
//     const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//     const shippingCharges = shippingAmount - refundedShipping;


//         // Calculate restocking fees and return shipping fees
//        // Calculate restocking fees and return shipping fees
//     let totalRestockingFees = 0;
//     let totalReturnShippingFees = 0;

//     order.returns?.nodes?.forEach((returnItem: any) => {
//       // Calculate restocking fees from return line items
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//           totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//         }
//       });

//       // Calculate return shipping fees - it's an array!
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         if (shippingFee?.amountSet?.shopMoney?.amount) {
//           totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//         }
//       });
//     });



//     console.log('Order:', order.name);
//     console.log('Returns nodes:', order.returns?.nodes);
//     if (order.returns?.nodes) {
//       order.returns.nodes.forEach((returnItem: any, index: number) => {
//         console.log(`Return ${index} shipping fees:`, returnItem.returnShippingFees);
//       });
//     }
//     console.log('Total return shipping fees calculated:', totalReturnShippingFees);

//     // Calculate sales metrics
//        // Calculate total return fees (DECLARE FIRST)
//     const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//     // Calculate sales metrics
//         // Calculate sales metrics
//        // Calculate sales metrics
//      // Calculate sales metrics
//     const grossSales = subtotal + discounts;
    
//     // Net Sales = Gross Sales - Returns (including over-refunds) - Discounts
//     const netSales = grossSales - (grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0)) - discounts;

//      return {
//       ...order,
//       calculatedGrossSales: grossSales,
      
//       calculatedGrossReturns: grossReturns,
//       calculatedNetReturns: netReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales,
//       calculatedRefundDiscrepancy: refundDiscrepancy,
//       calculatedRestockingFees: totalRestockingFees,
//       calculatedReturnShippingFees: totalReturnShippingFees,
//       calculatedTotalReturnFees: totalReturnFees,
//       calculatedShippingCharges: shippingCharges
//     };
//   });

//   return json({ 
//     orders: processedOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// export default function OrdersLast7Days() {
//   const { orders } = useLoaderData<typeof loader>();

//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   // Calculate summary statistics using currentTotalPriceSet for revenue
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Use actual shipping refunds
//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   // Calculate net shipping charges
// const totalShippingCharges = totalShipping - totalShippingRefunds;

//   // Calculate gross returns (sum of all refunded line items)
//    // Calculate total refund discrepancy using Shopify's direct field (DECLARE FIRST)
//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   // Calculate gross returns (sum of all refunded line items)
//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // Calculate net returns (gross returns minus over-refunds only)
//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   // Calculate gross sales (subtotal + discounts)
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   // Calculate net sales (gross sales - discounts - gross returns - refunded shipping)
//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   // Calculate total line items price by summing all line items
//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   // Orders with refunds
//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;


//   // Calculate total restocking fees and return shipping fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   // Orders with returns
//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   // Calculate total taxes (revenue - gross sales - shipping charges)
//   const totalTaxes = totalRevenue - totalGrossSales - totalShippingCharges;

  

//   // Calculate total sales (gross sales + shipping charges + return fees + taxes - returns - discounts)
//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;






//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return (
//     <div style={{ padding: "20px" }}>
//       <h2>Orders Last 7 Days</h2>
      
//       {/* Enhanced Summary Statistics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Orders</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#007bff" }}>
//             {totalOrders}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Total Revenue</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#28a745" }}>
//             ${totalRevenue.toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Using current total prices
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333" }}>Average Order Value</h3>
//           <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: "#6f42c1" }}>
//             ${averageOrderValue.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Sales Metrics */}
//             {/* Sales Metrics */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Gross Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalGrossSales.toFixed(2)}
//           </p>
//         </div>
        
//         {/* THIS IS WHERE YOUR NEW CODE GOES - REPLACING "GROSS RETURNS" */}
//                 <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalReturns.toFixed(2)}
//           </p>
//         </div>
        
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Net Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             ${totalNetSales.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e6f3ff", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b3d9ff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Sales</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#0066cc" }}>
//             ${totalSales.toFixed(2)}
//           </p>
//         </div>
      
//       </div>

//       {/* Financial Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(4, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f5e8", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #c3e6c3"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Received</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#155724" }}>
//             ${totalReceived.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#ffeaea", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #f5c6cb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Refunded</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#721c24" }}>
//             ${totalRefunded.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3cd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffeaa7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Outstanding</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#856404" }}>
//             ${totalOutstanding.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e8f4fd", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b8daff"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004085" }}>
//             {fullyPaidOrders} / {totalOrders}
//           </p>
//         </div>
//       </div>

//       {/* Cost Breakdown */}
//             {/* Cost Breakdown */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(3, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff3e0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcc80"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Line Items</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e65100" }}>
//             ${totalLineItemsPrice.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#f3e5f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #e1bee7"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Discounts</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#4a148c" }}>
//             ${totalDiscounts.toFixed(2)}
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f2f1", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2dfdb"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Shipping Charges</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#004d40" }}>
//             ${(totalShipping - totalShippingRefunds).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Shipping: ${totalShipping.toFixed(2)} - Refunds: ${totalShippingRefunds.toFixed(2)}
//           </p>
//         </div>
//       </div>

//       {/* Refund Analysis */}
//          {/* Refund Analysis */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>



//       {/* Return Fees Section */}
//             {/* Return Fees Section - Combined */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f5", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffccd5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Returns</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#e83e8c" }}>
//             {ordersWithReturns}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithReturns / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#e0f7fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #b2ebf2"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Total Return Fees</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#006064" }}>
//             ${(totalRestockingFees + totalReturnShippingFees).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             Restocking: ${totalRestockingFees.toFixed(2)} + Shipping: ${totalReturnShippingFees.toFixed(2)}
//           </p>
//         </div>
//       </div>
      


//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff0f0", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: "1px solid #ffcccc"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//           <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: "#dc3545" }}>
//             {ordersWithRefunds}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {((ordersWithRefunds / totalOrders) * 100).toFixed(1)}% of orders
//           </p>
//         </div>
    
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: totalRefundDiscrepancy !== 0 ? "#fff3cd" : "#f8f9fa", 
//           borderRadius: "8px", 
//           textAlign: "center",
//           border: totalRefundDiscrepancy !== 0 ? "1px solid #ffc107" : "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 8px 0", color: "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//           <p style={{ 
//             margin: "0", 
//             fontSize: "20px", 
//             fontWeight: "bold", 
//             color: totalRefundDiscrepancy !== 0 ? "#856404" : "#6c757d"
//           }}>
//             ${Math.abs(totalRefundDiscrepancy).toFixed(2)}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//             {totalRefundDiscrepancy > 0 ? 'Over-refunded' : totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//           </p>
//           <p style={{ margin: "4px 0 0 0", fontSize: "10px", color: "#666", fontStyle: "italic" }}>
//             Direct from Shopify API
//           </p>
//         </div>
//       </div>

//       {/* Status Overview */}
//       <div style={{ 
//         display: "grid", 
//         gridTemplateColumns: "repeat(2, 1fr)", 
//         gap: "16px", 
//         marginBottom: "24px" 
//       }}>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Financial Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(financialStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//         <div style={{ 
//           padding: "16px", 
//           backgroundColor: "#fff", 
//           borderRadius: "8px", 
//           border: "1px solid #e5e5e5"
//         }}>
//           <h3 style={{ margin: "0 0 12px 0", color: "#333" }}>Fulfillment Status</h3>
//           <div style={{ fontSize: "14px" }}>
//             {Object.entries(fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//               <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                 <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                 <span style={{ fontWeight: "bold" }}>{count}</span>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>

//       {orders.map((order: any) => {
//         // Calculate line items total for this order
//         const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0) || 0;

//         // Get refund discrepancy directly from Shopify
//         const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//         // Calculate refunded shipping for this order
//         const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//         // Check if current total differs from original total
//         const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//         return (
//           <div 
//             key={order.id} 
//             style={{ 
//               border: "1px solid #e5e5e5",
//               borderRadius: "8px",
//               padding: "12px",
//               marginBottom: "12px",
//               backgroundColor: "#fafafa"
//             }}
//           >
//             {/* Order Header */}
//             <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//               <div>
//                 <h3 style={{ margin: "0 0 4px 0" }}>
//                   {order.name} (Order #{getOrderNumber(order.name)})
//                   {order.fullyPaid && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#28a745", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Fully Paid
//                     </span>
//                   )}
//                   {order.refunds && order.refunds.length > 0 && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#dc3545", 
//                       color: "white", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                     </span>
//                   )}



//                 {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                   <span style={{ 
//                     marginLeft: "8px", 
//                     backgroundColor: "#ffc107", 
//                     color: "#212529", 
//                     padding: "2px 8px", 
//                     borderRadius: "12px", 
//                     fontSize: "12px",
//                     fontWeight: "normal"
//                   }}>
//                     {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                   </span>
//                 )}


//                   {hasPriceAdjustment && (
//                     <span style={{ 
//                       marginLeft: "8px", 
//                       backgroundColor: "#ffc107", 
//                       color: "#212529", 
//                       padding: "2px 8px", 
//                       borderRadius: "12px", 
//                       fontSize: "12px",
//                       fontWeight: "normal"
//                     }}>
//                       Price Adjusted
//                     </span>
//                   )}
//                 </h3>
//                 <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                   Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                 </p>
//               </div>
//               <div style={{ textAlign: "right" }}>
//                 <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                   Created: {new Date(order.createdAt).toLocaleString()}
//                 </p>
//                 {order.updatedAt && (
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Updated: {new Date(order.updatedAt).toLocaleString()}
//                   </p>
//                 )}
//               </div>
//             </div>

//             {/* Enhanced Financial Details */}
//             <div style={{ 
//               display: "grid", 
//               gridTemplateColumns: "1fr 1fr", 
//               gap: "16px", 
//               marginBottom: "12px",
//               padding: "12px",
//               backgroundColor: "white",
//               borderRadius: "6px",
//               border: "1px solid #e0e0e0"
//             }}>
//               {/* Payment Status */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Received:</span>
//                     <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                       {formatMoney(order.totalReceivedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Total Refunded:</span>
//                     <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                       {formatMoney(order.totalRefundedSet)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Outstanding:</span>
//                     <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                       {formatMoney(order.totalOutstandingSet)}
//                     </span>
//                   </div>
                 
//                   {orderRefundDiscrepancy !== 0 && (
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Refund Discrepancy:</span>
//                       <span style={{ 
//                         fontWeight: "bold", 
//                         color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                         backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                         padding: "2px 6px",
//                         borderRadius: "4px"
//                       }}>
//                         ${Math.abs(orderRefundDiscrepancy).toFixed(2)} 
//                         ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                         <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                           (Shopify)
//                         </span>
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                     <span>Fully Paid:</span>
//                     <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                       {order.fullyPaid ? "Yes" : "No"}
//                     </span>
//                   </div>
//                 </div>
//               </div>

//               {/* Order Summary */}
//               <div>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                 <div style={{ fontSize: "14px" }}>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Line Items Total:</span>
//                     <span>${orderLineItemsTotal.toFixed(2)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Subtotal:</span>
//                     <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                   </div>
//                                    <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     marginBottom: "4px",
//                     fontWeight: "bold"
//                   }}>
//                     <span>Shipping Charges:</span>
//                     <span>
//                       ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                     </span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Tax:</span>
//                     <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                   </div>
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Discounts:</span>
//                     <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                   </div>

//                                     {/* Return Fees */}
//                                  {/* Return Fees - Combined Display */}
//                              {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                     <div style={{ 
//                       display: "flex", 
//                       justifyContent: "space-between", 
//                       marginBottom: "4px",
//                       backgroundColor: "#f8f9fa",
//                       padding: "4px 8px",
//                       borderRadius: "4px",
//                       border: "1px solid #e9ecef"
//                     }}>
//                       <span>Return Fees:</span>
//                       <span style={{ color: "#856404", fontWeight: "bold" }}>
//                         ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                         <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                           (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                         </span>
//                       </span>
//                     </div>
//                   )}
//                   <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                     <span>Original Total:</span>
//                     <span>{formatMoney(order.totalPriceSet)}</span>
//                   </div>
//                   <div style={{ 
//                     display: "flex", 
//                     justifyContent: "space-between", 
//                     borderTop: "1px solid #ddd", 
//                     marginTop: "4px", 
//                     paddingTop: "4px", 
//                     fontWeight: "bold",
//                     backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                     padding: '4px',
//                     borderRadius: '4px'
//                   }}>
//                     <span>Current Total:</span>
//                     <span style={{ 
//                       color: hasPriceAdjustment ? "#856404" : "inherit"
//                     }}>
//                       {formatMoney(order.currentTotalPriceSet)}
//                       {hasPriceAdjustment && (
//                         <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                           (adjusted)
//                         </span>
//                       )}
//                     </span>
//                   </div>
                  
//                   {/* Gross Returns Calculation */}
//                                     {/* Gross Returns Calculation */}
//                   {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                     <>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginTop: "8px", 
//                         paddingTop: "8px", 
//                         borderTop: "1px solid #ddd",
//                         fontSize: "13px"
//                       }}>
//                         <span>Gross Sales:</span>
//                         <span style={{ fontWeight: "bold", color: "#155724" }}>
//                           ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
//                                                   {order.calculatedGrossReturns > 0 && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           fontSize: "13px",
//                           fontWeight: "bold"
//                         }}>
//                           <span>Returns:</span>
//                           <span style={{ color: "#721c24" }}>
//                             -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                           </span>
//                         </div>
//                       )}
//                                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                           <span>Return Fees:</span>
//                           <span style={{ fontWeight: "bold", color: "#856404" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         fontSize: "13px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Net Sales:</span>
//                         <span style={{ color: "#004085" }}>
//                           ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                         </span>
//                       </div>
                 
                      
//                       {/* Total Sales Section */}
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         fontSize: "13px",
//                         fontWeight: "bold",
//                         backgroundColor: "#e6f3ff",
//                         padding: "4px 8px",
//                         borderRadius: "4px",
//                         border: "1px solid #b3d9ff",
//                         marginTop: "8px"
//                       }}>
//                         <span>Total Sales:</span>
//                         <span style={{ color: "#0066cc" }}>
//                           ${(order.calculatedGrossSales + 
//                              order.calculatedShippingCharges + 
//                              order.calculatedTotalReturnFees + 
//                              (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                              (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                              parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                             ).toFixed(2)}
//                         </span>
//                       </div>
//                     </>
//                   )}
                  
//                 </div>
//               </div>
//             </div>

//             {/* Refunds Section */}
//             {order.refunds && order.refunds.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                 {order.refunds.map((refund: any, index: number) => {
//                   const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                     return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                   }, 0) || 0;

//                   return (
//                     <div 
//                       key={refund.id} 
//                       style={{ 
//                         padding: "12px",
//                         backgroundColor: "white",
//                         borderRadius: "6px",
//                         marginBottom: "8px",
//                         border: "1px solid #e0e0e0"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                         <div>
//                           <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                           <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                             {new Date(refund.createdAt).toLocaleString()}
//                           </p>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                             {formatMoney(refund.totalRefundedSet)}
//                           </p>
//                         </div>
//                       </div>
                      
//                       {refund.note && (
//                         <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                           Note: "{refund.note}"
//                         </p>
//                       )}

//                       <div style={{ fontSize: "14px" }}>
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                           <span>Line Items Refunded:</span>
//                           <span>${lineItemsRefunded.toFixed(2)}</span>
//                         </div>
//                       </div>

//                       {/* Refund Line Items */}
//                       {refund.refundLineItems?.edges?.length > 0 && (
//                         <details style={{ marginTop: "8px" }}>
//                           <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                           <div style={{ marginTop: "8px" }}>
//                             {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                               <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                 {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                               </div>
//                             ))}
//                           </div>
//                         </details>
//                       )}
//                     </div>
//                   );
//                 })}
//               </div>
//             )}

//             {/* Shipping & Notes */}
//             <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//               <div>
//                 {order.shippingLine && (
//                   <div>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                     <p style={{ margin: "0", fontSize: "14px" }}>
//                       {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                       {order.shippingLine.discountedPriceSet && (
//                         <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                           (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                         </span>
//                       )}
//                     </p>
//                   </div>
//                 )}
                
//                 {order.note && (
//                   <>
//                     <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                     <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                   </>
//                 )}
//               </div>
//               <div></div>
//             </div>

//             {/* Discounts */}
//             {order.discountApplications?.edges?.length > 0 && (
//               <div style={{ marginBottom: "12px" }}>
//                 <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                 <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                   {order.discountApplications.edges.map((discount: any, index: number) => (
//                     <li key={index}>
//                       {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                       {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                       {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                     </li>
//                   ))}
//                 </ul>
//               </div>
//             )}

//             {/* Line Items */}
//             <details style={{ marginTop: "8px" }}>
//               <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//               <div style={{ marginTop: "8px" }}>
//                 {order.lineItems.edges.map((li: any, i: number) => (
//                   <div 
//                     key={li.node.id} 
//                     style={{ 
//                       padding: "8px",
//                       backgroundColor: "white",
//                       borderRadius: "4px",
//                       marginBottom: "4px",
//                       border: "1px solid #eee"
//                     }}
//                   >
//                     <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                       <div style={{ flex: 1 }}>
//                         <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                         <div style={{ fontSize: "12px", color: "#666" }}>
//                           {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                           SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                         </div>
//                       </div>
//                       <div style={{ textAlign: "right" }}>
//                         <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                         <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                       </div>
//                     </div>
                    
//                     {li.node.taxLines && li.node.taxLines.length > 0 && (
//                       <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                         <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                           <span key={index}>
//                             {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                             {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                           </span>
//                         ))}
//                       </div>
//                     )}
//                   </div>
//                 ))}
//               </div>
//             </details>

//             {/* Fulfillments */}
//             {order.fulfillments?.length > 0 && (
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.fulfillments.map((fulfillment: any) => (
//                     <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                       <div><strong>Status:</strong> {fulfillment.status}</div>
//                       <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                       {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                         <div>
//                           <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                           {fulfillment.trackingInfo.url && (
//                             <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                               (Track)
//                             </a>
//                           )}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>
//             )}

//             {/* Cancellation Info */}
//             {order.cancelledAt && (
//               <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                 <strong>Order Cancelled</strong>
//                 <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                 {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//               </div>
//             )}
//           </div>
//         );
//       })}
//     </div>
//   );
// }
































































































































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders and separate gift card transactions
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') ||
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       processRegularOrder(order, regularOrders);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') &&
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - split into regular and gift card portions
//         processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//       } else {
//         // Pure gift card order
//         processGiftCardOrder(order, giftCardOrders);
//       }
//     }
//   });

//   function processRegularOrder(order: any, targetArray: any[]) {
//     const processed = calculateOrderMetrics(order);
//     targetArray.push(processed);
//   }

//   function processGiftCardOrder(order: any, targetArray: any[]) {
//     const processed = calculateOrderMetrics(order);
//     processed.isGiftCardOrder = true;
//     targetArray.push(processed);
//   }

//   function processMixedOrder(
//     order: any, 
//     regularLineItems: any[], 
//     giftCardLineItems: any[], 
//     regularTarget: any[], 
//     giftCardTarget: any[]
//   ) {
//     // Calculate totals for regular items
//     const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//       return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0);

//     const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//       return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalSubtotal = regularSubtotal + giftCardSubtotal;
//     const regularRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//     const giftCardRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;

//     // Create regular portion
//     const regularPortion = {
//       ...order,
//       lineItems: { edges: regularLineItems },
//       isMixedOrderRegular: true,
//       originalOrderName: order.name,
//       calculatedRatio: regularRatio
//     };
//     const processedRegular = calculateOrderMetrics(regularPortion);
//     regularTarget.push(processedRegular);

//     // Create gift card portion
//     const giftCardPortion = {
//       ...order,
//       lineItems: { edges: giftCardLineItems },
//       isMixedOrderGiftCard: true,
//       originalOrderName: order.name,
//       calculatedRatio: giftCardRatio
//     };
//     const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//     giftCardTarget.push(processedGiftCard);
//   }

//   function calculateOrderMetrics(order: any) {
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Get refund discrepancy directly from Shopify
//     const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items)
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate net returns (gross returns minus over-refunds only)
//     const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//     // Calculate refunded shipping
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Calculate shipping charges
//     const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//     const shippingCharges = shippingAmount - refundedShipping;

//     // Calculate restocking fees and return shipping fees
//     let totalRestockingFees = 0;
//     let totalReturnShippingFees = 0;

//     order.returns?.nodes?.forEach((returnItem: any) => {
//       // Calculate restocking fees from return line items
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//           totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//         }
//       });

//       // Calculate return shipping fees - it's an array!
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         if (shippingFee?.amountSet?.shopMoney?.amount) {
//           totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//         }
//       });
//     });

//     // Calculate total return fees
//     const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//     // Calculate sales metrics
//     const grossSales = subtotal + discounts;
    
//     // Net Sales = Gross Sales - Returns (including over-refunds) - Discounts
//     const netSales = grossSales - (grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0)) - discounts;

//     return {
//       ...order,
//       calculatedGrossSales: grossSales,
//       calculatedGrossReturns: grossReturns,
//       calculatedNetReturns: netReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales,
//       calculatedRefundDiscrepancy: refundDiscrepancy,
//       calculatedRestockingFees: totalRestockingFees,
//       calculatedReturnShippingFees: totalReturnShippingFees,
//       calculatedTotalReturnFees: totalReturnFees,
//       calculatedShippingCharges: shippingCharges
//     };
//   }

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//   return json({ 
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// // OrderDisplaySection component defined outside the main component
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false 
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean 
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       <div>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Individual Order Details ({orders.length} orders)
//         </h3>
//         {orders.map((order: any) => {
//           // Calculate line items total for this order
//           const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//             return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//           }, 0) || 0;

//           // Get refund discrepancy directly from Shopify
//           const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//           // Calculate refunded shipping for this order
//           const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//           // Check if current total differs from original total
//           const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//           return (
//             <div 
//               key={order.id} 
//               style={{ 
//                 border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                 borderRadius: "8px",
//                 padding: "12px",
//                 marginBottom: "12px",
//                 backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//               }}
//             >
//               {/* Order Header */}
//               <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                 <div>
//                   <h3 style={{ margin: "0 0 4px 0" }}>
//                     {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                       <span>
//                         {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                         </span>
//                       </span>
//                     ) : (
//                       <span>
//                         {order.name} (Order #{getOrderNumber(order.name)})
//                       </span>
//                     )}
//                     {order.fullyPaid && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#28a745", 
//                         color: "white", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         Fully Paid
//                       </span>
//                     )}
//                     {order.refunds && order.refunds.length > 0 && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#dc3545", 
//                         color: "white", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                       </span>
//                     )}

//                     {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#ffc107", 
//                         color: "#212529", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                       </span>
//                     )}

//                     {hasPriceAdjustment && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#ffc107", 
//                         color: "#212529", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         Price Adjusted
//                       </span>
//                     )}
//                   </h3>
//                   <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                     Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                   </p>
//                 </div>
//                 <div style={{ textAlign: "right" }}>
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Created: {new Date(order.createdAt).toLocaleString()}
//                   </p>
//                   {order.updatedAt && (
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Updated: {new Date(order.updatedAt).toLocaleString()}
//                     </p>
//                   )}
//                 </div>
//               </div>

//               {/* Enhanced Financial Details */}
//               <div style={{ 
//                 display: "grid", 
//                 gridTemplateColumns: "1fr 1fr", 
//                 gap: "16px", 
//                 marginBottom: "12px",
//                 padding: "12px",
//                 backgroundColor: "white",
//                 borderRadius: "6px",
//                 border: "1px solid #e0e0e0"
//               }}>
//                 {/* Payment Status */}
//                 <div>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                   <div style={{ fontSize: "14px" }}>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Total Received:</span>
//                       <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                         {formatMoney(order.totalReceivedSet)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Total Refunded:</span>
//                       <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                         {formatMoney(order.totalRefundedSet)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Outstanding:</span>
//                       <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                         {formatMoney(order.totalOutstandingSet)}
//                       </span>
//                     </div>
                  
//                     {orderRefundDiscrepancy !== 0 && (
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Refund Discrepancy:</span>
//                         <span style={{ 
//                           fontWeight: "bold", 
//                           color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                           backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                           padding: "2px 6px",
//                           borderRadius: "4px"
//                         }}>
//                           {formatMoneyWithSign(orderRefundDiscrepancy)}
//                           ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                           <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                             (Shopify)
//                           </span>
//                         </span>
//                       </div>
//                     )}
//                     <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                       <span>Fully Paid:</span>
//                       <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                         {order.fullyPaid ? "Yes" : "No"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>

//                 {/* Order Summary */}
//                 <div>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                   <div style={{ fontSize: "14px" }}>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Line Items Total:</span>
//                       <span>${orderLineItemsTotal.toFixed(2)}</span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Subtotal:</span>
//                       <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                     </div>
//                     <div style={{ 
//                       display: "flex", 
//                       justifyContent: "space-between", 
//                       marginBottom: "4px",
//                       fontWeight: "bold"
//                     }}>
//                       <span>Shipping Charges:</span>
//                       <span>
//                         ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Tax:</span>
//                       <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Discounts:</span>
//                       <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                     </div>

//                     {/* Return Fees */}
//                     {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         backgroundColor: "#f8f9fa",
//                         padding: "4px 8px",
//                         borderRadius: "4px",
//                         border: "1px solid #e9ecef"
//                       }}>
//                         <span>Return Fees:</span>
//                         <span style={{ color: "#856404", fontWeight: "bold" }}>
//                           ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                           <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                             (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                           </span>
//                         </span>
//                       </div>
//                     )}
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Original Total:</span>
//                       <span>{formatMoney(order.totalPriceSet)}</span>
//                     </div>
//                     <div style={{ 
//                       display: "flex", 
//                       justifyContent: "space-between", 
//                       borderTop: "1px solid #ddd", 
//                       marginTop: "4px", 
//                       paddingTop: "4px", 
//                       fontWeight: "bold",
//                       backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                       padding: '4px',
//                       borderRadius: '4px'
//                     }}>
//                       <span>Current Total:</span>
//                       <span style={{ 
//                         color: hasPriceAdjustment ? "#856404" : "inherit"
//                       }}>
//                         {formatMoney(order.currentTotalPriceSet)}
//                         {hasPriceAdjustment && (
//                           <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                             (adjusted)
//                           </span>
//                         )}
//                       </span>
//                     </div>
                    
//                     {/* Gross Returns Calculation */}
//                     {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                       <>
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginTop: "8px", 
//                           paddingTop: "8px", 
//                           borderTop: "1px solid #ddd",
//                           fontSize: "13px"
//                         }}>
//                           <span>Gross Sales:</span>
//                           <span style={{ fontWeight: "bold", color: "#155724" }}>
//                             ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
//                         {order.calculatedGrossReturns > 0 && (
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Returns:</span>
//                             <span style={{ color: "#721c24" }}>
//                               -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                             </span>
//                           </div>
//                         )}
//                         {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                           <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                             <span>Return Fees:</span>
//                             <span style={{ fontWeight: "bold", color: "#856404" }}>
//                               ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             </span>
//                           </div>
//                         )}
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           fontSize: "13px",
//                           fontWeight: "bold"
//                         }}>
//                           <span>Net Sales:</span>
//                           <span style={{ color: "#004085" }}>
//                             ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
                      
//                         {/* Total Sales Section */}
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           fontSize: "13px",
//                           fontWeight: "bold",
//                           backgroundColor: "#e6f3ff",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #b3d9ff",
//                           marginTop: "8px"
//                         }}>
//                           <span>Total Sales:</span>
//                           <span style={{ color: "#0066cc" }}>
//                             ${(order.calculatedGrossSales + 
//                               order.calculatedShippingCharges + 
//                               order.calculatedTotalReturnFees + 
//                               (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                               (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                               parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                               ).toFixed(2)}
//                           </span>
//                         </div>
//                       </>
//                     )}
//                   </div>
//                 </div>
//               </div>

//               {/* Refunds Section */}
//               {order.refunds && order.refunds.length > 0 && (
//                 <div style={{ marginBottom: "12px" }}>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                   {order.refunds.map((refund: any, index: number) => {
//                     const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                       return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                     }, 0) || 0;

//                     return (
//                       <div 
//                         key={refund.id} 
//                         style={{ 
//                           padding: "12px",
//                           backgroundColor: "white",
//                           borderRadius: "6px",
//                           marginBottom: "8px",
//                           border: "1px solid #e0e0e0"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                           <div>
//                             <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                             <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                               {new Date(refund.createdAt).toLocaleString()}
//                             </p>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                               {formatMoney(refund.totalRefundedSet)}
//                             </p>
//                           </div>
//                         </div>
                        
//                         {refund.note && (
//                           <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                             Note: "{refund.note}"
//                           </p>
//                         )}

//                         <div style={{ fontSize: "14px" }}>
//                           <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                             <span>Line Items Refunded:</span>
//                             <span>${lineItemsRefunded.toFixed(2)}</span>
//                           </div>
//                         </div>

//                         {/* Refund Line Items */}
//                         {refund.refundLineItems?.edges?.length > 0 && (
//                           <details style={{ marginTop: "8px" }}>
//                             <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                             <div style={{ marginTop: "8px" }}>
//                               {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                 <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                   {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                 </div>
//                               ))}
//                             </div>
//                           </details>
//                         )}
//                       </div>
//                     );
//                   })}
//                 </div>
//               )}

//               {/* Shipping & Notes */}
//               <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                 <div>
//                   {order.shippingLine && (
//                     <div>
//                       <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                       <p style={{ margin: "0", fontSize: "14px" }}>
//                         {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                         {order.shippingLine.discountedPriceSet && (
//                           <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                             (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                           </span>
//                         )}
//                       </p>
//                     </div>
//                   )}
                  
//                   {order.note && (
//                     <>
//                       <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                       <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                     </>
//                   )}
//                 </div>
//                 <div></div>
//               </div>

//               {/* Discounts */}
//               {order.discountApplications?.edges?.length > 0 && (
//                 <div style={{ marginBottom: "12px" }}>
//                   <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                   <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                     {order.discountApplications.edges.map((discount: any, index: number) => (
//                       <li key={index}>
//                         {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                         {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                         {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                       </li>
//                     ))}
//                   </ul>
//                 </div>
//               )}

//               {/* Line Items */}
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.lineItems.edges.map((li: any, i: number) => (
//                     <div 
//                       key={li.node.id} 
//                       style={{ 
//                         padding: "8px",
//                         backgroundColor: "white",
//                         borderRadius: "4px",
//                         marginBottom: "4px",
//                         border: "1px solid #eee"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                         <div style={{ flex: 1 }}>
//                           <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                           <div style={{ fontSize: "12px", color: "#666" }}>
//                             {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                             SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                           </div>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                           <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                         </div>
//                       </div>
                      
//                       {li.node.taxLines && li.node.taxLines.length > 0 && (
//                         <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                           <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                             <span key={index}>
//                               {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                               {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                             </span>
//                           ))}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>

//               {/* Fulfillments */}
//               {order.fulfillments?.length > 0 && (
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.fulfillments.map((fulfillment: any) => (
//                       <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                         <div><strong>Status:</strong> {fulfillment.status}</div>
//                         <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                         {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                           <div>
//                             <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                             {fulfillment.trackingInfo.url && (
//                               <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                 (Track)
//                               </a>
//                             )}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>
//               )}

//               {/* Cancellation Info */}
//               {order.cancelledAt && (
//                 <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                   <strong>Order Cancelled</strong>
//                   <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                   {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// };

// export default function OrdersLast7Days() {
//   const { regularOrders, giftCardOrders } = useLoaderData<typeof loader>();

//   // Calculate summary statistics for regular orders
//   const calculateSummary = (orders: any[]) => {
//     const totalRevenue = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalReceived = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalRefunded = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalOutstanding = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalDiscounts = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShipping = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShippingCharges = totalShipping - totalShippingRefunds;

//     const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedRefundDiscrepancy || 0);
//     }, 0);

//     const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedGrossReturns || 0);
//     }, 0);

//     const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//     const totalGrossSales = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedGrossSales || 0);
//     }, 0);

//     const totalNetSales = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedNetSales || 0);
//     }, 0);

//     const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//       const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//         return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;
//       return sum + lineItemsTotal;
//     }, 0);

//     const totalTaxes = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalOrders = orders.length;
//     const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//     const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//     const ordersWithRefunds = orders.filter((order: any) => 
//       order.refunds && order.refunds.length > 0
//     ).length;

//     const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedRestockingFees || 0);
//     }, 0);

//     const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedReturnShippingFees || 0);
//     }, 0);

//     const ordersWithReturns = orders.filter((order: any) => 
//       order.returns?.nodes && order.returns.nodes.length > 0
//     ).length;

//     const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//     // Count orders by financial status
//     const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//       const status = order.displayFinancialStatus || 'unknown';
//       acc[status] = (acc[status] || 0) + 1;
//       return acc;
//     }, {});

//     // Count orders by fulfillment status
//     const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//       const status = order.displayFulfillmentStatus || 'unknown';
//       acc[status] = (acc[status] || 0) + 1;
//       return acc;
//     }, {});

//     return {
//       totalRevenue,
//       totalReceived,
//       totalRefunded,
//       totalOutstanding,
//       totalDiscounts,
//       totalShippingCharges,
//       totalRefundDiscrepancy,
//       totalReturns,
//       totalGrossSales,
//       totalNetSales,
//       totalLineItemsPrice,
//       totalTaxes,
//       totalOrders,
//       averageOrderValue,
//       fullyPaidOrders,
//       ordersWithRefunds,
//       totalRestockingFees,
//       totalReturnShippingFees,
//       ordersWithReturns,
//       totalSales,
//       financialStatusCounts,
//       fulfillmentStatusCounts
//     };
//   };

//   const regularSummary = calculateSummary(regularOrders);
//   const giftCardSummary = calculateSummary(giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       {/* Regular Orders Section */}
//       <OrderDisplaySection 
//         orders={regularOrders} 
//         summary={regularSummary} 
//         title="Regular Orders Last 7 Days" 
//         isGiftCard={false}
//       />

//       {/* Gift Card Orders Section */}
//       <OrderDisplaySection 
//         orders={giftCardOrders} 
//         summary={giftCardSummary} 
//         title="Gift Card Orders Last 7 Days" 
//         isGiftCard={true}
//       />
//     </div>
//   );
// }

















































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate last 7 days date range
//   const now = new Date();
//   const past = new Date();
//   past.setDate(now.getDate() - 7);

//   const dateQuery = `created_at:>=${past.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast7Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const orders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders and separate gift card transactions
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') ||
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       processRegularOrder(order, regularOrders);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') &&
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - split into regular and gift card portions
//         processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//       } else {
//         // Pure gift card order
//         processGiftCardOrder(order, giftCardOrders);
//       }
//     }
//   });

//   function processRegularOrder(order: any, targetArray: any[]) {
//     const processed = calculateOrderMetrics(order);
//     targetArray.push(processed);
//   }

//   function processGiftCardOrder(order: any, targetArray: any[]) {
//     const processed = calculateOrderMetrics(order);
//     processed.isGiftCardOrder = true;
//     targetArray.push(processed);
//   }

//   function processMixedOrder(
//     order: any, 
//     regularLineItems: any[], 
//     giftCardLineItems: any[], 
//     regularTarget: any[], 
//     giftCardTarget: any[]
//   ) {
//     // Calculate totals for regular items
//     const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//       return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0);

//     const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//       return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalSubtotal = regularSubtotal + giftCardSubtotal;
    
//     // Avoid division by zero
//     const regularRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//     const giftCardRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;

//     // Helper function to split money sets
//     const splitMoneySet = (moneySet: any, ratio: number) => {
//       if (!moneySet?.shopMoney) return moneySet;
//       const originalAmount = parseFloat(moneySet.shopMoney.amount || 0);
//       return {
//         shopMoney: {
//           ...moneySet.shopMoney,
//           amount: (originalAmount * ratio).toFixed(2)
//         }
//       };
//     };

//     // Helper function to split refunds
//     const splitRefunds = (refunds: any[], ratio: number) => {
//       if (!refunds) return [];
//       return refunds.map((refund: any) => ({
//         ...refund,
//         totalRefundedSet: splitMoneySet(refund.totalRefundedSet, ratio),
//         refundLineItems: {
//           edges: refund.refundLineItems?.edges?.map((edge: any) => ({
//             ...edge,
//             node: {
//               ...edge.node,
//               subtotalSet: splitMoneySet(edge.node.subtotalSet, ratio),
//               totalTaxSet: splitMoneySet(edge.node.totalTaxSet, ratio)
//             }
//           })) || []
//         }
//       }));
//     };

//     // Helper function to split returns
//     const splitReturns = (returns: any, ratio: number) => {
//       if (!returns?.nodes) return returns;
//       return {
//         nodes: returns.nodes.map((returnItem: any) => ({
//           ...returnItem,
//           returnLineItems: {
//             nodes: returnItem.returnLineItems?.nodes?.map((lineItem: any) => ({
//               ...lineItem,
//               restockingFee: lineItem.restockingFee ? {
//                 amountSet: splitMoneySet(lineItem.restockingFee.amountSet, ratio)
//               } : null
//             })) || []
//           },
//           returnShippingFees: returnItem.returnShippingFees?.map((fee: any) => ({
//             amountSet: splitMoneySet(fee.amountSet, ratio)
//           })) || []
//         }))
//       };
//     };

//     // Create regular portion with split financial data
//     const regularPortion = {
//       ...order,
//       // Split line items
//       lineItems: { edges: regularLineItems },
      
//       // Split financial data using regular ratio
//       subtotalPriceSet: splitMoneySet(order.subtotalPriceSet, regularRatio),
//       currentSubtotalPriceSet: splitMoneySet(order.currentSubtotalPriceSet, regularRatio),
//       totalPriceSet: splitMoneySet(order.totalPriceSet, regularRatio),
//       currentTotalPriceSet: splitMoneySet(order.currentTotalPriceSet, regularRatio),
      
//       // Split payment data
//       totalReceivedSet: splitMoneySet(order.totalReceivedSet, regularRatio),
//       totalRefundedSet: splitMoneySet(order.totalRefundedSet, regularRatio),
//       totalOutstandingSet: splitMoneySet(order.totalOutstandingSet, regularRatio),
      
//       // Split costs and fees
//       totalDiscountsSet: splitMoneySet(order.totalDiscountsSet, regularRatio),
//       totalShippingPriceSet: splitMoneySet(order.totalShippingPriceSet, regularRatio),
//       totalRefundedShippingSet: splitMoneySet(order.totalRefundedShippingSet, regularRatio),
//       refundDiscrepancySet: splitMoneySet(order.refundDiscrepancySet, regularRatio),
//       currentTotalTaxSet: splitMoneySet(order.currentTotalTaxSet, regularRatio),
//       currentTotalDiscountsSet: splitMoneySet(order.currentTotalDiscountsSet, regularRatio),
      
//       // Split refunds and returns
//       refunds: splitRefunds(order.refunds, regularRatio),
//       returns: splitReturns(order.returns, regularRatio),
      
//       // Split shipping line
//       shippingLine: order.shippingLine ? {
//         ...order.shippingLine,
//         originalPriceSet: splitMoneySet(order.shippingLine.originalPriceSet, regularRatio),
//         discountedPriceSet: splitMoneySet(order.shippingLine.discountedPriceSet, regularRatio)
//       } : null,
      
//       // Metadata
//       isMixedOrderRegular: true,
//       originalOrderName: order.name,
//       calculatedRatio: regularRatio,
//       portionSubtotal: regularSubtotal
//     };

//     // Create gift card portion with split financial data
//     const giftCardPortion = {
//       ...order,
//       // Split line items
//       lineItems: { edges: giftCardLineItems },
      
//       // Split financial data using gift card ratio
//       subtotalPriceSet: splitMoneySet(order.subtotalPriceSet, giftCardRatio),
//       currentSubtotalPriceSet: splitMoneySet(order.currentSubtotalPriceSet, giftCardRatio),
//       totalPriceSet: splitMoneySet(order.totalPriceSet, giftCardRatio),
//       currentTotalPriceSet: splitMoneySet(order.currentTotalPriceSet, giftCardRatio),
      
//       // Split payment data
//       totalReceivedSet: splitMoneySet(order.totalReceivedSet, giftCardRatio),
//       totalRefundedSet: splitMoneySet(order.totalRefundedSet, giftCardRatio),
//       totalOutstandingSet: splitMoneySet(order.totalOutstandingSet, giftCardRatio),
      
//       // Split costs and fees
//       totalDiscountsSet: splitMoneySet(order.totalDiscountsSet, giftCardRatio),
//       totalShippingPriceSet: splitMoneySet(order.totalShippingPriceSet, giftCardRatio),
//       totalRefundedShippingSet: splitMoneySet(order.totalRefundedShippingSet, giftCardRatio),
//       refundDiscrepancySet: splitMoneySet(order.refundDiscrepancySet, giftCardRatio),
//       currentTotalTaxSet: splitMoneySet(order.currentTotalTaxSet, giftCardRatio),
//       currentTotalDiscountsSet: splitMoneySet(order.currentTotalDiscountsSet, giftCardRatio),
      
//       // Split refunds and returns
//       refunds: splitRefunds(order.refunds, giftCardRatio),
//       returns: splitReturns(order.returns, giftCardRatio),
      
//       // Split shipping line
//       shippingLine: order.shippingLine ? {
//         ...order.shippingLine,
//         originalPriceSet: splitMoneySet(order.shippingLine.originalPriceSet, giftCardRatio),
//         discountedPriceSet: splitMoneySet(order.shippingLine.discountedPriceSet, giftCardRatio)
//       } : null,
      
//       // Metadata
//       isMixedOrderGiftCard: true,
//       originalOrderName: order.name,
//       calculatedRatio: giftCardRatio,
//       portionSubtotal: giftCardSubtotal
//     };

//     // Process both portions with their own metrics
//     const processedRegular = calculateOrderMetrics(regularPortion);
//     regularTarget.push(processedRegular);

//     const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//     giftCardTarget.push(processedGiftCard);
//   }

//   function calculateOrderMetrics(order: any) {
//     // Use the split financial data from the order
//     const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//     const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//     // Get refund discrepancy directly from Shopify (already split)
//     const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//     // Calculate gross returns (sum of refunded line items) - already split
//     let grossReturns = 0;
//     order.refunds?.forEach((refund: any) => {
//       refund.refundLineItems?.edges?.forEach((edge: any) => {
//         grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//       });
//     });

//     // Calculate net returns (gross returns minus over-refunds only)
//     const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//     // Calculate refunded shipping - already split
//     const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//     // Calculate shipping charges - already split
//     const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//     const shippingCharges = shippingAmount - refundedShipping;

//     // Calculate restocking fees and return shipping fees - already split
//     let totalRestockingFees = 0;
//     let totalReturnShippingFees = 0;

//     order.returns?.nodes?.forEach((returnItem: any) => {
//       // Calculate restocking fees from return line items
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//           totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//         }
//       });

//       // Calculate return shipping fees - it's an array!
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         if (shippingFee?.amountSet?.shopMoney?.amount) {
//           totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//         }
//       });
//     });

//     // Calculate total return fees
//     const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//     // Calculate sales metrics using split data
//     const grossSales = subtotal + discounts;
    
//     // Net Sales = Gross Sales - Returns (including over-refunds) - Discounts
//     const netSales = grossSales - (grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0)) - discounts;

//     return {
//       ...order,
//       calculatedGrossSales: grossSales,
//       calculatedGrossReturns: grossReturns,
//       calculatedNetReturns: netReturns,
//       calculatedRefundedShipping: refundedShipping,
//       calculatedNetSales: netSales,
//       calculatedRefundDiscrepancy: refundDiscrepancy,
//       calculatedRestockingFees: totalRestockingFees,
//       calculatedReturnShippingFees: totalReturnShippingFees,
//       calculatedTotalReturnFees: totalReturnFees,
//       calculatedShippingCharges: shippingCharges
//     };
//   }

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//   return json({ 
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders,
//     shop,
//     dateRange: { 
//       start: past.toISOString(), 
//       end: now.toISOString() 
//     }
//   });
// };

// // OrderDisplaySection component defined outside the main component
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false 
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean 
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       <div>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Individual Order Details ({orders.length} orders)
//         </h3>
//         {orders.map((order: any) => {
//           // Calculate line items total for this order
//           const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//             return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//           }, 0) || 0;

//           // Get refund discrepancy directly from Shopify
//           const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//           // Calculate refunded shipping for this order
//           const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//           // Check if current total differs from original total
//           const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//           return (
//             <div 
//               key={order.id} 
//               style={{ 
//                 border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                 borderRadius: "8px",
//                 padding: "12px",
//                 marginBottom: "12px",
//                 backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//               }}
//             >
//               {/* Order Header */}
//               <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                 <div>
//                   <h3 style={{ margin: "0 0 4px 0" }}>
//                     {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                       <span>
//                         {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                         </span>
//                       </span>
//                     ) : (
//                       <span>
//                         {order.name} (Order #{getOrderNumber(order.name)})
//                       </span>
//                     )}
//                     {order.fullyPaid && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#28a745", 
//                         color: "white", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         Fully Paid
//                       </span>
//                     )}
//                     {order.refunds && order.refunds.length > 0 && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#dc3545", 
//                         color: "white", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                       </span>
//                     )}

//                     {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#ffc107", 
//                         color: "#212529", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                       </span>
//                     )}

//                     {hasPriceAdjustment && (
//                       <span style={{ 
//                         marginLeft: "8px", 
//                         backgroundColor: "#ffc107", 
//                         color: "#212529", 
//                         padding: "2px 8px", 
//                         borderRadius: "12px", 
//                         fontSize: "12px",
//                         fontWeight: "normal"
//                       }}>
//                         Price Adjusted
//                       </span>
//                     )}
//                   </h3>
//                   <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                     Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                   </p>
//                 </div>
//                 <div style={{ textAlign: "right" }}>
//                   <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                     Created: {new Date(order.createdAt).toLocaleString()}
//                   </p>
//                   {order.updatedAt && (
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Updated: {new Date(order.updatedAt).toLocaleString()}
//                     </p>
//                   )}
//                 </div>
//               </div>

//               {/* Enhanced Financial Details */}
//               <div style={{ 
//                 display: "grid", 
//                 gridTemplateColumns: "1fr 1fr", 
//                 gap: "16px", 
//                 marginBottom: "12px",
//                 padding: "12px",
//                 backgroundColor: "white",
//                 borderRadius: "6px",
//                 border: "1px solid #e0e0e0"
//               }}>
//                 {/* Payment Status */}
//                 <div>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                   <div style={{ fontSize: "14px" }}>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Total Received:</span>
//                       <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                         {formatMoney(order.totalReceivedSet)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Total Refunded:</span>
//                       <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                         {formatMoney(order.totalRefundedSet)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Outstanding:</span>
//                       <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                         {formatMoney(order.totalOutstandingSet)}
//                       </span>
//                     </div>
                  
//                     {orderRefundDiscrepancy !== 0 && (
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Refund Discrepancy:</span>
//                         <span style={{ 
//                           fontWeight: "bold", 
//                           color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                           backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                           padding: "2px 6px",
//                           borderRadius: "4px"
//                         }}>
//                           {formatMoneyWithSign(orderRefundDiscrepancy)}
//                           ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                           <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                             (Shopify)
//                           </span>
//                         </span>
//                       </div>
//                     )}
//                     <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                       <span>Fully Paid:</span>
//                       <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                         {order.fullyPaid ? "Yes" : "No"}
//                       </span>
//                     </div>
//                   </div>
//                 </div>

//                 {/* Order Summary */}
//                 <div>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                   <div style={{ fontSize: "14px" }}>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Line Items Total:</span>
//                       <span>${orderLineItemsTotal.toFixed(2)}</span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Subtotal:</span>
//                       <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                     </div>
//                     <div style={{ 
//                       display: "flex", 
//                       justifyContent: "space-between", 
//                       marginBottom: "4px",
//                       fontWeight: "bold"
//                     }}>
//                       <span>Shipping Charges:</span>
//                       <span>
//                         ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                       </span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Tax:</span>
//                       <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                     </div>
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Discounts:</span>
//                       <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                     </div>

//                     {/* Return Fees */}
//                     {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         backgroundColor: "#f8f9fa",
//                         padding: "4px 8px",
//                         borderRadius: "4px",
//                         border: "1px solid #e9ecef"
//                       }}>
//                         <span>Return Fees:</span>
//                         <span style={{ color: "#856404", fontWeight: "bold" }}>
//                           ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                           <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                             (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                           </span>
//                         </span>
//                       </div>
//                     )}
//                     <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                       <span>Original Total:</span>
//                       <span>{formatMoney(order.totalPriceSet)}</span>
//                     </div>
//                     <div style={{ 
//                       display: "flex", 
//                       justifyContent: "space-between", 
//                       borderTop: "1px solid #ddd", 
//                       marginTop: "4px", 
//                       paddingTop: "4px", 
//                       fontWeight: "bold",
//                       backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                       padding: '4px',
//                       borderRadius: '4px'
//                     }}>
//                       <span>Current Total:</span>
//                       <span style={{ 
//                         color: hasPriceAdjustment ? "#856404" : "inherit"
//                       }}>
//                         {formatMoney(order.currentTotalPriceSet)}
//                         {hasPriceAdjustment && (
//                           <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                             (adjusted)
//                           </span>
//                         )}
//                       </span>
//                     </div>
                    
//                     {/* Gross Returns Calculation */}
//                     {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                       <>
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginTop: "8px", 
//                           paddingTop: "8px", 
//                           borderTop: "1px solid #ddd",
//                           fontSize: "13px"
//                         }}>
//                           <span>Gross Sales:</span>
//                           <span style={{ fontWeight: "bold", color: "#155724" }}>
//                             ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
//                         {order.calculatedGrossReturns > 0 && (
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Returns:</span>
//                             <span style={{ color: "#721c24" }}>
//                               -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                             </span>
//                           </div>
//                         )}
//                         {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                           <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                             <span>Return Fees:</span>
//                             <span style={{ fontWeight: "bold", color: "#856404" }}>
//                               ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             </span>
//                           </div>
//                         )}
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           fontSize: "13px",
//                           fontWeight: "bold"
//                         }}>
//                           <span>Net Sales:</span>
//                           <span style={{ color: "#004085" }}>
//                             ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                           </span>
//                         </div>
                      
//                         {/* Total Sales Section */}
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           fontSize: "13px",
//                           fontWeight: "bold",
//                           backgroundColor: "#e6f3ff",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #b3d9ff",
//                           marginTop: "8px"
//                         }}>
//                           <span>Total Sales:</span>
//                           <span style={{ color: "#0066cc" }}>
//                             ${(order.calculatedGrossSales + 
//                               order.calculatedShippingCharges + 
//                               order.calculatedTotalReturnFees + 
//                               (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                               (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                               parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                               ).toFixed(2)}
//                           </span>
//                         </div>
//                       </>
//                     )}
//                   </div>
//                 </div>
//               </div>

//               {/* Refunds Section */}
//               {order.refunds && order.refunds.length > 0 && (
//                 <div style={{ marginBottom: "12px" }}>
//                   <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                   {order.refunds.map((refund: any, index: number) => {
//                     const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                       return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                     }, 0) || 0;

//                     return (
//                       <div 
//                         key={refund.id} 
//                         style={{ 
//                           padding: "12px",
//                           backgroundColor: "white",
//                           borderRadius: "6px",
//                           marginBottom: "8px",
//                           border: "1px solid #e0e0e0"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                           <div>
//                             <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                             <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                               {new Date(refund.createdAt).toLocaleString()}
//                             </p>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                               {formatMoney(refund.totalRefundedSet)}
//                             </p>
//                           </div>
//                         </div>
                        
//                         {refund.note && (
//                           <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                             Note: "{refund.note}"
//                           </p>
//                         )}

//                         <div style={{ fontSize: "14px" }}>
//                           <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                             <span>Line Items Refunded:</span>
//                             <span>${lineItemsRefunded.toFixed(2)}</span>
//                           </div>
//                         </div>

//                         {/* Refund Line Items */}
//                         {refund.refundLineItems?.edges?.length > 0 && (
//                           <details style={{ marginTop: "8px" }}>
//                             <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                             <div style={{ marginTop: "8px" }}>
//                               {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                 <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                   {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                 </div>
//                               ))}
//                             </div>
//                           </details>
//                         )}
//                       </div>
//                     );
//                   })}
//                 </div>
//               )}

//               {/* Shipping & Notes */}
//               <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                 <div>
//                   {order.shippingLine && (
//                     <div>
//                       <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                       <p style={{ margin: "0", fontSize: "14px" }}>
//                         {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                         {order.shippingLine.discountedPriceSet && (
//                           <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                             (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                           </span>
//                         )}
//                       </p>
//                     </div>
//                   )}
                  
//                   {order.note && (
//                     <>
//                       <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                       <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                     </>
//                   )}
//                 </div>
//                 <div></div>
//               </div>

//               {/* Discounts */}
//               {order.discountApplications?.edges?.length > 0 && (
//                 <div style={{ marginBottom: "12px" }}>
//                   <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                   <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                     {order.discountApplications.edges.map((discount: any, index: number) => (
//                       <li key={index}>
//                         {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                         {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                         {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                       </li>
//                     ))}
//                   </ul>
//                 </div>
//               )}

//               {/* Line Items */}
//               <details style={{ marginTop: "8px" }}>
//                 <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                 <div style={{ marginTop: "8px" }}>
//                   {order.lineItems.edges.map((li: any, i: number) => (
//                     <div 
//                       key={li.node.id} 
//                       style={{ 
//                         padding: "8px",
//                         backgroundColor: "white",
//                         borderRadius: "4px",
//                         marginBottom: "4px",
//                         border: "1px solid #eee"
//                       }}
//                     >
//                       <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                         <div style={{ flex: 1 }}>
//                           <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                           <div style={{ fontSize: "12px", color: "#666" }}>
//                             {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                             SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                           </div>
//                         </div>
//                         <div style={{ textAlign: "right" }}>
//                           <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                           <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                         </div>
//                       </div>
                      
//                       {li.node.taxLines && li.node.taxLines.length > 0 && (
//                         <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                           <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                             <span key={index}>
//                               {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                               {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                             </span>
//                           ))}
//                         </div>
//                       )}
//                     </div>
//                   ))}
//                 </div>
//               </details>

//               {/* Fulfillments */}
//               {order.fulfillments?.length > 0 && (
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.fulfillments.map((fulfillment: any) => (
//                       <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                         <div><strong>Status:</strong> {fulfillment.status}</div>
//                         <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                         {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                           <div>
//                             <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                             {fulfillment.trackingInfo.url && (
//                               <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                 (Track)
//                               </a>
//                             )}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>
//               )}

//               {/* Cancellation Info */}
//               {order.cancelledAt && (
//                 <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                   <strong>Order Cancelled</strong>
//                   <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                   {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                 </div>
//               )}
//             </div>
//           );
//         })}
//       </div>
//     </div>
//   );
// };

// export default function OrdersLast7Days() {
//   const { regularOrders, giftCardOrders } = useLoaderData<typeof loader>();

//   // Calculate summary statistics for regular orders
//   const calculateSummary = (orders: any[]) => {
//     const totalRevenue = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalReceived = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalRefunded = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalOutstanding = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalDiscounts = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShipping = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalShippingCharges = totalShipping - totalShippingRefunds;

//     const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedRefundDiscrepancy || 0);
//     }, 0);

//     const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedGrossReturns || 0);
//     }, 0);

//     const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//     const totalGrossSales = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedGrossSales || 0);
//     }, 0);

//     const totalNetSales = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedNetSales || 0);
//     }, 0);

//     const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//       const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//         return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;
//       return sum + lineItemsTotal;
//     }, 0);

//     const totalTaxes = orders.reduce((sum: number, order: any) => {
//       return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//     }, 0);

//     const totalOrders = orders.length;
//     const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//     const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//     const ordersWithRefunds = orders.filter((order: any) => 
//       order.refunds && order.refunds.length > 0
//     ).length;

//     const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedRestockingFees || 0);
//     }, 0);

//     const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//       return sum + (order.calculatedReturnShippingFees || 0);
//     }, 0);

//     const ordersWithReturns = orders.filter((order: any) => 
//       order.returns?.nodes && order.returns.nodes.length > 0
//     ).length;

//     const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//     // Count orders by financial status
//     const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//       const status = order.displayFinancialStatus || 'unknown';
//       acc[status] = (acc[status] || 0) + 1;
//       return acc;
//     }, {});

//     // Count orders by fulfillment status
//     const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//       const status = order.displayFulfillmentStatus || 'unknown';
//       acc[status] = (acc[status] || 0) + 1;
//       return acc;
//     }, {});

//     return {
//       totalRevenue,
//       totalReceived,
//       totalRefunded,
//       totalOutstanding,
//       totalDiscounts,
//       totalShippingCharges,
//       totalRefundDiscrepancy,
//       totalReturns,
//       totalGrossSales,
//       totalNetSales,
//       totalLineItemsPrice,
//       totalTaxes,
//       totalOrders,
//       averageOrderValue,
//       fullyPaidOrders,
//       ordersWithRefunds,
//       totalRestockingFees,
//       totalReturnShippingFees,
//       ordersWithReturns,
//       totalSales,
//       financialStatusCounts,
//       fulfillmentStatusCounts
//     };
//   };

//   const regularSummary = calculateSummary(regularOrders);
//   const giftCardSummary = calculateSummary(giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       {/* Regular Orders Section */}
//       <OrderDisplaySection 
//         orders={regularOrders} 
//         summary={regularSummary} 
//         title="Regular Orders Last 7 Days" 
//         isGiftCard={false}
//       />

//       {/* Gift Card Orders Section */}
//       <OrderDisplaySection 
//         orders={giftCardOrders} 
//         summary={giftCardSummary} 
//         title="Gift Card Orders Last 7 Days" 
//         isGiftCard={true}
//       />
//     </div>
//   );
// }































































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate date ranges for all three sections
//   const now = new Date();
  
//   // Today
//   const todayStart = new Date(now);
//   todayStart.setHours(0, 0, 0, 0);
//   const todayEnd = new Date(now);
//   todayEnd.setHours(23, 59, 59, 999);

//   // Last 7 Days
//   const sevenDaysAgo = new Date(now);
//   sevenDaysAgo.setDate(now.getDate() - 7);
//   sevenDaysAgo.setHours(0, 0, 0, 0);

//   // Last 8 Weeks
//   const eightWeeksAgo = new Date(now);
//   eightWeeksAgo.setDate(now.getDate() - 56); // 8 weeks * 7 days
//   eightWeeksAgo.setHours(0, 0, 0, 0);

//   // Fetch orders for all time periods
//   const dateQuery = `created_at:>=${eightWeeksAgo.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast8Weeks($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders and separate gift card transactions
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate totals for regular items
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;
      
//       // Avoid division by zero
//       const regularRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//       const giftCardRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;

//       // Helper function to split money sets
//       const splitMoneySet = (moneySet: any, ratio: number) => {
//         if (!moneySet?.shopMoney) return moneySet;
//         const originalAmount = parseFloat(moneySet.shopMoney.amount || 0);
//         return {
//           shopMoney: {
//             ...moneySet.shopMoney,
//             amount: (originalAmount * ratio).toFixed(2)
//           }
//         };
//       };

//       // Helper function to split refunds
//       const splitRefunds = (refunds: any[], ratio: number) => {
//         if (!refunds) return [];
//         return refunds.map((refund: any) => ({
//           ...refund,
//           totalRefundedSet: splitMoneySet(refund.totalRefundedSet, ratio),
//           refundLineItems: {
//             edges: refund.refundLineItems?.edges?.map((edge: any) => ({
//               ...edge,
//               node: {
//                 ...edge.node,
//                 subtotalSet: splitMoneySet(edge.node.subtotalSet, ratio),
//                 totalTaxSet: splitMoneySet(edge.node.totalTaxSet, ratio)
//               }
//             })) || []
//           }
//         }));
//       };

//       // Helper function to split returns
//       const splitReturns = (returns: any, ratio: number) => {
//         if (!returns?.nodes) return returns;
//         return {
//           nodes: returns.nodes.map((returnItem: any) => ({
//             ...returnItem,
//             returnLineItems: {
//               nodes: returnItem.returnLineItems?.nodes?.map((lineItem: any) => ({
//                 ...lineItem,
//                 restockingFee: lineItem.restockingFee ? {
//                   amountSet: splitMoneySet(lineItem.restockingFee.amountSet, ratio)
//                 } : null
//               })) || []
//             },
//             returnShippingFees: returnItem.returnShippingFees?.map((fee: any) => ({
//               amountSet: splitMoneySet(fee.amountSet, ratio)
//             })) || []
//           }))
//         };
//       };

//       // Create regular portion with split financial data
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Split financial data using regular ratio
//         subtotalPriceSet: splitMoneySet(order.subtotalPriceSet, regularRatio),
//         currentSubtotalPriceSet: splitMoneySet(order.currentSubtotalPriceSet, regularRatio),
//         totalPriceSet: splitMoneySet(order.totalPriceSet, regularRatio),
//         currentTotalPriceSet: splitMoneySet(order.currentTotalPriceSet, regularRatio),
        
//         // Split payment data
//         totalReceivedSet: splitMoneySet(order.totalReceivedSet, regularRatio),
//         totalRefundedSet: splitMoneySet(order.totalRefundedSet, regularRatio),
//         totalOutstandingSet: splitMoneySet(order.totalOutstandingSet, regularRatio),
        
//         // Split costs and fees
//         totalDiscountsSet: splitMoneySet(order.totalDiscountsSet, regularRatio),
//         totalShippingPriceSet: splitMoneySet(order.totalShippingPriceSet, regularRatio),
//         totalRefundedShippingSet: splitMoneySet(order.totalRefundedShippingSet, regularRatio),
//         refundDiscrepancySet: splitMoneySet(order.refundDiscrepancySet, regularRatio),
//         currentTotalTaxSet: splitMoneySet(order.currentTotalTaxSet, regularRatio),
//         currentTotalDiscountsSet: splitMoneySet(order.currentTotalDiscountsSet, regularRatio),
        
//         // Split refunds and returns
//         refunds: splitRefunds(order.refunds, regularRatio),
//         returns: splitReturns(order.returns, regularRatio),
        
//         // Split shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: splitMoneySet(order.shippingLine.originalPriceSet, regularRatio),
//           discountedPriceSet: splitMoneySet(order.shippingLine.discountedPriceSet, regularRatio)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         calculatedRatio: regularRatio,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with split financial data
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Split financial data using gift card ratio
//         subtotalPriceSet: splitMoneySet(order.subtotalPriceSet, giftCardRatio),
//         currentSubtotalPriceSet: splitMoneySet(order.currentSubtotalPriceSet, giftCardRatio),
//         totalPriceSet: splitMoneySet(order.totalPriceSet, giftCardRatio),
//         currentTotalPriceSet: splitMoneySet(order.currentTotalPriceSet, giftCardRatio),
        
//         // Split payment data
//         totalReceivedSet: splitMoneySet(order.totalReceivedSet, giftCardRatio),
//         totalRefundedSet: splitMoneySet(order.totalRefundedSet, giftCardRatio),
//         totalOutstandingSet: splitMoneySet(order.totalOutstandingSet, giftCardRatio),
        
//         // Split costs and fees
//         totalDiscountsSet: splitMoneySet(order.totalDiscountsSet, giftCardRatio),
//         totalShippingPriceSet: splitMoneySet(order.totalShippingPriceSet, giftCardRatio),
//         totalRefundedShippingSet: splitMoneySet(order.totalRefundedShippingSet, giftCardRatio),
//         refundDiscrepancySet: splitMoneySet(order.refundDiscrepancySet, giftCardRatio),
//         currentTotalTaxSet: splitMoneySet(order.currentTotalTaxSet, giftCardRatio),
//         currentTotalDiscountsSet: splitMoneySet(order.currentTotalDiscountsSet, giftCardRatio),
        
//         // Split refunds and returns
//         refunds: splitRefunds(order.refunds, giftCardRatio),
//         returns: splitReturns(order.returns, giftCardRatio),
        
//         // Split shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: splitMoneySet(order.shippingLine.originalPriceSet, giftCardRatio),
//           discountedPriceSet: splitMoneySet(order.shippingLine.discountedPriceSet, giftCardRatio)
//         } : null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         calculatedRatio: giftCardRatio,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Use the split financial data from the order
//       const subtotal = parseFloat(order.subtotalPriceSet?.shopMoney?.amount || 0);
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify (already split)
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items) - already split
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate net returns (gross returns minus over-refunds only)
//       const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//       // Calculate refunded shipping - already split
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges - already split
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees - already split
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         // Calculate restocking fees from return line items
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         // Calculate return shipping fees - it's an array!
//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // Calculate sales metrics using split data
//       const grossSales = subtotal + discounts;
      
//       // Net Sales = Gross Sales - Returns (including over-refunds) - Discounts
//       const netSales = grossSales - (grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0)) - discounts;

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= todayStart && orderDate <= todayEnd;
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= sevenDaysAgo && orderDate <= now;
//   });

//   const last8WeeksOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= eightWeeksAgo && orderDate <= now;
//   });

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last8WeeksProcessed = processOrders(last8WeeksOrders);

//   // Group last 7 days orders by date for daily breakdown
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     const dateKey = orderDate.toISOString().split('T')[0];
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey),
//         ...processed
//       };
//     });

//   // Group last 8 weeks orders by week for weekly breakdown
//   const last8WeeksByWeek: { [key: string]: any[] } = {};
//   last8WeeksOrders.forEach((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     const weekStart = new Date(orderDate);
//     weekStart.setDate(orderDate.getDate() - orderDate.getDay()); // Start of week (Sunday)
//     const weekKey = weekStart.toISOString().split('T')[0];
//     if (!last8WeeksByWeek[weekKey]) {
//       last8WeeksByWeek[weekKey] = [];
//     }
//     last8WeeksByWeek[weekKey].push(order);
//   });

//   // Process each week for last 8 weeks
//   const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//     .sort()
//     .reverse()
//     .slice(0, 8) // Only take last 8 weeks
//     .map(weekKey => {
//       const weekOrders = last8WeeksByWeek[weekKey];
//       const weekStart = new Date(weekKey);
//       const weekEnd = new Date(weekStart);
//       weekEnd.setDate(weekStart.getDate() + 6);
//       const processed = processOrders(weekOrders);
//       return {
//         weekKey,
//         weekStart,
//         weekEnd,
//         ...processed
//       };
//     });

//   return json({ 
//     // Today
//     today: todayProcessed,
    
//     // Last 7 Days
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
    
//     // Last 8 Weeks
//     last8Weeks: last8WeeksProcessed,
//     last8WeeksWeekly,
    
//     shop,
//     dateRanges: {
//       today: { start: todayStart, end: todayEnd },
//       last7Days: { start: sevenDaysAgo, end: now },
//       last8Weeks: { start: eightWeeksAgo, end: now }
//     }
//   });
// };

// // OrderDisplaySection component (same as before)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                           {order.calculatedGrossReturns > 0 && (
//                             <div style={{ 
//                               display: "flex", 
//                               justifyContent: "space-between", 
//                               fontSize: "13px",
//                               fontWeight: "bold"
//                             }}>
//                               <span>Returns:</span>
//                               <span style={{ color: "#721c24" }}>
//                                 -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                               </span>
//                           </div>
//                           )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary (same as before)
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last8Weeks, last8WeeksWeekly } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
//   const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "30px", textAlign: "center" }}>Orders Analytics Dashboard</h1>

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown</h3>
//           // In the Daily Breakdown section, replace this part:

// {last7DaysDaily.map((day) => {
//   const dayRegularSummary = calculateSummary(day.regularOrders);
//   const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//   return (
//     <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//       <summary style={{ 
//         cursor: "pointer", 
//         fontWeight: "bold", 
//         fontSize: "18px",
//         backgroundColor: "#f8f9fa",
//         padding: "16px",
//         borderRadius: "8px",
//         border: "1px solid #e5e5e5"
//       }}>
//         {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//         <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//           {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//           ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//         </span>
//       </summary>
      
//       <div style={{ marginTop: "16px" }}>
//         {/* Regular Orders for this day */}
//         <OrderDisplaySection 
//           orders={day.regularOrders} 
//           summary={dayRegularSummary} 
//           title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//           isGiftCard={false}
//           showIndividualOrders={false}
//         />

//         {/* Gift Card Orders for this day */}
//         <OrderDisplaySection 
//           orders={day.giftCardOrders} 
//           summary={dayGiftCardSummary} 
//           title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//           isGiftCard={true}
//           showIndividualOrders={false}
//         />
//       </div>
//     </details>
//   );
// })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown</h3>
//        // In the Last 8 Weeks Weekly Breakdown section, replace this part:

// {last8WeeksWeekly.map((week, index) => {
//   const weekRegularSummary = calculateSummary(week.regularOrders);
//   const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//   return (
//     <details key={week.weekKey} style={{ marginBottom: "20px" }}>
//       <summary style={{ 
//         cursor: "pointer", 
//         fontWeight: "bold", 
//         fontSize: "18px",
//         backgroundColor: "#f8f9fa",
//         padding: "16px",
//         borderRadius: "8px",
//         border: "1px solid #e5e5e5"
//       }}>
//         Week {last8WeeksWeekly.length - index}: {new Date(week.weekStart).toLocaleDateString()} - {new Date(week.weekEnd).toLocaleDateString()}
//         <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//           {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//           ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//         </span>
//       </summary>
      
//       <div style={{ marginTop: "16px" }}>
//         {/* Regular Orders for this week */}
//         <OrderDisplaySection 
//           orders={week.regularOrders} 
//           summary={weekRegularSummary} 
//           title={`Regular Orders - Week ${last8WeeksWeekly.length - index}`} 
//           isGiftCard={false}
//           showIndividualOrders={false}
//         />

//         {/* Gift Card Orders for this week */}
//         <OrderDisplaySection 
//           orders={week.giftCardOrders} 
//           summary={weekGiftCardSummary} 
//           title={`Gift Card Orders - Week ${last8WeeksWeekly.length - index}`} 
//           isGiftCard={true}
//           showIndividualOrders={false}
//         />
//       </div>
//     </details>
//   );
// })}
//         </div>
//       </div>
//     </div>
//   );
// }






























































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Calculate date ranges for all three sections
//   const now = new Date();
  
//   // Today
//   const todayStart = new Date(now);
//   todayStart.setHours(0, 0, 0, 0);
//   const todayEnd = new Date(now);
//   todayEnd.setHours(23, 59, 59, 999);

//   // Last 7 Days
//   const sevenDaysAgo = new Date(now);
//   sevenDaysAgo.setDate(now.getDate() - 7);
//   sevenDaysAgo.setHours(0, 0, 0, 0);

//   // Last 8 Weeks
//   const eightWeeksAgo = new Date(now);
//   eightWeeksAgo.setDate(now.getDate() - 56);
//   eightWeeksAgo.setHours(0, 0, 0, 0);

//   // Fetch orders for all time periods
//   const dateQuery = `created_at:>=${eightWeeksAgo.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast8Weeks($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders and separate gift card transactions
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate base subtotals for each portion
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;

//       // Calculate ACTUAL discounts per portion based on line item discounts
//       let regularDiscounts = 0;
//       let giftCardDiscounts = 0;

//       regularLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         regularDiscounts += lineItemDiscount;
//       });

//       giftCardLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         giftCardDiscounts += lineItemDiscount;
//       });

//       // Calculate ACTUAL refunds per portion based on refund line items
//       let regularRefunds = 0;
//       let giftCardRefunds = 0;

//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//           const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//           const lineItemId = refundLine.node.lineItem?.id;
          
//           // Find which portion this refund belongs to by checking line item ID
//           const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//           const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
          
//           if (isRegularRefund) {
//             regularRefunds += refundAmount;
//           } else if (isGiftCardRefund) {
//             giftCardRefunds += refundAmount;
//           }
//         });
//       });

//       // Calculate shipping - only split shipping proportionally if it applies to both
//       const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
      
//       // For shipping, use proportional split since it's usually order-level
//       const regularShippingRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//       const giftCardShippingRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;
      
//       const regularShipping = totalShipping * regularShippingRatio;
//       const giftCardShipping = totalShipping * giftCardShippingRatio;
//       const regularShippingRefunds = totalShippingRefunds * regularShippingRatio;
//       const giftCardShippingRefunds = totalShippingRefunds * giftCardShippingRatio;

//       // Calculate taxes per portion based on actual line item taxes
//       let regularTaxes = 0;
//       let giftCardTaxes = 0;

//       regularLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       giftCardLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Helper function to create money set
//       const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//         return {
//           shopMoney: {
//             amount: amount.toFixed(2),
//             currencyCode
//           }
//         };
//       };

//       // Create regular portion with ACCURATE financial data
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Financial data specific to regular portion - NOT proportional
//         subtotalPriceSet: createMoneySet(regularSubtotal),
//         currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//         totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//         currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//         totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(regularDiscounts),
//         totalShippingPriceSet: createMoneySet(regularShipping),
//         totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(regularTaxes),
//         currentTotalDiscountsSet: createMoneySet(regularDiscounts),
        
//         // Refunds - filter to only include refunds that apply to regular items
//         refunds: order.refunds?.map((refund: any) => {
//           const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (regularRefundItems.length === 0) return null;
          
//           const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//             refundLineItems: { edges: regularRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(regularShipping),
//           discountedPriceSet: createMoneySet(regularShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with ACCURATE financial data
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Financial data specific to gift card portion - NOT proportional
//         subtotalPriceSet: createMoneySet(giftCardSubtotal),
//         currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//         totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//         currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//         totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(giftCardDiscounts),
//         totalShippingPriceSet: createMoneySet(giftCardShipping),
//         totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(giftCardTaxes),
//         currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
        
//         // Refunds - filter to only include refunds that apply to gift card items
//         refunds: order.refunds?.map((refund: any) => {
//           const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (giftCardRefundItems.length === 0) return null;
          
//           const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//             refundLineItems: { edges: giftCardRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(giftCardShipping),
//           discountedPriceSet: createMoneySet(giftCardShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Calculate line items total (ORIGINAL prices before discounts)
//       const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;

//       // Get discounts from the order data
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items)
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate net returns (gross returns minus over-refunds only)
//       const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//       // Calculate refunded shipping
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // CORRECTED: Calculate sales metrics using accurate data
//       // Gross Sales = Original line items total (BEFORE any discounts)
//       const grossSales = lineItemsTotal;
      
//       // Net Sales = Gross Sales - Returns - Discounts
//       const netSales = grossSales - grossReturns - discounts;

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= todayStart && orderDate <= todayEnd;
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= sevenDaysAgo && orderDate <= now;
//   });

//   const last8WeeksOrders = allOrders.filter((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     return orderDate >= eightWeeksAgo && orderDate <= now;
//   });

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last8WeeksProcessed = processOrders(last8WeeksOrders);

//   // Group last 7 days orders by date for daily breakdown
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     const dateKey = orderDate.toISOString().split('T')[0];
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey),
//         ...processed
//       };
//     });

//   // Group last 8 weeks orders by week for weekly breakdown
//   const last8WeeksByWeek: { [key: string]: any[] } = {};
//   last8WeeksOrders.forEach((order: any) => {
//     const orderDate = new Date(order.createdAt);
//     const weekStart = new Date(orderDate);
//     weekStart.setDate(orderDate.getDate() - orderDate.getDay());
//     const weekKey = weekStart.toISOString().split('T')[0];
//     if (!last8WeeksByWeek[weekKey]) {
//       last8WeeksByWeek[weekKey] = [];
//     }
//     last8WeeksByWeek[weekKey].push(order);
//   });

//   // Process each week for last 8 weeks
//   const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//     .sort()
//     .reverse()
//     .slice(0, 8)
//     .map(weekKey => {
//       const weekOrders = last8WeeksByWeek[weekKey];
//       const weekStart = new Date(weekKey);
//       const weekEnd = new Date(weekStart);
//       weekEnd.setDate(weekStart.getDate() + 6);
//       const processed = processOrders(weekOrders);
//       return {
//         weekKey,
//         weekStart,
//         weekEnd,
//         ...processed
//       };
//     });

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last8Weeks: last8WeeksProcessed,
//     last8WeeksWeekly,
//     shop,
//     dateRanges: {
//       today: { start: todayStart, end: todayEnd },
//       last7Days: { start: sevenDaysAgo, end: now },
//       last8Weeks: { start: eightWeeksAgo, end: now }
//     }
//   });
// };

// // OrderDisplaySection component (keep exactly the same as in your original code)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                           {order.calculatedGrossReturns > 0 && (
//                             <div style={{ 
//                               display: "flex", 
//                               justifyContent: "space-between", 
//                               fontSize: "13px",
//                               fontWeight: "bold"
//                             }}>
//                               <span>Returns:</span>
//                               <span style={{ color: "#721c24" }}>
//                                 -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                               </span>
//                           </div>
//                           )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary (same as before)
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last8Weeks, last8WeeksWeekly } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
//   const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "30px", textAlign: "center" }}>Orders Analytics Dashboard</h1>

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown</h3>
//           {last8WeeksWeekly.map((week, index) => {
//             const weekRegularSummary = calculateSummary(week.regularOrders);
//             const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//             return (
//               <details key={week.weekKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   Week {last8WeeksWeekly.length - index}: {new Date(week.weekStart).toLocaleDateString()} - {new Date(week.weekEnd).toLocaleDateString()}
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//                     ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.regularOrders} 
//                     summary={weekRegularSummary} 
//                     title={`Regular Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.giftCardOrders} 
//                     summary={weekGiftCardSummary} 
//                     title={`Gift Card Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }
















































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert dates to store's local time
// const getStoreLocalDate = (date: Date, shopTimezone: string = 'America/New_York') => {
//   return new Date(date.toLocaleString('en-US', { timeZone: shopTimezone }));
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get current time in store's timezone (default to Eastern Time if not available)
//   const storeTimezone = 'America/New_York'; // Default, adjust as needed
  
//   // Calculate date ranges for all three sections using STORE LOCAL TIME
//   const now = getStoreLocalDate(new Date(), storeTimezone);
  
//   // Today (in store's local time)
//   const todayStart = new Date(now);
//   todayStart.setHours(0, 0, 0, 0);
//   const todayEnd = new Date(now);
//   todayEnd.setHours(23, 59, 59, 999);

//   // Last 7 Days (in store's local time)
//   const sevenDaysAgo = new Date(now);
//   sevenDaysAgo.setDate(now.getDate() - 7);
//   sevenDaysAgo.setHours(0, 0, 0, 0);

//   // Last 8 Weeks (in store's local time)
//   const eightWeeksAgo = new Date(now);
//   eightWeeksAgo.setDate(now.getDate() - 56);
//   eightWeeksAgo.setHours(0, 0, 0, 0);

//   // Fetch orders for all time periods
//   const dateQuery = `created_at:>=${eightWeeksAgo.toISOString()} created_at:<=${now.toISOString()}`;

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast8Weeks($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   // Process orders and separate gift card transactions
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate base subtotals for each portion
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;

//       // Calculate ACTUAL discounts per portion based on line item discounts
//       let regularDiscounts = 0;
//       let giftCardDiscounts = 0;

//       regularLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         regularDiscounts += lineItemDiscount;
//       });

//       giftCardLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         giftCardDiscounts += lineItemDiscount;
//       });

//       // Calculate ACTUAL refunds per portion based on refund line items
//       let regularRefunds = 0;
//       let giftCardRefunds = 0;

//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//           const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//           const lineItemId = refundLine.node.lineItem?.id;
          
//           // Find which portion this refund belongs to by checking line item ID
//           const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//           const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
          
//           if (isRegularRefund) {
//             regularRefunds += refundAmount;
//           } else if (isGiftCardRefund) {
//             giftCardRefunds += refundAmount;
//           }
//         });
//       });

//       // Calculate shipping - only split shipping proportionally if it applies to both
//       const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
      
//       // For shipping, use proportional split since it's usually order-level
//       const regularShippingRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//       const giftCardShippingRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;
      
//       const regularShipping = totalShipping * regularShippingRatio;
//       const giftCardShipping = totalShipping * giftCardShippingRatio;
//       const regularShippingRefunds = totalShippingRefunds * regularShippingRatio;
//       const giftCardShippingRefunds = totalShippingRefunds * giftCardShippingRatio;

//       // Calculate taxes per portion based on actual line item taxes
//       let regularTaxes = 0;
//       let giftCardTaxes = 0;

//       regularLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       giftCardLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Helper function to create money set
//       const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//         return {
//           shopMoney: {
//             amount: amount.toFixed(2),
//             currencyCode
//           }
//         };
//       };

//       // Create regular portion with ACCURATE financial data
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Financial data specific to regular portion - NOT proportional
//         subtotalPriceSet: createMoneySet(regularSubtotal),
//         currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//         totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//         currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//         totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(regularDiscounts),
//         totalShippingPriceSet: createMoneySet(regularShipping),
//         totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(regularTaxes),
//         currentTotalDiscountsSet: createMoneySet(regularDiscounts),
        
//         // Refunds - filter to only include refunds that apply to regular items
//         refunds: order.refunds?.map((refund: any) => {
//           const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (regularRefundItems.length === 0) return null;
          
//           const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//             refundLineItems: { edges: regularRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(regularShipping),
//           discountedPriceSet: createMoneySet(regularShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with ACCURATE financial data
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Financial data specific to gift card portion - NOT proportional
//         subtotalPriceSet: createMoneySet(giftCardSubtotal),
//         currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//         totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//         currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//         totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(giftCardDiscounts),
//         totalShippingPriceSet: createMoneySet(giftCardShipping),
//         totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(giftCardTaxes),
//         currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
        
//         // Refunds - filter to only include refunds that apply to gift card items
//         refunds: order.refunds?.map((refund: any) => {
//           const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (giftCardRefundItems.length === 0) return null;
          
//           const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//             refundLineItems: { edges: giftCardRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(giftCardShipping),
//           discountedPriceSet: createMoneySet(giftCardShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Calculate line items total (ORIGINAL prices before discounts)
//       const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;

//       // Get discounts from the order data
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items)
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate net returns (gross returns minus over-refunds only)
//       const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//       // Calculate refunded shipping
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // CORRECTED: Calculate sales metrics using accurate data
//       // Gross Sales = Original line items total (BEFORE any discounts)
//       const grossSales = lineItemsTotal;
      
//       // Net Sales = Gross Sales - Returns - Discounts
//       const netSales = grossSales - grossReturns - discounts;

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDate = getStoreLocalDate(new Date(order.createdAt), storeTimezone);
//     return orderDate >= todayStart && orderDate <= todayEnd;
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDate = getStoreLocalDate(new Date(order.createdAt), storeTimezone);
//     return orderDate >= sevenDaysAgo && orderDate <= now;
//   });

//   const last8WeeksOrders = allOrders.filter((order: any) => {
//     const orderDate = getStoreLocalDate(new Date(order.createdAt), storeTimezone);
//     return orderDate >= eightWeeksAgo && orderDate <= now;
//   });

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last8WeeksProcessed = processOrders(last8WeeksOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDate = getStoreLocalDate(new Date(order.createdAt), storeTimezone);
//     const dateKey = orderDate.toISOString().split('T')[0];
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey),
//         ...processed
//       };
//     });

//   // Group last 8 weeks orders by week for weekly breakdown using STORE LOCAL TIME
//   const last8WeeksByWeek: { [key: string]: any[] } = {};
//   last8WeeksOrders.forEach((order: any) => {
//     const orderDate = getStoreLocalDate(new Date(order.createdAt), storeTimezone);
//     const weekStart = new Date(orderDate);
//     weekStart.setDate(orderDate.getDate() - orderDate.getDay());
//     const weekKey = weekStart.toISOString().split('T')[0];
//     if (!last8WeeksByWeek[weekKey]) {
//       last8WeeksByWeek[weekKey] = [];
//     }
//     last8WeeksByWeek[weekKey].push(order);
//   });

//   // Process each week for last 8 weeks
//   const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//     .sort()
//     .reverse()
//     .slice(0, 8)
//     .map(weekKey => {
//       const weekOrders = last8WeeksByWeek[weekKey];
//       const weekStart = new Date(weekKey);
//       const weekEnd = new Date(weekStart);
//       weekEnd.setDate(weekStart.getDate() + 6);
//       const processed = processOrders(weekOrders);
//       return {
//         weekKey,
//         weekStart,
//         weekEnd,
//         ...processed
//       };
//     });

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last8Weeks: last8WeeksProcessed,
//     last8WeeksWeekly,
//     shop,
//     storeTimezone,
//     dateRanges: {
//       today: { start: todayStart, end: todayEnd },
//       last7Days: { start: sevenDaysAgo, end: now },
//       last8Weeks: { start: eightWeeksAgo, end: now }
//     }
//   });
// };

// // OrderDisplaySection component
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                           {order.calculatedGrossReturns > 0 && (
//                             <div style={{ 
//                               display: "flex", 
//                               justifyContent: "space-between", 
//                               fontSize: "13px",
//                               fontWeight: "bold"
//                             }}>
//                               <span>Returns:</span>
//                               <span style={{ color: "#721c24" }}>
//                                 -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                               </span>
//                           </div>
//                           )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last8Weeks, last8WeeksWeekly, storeTimezone } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
//   const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown</h3>
//           {last8WeeksWeekly.map((week, index) => {
//             const weekRegularSummary = calculateSummary(week.regularOrders);
//             const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//             return (
//               <details key={week.weekKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   Week {last8WeeksWeekly.length - index}: {new Date(week.weekStart).toLocaleDateString()} - {new Date(week.weekEnd).toLocaleDateString()}
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//                     ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.regularOrders} 
//                     summary={weekRegularSummary} 
//                     title={`Regular Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.giftCardOrders} 
//                     summary={weekGiftCardSummary} 
//                     title={`Gift Card Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }














































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone }); // en-CA gives YYYY-MM-DD format
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Helper to check if a UTC date is within last N days in store timezone
// const isWithinLastNDaysInStoreTime = (utcDate: Date, days: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (days ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - days);
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// // Helper to check if a UTC date is within last N weeks in store timezone
// const isWithinLastNWeeksInStoreTime = (utcDate: Date, weeks: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (weeks ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - (weeks * 7));
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   console.log('=== STORE TIME DEBUGGING ===');
//   console.log('Store timezone:', storeTimezone);
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   console.log('Current UTC time:', nowUTC.toISOString());
//   console.log('Today in store time:', todayStore);
  
//   // Calculate reference dates for the queries
//   const eightWeeksAgoUTC = new Date(nowUTC);
//   eightWeeksAgoUTC.setDate(nowUTC.getDate() - 56);
  
//   const sevenDaysAgoUTC = new Date(nowUTC);
//   sevenDaysAgoUTC.setDate(nowUTC.getDate() - 7);

//   console.log('Date ranges for API query:', {
//     eightWeeksAgo: eightWeeksAgoUTC.toISOString(),
//     now: nowUTC.toISOString()
//   });

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${eightWeeksAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;
  
//   console.log('GraphQL query date range:', dateQuery);

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast8Weeks($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   console.log(`Total orders fetched: ${allOrders.length}`);

//   // Process orders and separate gift card transactions (KEEP EXACTLY THE SAME)
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate base subtotals for each portion
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;

//       // Calculate ACTUAL discounts per portion based on line item discounts
//       let regularDiscounts = 0;
//       let giftCardDiscounts = 0;

//       regularLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         regularDiscounts += lineItemDiscount;
//       });

//       giftCardLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         giftCardDiscounts += lineItemDiscount;
//       });

//       // Calculate ACTUAL refunds per portion based on refund line items
//       let regularRefunds = 0;
//       let giftCardRefunds = 0;

//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//           const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//           const lineItemId = refundLine.node.lineItem?.id;
          
//           // Find which portion this refund belongs to by checking line item ID
//           const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//           const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
          
//           if (isRegularRefund) {
//             regularRefunds += refundAmount;
//           } else if (isGiftCardRefund) {
//             giftCardRefunds += refundAmount;
//           }
//         });
//       });

//       // Calculate shipping - only split shipping proportionally if it applies to both
//       const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
      
//       // For shipping, use proportional split since it's usually order-level
//       const regularShippingRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//       const giftCardShippingRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;
      
//       const regularShipping = totalShipping * regularShippingRatio;
//       const giftCardShipping = totalShipping * giftCardShippingRatio;
//       const regularShippingRefunds = totalShippingRefunds * regularShippingRatio;
//       const giftCardShippingRefunds = totalShippingRefunds * giftCardShippingRatio;

//       // Calculate taxes per portion based on actual line item taxes
//       let regularTaxes = 0;
//       let giftCardTaxes = 0;

//       regularLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       giftCardLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Helper function to create money set
//       const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//         return {
//           shopMoney: {
//             amount: amount.toFixed(2),
//             currencyCode
//           }
//         };
//       };

//       // Create regular portion with ACCURATE financial data
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Financial data specific to regular portion - NOT proportional
//         subtotalPriceSet: createMoneySet(regularSubtotal),
//         currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//         totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//         currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//         totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(regularDiscounts),
//         totalShippingPriceSet: createMoneySet(regularShipping),
//         totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(regularTaxes),
//         currentTotalDiscountsSet: createMoneySet(regularDiscounts),
        
//         // Refunds - filter to only include refunds that apply to regular items
//         refunds: order.refunds?.map((refund: any) => {
//           const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (regularRefundItems.length === 0) return null;
          
//           const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//             refundLineItems: { edges: regularRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(regularShipping),
//           discountedPriceSet: createMoneySet(regularShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with ACCURATE financial data
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Financial data specific to gift card portion - NOT proportional
//         subtotalPriceSet: createMoneySet(giftCardSubtotal),
//         currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//         totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//         currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//         totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(giftCardDiscounts),
//         totalShippingPriceSet: createMoneySet(giftCardShipping),
//         totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(giftCardTaxes),
//         currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
        
//         // Refunds - filter to only include refunds that apply to gift card items
//         refunds: order.refunds?.map((refund: any) => {
//           const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (giftCardRefundItems.length === 0) return null;
          
//           const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//             refundLineItems: { edges: giftCardRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(giftCardShipping),
//           discountedPriceSet: createMoneySet(giftCardShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Calculate line items total (ORIGINAL prices before discounts)
//       const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;

//       // Get discounts from the order data
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items)
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate net returns (gross returns minus over-refunds only)
//       const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//       // Calculate refunded shipping
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // CORRECTED: Calculate sales metrics using accurate data
//       // Gross Sales = Original line items total (BEFORE any discounts)
//       const grossSales = lineItemsTotal;
      
//       // Net Sales = Gross Sales - Returns - Discounts
//       const netSales = grossSales - grossReturns - discounts;

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 7, storeTimezone);
//   });

//   const last8WeeksOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNWeeksInStoreTime(orderDateUTC, 8, storeTimezone);
//   });

//   // Debug: log some order dates to verify
//   console.log('Sample order dates for verification:');
//   allOrders.slice(0, 5).forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const isToday = isTodayInStoreTime(orderDateUTC, storeTimezone);
//     console.log(`Order ${order.name}: UTC: ${orderDateUTC.toISOString()} -> Store: ${orderDateStore} -> Today: ${isToday}`);
//   });

//   console.log(`Today orders: ${todayOrders.length}`);
//   console.log(`Last 7 days orders: ${last7DaysOrders.length}`);
//   console.log(`Last 8 weeks orders: ${last8WeeksOrders.length}`);

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last8WeeksProcessed = processOrders(last8WeeksOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // Group last 8 weeks orders by week for weekly breakdown using STORE LOCAL TIME
//   const last8WeeksByWeek: { [key: string]: any[] } = {};
//   last8WeeksOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const weekStart = new Date(orderDateStore + 'T00:00:00');
//     weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Start of week (Sunday)
//     const weekKey = weekStart.toISOString().split('T')[0];
//     if (!last8WeeksByWeek[weekKey]) {
//       last8WeeksByWeek[weekKey] = [];
//     }
//     last8WeeksByWeek[weekKey].push(order);
//   });

//   // Process each week for last 8 weeks
//   const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//     .sort()
//     .reverse()
//     .slice(0, 8)
//     .map(weekKey => {
//       const weekOrders = last8WeeksByWeek[weekKey];
//       const weekStart = new Date(weekKey + 'T00:00:00');
//       const weekEnd = new Date(weekStart);
//       weekEnd.setDate(weekStart.getDate() + 6);
//       const processed = processOrders(weekOrders);
//       return {
//         weekKey,
//         weekStart,
//         weekEnd,
//         ...processed
//       };
//     });

//   console.log('=== END STORE TIME DEBUGGING ===');

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last8Weeks: last8WeeksProcessed,
//     last8WeeksWeekly,
//     shop,
//     storeTimezone,
//     debug: {
//       nowUTC: nowUTC.toISOString(),
//       todayStore,
//       todayOrdersCount: todayOrders.length,
//       sampleOrders: allOrders.slice(0, 3).map((order: any) => ({
//         name: order.name,
//         createdAtUTC: order.createdAt,
//         createdAtStore: getStoreLocalDateString(new Date(order.createdAt), storeTimezone),
//         isToday: isTodayInStoreTime(new Date(order.createdAt), storeTimezone)
//       }))
//     }
//   });
// };

// // ... REST OF THE CODE (OrderDisplaySection, calculateSummary, and OrdersDashboard component)
// // Keep all the remaining code exactly the same as in your original file
// // Only replace the loader function with the one above

// // OrderDisplaySection component (KEEP EXACTLY THE SAME AS BEFORE)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                           {order.calculatedGrossReturns > 0 && (
//                             <div style={{ 
//                               display: "flex", 
//                               justifyContent: "space-between", 
//                               fontSize: "13px",
//                               fontWeight: "bold"
//                             }}>
//                               <span>Returns:</span>
//                               <span style={{ color: "#721c24" }}>
//                                 -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                               </span>
//                           </div>
//                           )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last8Weeks, last8WeeksWeekly, storeTimezone, debug } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
//   const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Debug information */}
//       {debug && (
//         <details style={{ marginBottom: "20px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "5px" }}>
//           <summary>Debug Information</summary>
//           <pre style={{ fontSize: "12px", overflow: "auto" }}>
//             {JSON.stringify(debug, null, 2)}
//           </pre>
//         </details>
//       )}

//       {/* Rest of your dashboard UI remains exactly the same */}
//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders ({today.regularOrders.length + today.giftCardOrders.length} total)
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown</h3>
//           {last8WeeksWeekly.map((week, index) => {
//             const weekRegularSummary = calculateSummary(week.regularOrders);
//             const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//             return (
//               <details key={week.weekKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   Week {last8WeeksWeekly.length - index}: {new Date(week.weekStart).toLocaleDateString()} - {new Date(week.weekEnd).toLocaleDateString()}
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//                     ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.regularOrders} 
//                     summary={weekRegularSummary} 
//                     title={`Regular Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.giftCardOrders} 
//                     summary={weekGiftCardSummary} 
//                     title={`Gift Card Orders - Week ${last8WeeksWeekly.length - index}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }

























































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone }); // en-CA gives YYYY-MM-DD format
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Helper to check if a UTC date is within last N days in store timezone
// const isWithinLastNDaysInStoreTime = (utcDate: Date, days: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (days ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - days);
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   console.log('=== STORE TIME DEBUGGING ===');
//   console.log('Store timezone:', storeTimezone);
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   console.log('Current UTC time:', nowUTC.toISOString());
//   console.log('Today in store time:', todayStore);
  
//   // Calculate reference dates for the queries - 30 days ago for API query
//   const thirtyDaysAgoUTC = new Date(nowUTC);
//   thirtyDaysAgoUTC.setDate(nowUTC.getDate() - 30);
  
//   const sevenDaysAgoUTC = new Date(nowUTC);
//   sevenDaysAgoUTC.setDate(nowUTC.getDate() - 7);

//   console.log('Date ranges for API query:', {
//     thirtyDaysAgo: thirtyDaysAgoUTC.toISOString(),
//     now: nowUTC.toISOString()
//   });

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${thirtyDaysAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;
  
//   console.log('GraphQL query date range:', dateQuery);

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast30Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   console.log(`Total orders fetched: ${allOrders.length}`);

//   // Process orders and separate gift card transactions (KEEP EXACTLY THE SAME)
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate base subtotals for each portion
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;

//       // Calculate ACTUAL discounts per portion based on line item discounts
//       let regularDiscounts = 0;
//       let giftCardDiscounts = 0;

//       regularLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         regularDiscounts += lineItemDiscount;
//       });

//       giftCardLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         giftCardDiscounts += lineItemDiscount;
//       });

//       // Calculate ACTUAL refunds per portion based on refund line items
//       let regularRefunds = 0;
//       let giftCardRefunds = 0;

//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//           const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//           const lineItemId = refundLine.node.lineItem?.id;
          
//           // Find which portion this refund belongs to by checking line item ID
//           const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//           const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
          
//           if (isRegularRefund) {
//             regularRefunds += refundAmount;
//           } else if (isGiftCardRefund) {
//             giftCardRefunds += refundAmount;
//           }
//         });
//       });

//       // Calculate shipping - only split shipping proportionally if it applies to both
//       const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
      
//       // For shipping, use proportional split since it's usually order-level
//       const regularShippingRatio = totalSubtotal > 0 ? regularSubtotal / totalSubtotal : 0;
//       const giftCardShippingRatio = totalSubtotal > 0 ? giftCardSubtotal / totalSubtotal : 0;
      
//       const regularShipping = totalShipping * regularShippingRatio;
//       const giftCardShipping = totalShipping * giftCardShippingRatio;
//       const regularShippingRefunds = totalShippingRefunds * regularShippingRatio;
//       const giftCardShippingRefunds = totalShippingRefunds * giftCardShippingRatio;

//       // Calculate taxes per portion based on actual line item taxes
//       let regularTaxes = 0;
//       let giftCardTaxes = 0;

//       regularLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       giftCardLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Helper function to create money set
//       const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//         return {
//           shopMoney: {
//             amount: amount.toFixed(2),
//             currencyCode
//           }
//         };
//       };

//       // Create regular portion with ACCURATE financial data
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Financial data specific to regular portion - NOT proportional
//         subtotalPriceSet: createMoneySet(regularSubtotal),
//         currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//         totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//         currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//         totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(regularDiscounts),
//         totalShippingPriceSet: createMoneySet(regularShipping),
//         totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(regularTaxes),
//         currentTotalDiscountsSet: createMoneySet(regularDiscounts),
        
//         // Refunds - filter to only include refunds that apply to regular items
//         refunds: order.refunds?.map((refund: any) => {
//           const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (regularRefundItems.length === 0) return null;
          
//           const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//             refundLineItems: { edges: regularRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(regularShipping),
//           discountedPriceSet: createMoneySet(regularShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with ACCURATE financial data
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Financial data specific to gift card portion - NOT proportional
//         subtotalPriceSet: createMoneySet(giftCardSubtotal),
//         currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//         totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//         currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//         totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(giftCardDiscounts),
//         totalShippingPriceSet: createMoneySet(giftCardShipping),
//         totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(giftCardTaxes),
//         currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
        
//         // Refunds - filter to only include refunds that apply to gift card items
//         refunds: order.refunds?.map((refund: any) => {
//           const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (giftCardRefundItems.length === 0) return null;
          
//           const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//             refundLineItems: { edges: giftCardRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(giftCardShipping),
//           discountedPriceSet: createMoneySet(giftCardShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Calculate line items total (ORIGINAL prices before discounts)
//       const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;

//       // Get discounts from the order data
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items)
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate net returns (gross returns minus over-refunds only)
//       const netReturns = grossReturns - (refundDiscrepancy > 0 ? refundDiscrepancy : 0);

//       // Calculate refunded shipping
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // CORRECTED: Calculate sales metrics using accurate data
//       // Gross Sales = Original line items total (BEFORE any discounts)
//       const grossSales = lineItemsTotal;
      
//       // Net Sales = Gross Sales - Returns - Discounts
//       const netSales = grossSales - grossReturns - discounts;

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 7, storeTimezone);
//   });

//   const last30DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 30, storeTimezone);
//   });

//   // Debug: log some order dates to verify
//   console.log('Sample order dates for verification:');
//   allOrders.slice(0, 5).forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const isToday = isTodayInStoreTime(orderDateUTC, storeTimezone);
//     console.log(`Order ${order.name}: UTC: ${orderDateUTC.toISOString()} -> Store: ${orderDateStore} -> Today: ${isToday}`);
//   });

//   console.log(`Today orders: ${todayOrders.length}`);
//   console.log(`Last 7 days orders: ${last7DaysOrders.length}`);
//   console.log(`Last 30 days orders: ${last30DaysOrders.length}`);

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last30DaysProcessed = processOrders(last30DaysOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // Group last 30 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last30DaysByDate: { [key: string]: any[] } = {};
//   last30DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last30DaysByDate[dateKey]) {
//       last30DaysByDate[dateKey] = [];
//     }
//     last30DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 30 days
//   const last30DaysDaily = Object.keys(last30DaysByDate)
//     .sort()
//     .reverse()
//     .slice(0, 30) // Only take last 30 days
//     .map(dateKey => {
//       const dayOrders = last30DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   console.log('=== END STORE TIME DEBUGGING ===');

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last30Days: last30DaysProcessed,
//     last30DaysDaily,
//     shop,
//     storeTimezone,
//     debug: {
//       nowUTC: nowUTC.toISOString(),
//       todayStore,
//       todayOrdersCount: todayOrders.length,
//       last7DaysOrdersCount: last7DaysOrders.length,
//       last30DaysOrdersCount: last30DaysOrders.length,
//       sampleOrders: allOrders.slice(0, 3).map((order: any) => ({
//         name: order.name,
//         createdAtUTC: order.createdAt,
//         createdAtStore: getStoreLocalDateString(new Date(order.createdAt), storeTimezone),
//         isToday: isTodayInStoreTime(new Date(order.createdAt), storeTimezone)
//       }))
//     }
//   });
// };

// // OrderDisplaySection component (KEEP EXACTLY THE SAME AS BEFORE)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: summary.totalRefundDiscrepancy !== 0 ? 
//               (isGiftCard ? "#F0E68C" : "#fff3cd") : 
//               (isGiftCard ? "#FFF8DC" : "#f8f9fa"), 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: summary.totalRefundDiscrepancy !== 0 ? 
//               `1px solid ${isGiftCard ? "#D2691E" : "#ffc107"}` : 
//               `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy</h3>
//             <p style={{ 
//               margin: "0", 
//               fontSize: "20px", 
//               fontWeight: "bold", 
//               color: summary.totalRefundDiscrepancy !== 0 ? 
//                 (isGiftCard ? "#8B4513" : "#856404") : 
//                 (isGiftCard ? "#8B4513" : "#6c757d")
//             }}>
//               {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {summary.totalRefundDiscrepancy > 0 ? 'Over-refunded' : summary.totalRefundDiscrepancy < 0 ? 'Under-refunded' : 'No discrepancy'}
//             </p>
//           </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                           {order.calculatedGrossReturns > 0 && (
//                             <div style={{ 
//                               display: "flex", 
//                               justifyContent: "space-between", 
//                               fontSize: "13px",
//                               fontWeight: "bold"
//                             }}>
//                               <span>Returns:</span>
//                               <span style={{ color: "#721c24" }}>
//                                 -${(order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)).toFixed(2)}
//                               </span>
//                           </div>
//                           )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalReturns = totalGrossReturns - (totalRefundDiscrepancy > 0 ? totalRefundDiscrepancy : 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last30Days, last30DaysDaily, storeTimezone, debug } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last30DaysRegularSummary = calculateSummary(last30Days.regularOrders);
//   const last30DaysGiftCardSummary = calculateSummary(last30Days.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Debug information */}
//       {debug && (
//         <details style={{ marginBottom: "20px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "5px" }}>
//           <summary>Debug Information</summary>
//           <pre style={{ fontSize: "12px", overflow: "auto" }}>
//             {JSON.stringify(debug, null, 2)}
//           </pre>
//         </details>
//       )}

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders ({today.regularOrders.length + today.giftCardOrders.length} total)
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 7 Days</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 30 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 30 Days
//         </h2>

//         {/* Total Last 30 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 30 Days</h3>
          
//           {/* Regular Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.regularOrders} 
//             summary={last30DaysRegularSummary} 
//             title="Regular Orders - Last 30 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.giftCardOrders} 
//             summary={last30DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 30 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 30 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 30 Days</h3>
//           {last30DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }












































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone }); // en-CA gives YYYY-MM-DD format
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Helper to check if a UTC date is within last N days in store timezone
// const isWithinLastNDaysInStoreTime = (utcDate: Date, days: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (days ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - days);
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   console.log('=== STORE TIME DEBUGGING ===');
//   console.log('Store timezone:', storeTimezone);
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   console.log('Current UTC time:', nowUTC.toISOString());
//   console.log('Today in store time:', todayStore);
  
//   // Calculate reference dates for the queries - 30 days ago for API query
//   const thirtyDaysAgoUTC = new Date(nowUTC);
//   thirtyDaysAgoUTC.setDate(nowUTC.getDate() - 30);
  
//   const sevenDaysAgoUTC = new Date(nowUTC);
//   sevenDaysAgoUTC.setDate(nowUTC.getDate() - 7);

//   console.log('Date ranges for API query:', {
//     thirtyDaysAgo: thirtyDaysAgoUTC.toISOString(),
//     now: nowUTC.toISOString()
//   });

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${thirtyDaysAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;
  
//   console.log('GraphQL query date range:', dateQuery);

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast30Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   console.log(`Total orders fetched: ${allOrders.length}`);

//   // Process orders and separate gift card transactions (KEEP EXACTLY THE SAME)
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//   // Create a copy of the order with zero shipping
//   const giftCardOrder = {
//     ...order,
//     totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//     totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//     shippingLine: null
//   };
  
//   const processed = calculateOrderMetrics(giftCardOrder);
//   processed.isGiftCardOrder = true;
//   targetArray.push(processed);
// }

//     function processMixedOrder(
//   order: any, 
//   regularLineItems: any[], 
//   giftCardLineItems: any[], 
//   regularTarget: any[], 
//   giftCardTarget: any[]
// ) {
//   // Calculate base subtotals for each portion
//   const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0);

//   const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalSubtotal = regularSubtotal + giftCardSubtotal;

//   // Calculate ACTUAL discounts per portion based on line item discounts
//   let regularDiscounts = 0;
//   let giftCardDiscounts = 0;

//   regularLineItems.forEach((li: any) => {
//     const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//     const lineItemDiscount = originalTotal - discountedTotal;
//     regularDiscounts += lineItemDiscount;
//   });

//   giftCardLineItems.forEach((li: any) => {
//     const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//     const lineItemDiscount = originalTotal - discountedTotal;
//     giftCardDiscounts += lineItemDiscount;
//   });

//   // Calculate ACTUAL refunds per portion based on refund line items
//   let regularRefunds = 0;
//   let giftCardRefunds = 0;

//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//       const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//       const lineItemId = refundLine.node.lineItem?.id;
      
//       // Find which portion this refund belongs to by checking line item ID
//       const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//       const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
      
//       if (isRegularRefund) {
//         regularRefunds += refundAmount;
//       } else if (isGiftCardRefund) {
//         giftCardRefunds += refundAmount;
//       }
//     });
//   });

//   // MODIFICATION 1: Remove shipping fees from gift cards - ALL shipping goes to regular orders
//   const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
  
//   // Gift cards get NO shipping fees
//   const regularShipping = totalShipping;
//   const giftCardShipping = 0; // No shipping for gift cards
//   const regularShippingRefunds = totalShippingRefunds;
//   const giftCardShippingRefunds = 0; // No shipping refunds for gift cards

//   // Calculate taxes per portion based on actual line item taxes
//   let regularTaxes = 0;
//   let giftCardTaxes = 0;

//   regularLineItems.forEach((li: any) => {
//     li.node.taxLines?.forEach((tax: any) => {
//       regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//     });
//   });

//   giftCardLineItems.forEach((li: any) => {
//     li.node.taxLines?.forEach((tax: any) => {
//       giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Helper function to create money set
//   const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//     return {
//       shopMoney: {
//         amount: amount.toFixed(2),
//         currencyCode
//       }
//     };
//   };

//   // Create regular portion with ALL shipping
//   const regularPortion = {
//     ...order,
//     // Split line items
//     lineItems: { edges: regularLineItems },
    
//     // Financial data specific to regular portion - with ALL shipping
//     subtotalPriceSet: createMoneySet(regularSubtotal),
//     currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//     totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//     currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
    
//     // Payment data
//     totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//     totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//     totalOutstandingSet: createMoneySet(0),
    
//     // Costs and fees - ACTUAL amounts, not proportional
//     totalDiscountsSet: createMoneySet(regularDiscounts),
//     totalShippingPriceSet: createMoneySet(regularShipping),
//     totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//     refundDiscrepancySet: createMoneySet(0),
//     currentTotalTaxSet: createMoneySet(regularTaxes),
//     currentTotalDiscountsSet: createMoneySet(regularDiscounts),
    
//     // Refunds - filter to only include refunds that apply to regular items
//     refunds: order.refunds?.map((refund: any) => {
//       const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//         regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//       ) || [];
      
//       if (regularRefundItems.length === 0) return null;
      
//       const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//         sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
      
//       return {
//         ...refund,
//         totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//         refundLineItems: { edges: regularRefundItems }
//       };
//     }).filter(Boolean),
    
//     // Returns
//     returns: { nodes: [] },
    
//     // Shipping line
//     shippingLine: order.shippingLine ? {
//       ...order.shippingLine,
//       originalPriceSet: createMoneySet(regularShipping),
//       discountedPriceSet: createMoneySet(regularShipping)
//     } : null,
    
//     // Metadata
//     isMixedOrderRegular: true,
//     originalOrderName: order.name,
//     portionSubtotal: regularSubtotal
//   };

//   // Create gift card portion with NO shipping
//   const giftCardPortion = {
//     ...order,
//     // Split line items
//     lineItems: { edges: giftCardLineItems },
    
//     // Financial data specific to gift card portion - NO shipping
//     subtotalPriceSet: createMoneySet(giftCardSubtotal),
//     currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//     totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//     currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
    
//     // Payment data
//     totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//     totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//     totalOutstandingSet: createMoneySet(0),
    
//     // Costs and fees - ACTUAL amounts, not proportional
//     totalDiscountsSet: createMoneySet(giftCardDiscounts),
//     totalShippingPriceSet: createMoneySet(giftCardShipping), // Zero shipping for gift cards
//     totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds), // Zero shipping refunds
//     refundDiscrepancySet: createMoneySet(0),
//     currentTotalTaxSet: createMoneySet(giftCardTaxes),
//     currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
    
//     // Refunds - filter to only include refunds that apply to gift card items
//     refunds: order.refunds?.map((refund: any) => {
//       const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//         giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//       ) || [];
      
//       if (giftCardRefundItems.length === 0) return null;
      
//       const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//         sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
      
//       return {
//         ...refund,
//         totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//         refundLineItems: { edges: giftCardRefundItems }
//       };
//     }).filter(Boolean),
    
//     // Returns
//     returns: { nodes: [] },
    
//     // Shipping line - no shipping for gift cards
//     shippingLine: null,
    
//     // Metadata
//     isMixedOrderGiftCard: true,
//     originalOrderName: order.name,
//     portionSubtotal: giftCardSubtotal
//   };

//   // Process both portions with their own metrics
//   const processedRegular = calculateOrderMetrics(regularPortion);
//   regularTarget.push(processedRegular);

//   const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//   giftCardTarget.push(processedGiftCard);
// }

//    function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;

//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });

//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // CORRECTED: Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;
  
//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;
  
//   // MODIFICATION: Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     // This means we lost additional money, so ADD to net sales (increases the loss/reduces revenue)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)  
//     // This means we kept additional money, so DEDUCT from net sales (increases revenue)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     // Over-refund means we refunded MORE than we should have
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Under-refund means we refunded LESS than we should have  
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   return {
//     ...order,
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedTotalReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 7, storeTimezone);
//   });

//   const last30DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 30, storeTimezone);
//   });

//   // Debug: log some order dates to verify
//   console.log('Sample order dates for verification:');
//   allOrders.slice(0, 5).forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const isToday = isTodayInStoreTime(orderDateUTC, storeTimezone);
//     console.log(`Order ${order.name}: UTC: ${orderDateUTC.toISOString()} -> Store: ${orderDateStore} -> Today: ${isToday}`);
//   });

//   console.log(`Today orders: ${todayOrders.length}`);
//   console.log(`Last 7 days orders: ${last7DaysOrders.length}`);
//   console.log(`Last 30 days orders: ${last30DaysOrders.length}`);

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last30DaysProcessed = processOrders(last30DaysOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // Group last 30 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last30DaysByDate: { [key: string]: any[] } = {};
//   last30DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last30DaysByDate[dateKey]) {
//       last30DaysByDate[dateKey] = [];
//     }
//     last30DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 30 days
//   const last30DaysDaily = Object.keys(last30DaysByDate)
//     .sort()
//     .reverse()
//     .slice(0, 30) // Only take last 30 days
//     .map(dateKey => {
//       const dayOrders = last30DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   console.log('=== END STORE TIME DEBUGGING ===');

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last30Days: last30DaysProcessed,
//     last30DaysDaily,
//     shop,
//     storeTimezone,
//     debug: {
//       nowUTC: nowUTC.toISOString(),
//       todayStore,
//       todayOrdersCount: todayOrders.length,
//       last7DaysOrdersCount: last7DaysOrders.length,
//       last30DaysOrdersCount: last30DaysOrders.length,
//       sampleOrders: allOrders.slice(0, 3).map((order: any) => ({
//         name: order.name,
//         createdAtUTC: order.createdAt,
//         createdAtStore: getStoreLocalDateString(new Date(order.createdAt), storeTimezone),
//         isToday: isTodayInStoreTime(new Date(order.createdAt), storeTimezone)
//       }))
//     }
//   });
// };

// // OrderDisplaySection component (KEEP EXACTLY THE SAME AS BEFORE)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
       
// <div style={{ 
//   padding: "16px", 
//   backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//   borderRadius: "8px", 
//   textAlign: "center",
//   border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
// }}>
//   <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy Impact</h3>
//   <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//     {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//   </p>
//   <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//     {summary.ordersWithOverRefunds} over-refunds  {summary.ordersWithUnderRefunds} under-refunds
//   </p>
//   <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//     {summary.totalRefundDiscrepancy > 0 ? 'Added to net sales' : summary.totalRefundDiscrepancy < 0 ? 'Deducted from net sales' : 'No impact'}
//   </p>
// </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                         // In the individual order display section, replace the returns calculation:
// {order.calculatedGrossReturns > 0 && (
//   <div style={{ 
//     display: "flex", 
//     justifyContent: "space-between", 
//     fontSize: "13px",
//     fontWeight: "bold"
//   }}>
//     <span>Returns:</span>
//     <span style={{ color: "#721c24" }}>
//       -${order.calculatedNetReturns.toFixed(2)}
//       {order.calculatedRefundDiscrepancy !== 0 && (
//         <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//           (Gross: ${order.calculatedGrossReturns.toFixed(2)} 
//           {order.hasOverRefund ? ` - Over: $${order.calculatedRefundDiscrepancy.toFixed(2)}` : ''}
//           {order.hasUnderRefund ? ` + Under: $${Math.abs(order.calculatedRefundDiscrepancy).toFixed(2)}` : ''})
//         </span>
//       )}
//     </span>
//   </div>
// )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // MODIFICATION: Calculate net returns considering discrepancies
//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   // Count orders with over/under refunds
//   const ordersWithOverRefunds = orders.filter((order: any) => order.hasOverRefund).length;
//   const ordersWithUnderRefunds = orders.filter((order: any) => order.hasUnderRefund).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalNetReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns: totalNetReturns, // Now using net returns
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     ordersWithOverRefunds,
//     ordersWithUnderRefunds,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { today, last7Days, last7DaysDaily, last30Days, last30DaysDaily, storeTimezone, debug } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last30DaysRegularSummary = calculateSummary(last30Days.regularOrders);
//   const last30DaysGiftCardSummary = calculateSummary(last30Days.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Debug information */}
//       {debug && (
//         <details style={{ marginBottom: "20px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "5px" }}>
//           <summary>Debug Information</summary>
//           <pre style={{ fontSize: "12px", overflow: "auto" }}>
//             {JSON.stringify(debug, null, 2)}
//           </pre>
//         </details>
//       )}

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders ({today.regularOrders.length + today.giftCardOrders.length} total)
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 7 Days</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 30 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 30 Days
//         </h2>

//         {/* Total Last 30 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 30 Days</h3>
          
//           {/* Regular Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.regularOrders} 
//             summary={last30DaysRegularSummary} 
//             title="Regular Orders - Last 30 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.giftCardOrders} 
//             summary={last30DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 30 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 30 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 30 Days</h3>
//           {last30DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }








































































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone }); // en-CA gives YYYY-MM-DD format
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };


// // Helper function to get week start date (Monday)
// const getWeekStartDate = (dateString: string): string => {
//   const date = new Date(dateString + 'T00:00:00');
//   const day = date.getDay();
//   const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
//   const monday = new Date(date.setDate(diff));
//   return monday.toISOString().split('T')[0]; // Returns YYYY-MM-DD
// };


// // Helper to check if a UTC date is within last N days in store timezone
// const isWithinLastNDaysInStoreTime = (utcDate: Date, days: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (days ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - days);
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   console.log('=== STORE TIME DEBUGGING ===');
//   console.log('Store timezone:', storeTimezone);
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   console.log('Current UTC time:', nowUTC.toISOString());
//   console.log('Today in store time:', todayStore);
  
//   // Calculate reference dates for the queries - 30 days ago for API query
//   const thirtyDaysAgoUTC = new Date(nowUTC);
//   thirtyDaysAgoUTC.setDate(nowUTC.getDate() - 30);
  
//   const sevenDaysAgoUTC = new Date(nowUTC);
//   sevenDaysAgoUTC.setDate(nowUTC.getDate() - 7);

//   console.log('Date ranges for API query:', {
//     thirtyDaysAgo: thirtyDaysAgoUTC.toISOString(),
//     now: nowUTC.toISOString()
//   });

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${thirtyDaysAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;
  
//   console.log('GraphQL query date range:', dateQuery);

//   const response = await admin.graphql(
//     `#graphql
//     query OrdersLast30Days($query: String!) {
//       orders(first: 250, query: $query, sortKey: CREATED_AT, reverse: true) {
//         edges {
//           node {
//             id
//             name
//             createdAt
//             updatedAt
//             displayFinancialStatus
//             displayFulfillmentStatus
//             confirmed
//             cancelledAt
//             cancelReason
//             note
//             fullyPaid
            
//             # Enhanced Financial Information
//             totalReceivedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalOutstandingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalShippingPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalRefundedShippingSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Refund Discrepancy - Direct from Shopify
//             refundDiscrepancySet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }

//             # Returns Information with Restocking Fees
//             returns(first: 7) {
//               nodes {
//                 returnLineItems(first: 10) {
//                   nodes {
//                     ... on ReturnLineItem {
//                       restockingFee {
//                         amountSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 returnShippingFees {
//                   amountSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Refund Information
//             refunds {
//               id
//               createdAt
//               note
//               totalRefundedSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               refundLineItems(first: 10) {
//                 edges {
//                   node {
//                     lineItem {
//                       id
//                       name
//                     }
//                     quantity
//                     subtotalSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     totalTaxSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Pricing Information
//             currentSubtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalTaxSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalDiscountsSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             currentTotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             subtotalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
//             totalPriceSet {
//               shopMoney {
//                 amount
//                 currencyCode
//               }
//             }
            
//             # Fulfillment Information
//             fulfillments(first: 5) {
//               id
//               status
//               createdAt
//               trackingInfo {
//                 company
//                 number
//                 url
//               }
//             }
            
//             # Shipping Line Information
//             shippingLine {
//               title
//               originalPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//               discountedPriceSet {
//                 shopMoney {
//                   amount
//                   currencyCode
//                 }
//               }
//             }
            
//             # Discount Information
//             discountApplications(first: 5) {
//               edges {
//                 node {
//                   __typename
//                   ... on DiscountCodeApplication {
//                     code
//                     allocationMethod
//                     targetType
//                     value {
//                       ... on MoneyV2 {
//                         amount
//                         currencyCode
//                       }
//                       ... on PricingPercentageValue {
//                         percentage
//                       }
//                     }
//                   }
//                 }
//               }
//             }
            
//             # Line Items with enhanced details including tax lines
//             lineItems(first: 50) {
//               edges {
//                 node {
//                   id
//                   name
//                   title
//                   quantity
//                   sku
//                   variantTitle
//                   product {
//                     id
//                     title
//                   }
//                   variant {
//                     id
//                     title
//                     sku
//                     price
//                   }
//                   originalUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedUnitPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   originalTotalSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   # Tax lines for each line item
//                   taxLines {
//                     priceSet {
//                       shopMoney {
//                         amount
//                         currencyCode
//                       }
//                     }
//                     rate
//                     title
//                   }
//                 }
//               }
//             }
//           }
//         }
//       }
//     }
//     `,
//     { variables: { query: dateQuery } }
//   );

//   const jsonData = await response.json();
//   const allOrders = jsonData?.data?.orders?.edges?.map((x: any) => x.node) ?? [];

//   console.log(`Total orders fetched: ${allOrders.length}`);

//   // Process orders and separate gift card transactions (KEEP EXACTLY THE SAME)
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//   // Create a copy of the order with zero shipping
//   const giftCardOrder = {
//     ...order,
//     totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//     totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//     shippingLine: null
//   };
  
//   const processed = calculateOrderMetrics(giftCardOrder);
//   processed.isGiftCardOrder = true;
//   targetArray.push(processed);
// }

//     function processMixedOrder(
//   order: any, 
//   regularLineItems: any[], 
//   giftCardLineItems: any[], 
//   regularTarget: any[], 
//   giftCardTarget: any[]
// ) {
//   // Calculate base subtotals for each portion
//   const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0);

//   const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalSubtotal = regularSubtotal + giftCardSubtotal;

//   // Calculate ACTUAL discounts per portion based on line item discounts
//   let regularDiscounts = 0;
//   let giftCardDiscounts = 0;

//   regularLineItems.forEach((li: any) => {
//     const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//     const lineItemDiscount = originalTotal - discountedTotal;
//     regularDiscounts += lineItemDiscount;
//   });

//   giftCardLineItems.forEach((li: any) => {
//     const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//     const lineItemDiscount = originalTotal - discountedTotal;
//     giftCardDiscounts += lineItemDiscount;
//   });

//   // Calculate ACTUAL refunds per portion based on refund line items
//   let regularRefunds = 0;
//   let giftCardRefunds = 0;

//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//       const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//       const lineItemId = refundLine.node.lineItem?.id;
      
//       // Find which portion this refund belongs to by checking line item ID
//       const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//       const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
      
//       if (isRegularRefund) {
//         regularRefunds += refundAmount;
//       } else if (isGiftCardRefund) {
//         giftCardRefunds += refundAmount;
//       }
//     });
//   });

//   // MODIFICATION 1: Remove shipping fees from gift cards - ALL shipping goes to regular orders
//   const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
  
//   // Gift cards get NO shipping fees
//   const regularShipping = totalShipping;
//   const giftCardShipping = 0; // No shipping for gift cards
//   const regularShippingRefunds = totalShippingRefunds;
//   const giftCardShippingRefunds = 0; // No shipping refunds for gift cards

//   // Calculate taxes per portion based on actual line item taxes
//   let regularTaxes = 0;
//   let giftCardTaxes = 0;

//   regularLineItems.forEach((li: any) => {
//     li.node.taxLines?.forEach((tax: any) => {
//       regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//     });
//   });

//   giftCardLineItems.forEach((li: any) => {
//     li.node.taxLines?.forEach((tax: any) => {
//       giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Helper function to create money set
//   const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//     return {
//       shopMoney: {
//         amount: amount.toFixed(2),
//         currencyCode
//       }
//     };
//   };

//   // Create regular portion with ALL shipping
//   const regularPortion = {
//     ...order,
//     // Split line items
//     lineItems: { edges: regularLineItems },
    
//     // Financial data specific to regular portion - with ALL shipping
//     subtotalPriceSet: createMoneySet(regularSubtotal),
//     currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//     totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//     currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
    
//     // Payment data
//     totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//     totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//     totalOutstandingSet: createMoneySet(0),
    
//     // Costs and fees - ACTUAL amounts, not proportional
//     totalDiscountsSet: createMoneySet(regularDiscounts),
//     totalShippingPriceSet: createMoneySet(regularShipping),
//     totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//     refundDiscrepancySet: createMoneySet(0),
//     currentTotalTaxSet: createMoneySet(regularTaxes),
//     currentTotalDiscountsSet: createMoneySet(regularDiscounts),
    
//     // Refunds - filter to only include refunds that apply to regular items
//     refunds: order.refunds?.map((refund: any) => {
//       const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//         regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//       ) || [];
      
//       if (regularRefundItems.length === 0) return null;
      
//       const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//         sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
      
//       return {
//         ...refund,
//         totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//         refundLineItems: { edges: regularRefundItems }
//       };
//     }).filter(Boolean),
    
//     // Returns
//     returns: { nodes: [] },
    
//     // Shipping line
//     shippingLine: order.shippingLine ? {
//       ...order.shippingLine,
//       originalPriceSet: createMoneySet(regularShipping),
//       discountedPriceSet: createMoneySet(regularShipping)
//     } : null,
    
//     // Metadata
//     isMixedOrderRegular: true,
//     originalOrderName: order.name,
//     portionSubtotal: regularSubtotal
//   };

//   // Create gift card portion with NO shipping
//   const giftCardPortion = {
//     ...order,
//     // Split line items
//     lineItems: { edges: giftCardLineItems },
    
//     // Financial data specific to gift card portion - NO shipping
//     subtotalPriceSet: createMoneySet(giftCardSubtotal),
//     currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//     totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//     currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
    
//     // Payment data
//     totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//     totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//     totalOutstandingSet: createMoneySet(0),
    
//     // Costs and fees - ACTUAL amounts, not proportional
//     totalDiscountsSet: createMoneySet(giftCardDiscounts),
//     totalShippingPriceSet: createMoneySet(giftCardShipping), // Zero shipping for gift cards
//     totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds), // Zero shipping refunds
//     refundDiscrepancySet: createMoneySet(0),
//     currentTotalTaxSet: createMoneySet(giftCardTaxes),
//     currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
    
//     // Refunds - filter to only include refunds that apply to gift card items
//     refunds: order.refunds?.map((refund: any) => {
//       const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//         giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//       ) || [];
      
//       if (giftCardRefundItems.length === 0) return null;
      
//       const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//         sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
      
//       return {
//         ...refund,
//         totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//         refundLineItems: { edges: giftCardRefundItems }
//       };
//     }).filter(Boolean),
    
//     // Returns
//     returns: { nodes: [] },
    
//     // Shipping line - no shipping for gift cards
//     shippingLine: null,
    
//     // Metadata
//     isMixedOrderGiftCard: true,
//     originalOrderName: order.name,
//     portionSubtotal: giftCardSubtotal
//   };

//   // Process both portions with their own metrics
//   const processedRegular = calculateOrderMetrics(regularPortion);
//   regularTarget.push(processedRegular);

//   const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//   giftCardTarget.push(processedGiftCard);
// }

//    function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;

//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });

//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // CORRECTED: Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;
  
//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;
  
//   // MODIFICATION: Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     // This means we lost additional money, so ADD to net sales (increases the loss/reduces revenue)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)  
//     // This means we kept additional money, so DEDUCT from net sales (increases revenue)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     // Over-refund means we refunded MORE than we should have
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Under-refund means we refunded LESS than we should have  
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   return {
//     ...order,
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedTotalReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 7, storeTimezone);
//   });

//   const last30DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 30, storeTimezone);
//   });





// // NEW: Today's last 7 days (rolling 7 days including today)
// const todaysLast7DaysOrders = last7DaysOrders;

// // NEW: Last 8 weeks
// const last8WeeksOrders = allOrders.filter((order: any) => {
//   const orderDateUTC = new Date(order.createdAt);
//   return isWithinLastNDaysInStoreTime(orderDateUTC, 56, storeTimezone); // 8 weeks * 7 days
// });

// // NEW: Last 6 months + current month
// const last6MonthsPlusCurrentOrders = allOrders.filter((order: any) => {
//   const orderDateUTC = new Date(order.createdAt);
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);
//   const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//   const sevenMonthsAgoStore = getStoreLocalDateString(sevenMonthsAgoUTC, storeTimezone);
//   return orderDateStore >= sevenMonthsAgoStore && orderDateStore <= todayStore;
// });



//   // Debug: log some order dates to verify
//   console.log('Sample order dates for verification:');
//   allOrders.slice(0, 5).forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const isToday = isTodayInStoreTime(orderDateUTC, storeTimezone);
//     console.log(`Order ${order.name}: UTC: ${orderDateUTC.toISOString()} -> Store: ${orderDateStore} -> Today: ${isToday}`);
//   });

//   console.log(`Today orders: ${todayOrders.length}`);
//   console.log(`Last 7 days orders: ${last7DaysOrders.length}`);
//   console.log(`Last 30 days orders: ${last30DaysOrders.length}`);

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last30DaysProcessed = processOrders(last30DaysOrders);


//   // NEW: Process new time period orders
// const todaysLast7DaysProcessed = processOrders(todaysLast7DaysOrders);
// const last8WeeksProcessed = processOrders(last8WeeksOrders);
// const last6MonthsPlusCurrentProcessed = processOrders(last6MonthsPlusCurrentOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // Group last 30 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last30DaysByDate: { [key: string]: any[] } = {};
//   last30DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last30DaysByDate[dateKey]) {
//       last30DaysByDate[dateKey] = [];
//     }
//     last30DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 30 days
//   const last30DaysDaily = Object.keys(last30DaysByDate)
//     .sort()
//     .reverse()
//     .slice(0, 30) // Only take last 30 days
//     .map(dateKey => {
//       const dayOrders = last30DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   console.log('=== END STORE TIME DEBUGGING ===');

//   // NEW: Group last 8 weeks orders by week for weekly breakdown
// const last8WeeksByWeek: { [key: string]: any[] } = {};
// last8WeeksOrders.forEach((order: any) => {
//   const orderDateUTC = new Date(order.createdAt);
//   const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//   const weekStart = getWeekStartDate(dateKey);
//   if (!last8WeeksByWeek[weekStart]) {
//     last8WeeksByWeek[weekStart] = [];
//   }
//   last8WeeksByWeek[weekStart].push(order);
// });

// // Process each week for last 8 weeks
// const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//   .sort()
//   .reverse()
//   .slice(0, 8) // Only take last 8 weeks
//   .map(weekStart => {
//     const weekOrders = last8WeeksByWeek[weekStart];
//     const processed = processOrders(weekOrders);
//     return {
//       weekStart,
//       date: new Date(weekStart + 'T00:00:00'),
//       ...processed
//     };
//   });

// // NEW: Group last 6 months + current by month for monthly breakdown
// const last6MonthsPlusCurrentByMonth: { [key: string]: any[] } = {};
// last6MonthsPlusCurrentOrders.forEach((order: any) => {
//   const orderDateUTC = new Date(order.createdAt);
//   const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//   const monthKey = dateKey.substring(0, 7); // YYYY-MM
//   if (!last6MonthsPlusCurrentByMonth[monthKey]) {
//     last6MonthsPlusCurrentByMonth[monthKey] = [];
//   }
//   last6MonthsPlusCurrentByMonth[monthKey].push(order);
// });

// // Process each month for last 6 months + current
// const last6MonthsPlusCurrentMonthly = Object.keys(last6MonthsPlusCurrentByMonth)
//   .sort()
//   .reverse()
//   .slice(0, 7) // Only take last 7 months (6 + current)
//   .map(monthKey => {
//     const monthOrders = last6MonthsPlusCurrentByMonth[monthKey];
//     const processed = processOrders(monthOrders);
//     return {
//       monthKey,
//       date: new Date(monthKey + '-01T00:00:00'), // First day of month
//       ...processed
//     };
//   });

// console.log('=== END STORE TIME DEBUGGING ===');

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last30Days: last30DaysProcessed,
//     last30DaysDaily,
//       todaysLast7Days: todaysLast7DaysProcessed,
//   last8Weeks: last8WeeksProcessed,
//   last8WeeksWeekly,
//   last6MonthsPlusCurrent: last6MonthsPlusCurrentProcessed,
//   last6MonthsPlusCurrentMonthly,
//     shop,
//     storeTimezone,
//     debug: {
//       nowUTC: nowUTC.toISOString(),
//       todayStore,
//       todayOrdersCount: todayOrders.length,
//       last7DaysOrdersCount: last7DaysOrders.length,
//       last30DaysOrdersCount: last30DaysOrders.length,
//       sampleOrders: allOrders.slice(0, 3).map((order: any) => ({
//         name: order.name,
//         createdAtUTC: order.createdAt,
//         createdAtStore: getStoreLocalDateString(new Date(order.createdAt), storeTimezone),
//         isToday: isTodayInStoreTime(new Date(order.createdAt), storeTimezone)
//       }))
//     }
//   });
// };

// // OrderDisplaySection component (KEEP EXACTLY THE SAME AS BEFORE)
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   const formatMoney = (moneySet: any) => {
//     if (!moneySet?.shopMoney) return "$0.00";
//     return `$${parseFloat(moneySet.shopMoney.amount).toFixed(2)}`;
//   };

//   const formatMoneyWithSign = (amount: number) => {
//     if (amount >= 0) {
//       return `$${Math.abs(amount).toFixed(2)}`;
//     } else {
//       return `-$${Math.abs(amount).toFixed(2)}`;
//     }
//   };

//   const getOrderNumber = (orderName: string) => {
//     return orderName.replace('#', '');
//   };

//   return (
//     <div style={{ marginBottom: "40px" }}>
//       <h2 style={{ 
//         color: isGiftCard ? "#8B4513" : "#333",
//         borderBottom: `2px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//         paddingBottom: "8px"
//       }}>
//         {title}
//       </h2>
      
//       {/* Consolidated Display */}
//       <div style={{ marginBottom: "40px" }}>
//         <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//           Consolidated Display
//         </h3>
        
//         {/* Enhanced Summary Statistics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(3, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Orders</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#007bff" }}>
//               {summary.totalOrders}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Total Revenue</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#28a745" }}>
//               {formatMoneyWithSign(summary.totalRevenue)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Using current total prices
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#f8f9fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Average Order Value</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#D2691E" : "#6f42c1" }}>
//               {formatMoneyWithSign(summary.averageOrderValue)}
//             </p>
//           </div>
//         </div>

//         {/* Sales Metrics */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Gross Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalGrossSales)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalReturns)}
//             </p>
//           </div>
          
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Net Sales</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {formatMoneyWithSign(summary.totalNetSales)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//         </div>

//         {/* Financial Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#e8f5e8", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#c3e6c3"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Received</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#155724" }}>
//               {formatMoneyWithSign(summary.totalReceived)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#ffeaea", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#f5c6cb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Refunded</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#721c24" }}>
//               {formatMoneyWithSign(-summary.totalRefunded)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Outstanding</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//               {formatMoneyWithSign(summary.totalOutstanding)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e8f4fd", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b8daff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Fully Paid Orders</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004085" }}>
//               {summary.fullyPaidOrders} / {summary.totalOrders}
//             </p>
//           </div>
//         </div>

//         {/* Cost Breakdown */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(4, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F5F5DC" : "#fff3e0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcc80"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Line Items</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e65100" }}>
//               {formatMoneyWithSign(summary.totalLineItemsPrice)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#f3e5f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e1bee7"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Discounts</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#4a148c" }}>
//               {formatMoneyWithSign(-summary.totalDiscounts)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f2f1", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2dfdb"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Shipping Charges</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#004d40" }}>
//               {formatMoneyWithSign(summary.totalShippingCharges)}
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFDAB9" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Taxes</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalTaxes)}
//             </p>
//           </div>
//         </div>

//         {/* Total Sales */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "1fr", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#DEB887" : "#e6f3ff", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `2px solid ${isGiftCard ? "#8B4513" : "#b3d9ff"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#FFF" : "#333", fontSize: "16px" }}>Total Sales</h3>
//             <p style={{ margin: "0", fontSize: "24px", fontWeight: "bold", color: isGiftCard ? "#FFF" : "#0066cc" }}>
//               {formatMoneyWithSign(summary.totalSales)}
//             </p>
//           </div>
//         </div>

//         {/* Refund Analysis */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f0", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffcccc"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Refunds</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#dc3545" }}>
//               {summary.ordersWithRefunds}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithRefunds / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
      
       
// <div style={{ 
//   padding: "16px", 
//   backgroundColor: isGiftCard ? "#F0E68C" : "#fff3cd", 
//   borderRadius: "8px", 
//   textAlign: "center",
//   border: `1px solid ${isGiftCard ? "#D2691E" : "#ffeaa7"}`
// }}>
//   <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Refund Discrepancy Impact</h3>
//   <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#856404" }}>
//     {formatMoneyWithSign(summary.totalRefundDiscrepancy)}
//   </p>
//   <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//     {summary.ordersWithOverRefunds} over-refunds  {summary.ordersWithUnderRefunds} under-refunds
//   </p>
//   <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//     {summary.totalRefundDiscrepancy > 0 ? 'Added to net sales' : summary.totalRefundDiscrepancy < 0 ? 'Deducted from net sales' : 'No impact'}
//   </p>
// </div>
//         </div>

//         {/* Return Fees Section */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFEBCD" : "#fff0f5", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#ffccd5"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Orders with Returns</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#e83e8c" }}>
//               {summary.ordersWithReturns}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               {((summary.ordersWithReturns / summary.totalOrders) * 100).toFixed(1)}% of orders
//             </p>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#F0E68C" : "#e0f7fa", 
//             borderRadius: "8px", 
//             textAlign: "center",
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#b2ebf2"}`
//           }}>
//             <h3 style={{ margin: "0 0 8px 0", color: isGiftCard ? "#8B4513" : "#333", fontSize: "14px" }}>Total Return Fees</h3>
//             <p style={{ margin: "0", fontSize: "20px", fontWeight: "bold", color: isGiftCard ? "#8B4513" : "#006064" }}>
//               {formatMoneyWithSign(summary.totalRestockingFees + summary.totalReturnShippingFees)}
//             </p>
//             <p style={{ margin: "4px 0 0 0", fontSize: "12px", color: "#666" }}>
//               Restocking: {formatMoneyWithSign(summary.totalRestockingFees)} + Shipping: {formatMoneyWithSign(summary.totalReturnShippingFees)}
//             </p>
//           </div>
//         </div>

//         {/* Status Overview */}
//         <div style={{ 
//           display: "grid", 
//           gridTemplateColumns: "repeat(2, 1fr)", 
//           gap: "16px", 
//           marginBottom: "24px" 
//         }}>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Financial Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.financialStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//           <div style={{ 
//             padding: "16px", 
//             backgroundColor: isGiftCard ? "#FFF8DC" : "#fff", 
//             borderRadius: "8px", 
//             border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`
//           }}>
//             <h3 style={{ margin: "0 0 12px 0", color: isGiftCard ? "#8B4513" : "#333" }}>Fulfillment Status</h3>
//             <div style={{ fontSize: "14px" }}>
//               {Object.entries(summary.fulfillmentStatusCounts).map(([status, count]: [string, any]) => (
//                 <div key={status} style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
//                   <span style={{ textTransform: 'capitalize' }}>{status.replace('_', ' ')}:</span>
//                   <span style={{ fontWeight: "bold" }}>{count}</span>
//                 </div>
//               ))}
//             </div>
//           </div>
//         </div>
//       </div>

//       {/* Individual Order Details */}
//       {showIndividualOrders && (
//         <div>
//           <h3 style={{ marginBottom: "20px", color: isGiftCard ? "#8B4513" : "#333" }}>
//             Individual Order Details ({orders.length} orders)
//           </h3>
//           {orders.map((order: any) => {
//             // Calculate line items total for this order
//             const orderLineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//               return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//             }, 0) || 0;

//             // Get refund discrepancy directly from Shopify
//             const orderRefundDiscrepancy = order.calculatedRefundDiscrepancy || 0;

//             // Calculate refunded shipping for this order
//             const orderShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//             // Check if current total differs from original total
//             const hasPriceAdjustment = order.currentTotalPriceSet?.shopMoney?.amount !== order.totalPriceSet?.shopMoney?.amount;

//             return (
//               <div 
//                 key={order.id} 
//                 style={{ 
//                   border: `1px solid ${isGiftCard ? "#D2691E" : "#e5e5e5"}`,
//                   borderRadius: "8px",
//                   padding: "12px",
//                   marginBottom: "12px",
//                   backgroundColor: isGiftCard ? "#FFF8DC" : "#fafafa"
//                 }}
//               >
//                 {/* Order Header */}
//                 <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                   <div>
//                     <h3 style={{ margin: "0 0 4px 0" }}>
//                       {order.isMixedOrderRegular || order.isMixedOrderGiftCard ? (
//                         <span>
//                           {order.originalOrderName} (Order #{getOrderNumber(order.originalOrderName)})
//                           <span style={{ 
//                             marginLeft: "8px", 
//                             backgroundColor: "#ffc107", 
//                             color: "#212529", 
//                             padding: "2px 8px", 
//                             borderRadius: "12px", 
//                             fontSize: "12px",
//                             fontWeight: "normal"
//                           }}>
//                             {order.isMixedOrderRegular ? "Regular Portion" : "Gift Card Portion"}
//                           </span>
//                         </span>
//                       ) : (
//                         <span>
//                           {order.name} (Order #{getOrderNumber(order.name)})
//                         </span>
//                       )}
//                       {order.fullyPaid && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#28a745", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Fully Paid
//                         </span>
//                       )}
//                       {order.refunds && order.refunds.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#dc3545", 
//                           color: "white", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.refunds.length} Refund{order.refunds.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {order.returns?.nodes && order.returns.nodes.length > 0 && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           {order.returns.nodes.length} Return{order.returns.nodes.length > 1 ? 's' : ''}
//                         </span>
//                       )}

//                       {hasPriceAdjustment && (
//                         <span style={{ 
//                           marginLeft: "8px", 
//                           backgroundColor: "#ffc107", 
//                           color: "#212529", 
//                           padding: "2px 8px", 
//                           borderRadius: "12px", 
//                           fontSize: "12px",
//                           fontWeight: "normal"
//                         }}>
//                           Price Adjusted
//                         </span>
//                       )}
//                     </h3>
//                     <p style={{ margin: "0", color: "#666", fontSize: "14px" }}>
//                       Financial: <b>{order.displayFinancialStatus}</b> | Fulfillment: <b>{order.displayFulfillmentStatus}</b>
//                     </p>
//                   </div>
//                   <div style={{ textAlign: "right" }}>
//                     <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                       Created: {new Date(order.createdAt).toLocaleString()}
//                     </p>
//                     {order.updatedAt && (
//                       <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                         Updated: {new Date(order.updatedAt).toLocaleString()}
//                       </p>
//                     )}
//                   </div>
//                 </div>

//                 {/* Enhanced Financial Details */}
//                 <div style={{ 
//                   display: "grid", 
//                   gridTemplateColumns: "1fr 1fr", 
//                   gap: "16px", 
//                   marginBottom: "12px",
//                   padding: "12px",
//                   backgroundColor: "white",
//                   borderRadius: "6px",
//                   border: "1px solid #e0e0e0"
//                 }}>
//                   {/* Payment Status */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Payment Status</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Received:</span>
//                         <span style={{ fontWeight: "bold", color: "#28a745" }}>
//                           {formatMoney(order.totalReceivedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Total Refunded:</span>
//                         <span style={{ fontWeight: "bold", color: "#dc3545" }}>
//                           {formatMoney(order.totalRefundedSet)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Outstanding:</span>
//                         <span style={{ fontWeight: "bold", color: "#ffc107" }}>
//                           {formatMoney(order.totalOutstandingSet)}
//                         </span>
//                       </div>
                    
//                       {orderRefundDiscrepancy !== 0 && (
//                         <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                           <span>Refund Discrepancy:</span>
//                           <span style={{ 
//                             fontWeight: "bold", 
//                             color: orderRefundDiscrepancy > 0 ? "#856404" : "#0d6efd",
//                             backgroundColor: orderRefundDiscrepancy > 0 ? "#fff3cd" : "#e7f1ff",
//                             padding: "2px 6px",
//                             borderRadius: "4px"
//                           }}>
//                             {formatMoneyWithSign(orderRefundDiscrepancy)}
//                             ({orderRefundDiscrepancy > 0 ? 'Over' : 'Under'})
//                             <span style={{ fontSize: '10px', marginLeft: '4px', color: '#666' }}>
//                               (Shopify)
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", borderTop: "1px solid #ddd", marginTop: "4px", paddingTop: "4px" }}>
//                         <span>Fully Paid:</span>
//                         <span style={{ fontWeight: "bold", color: order.fullyPaid ? "#28a745" : "#dc3545" }}>
//                           {order.fullyPaid ? "Yes" : "No"}
//                         </span>
//                       </div>
//                     </div>
//                   </div>

//                   {/* Order Summary */}
//                   <div>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Order Summary</h4>
//                     <div style={{ fontSize: "14px" }}>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Line Items Total:</span>
//                         <span>${orderLineItemsTotal.toFixed(2)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Subtotal:</span>
//                         <span>{formatMoney(order.currentSubtotalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         marginBottom: "4px",
//                         fontWeight: "bold"
//                       }}>
//                         <span>Shipping Charges:</span>
//                         <span>
//                           ${(parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0) - orderShippingRefunds).toFixed(2)}
//                         </span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Tax:</span>
//                         <span>{formatMoney(order.currentTotalTaxSet)}</span>
//                       </div>
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Discounts:</span>
//                         <span style={{ color: "#dc3545" }}>-{formatMoney(order.totalDiscountsSet)}</span>
//                       </div>

//                       {/* Return Fees */}
//                       {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                         <div style={{ 
//                           display: "flex", 
//                           justifyContent: "space-between", 
//                           marginBottom: "4px",
//                           backgroundColor: "#f8f9fa",
//                           padding: "4px 8px",
//                           borderRadius: "4px",
//                           border: "1px solid #e9ecef"
//                         }}>
//                           <span>Return Fees:</span>
//                           <span style={{ color: "#856404", fontWeight: "bold" }}>
//                             ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                             <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//                               (Restocking: ${order.calculatedRestockingFees.toFixed(2)} + Shipping: ${order.calculatedReturnShippingFees.toFixed(2)})
//                             </span>
//                           </span>
//                         </div>
//                       )}
//                       <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "4px" }}>
//                         <span>Original Total:</span>
//                         <span>{formatMoney(order.totalPriceSet)}</span>
//                       </div>
//                       <div style={{ 
//                         display: "flex", 
//                         justifyContent: "space-between", 
//                         borderTop: "1px solid #ddd", 
//                         marginTop: "4px", 
//                         paddingTop: "4px", 
//                         fontWeight: "bold",
//                         backgroundColor: hasPriceAdjustment ? "#fff3cd" : "transparent",
//                         padding: '4px',
//                         borderRadius: '4px'
//                       }}>
//                         <span>Current Total:</span>
//                         <span style={{ 
//                           color: hasPriceAdjustment ? "#856404" : "inherit"
//                         }}>
//                           {formatMoney(order.currentTotalPriceSet)}
//                           {hasPriceAdjustment && (
//                             <span style={{ fontSize: '12px', marginLeft: '8px', color: '#666' }}>
//                               (adjusted)
//                             </span>
//                           )}
//                         </span>
//                       </div>
                      
//                       {/* Gross Returns Calculation */}
//                       {(order.calculatedGrossReturns > 0 || order.calculatedGrossSales > 0) && (
//                         <>
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             marginTop: "8px", 
//                             paddingTop: "8px", 
//                             borderTop: "1px solid #ddd",
//                             fontSize: "13px"
//                           }}>
//                             <span>Gross Sales:</span>
//                             <span style={{ fontWeight: "bold", color: "#155724" }}>
//                               ${order.calculatedGrossSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
//                         // In the individual order display section, replace the returns calculation:
// {order.calculatedGrossReturns > 0 && (
//   <div style={{ 
//     display: "flex", 
//     justifyContent: "space-between", 
//     fontSize: "13px",
//     fontWeight: "bold"
//   }}>
//     <span>Returns:</span>
//     <span style={{ color: "#721c24" }}>
//       -${order.calculatedNetReturns.toFixed(2)}
//       {order.calculatedRefundDiscrepancy !== 0 && (
//         <span style={{ fontSize: "11px", marginLeft: "4px", color: "#6c757d" }}>
//           (Gross: ${order.calculatedGrossReturns.toFixed(2)} 
//           {order.hasOverRefund ? ` - Over: $${order.calculatedRefundDiscrepancy.toFixed(2)}` : ''}
//           {order.hasUnderRefund ? ` + Under: $${Math.abs(order.calculatedRefundDiscrepancy).toFixed(2)}` : ''})
//         </span>
//       )}
//     </span>
//   </div>
// )}
//                           {(order.calculatedRestockingFees > 0 || order.calculatedReturnShippingFees > 0) && (
//                             <div style={{ display: "flex", justifyContent: "space-between", fontSize: "13px" }}>
//                               <span>Return Fees:</span>
//                               <span style={{ fontWeight: "bold", color: "#856404" }}>
//                                 ${(order.calculatedRestockingFees + order.calculatedReturnShippingFees).toFixed(2)}
//                               </span>
//                             </div>
//                           )}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold"
//                           }}>
//                             <span>Net Sales:</span>
//                             <span style={{ color: "#004085" }}>
//                               ${order.calculatedNetSales?.toFixed(2) || '0.00'}
//                             </span>
//                           </div>
                        
//                           {/* Total Sales Section */}
//                           <div style={{ 
//                             display: "flex", 
//                             justifyContent: "space-between", 
//                             fontSize: "13px",
//                             fontWeight: "bold",
//                             backgroundColor: "#e6f3ff",
//                             padding: "4px 8px",
//                             borderRadius: "4px",
//                             border: "1px solid #b3d9ff",
//                             marginTop: "8px"
//                           }}>
//                             <span>Total Sales:</span>
//                             <span style={{ color: "#0066cc" }}>
//                               ${(order.calculatedGrossSales + 
//                                 order.calculatedShippingCharges + 
//                                 order.calculatedTotalReturnFees + 
//                                 (parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0)) -
//                                 (order.calculatedGrossReturns - (order.calculatedRefundDiscrepancy > 0 ? order.calculatedRefundDiscrepancy : 0)) -
//                                 parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0)
//                                 ).toFixed(2)}
//                             </span>
//                           </div>
//                         </>
//                       )}
//                     </div>
//                   </div>
//                 </div>

//                 {/* Refunds Section */}
//                 {order.refunds && order.refunds.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "0 0 8px 0", color: "#333" }}>Refunds ({order.refunds.length})</h4>
//                     {order.refunds.map((refund: any, index: number) => {
//                       const lineItemsRefunded = refund.refundLineItems?.edges?.reduce((sum: number, line: any) => {
//                         return sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0);
//                       }, 0) || 0;

//                       return (
//                         <div 
//                           key={refund.id} 
//                           style={{ 
//                             padding: "12px",
//                             backgroundColor: "white",
//                             borderRadius: "6px",
//                             marginBottom: "8px",
//                             border: "1px solid #e0e0e0"
//                           }}
//                         >
//                           <div style={{ display: "flex", justifyContent: "space-between", alignItems: "start", marginBottom: "8px" }}>
//                             <div>
//                               <h5 style={{ margin: "0 0 4px 0" }}>Refund #{index + 1}</h5>
//                               <p style={{ margin: "0", color: "#666", fontSize: "12px" }}>
//                                 {new Date(refund.createdAt).toLocaleString()}
//                               </p>
//                             </div>
//                             <div style={{ textAlign: "right" }}>
//                               <p style={{ margin: "0", fontWeight: "bold", color: "#dc3545" }}>
//                                 {formatMoney(refund.totalRefundedSet)}
//                               </p>
//                             </div>
//                           </div>
                          
//                           {refund.note && (
//                             <p style={{ margin: "0 0 8px 0", fontSize: "14px", fontStyle: "italic" }}>
//                               Note: "{refund.note}"
//                             </p>
//                           )}

//                           <div style={{ fontSize: "14px" }}>
//                             <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "2px" }}>
//                               <span>Line Items Refunded:</span>
//                               <span>${lineItemsRefunded.toFixed(2)}</span>
//                             </div>
//                           </div>

//                           {/* Refund Line Items */}
//                           {refund.refundLineItems?.edges?.length > 0 && (
//                             <details style={{ marginTop: "8px" }}>
//                               <summary style={{ cursor: "pointer", fontSize: "14px" }}>Refunded Items</summary>
//                               <div style={{ marginTop: "8px" }}>
//                                 {refund.refundLineItems.edges.map((line: any, lineIndex: number) => (
//                                   <div key={lineIndex} style={{ fontSize: "12px", marginBottom: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px" }}>
//                                     {line.node.quantity}x {line.node.lineItem.name} - {formatMoney(line.node.subtotalSet)}
//                                   </div>
//                                 ))}
//                               </div>
//                             </details>
//                           )}
//                         </div>
//                       );
//                     })}
//                   </div>
//                 )}

//                 {/* Shipping & Notes */}
//                 <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "16px", marginBottom: "12px" }}>
//                   <div>
//                     {order.shippingLine && (
//                       <div>
//                         <h4 style={{ margin: "8px 0 4px 0" }}>Shipping Method</h4>
//                         <p style={{ margin: "0", fontSize: "14px" }}>
//                           {order.shippingLine.title} - {formatMoney(order.shippingLine.originalPriceSet)}
//                           {order.shippingLine.discountedPriceSet && (
//                             <span style={{ color: "#dc3545", marginLeft: "8px" }}>
//                               (Discounted: {formatMoney(order.shippingLine.discountedPriceSet)})
//                             </span>
//                           )}
//                         </p>
//                       </div>
//                     )}
                    
//                     {order.note && (
//                       <>
//                         <h4 style={{ margin: "12px 0 4px 0" }}>Order Note</h4>
//                         <p style={{ margin: "0", fontSize: "14px", fontStyle: "italic" }}>"{order.note}"</p>
//                       </>
//                     )}
//                   </div>
//                   <div></div>
//                 </div>

//                 {/* Discounts */}
//                 {order.discountApplications?.edges?.length > 0 && (
//                   <div style={{ marginBottom: "12px" }}>
//                     <h4 style={{ margin: "8px 0 4px 0" }}>Discounts Applied</h4>
//                     <ul style={{ margin: "0", paddingLeft: "16px", fontSize: "14px" }}>
//                       {order.discountApplications.edges.map((discount: any, index: number) => (
//                         <li key={index}>
//                           {discount.node.__typename === 'DiscountCodeApplication' && discount.node.code}
//                           {discount.node.value?.percentage && ` - ${discount.node.value.percentage}%`}
//                           {discount.node.value?.amount && ` - $${discount.node.value.amount}`}
//                         </li>
//                       ))}
//                     </ul>
//                   </div>
//                 )}

//                 {/* Line Items */}
//                 <details style={{ marginTop: "8px" }}>
//                   <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Line Items ({order.lineItems.edges.length})</summary>
//                   <div style={{ marginTop: "8px" }}>
//                     {order.lineItems.edges.map((li: any, i: number) => (
//                       <div 
//                         key={li.node.id} 
//                         style={{ 
//                           padding: "8px",
//                           backgroundColor: "white",
//                           borderRadius: "4px",
//                           marginBottom: "4px",
//                           border: "1px solid #eee"
//                         }}
//                       >
//                         <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
//                           <div style={{ flex: 1 }}>
//                             <div style={{ fontWeight: "bold" }}>{li.node.name}</div>
//                             <div style={{ fontSize: "12px", color: "#666" }}>
//                               {li.node.variantTitle && `Variant: ${li.node.variantTitle} | `}
//                               SKU: {li.node.sku || "N/A"} | Qty: {li.node.quantity}
//                             </div>
//                           </div>
//                           <div style={{ textAlign: "right" }}>
//                             <div>{formatMoney(li.node.discountedUnitPriceSet)} each</div>
//                             <div style={{ fontWeight: "bold" }}>{formatMoney(li.node.discountedTotalSet)} total</div>
//                           </div>
//                         </div>
                        
//                         {li.node.taxLines && li.node.taxLines.length > 0 && (
//                           <div style={{ marginTop: "4px", padding: "4px", backgroundColor: "#f8f9fa", borderRadius: "2px", fontSize: "12px" }}>
//                             <strong>Taxes:</strong> {li.node.taxLines.map((tax: any, index: number) => (
//                               <span key={index}>
//                                 {tax.title} ({tax.rate * 100}%): {formatMoney(tax.priceSet)}
//                                 {index < li.node.taxLines.length - 1 ? ', ' : ''}
//                               </span>
//                             ))}
//                           </div>
//                         )}
//                       </div>
//                     ))}
//                   </div>
//                 </details>

//                 {/* Fulfillments */}
//                 {order.fulfillments?.length > 0 && (
//                   <details style={{ marginTop: "8px" }}>
//                     <summary style={{ cursor: "pointer", fontWeight: "bold" }}>Fulfillments</summary>
//                     <div style={{ marginTop: "8px" }}>
//                       {order.fulfillments.map((fulfillment: any) => (
//                         <div key={fulfillment.id} style={{ fontSize: "14px", marginBottom: "8px", padding: "8px", backgroundColor: "white", borderRadius: "4px" }}>
//                           <div><strong>Status:</strong> {fulfillment.status}</div>
//                           <div><strong>Created:</strong> {new Date(fulfillment.createdAt).toLocaleString()}</div>
//                           {fulfillment.trackingInfo && fulfillment.trackingInfo.number && (
//                             <div>
//                               <strong>Tracking:</strong> {fulfillment.trackingInfo.company} - {fulfillment.trackingInfo.number}
//                               {fulfillment.trackingInfo.url && (
//                                 <a href={fulfillment.trackingInfo.url} target="_blank" rel="noopener noreferrer" style={{ marginLeft: "8px" }}>
//                                   (Track)
//                                 </a>
//                               )}
//                             </div>
//                           )}
//                         </div>
//                       ))}
//                     </div>
//                   </details>
//                 )}

//                 {/* Cancellation Info */}
//                 {order.cancelledAt && (
//                   <div style={{ marginTop: "8px", padding: "8px", backgroundColor: "#fff3cd", borderRadius: "4px", border: "1px solid #ffeaa7" }}>
//                     <strong>Order Cancelled</strong>
//                     <div>Date: {new Date(order.cancelledAt).toLocaleString()}</div>
//                     {order.cancelReason && <div>Reason: {order.cancelReason}</div>}
//                   </div>
//                 )}
//               </div>
//             );
//           })}
//         </div>
//       )}
//     </div>
//   );
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // MODIFICATION: Calculate net returns considering discrepancies
//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   // Count orders with over/under refunds
//   const ordersWithOverRefunds = orders.filter((order: any) => order.hasOverRefund).length;
//   const ordersWithUnderRefunds = orders.filter((order: any) => order.hasUnderRefund).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalNetReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns: totalNetReturns, // Now using net returns
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     ordersWithOverRefunds,
//     ordersWithUnderRefunds,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export default function OrdersDashboard() {
//   const { 
//     today, 
//     last7Days, 
//     last7DaysDaily, 
//     last30Days, 
//     last30DaysDaily,
//     // NEW: Additional time periods
//     todaysLast7Days,
//     last8Weeks,
//     last8WeeksWeekly,
//     last6MonthsPlusCurrent,
//     last6MonthsPlusCurrentMonthly,
//     shop, 
//     storeTimezone, 
//     debug 
//   } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last30DaysRegularSummary = calculateSummary(last30Days.regularOrders);
//   const last30DaysGiftCardSummary = calculateSummary(last30Days.giftCardOrders);


// // NEW: Calculate summaries for additional time periods
// const todaysLast7DaysRegularSummary = calculateSummary(todaysLast7Days.regularOrders);
// const todaysLast7DaysGiftCardSummary = calculateSummary(todaysLast7Days.giftCardOrders);

// const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
// const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

// const last6MonthsPlusCurrentRegularSummary = calculateSummary(last6MonthsPlusCurrent.regularOrders);
// const last6MonthsPlusCurrentGiftCardSummary = calculateSummary(last6MonthsPlusCurrent.giftCardOrders);

//   return (
//         <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Debug information */}
//       {debug && (
//         <details style={{ marginBottom: "20px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "5px" }}>
//           <summary>Debug Information</summary>
//           <pre style={{ fontSize: "12px", overflow: "auto" }}>
//             {JSON.stringify(debug, null, 2)}
//           </pre>
//         </details>
//       )}

//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders ({today.regularOrders.length + today.giftCardOrders.length} total)
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Today's Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Last 7 Days
//         </h2>
        
//         {/* Regular Orders - Today's Last 7 Days */}
//         <OrderDisplaySection 
//           orders={todaysLast7Days.regularOrders} 
//           summary={todaysLast7DaysRegularSummary} 
//           title="Regular Orders - Today's Last 7 Days" 
//           isGiftCard={false}
//           showIndividualOrders={false}
//         />

//         {/* Gift Card Orders - Today's Last 7 Days */}
//         <OrderDisplaySection 
//           orders={todaysLast7Days.giftCardOrders} 
//           summary={todaysLast7DaysGiftCardSummary} 
//           title="Gift Card Orders - Today's Last 7 Days" 
//           isGiftCard={true}
//           showIndividualOrders={false}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 7 Days</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 30 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 30 Days
//         </h2>

//         {/* Total Last 30 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 30 Days</h3>
          
//           {/* Regular Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.regularOrders} 
//             summary={last30DaysRegularSummary} 
//             title="Regular Orders - Last 30 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.giftCardOrders} 
//             summary={last30DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 30 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 30 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 30 Days</h3>
//           {last30DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown - Last 8 Weeks</h3>
//           {last8WeeksWeekly.map((week) => {
//             const weekRegularSummary = calculateSummary(week.regularOrders);
//             const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//             return (
//               <details key={week.weekStart} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   Week of {new Date(week.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//                     ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.regularOrders} 
//                     summary={weekRegularSummary} 
//                     title={`Regular Orders - Week of ${new Date(week.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.giftCardOrders} 
//                     summary={weekGiftCardSummary} 
//                     title={`Gift Card Orders - Week of ${new Date(week.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 6 Months + Current Month Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 6 Months + Current Month
//         </h2>

//         {/* Total Last 6 Months + Current */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 6 Months + Current Month</h3>
          
//           {/* Regular Orders Last 6 Months + Current */}
//           <OrderDisplaySection 
//             orders={last6MonthsPlusCurrent.regularOrders} 
//             summary={last6MonthsPlusCurrentRegularSummary} 
//             title="Regular Orders - Last 6 Months + Current" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 6 Months + Current */}
//           <OrderDisplaySection 
//             orders={last6MonthsPlusCurrent.giftCardOrders} 
//             summary={last6MonthsPlusCurrentGiftCardSummary} 
//             title="Gift Card Orders - Last 6 Months + Current" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Monthly Breakdown Last 6 Months + Current */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Monthly Breakdown - Last 6 Months + Current</h3>
//           {last6MonthsPlusCurrentMonthly.map((month) => {
//             const monthRegularSummary = calculateSummary(month.regularOrders);
//             const monthGiftCardSummary = calculateSummary(month.giftCardOrders);

//             return (
//               <details key={month.monthKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {monthRegularSummary.totalOrders + monthGiftCardSummary.totalOrders} orders  
//                     ${(monthRegularSummary.totalRevenue + monthGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this month */}
//                   <OrderDisplaySection 
//                     orders={month.regularOrders} 
//                     summary={monthRegularSummary} 
//                     title={`Regular Orders - ${new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this month */}
//                   <OrderDisplaySection 
//                     orders={month.giftCardOrders} 
//                     summary={monthGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }




























































// // app/routes/orders-last-7-days.tsx

// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone }); // en-CA gives YYYY-MM-DD format
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Helper function to get week start date (Monday)
// const getWeekStartDate = (dateString: string): string => {
//   const date = new Date(dateString + 'T00:00:00');
//   const day = date.getDay();
//   const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
//   const monday = new Date(date.setDate(diff));
//   return monday.toISOString().split('T')[0]; // Returns YYYY-MM-DD
// };

// // Helper to check if a UTC date is within last N days in store timezone
// const isWithinLastNDaysInStoreTime = (utcDate: Date, days: number, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  
//   // Calculate the start date (days ago) in store timezone
//   const startDateUTC = new Date(nowUTC);
//   startDateUTC.setDate(nowUTC.getDate() - days);
//   const startDateStore = getStoreLocalDateString(startDateUTC, storeTimezone);
  
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   return orderDateStore >= startDateStore && orderDateStore <= todayStore;
// };

// // Helper function to calculate summary
// const calculateSummary = (orders: any[]) => {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOutstanding = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalOutstandingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   // MODIFICATION: Calculate net returns considering discrepancies
//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalLineItemsPrice = orders.reduce((sum: number, order: any) => {
//     const lineItemsTotal = order.lineItems?.edges?.reduce((lineSum: number, li: any) => {
//       return lineSum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//     }, 0) || 0;
//     return sum + lineItemsTotal;
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
//   const fullyPaidOrders = orders.filter((order: any) => order.fullyPaid).length;

//   const ordersWithRefunds = orders.filter((order: any) => 
//     order.refunds && order.refunds.length > 0
//   ).length;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const ordersWithReturns = orders.filter((order: any) => 
//     order.returns?.nodes && order.returns.nodes.length > 0
//   ).length;

//   // Count orders with over/under refunds
//   const ordersWithOverRefunds = orders.filter((order: any) => order.hasOverRefund).length;
//   const ordersWithUnderRefunds = orders.filter((order: any) => order.hasUnderRefund).length;

//   const totalSales = totalGrossSales + totalShippingCharges + (totalRestockingFees + totalReturnShippingFees) + totalTaxes - totalNetReturns - totalDiscounts;

//   // Count orders by financial status
//   const financialStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFinancialStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   // Count orders by fulfillment status
//   const fulfillmentStatusCounts = orders.reduce((acc: any, order: any) => {
//     const status = order.displayFulfillmentStatus || 'unknown';
//     acc[status] = (acc[status] || 0) + 1;
//     return acc;
//   }, {});

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalOutstanding,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns: totalNetReturns, // Now using net returns
//     totalGrossSales,
//     totalNetSales,
//     totalLineItemsPrice,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     fullyPaidOrders,
//     ordersWithRefunds,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     ordersWithReturns,
//     ordersWithOverRefunds,
//     ordersWithUnderRefunds,
//     totalSales,
//     financialStatusCounts,
//     fulfillmentStatusCounts
//   };
// };

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   console.log('=== STORE TIME DEBUGGING ===');
//   console.log('Store timezone:', storeTimezone);
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  
//   console.log('Current UTC time:', nowUTC.toISOString());
//   console.log('Today in store time:', todayStore);
  
//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);
  
//   const sevenDaysAgoUTC = new Date(nowUTC);
//   sevenDaysAgoUTC.setDate(nowUTC.getDate() - 7);

//   console.log('Date ranges for API query:', {
//     sevenMonthsAgo: sevenMonthsAgoUTC.toISOString(),
//     now: nowUTC.toISOString()
//   });

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;
  
//   console.log('GraphQL query date range:', dateQuery);
//   console.log('Starting paginated order fetch...');

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 200; // Increased limit to fetch ALL orders

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
//     console.log(`Fetching page ${pageCount}...`);
    
//     const paginationVariables: any = { 
//       query: dateQuery,
//       first: 100 // Safe batch size
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query OrdersLast30Days($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
                
//                 # Enhanced Financial Information
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
                
//                 # Refund Discrepancy - Direct from Shopify
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }

//                 # Returns Information with Restocking Fees
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
                
//                 # Refund Information
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
                
//                 # Pricing Information
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
                
//                 # Fulfillment Information
//                 fulfillments(first: 5) {
//                   id
//                   status
//                   createdAt
//                   trackingInfo {
//                     company
//                     number
//                     url
//                   }
//                 }
                
//                 # Shipping Line Information
//                 shippingLine {
//                   title
//                   originalPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   discountedPriceSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                 }
                
//                 # Discount Information
//                 discountApplications(first: 5) {
//                   edges {
//                     node {
//                       __typename
//                       ... on DiscountCodeApplication {
//                         code
//                         allocationMethod
//                         targetType
//                         value {
//                           ... on MoneyV2 {
//                             amount
//                             currencyCode
//                           }
//                           ... on PricingPercentageValue {
//                             percentage
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
                
//                 # Line Items with enhanced details including tax lines
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       # Tax lines for each line item
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }
//         `,
//         { variables: paginationVariables }
//       );

//       const jsonData = await response.json();
      
//       // Check for GraphQL errors in the response data
//       if (jsonData.errors && Array.isArray(jsonData.errors)) {
//         console.error('GraphQL Errors:', jsonData.errors);
        
//         // Check for API limit errors
//         const apiLimitError = jsonData.errors.find((error: any) => 
//           error.message?.includes('limit') || 
//           error.message?.includes('throttle') ||
//           error.message?.includes('rate limit')
//         );
        
//         if (apiLimitError) {
//           console.warn('API limit approached, stopping pagination');
//           break;
//         }
        
//         throw new Error(`GraphQL error: ${JSON.stringify(jsonData.errors)}`);
//       }

//       const ordersData = jsonData?.data?.orders;
      
//       if (!ordersData) {
//         console.error('No orders data in response:', jsonData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
      
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);
      
//       allOrders = [...allOrders, ...pageOrders];
      
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;
      
//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         console.log(`Waiting 200ms before next page...`);
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }
      
//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);
      
//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
      
//       // Check if it's an API limit error
//       if (error.message?.includes('limit') || error.message?.includes('throttle')) {
//         console.warn('API limit reached, stopping pagination');
//         break;
//       }
      
//       // For other errors, wait and retry once
//       console.log('Waiting 1 second before retry...');
//       await new Promise(resolve => setTimeout(resolve, 1000));
      
//       try {
//         // Retry logic could go here, but for now we'll break
//         console.warn('Skipping to next page after error');
//         break;
//       } catch (retryError) {
//         console.error('Retry also failed, stopping pagination');
//         break;
//       }
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Process orders and separate gift card transactions
//   const processOrders = (orders: any[]) => {
//     const regularOrders: any[] = [];
//     const giftCardOrders: any[] = [];
//     const mixedOrdersRegular: any[] = [];
//     const mixedOrdersGiftCard: any[] = [];

//     orders.forEach((order: any) => {
//       // Check if order contains gift cards
//       const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') ||
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (!hasGiftCards) {
//         // Pure regular order
//         processRegularOrder(order, regularOrders);
//       } else {
//         // Order contains gift cards - check if mixed or pure gift card
//         const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//           li.node.name?.toLowerCase().includes('gift card') || 
//           li.node.title?.toLowerCase().includes('gift card') ||
//           li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//           !li.node.name?.toLowerCase().includes('gift card') && 
//           !li.node.title?.toLowerCase().includes('gift card') &&
//           !li.node.product?.title?.toLowerCase().includes('gift card')
//         );

//         if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//           // Mixed order - split into regular and gift card portions
//           processMixedOrder(order, regularLineItems, giftCardLineItems, mixedOrdersRegular, mixedOrdersGiftCard);
//         } else {
//           // Pure gift card order
//           processGiftCardOrder(order, giftCardOrders);
//         }
//       }
//     });

//     function processRegularOrder(order: any, targetArray: any[]) {
//       const processed = calculateOrderMetrics(order);
//       targetArray.push(processed);
//     }

//     function processGiftCardOrder(order: any, targetArray: any[]) {
//       // Create a copy of the order with zero shipping
//       const giftCardOrder = {
//         ...order,
//         totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//         totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: "USD" } },
//         shippingLine: null
//       };
      
//       const processed = calculateOrderMetrics(giftCardOrder);
//       processed.isGiftCardOrder = true;
//       targetArray.push(processed);
//     }

//     function processMixedOrder(
//       order: any, 
//       regularLineItems: any[], 
//       giftCardLineItems: any[], 
//       regularTarget: any[], 
//       giftCardTarget: any[]
//     ) {
//       // Calculate base subtotals for each portion
//       const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0);

//       const totalSubtotal = regularSubtotal + giftCardSubtotal;

//       // Calculate ACTUAL discounts per portion based on line item discounts
//       let regularDiscounts = 0;
//       let giftCardDiscounts = 0;

//       regularLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         regularDiscounts += lineItemDiscount;
//       });

//       giftCardLineItems.forEach((li: any) => {
//         const originalTotal = parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         const discountedTotal = parseFloat(li.node.discountedTotalSet?.shopMoney?.amount || 0);
//         const lineItemDiscount = originalTotal - discountedTotal;
//         giftCardDiscounts += lineItemDiscount;
//       });

//       // Calculate ACTUAL refunds per portion based on refund line items
//       let regularRefunds = 0;
//       let giftCardRefunds = 0;

//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((refundLine: any) => {
//           const refundAmount = parseFloat(refundLine.node.subtotalSet?.shopMoney?.amount || 0);
//           const lineItemId = refundLine.node.lineItem?.id;
          
//           // Find which portion this refund belongs to by checking line item ID
//           const isRegularRefund = regularLineItems.some((li: any) => li.node.id === lineItemId);
//           const isGiftCardRefund = giftCardLineItems.some((li: any) => li.node.id === lineItemId);
          
//           if (isRegularRefund) {
//             regularRefunds += refundAmount;
//           } else if (isGiftCardRefund) {
//             giftCardRefunds += refundAmount;
//           }
//         });
//       });

//       // MODIFICATION 1: Remove shipping fees from gift cards - ALL shipping goes to regular orders
//       const totalShipping = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const totalShippingRefunds = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
      
//       // Gift cards get NO shipping fees
//       const regularShipping = totalShipping;
//       const giftCardShipping = 0; // No shipping for gift cards
//       const regularShippingRefunds = totalShippingRefunds;
//       const giftCardShippingRefunds = 0; // No shipping refunds for gift cards

//       // Calculate taxes per portion based on actual line item taxes
//       let regularTaxes = 0;
//       let giftCardTaxes = 0;

//       regularLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           regularTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       giftCardLineItems.forEach((li: any) => {
//         li.node.taxLines?.forEach((tax: any) => {
//           giftCardTaxes += parseFloat(tax.priceSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Helper function to create money set
//       const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//         return {
//           shopMoney: {
//             amount: amount.toFixed(2),
//             currencyCode
//           }
//         };
//       };

//       // Create regular portion with ALL shipping
//       const regularPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: regularLineItems },
        
//         // Financial data specific to regular portion - with ALL shipping
//         subtotalPriceSet: createMoneySet(regularSubtotal),
//         currentSubtotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts),
//         totalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
//         currentTotalPriceSet: createMoneySet(regularSubtotal - regularDiscounts + regularShipping + regularTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(regularSubtotal + regularShipping + regularTaxes),
//         totalRefundedSet: createMoneySet(regularRefunds + regularShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(regularDiscounts),
//         totalShippingPriceSet: createMoneySet(regularShipping),
//         totalRefundedShippingSet: createMoneySet(regularShippingRefunds),
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(regularTaxes),
//         currentTotalDiscountsSet: createMoneySet(regularDiscounts),
        
//         // Refunds - filter to only include refunds that apply to regular items
//         refunds: order.refunds?.map((refund: any) => {
//           const regularRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             regularLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (regularRefundItems.length === 0) return null;
          
//           const refundTotal = regularRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + regularShippingRefunds),
//             refundLineItems: { edges: regularRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line
//         shippingLine: order.shippingLine ? {
//           ...order.shippingLine,
//           originalPriceSet: createMoneySet(regularShipping),
//           discountedPriceSet: createMoneySet(regularShipping)
//         } : null,
        
//         // Metadata
//         isMixedOrderRegular: true,
//         originalOrderName: order.name,
//         portionSubtotal: regularSubtotal
//       };

//       // Create gift card portion with NO shipping
//       const giftCardPortion = {
//         ...order,
//         // Split line items
//         lineItems: { edges: giftCardLineItems },
        
//         // Financial data specific to gift card portion - NO shipping
//         subtotalPriceSet: createMoneySet(giftCardSubtotal),
//         currentSubtotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts),
//         totalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
//         currentTotalPriceSet: createMoneySet(giftCardSubtotal - giftCardDiscounts + giftCardShipping + giftCardTaxes),
        
//         // Payment data
//         totalReceivedSet: createMoneySet(giftCardSubtotal + giftCardShipping + giftCardTaxes),
//         totalRefundedSet: createMoneySet(giftCardRefunds + giftCardShippingRefunds),
//         totalOutstandingSet: createMoneySet(0),
        
//         // Costs and fees - ACTUAL amounts, not proportional
//         totalDiscountsSet: createMoneySet(giftCardDiscounts),
//         totalShippingPriceSet: createMoneySet(giftCardShipping), // Zero shipping for gift cards
//         totalRefundedShippingSet: createMoneySet(giftCardShippingRefunds), // Zero shipping refunds
//         refundDiscrepancySet: createMoneySet(0),
//         currentTotalTaxSet: createMoneySet(giftCardTaxes),
//         currentTotalDiscountsSet: createMoneySet(giftCardDiscounts),
        
//         // Refunds - filter to only include refunds that apply to gift card items
//         refunds: order.refunds?.map((refund: any) => {
//           const giftCardRefundItems = refund.refundLineItems?.edges?.filter((refundLine: any) => 
//             giftCardLineItems.some((li: any) => li.node.id === refundLine.node.lineItem?.id)
//           ) || [];
          
//           if (giftCardRefundItems.length === 0) return null;
          
//           const refundTotal = giftCardRefundItems.reduce((sum: number, line: any) => 
//             sum + parseFloat(line.node.subtotalSet?.shopMoney?.amount || 0), 0);
          
//           return {
//             ...refund,
//             totalRefundedSet: createMoneySet(refundTotal + giftCardShippingRefunds),
//             refundLineItems: { edges: giftCardRefundItems }
//           };
//         }).filter(Boolean),
        
//         // Returns
//         returns: { nodes: [] },
        
//         // Shipping line - no shipping for gift cards
//         shippingLine: null,
        
//         // Metadata
//         isMixedOrderGiftCard: true,
//         originalOrderName: order.name,
//         portionSubtotal: giftCardSubtotal
//       };

//       // Process both portions with their own metrics
//       const processedRegular = calculateOrderMetrics(regularPortion);
//       regularTarget.push(processedRegular);

//       const processedGiftCard = calculateOrderMetrics(giftCardPortion);
//       giftCardTarget.push(processedGiftCard);
//     }

//     function calculateOrderMetrics(order: any) {
//       // Calculate line items total (ORIGINAL prices before discounts)
//       const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//         return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//       }, 0) || 0;

//       // Get discounts from the order data
//       const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//       // Get refund discrepancy directly from Shopify
//       const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//       // Calculate gross returns (sum of refunded line items)
//       let grossReturns = 0;
//       order.refunds?.forEach((refund: any) => {
//         refund.refundLineItems?.edges?.forEach((edge: any) => {
//           grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//         });
//       });

//       // Calculate refunded shipping
//       const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//       // Calculate shipping charges
//       const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//       const shippingCharges = shippingAmount - refundedShipping;

//       // Calculate restocking fees and return shipping fees
//       let totalRestockingFees = 0;
//       let totalReturnShippingFees = 0;

//       order.returns?.nodes?.forEach((returnItem: any) => {
//         returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//           if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//             totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//           }
//         });

//         returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//           if (shippingFee?.amountSet?.shopMoney?.amount) {
//             totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//           }
//         });
//       });

//       // Calculate total return fees
//       const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//       // CORRECTED: Calculate sales metrics using accurate data
//       // Gross Sales = Original line items total (BEFORE any discounts)
//       const grossSales = lineItemsTotal;
      
//       // Net Sales = Gross Sales - Returns - Discounts
//       let netSales = grossSales - grossReturns - discounts;
      
//       // MODIFICATION: Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//       if (refundDiscrepancy > 0) {
//         // Positive discrepancy = OVER-refund (we refunded more than we should have)
//         // This means we lost additional money, so ADD to net sales (increases the loss/reduces revenue)
//         netSales += refundDiscrepancy;
//       } else if (refundDiscrepancy < 0) {
//         // Negative discrepancy = UNDER-refund (we refunded less than we should have)  
//         // This means we kept additional money, so DEDUCT from net sales (increases revenue)
//         netSales -= Math.abs(refundDiscrepancy);
//       }

//       // Calculate net returns (gross returns adjusted for discrepancies)
//       let netReturns = grossReturns;
//       if (refundDiscrepancy > 0) {
//         // Over-refund means we refunded MORE than we should have
//         netReturns = grossReturns - refundDiscrepancy;
//       } else if (refundDiscrepancy < 0) {
//         // Under-refund means we refunded LESS than we should have  
//         netReturns = grossReturns + Math.abs(refundDiscrepancy);
//       }

//       return {
//         ...order,
//         calculatedGrossSales: grossSales,
//         calculatedGrossReturns: grossReturns,
//         calculatedNetReturns: netReturns,
//         calculatedRefundedShipping: refundedShipping,
//         calculatedNetSales: netSales,
//         calculatedRefundDiscrepancy: refundDiscrepancy,
//         calculatedRestockingFees: totalRestockingFees,
//         calculatedReturnShippingFees: totalReturnShippingFees,
//         calculatedTotalReturnFees: totalReturnFees,
//         calculatedShippingCharges: shippingCharges,
//         // Add flags for display purposes
//         hasOverRefund: refundDiscrepancy > 0,
//         hasUnderRefund: refundDiscrepancy < 0
//       };
//     }

//     // Combine all regular orders (pure regular + mixed regular portions)
//     const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//     const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];

//     return {
//       regularOrders: allRegularOrders,
//       giftCardOrders: allGiftCardOrders
//     };
//   };

//   // Filter orders for each time period using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   const last7DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 7, storeTimezone);
//   });

//   const last30DaysOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 30, storeTimezone);
//   });

//   // NEW: Today's last 7 days (rolling 7 days including today)
//   const todaysLast7DaysOrders = last7DaysOrders;

//   // NEW: Last 8 weeks
//   const last8WeeksOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isWithinLastNDaysInStoreTime(orderDateUTC, 56, storeTimezone); // 8 weeks * 7 days
//   });

//   // NEW: Last 6 months + current month
//   const last6MonthsPlusCurrentOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const sevenMonthsAgoUTC = new Date(nowUTC);
//     sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const sevenMonthsAgoStore = getStoreLocalDateString(sevenMonthsAgoUTC, storeTimezone);
//     return orderDateStore >= sevenMonthsAgoStore && orderDateStore <= todayStore;
//   });

//   // Debug: log some order dates to verify
//   console.log('Sample order dates for verification:');
//   allOrders.slice(0, 5).forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const orderDateStore = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const isToday = isTodayInStoreTime(orderDateUTC, storeTimezone);
//     console.log(`Order ${order.name}: UTC: ${orderDateUTC.toISOString()} -> Store: ${orderDateStore} -> Today: ${isToday}`);
//   });

//   console.log(`Today orders: ${todayOrders.length}`);
//   console.log(`Last 7 days orders: ${last7DaysOrders.length}`);
//   console.log(`Last 30 days orders: ${last30DaysOrders.length}`);
//   console.log(`Today's Last 7 Days orders: ${todaysLast7DaysOrders.length}`);
//   console.log(`Last 8 Weeks orders: ${last8WeeksOrders.length}`);
//   console.log(`Last 6 Months + Current orders: ${last6MonthsPlusCurrentOrders.length}`);

//   // Process orders for each time period
//   const todayProcessed = processOrders(todayOrders);
//   const last7DaysProcessed = processOrders(last7DaysOrders);
//   const last30DaysProcessed = processOrders(last30DaysOrders);

//   // NEW: Process new time period orders
//   const todaysLast7DaysProcessed = processOrders(todaysLast7DaysOrders);
//   const last8WeeksProcessed = processOrders(last8WeeksOrders);
//   const last6MonthsPlusCurrentProcessed = processOrders(last6MonthsPlusCurrentOrders);

//   // Group last 7 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last7DaysByDate: { [key: string]: any[] } = {};
//   last7DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last7DaysByDate[dateKey]) {
//       last7DaysByDate[dateKey] = [];
//     }
//     last7DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 7 days
//   const last7DaysDaily = Object.keys(last7DaysByDate)
//     .sort()
//     .reverse()
//     .map(dateKey => {
//       const dayOrders = last7DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // Group last 30 days orders by date for daily breakdown using STORE LOCAL TIME
//   const last30DaysByDate: { [key: string]: any[] } = {};
//   last30DaysOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     if (!last30DaysByDate[dateKey]) {
//       last30DaysByDate[dateKey] = [];
//     }
//     last30DaysByDate[dateKey].push(order);
//   });

//   // Process each day for last 30 days
//   const last30DaysDaily = Object.keys(last30DaysByDate)
//     .sort()
//     .reverse()
//     .slice(0, 30) // Only take last 30 days
//     .map(dateKey => {
//       const dayOrders = last30DaysByDate[dateKey];
//       const processed = processOrders(dayOrders);
//       return {
//         dateKey,
//         date: new Date(dateKey + 'T00:00:00'), // Create date from YYYY-MM-DD
//         ...processed
//       };
//     });

//   // NEW: Group last 8 weeks orders by week for weekly breakdown
//   const last8WeeksByWeek: { [key: string]: any[] } = {};
//   last8WeeksOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const weekStart = getWeekStartDate(dateKey);
//     if (!last8WeeksByWeek[weekStart]) {
//       last8WeeksByWeek[weekStart] = [];
//     }
//     last8WeeksByWeek[weekStart].push(order);
//   });

//   // Process each week for last 8 weeks
//   const last8WeeksWeekly = Object.keys(last8WeeksByWeek)
//     .sort()
//     .reverse()
//     .slice(0, 8) // Only take last 8 weeks
//     .map(weekStart => {
//       const weekOrders = last8WeeksByWeek[weekStart];
//       const processed = processOrders(weekOrders);
//       return {
//         weekStart,
//         date: new Date(weekStart + 'T00:00:00'),
//         ...processed
//       };
//     });

//   // NEW: Group last 6 months + current by month for monthly breakdown
//   const last6MonthsPlusCurrentByMonth: { [key: string]: any[] } = {};
//   last6MonthsPlusCurrentOrders.forEach((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     const dateKey = getStoreLocalDateString(orderDateUTC, storeTimezone);
//     const monthKey = dateKey.substring(0, 7); // YYYY-MM
//     if (!last6MonthsPlusCurrentByMonth[monthKey]) {
//       last6MonthsPlusCurrentByMonth[monthKey] = [];
//     }
//     last6MonthsPlusCurrentByMonth[monthKey].push(order);
//   });

//   // Process each month for last 6 months + current
//   const last6MonthsPlusCurrentMonthly = Object.keys(last6MonthsPlusCurrentByMonth)
//     .sort()
//     .reverse()
//     .slice(0, 7) // Only take last 7 months (6 + current)
//     .map(monthKey => {
//       const monthOrders = last6MonthsPlusCurrentByMonth[monthKey];
//       const processed = processOrders(monthOrders);
//       return {
//         monthKey,
//         date: new Date(monthKey + '-01T00:00:00'), // First day of month
//         ...processed
//       };
//     });

//   console.log('=== END STORE TIME DEBUGGING ===');

//   return json({ 
//     today: todayProcessed,
//     last7Days: last7DaysProcessed,
//     last7DaysDaily,
//     last30Days: last30DaysProcessed,
//     last30DaysDaily,
//     // NEW: Additional time periods
//     todaysLast7Days: todaysLast7DaysProcessed,
//     last8Weeks: last8WeeksProcessed,
//     last8WeeksWeekly,
//     last6MonthsPlusCurrent: last6MonthsPlusCurrentProcessed,
//     last6MonthsPlusCurrentMonthly,
//     shop,
//     storeTimezone,
//     debug: {
//       nowUTC: nowUTC.toISOString(),
//       todayStore,
//       pagination: {
//         totalPages: pageCount,
//         totalOrders: allOrders.length,
//         reachedSafetyLimit: pageCount >= maxPages
//       },
//       todayOrdersCount: todayOrders.length,
//       last7DaysOrdersCount: last7DaysOrders.length,
//       last30DaysOrdersCount: last30DaysOrders.length,
//       todaysLast7DaysOrdersCount: todaysLast7DaysOrders.length,
//       last8WeeksOrdersCount: last8WeeksOrders.length,
//       last6MonthsPlusCurrentOrdersCount: last6MonthsPlusCurrentOrders.length,
//       sampleOrders: allOrders.slice(0, 3).map((order: any) => ({
//         name: order.name,
//         createdAtUTC: order.createdAt,
//         createdAtStore: getStoreLocalDateString(new Date(order.createdAt), storeTimezone),
//         isToday: isTodayInStoreTime(new Date(order.createdAt), storeTimezone)
//       }))
//     }
//   });
// };

// // OrderDisplaySection component (keep the full component as you had it)
// // ... [Include your complete OrderDisplaySection component here]

// // Since the file is very large, I'll provide a placeholder. Make sure to include your complete OrderDisplaySection component
// const OrderDisplaySection = ({ 
//   orders, 
//   summary, 
//   title, 
//   isGiftCard = false,
//   showIndividualOrders = true
// }: { 
//   orders: any[], 
//   summary: any, 
//   title: string, 
//   isGiftCard?: boolean,
//   showIndividualOrders?: boolean
// }) => {
//   // Your complete OrderDisplaySection implementation goes here
//   return <div>Order Display Section</div>;
// };

// export default function OrdersDashboard() {
//   const { 
//     today, 
//     last7Days, 
//     last7DaysDaily, 
//     last30Days, 
//     last30DaysDaily,
//     // NEW: Additional time periods
//     todaysLast7Days,
//     last8Weeks,
//     last8WeeksWeekly,
//     last6MonthsPlusCurrent,
//     last6MonthsPlusCurrentMonthly,
//     shop, 
//     storeTimezone, 
//     debug 
//   } = useLoaderData<typeof loader>();

//   // Calculate summaries for each section
//   const todayRegularSummary = calculateSummary(today.regularOrders);
//   const todayGiftCardSummary = calculateSummary(today.giftCardOrders);
  
//   const last7DaysRegularSummary = calculateSummary(last7Days.regularOrders);
//   const last7DaysGiftCardSummary = calculateSummary(last7Days.giftCardOrders);
  
//   const last30DaysRegularSummary = calculateSummary(last30Days.regularOrders);
//   const last30DaysGiftCardSummary = calculateSummary(last30Days.giftCardOrders);

//   // NEW: Calculate summaries for additional time periods
//   const todaysLast7DaysRegularSummary = calculateSummary(todaysLast7Days.regularOrders);
//   const todaysLast7DaysGiftCardSummary = calculateSummary(todaysLast7Days.giftCardOrders);

//   const last8WeeksRegularSummary = calculateSummary(last8Weeks.regularOrders);
//   const last8WeeksGiftCardSummary = calculateSummary(last8Weeks.giftCardOrders);

//   const last6MonthsPlusCurrentRegularSummary = calculateSummary(last6MonthsPlusCurrent.regularOrders);
//   const last6MonthsPlusCurrentGiftCardSummary = calculateSummary(last6MonthsPlusCurrent.giftCardOrders);

//   return (
//     <div style={{ padding: "20px" }}>
//       <h1 style={{ marginBottom: "10px", textAlign: "center" }}>Orders Analytics Dashboard</h1>
//       <p style={{ textAlign: "center", color: "#666", marginBottom: "30px" }}>
//         Times displayed in store local time ({storeTimezone})
//       </p>

//       {/* Debug information */}
//       {debug && (
//         <details style={{ marginBottom: "20px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "5px" }}>
//           <summary>Debug Information</summary>
//           <pre style={{ fontSize: "12px", overflow: "auto" }}>
//             {JSON.stringify(debug, null, 2)}
//           </pre>
//         </details>

//  )}
//       {/* Today Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Orders ({today.regularOrders.length + today.giftCardOrders.length} total)
//         </h2>
        
//         {/* Regular Orders Today */}
//         <OrderDisplaySection 
//           orders={today.regularOrders} 
//           summary={todayRegularSummary} 
//           title="Regular Orders - Today" 
//           isGiftCard={false}
//         />

//         {/* Gift Card Orders Today */}
//         <OrderDisplaySection 
//           orders={today.giftCardOrders} 
//           summary={todayGiftCardSummary} 
//           title="Gift Card Orders - Today" 
//           isGiftCard={true}
//         />
//       </div>

//       {/* Today's Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Today's Last 7 Days
//         </h2>
        
//         {/* Regular Orders - Today's Last 7 Days */}
//         <OrderDisplaySection 
//           orders={todaysLast7Days.regularOrders} 
//           summary={todaysLast7DaysRegularSummary} 
//           title="Regular Orders - Today's Last 7 Days" 
//           isGiftCard={false}
//           showIndividualOrders={false}
//         />

//         {/* Gift Card Orders - Today's Last 7 Days */}
//         <OrderDisplaySection 
//           orders={todaysLast7Days.giftCardOrders} 
//           summary={todaysLast7DaysGiftCardSummary} 
//           title="Gift Card Orders - Today's Last 7 Days" 
//           isGiftCard={true}
//           showIndividualOrders={false}
//         />
//       </div>

//       {/* Last 7 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 7 Days
//         </h2>

//         {/* Total Last 7 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 7 Days</h3>
          
//           {/* Regular Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.regularOrders} 
//             summary={last7DaysRegularSummary} 
//             title="Regular Orders - Last 7 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 7 Days */}
//           <OrderDisplaySection 
//             orders={last7Days.giftCardOrders} 
//             summary={last7DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 7 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 7 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 7 Days</h3>
//           {last7DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 30 Days Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 30 Days
//         </h2>

//         {/* Total Last 30 Days */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 30 Days</h3>
          
//           {/* Regular Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.regularOrders} 
//             summary={last30DaysRegularSummary} 
//             title="Regular Orders - Last 30 Days Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 30 Days */}
//           <OrderDisplaySection 
//             orders={last30Days.giftCardOrders} 
//             summary={last30DaysGiftCardSummary} 
//             title="Gift Card Orders - Last 30 Days Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Daily Breakdown Last 30 Days */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Daily Breakdown - Last 30 Days</h3>
//           {last30DaysDaily.map((day) => {
//             const dayRegularSummary = calculateSummary(day.regularOrders);
//             const dayGiftCardSummary = calculateSummary(day.giftCardOrders);

//             return (
//               <details key={day.dateKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {dayRegularSummary.totalOrders + dayGiftCardSummary.totalOrders} orders  
//                     ${(dayRegularSummary.totalRevenue + dayGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.regularOrders} 
//                     summary={dayRegularSummary} 
//                     title={`Regular Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this day */}
//                   <OrderDisplaySection 
//                     orders={day.giftCardOrders} 
//                     summary={dayGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(day.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 8 Weeks Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 8 Weeks
//         </h2>

//         {/* Total Last 8 Weeks */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 8 Weeks</h3>
          
//           {/* Regular Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.regularOrders} 
//             summary={last8WeeksRegularSummary} 
//             title="Regular Orders - Last 8 Weeks Total" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 8 Weeks */}
//           <OrderDisplaySection 
//             orders={last8Weeks.giftCardOrders} 
//             summary={last8WeeksGiftCardSummary} 
//             title="Gift Card Orders - Last 8 Weeks Total" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Weekly Breakdown Last 8 Weeks */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Weekly Breakdown - Last 8 Weeks</h3>
//           {last8WeeksWeekly.map((week) => {
//             const weekRegularSummary = calculateSummary(week.regularOrders);
//             const weekGiftCardSummary = calculateSummary(week.giftCardOrders);

//             return (
//               <details key={week.weekStart} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   Week of {new Date(week.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {weekRegularSummary.totalOrders + weekGiftCardSummary.totalOrders} orders  
//                     ${(weekRegularSummary.totalRevenue + weekGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.regularOrders} 
//                     summary={weekRegularSummary} 
//                     title={`Regular Orders - Week of ${new Date(week.date).toLocaleDateString()}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this week */}
//                   <OrderDisplaySection 
//                     orders={week.giftCardOrders} 
//                     summary={weekGiftCardSummary} 
//                     title={`Gift Card Orders - Week of ${new Date(week.date).toLocaleDateString()}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>

//       {/* Last 6 Months + Current Month Section */}
//       <div style={{ marginBottom: "50px" }}>
//         <h2 style={{ borderBottom: "2px solid #333", paddingBottom: "8px", marginBottom: "30px" }}>
//           Last 6 Months + Current Month
//         </h2>

//         {/* Total Last 6 Months + Current */}
//         <div style={{ marginBottom: "40px" }}>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Total Last 6 Months + Current Month</h3>
          
//           {/* Regular Orders Last 6 Months + Current */}
//           <OrderDisplaySection 
//             orders={last6MonthsPlusCurrent.regularOrders} 
//             summary={last6MonthsPlusCurrentRegularSummary} 
//             title="Regular Orders - Last 6 Months + Current" 
//             isGiftCard={false}
//             showIndividualOrders={false}
//           />

//           {/* Gift Card Orders Last 6 Months + Current */}
//           <OrderDisplaySection 
//             orders={last6MonthsPlusCurrent.giftCardOrders} 
//             summary={last6MonthsPlusCurrentGiftCardSummary} 
//             title="Gift Card Orders - Last 6 Months + Current" 
//             isGiftCard={true}
//             showIndividualOrders={false}
//           />
//         </div>

//         {/* Monthly Breakdown Last 6 Months + Current */}
//         <div>
//           <h3 style={{ color: "#333", marginBottom: "20px" }}>Monthly Breakdown - Last 6 Months + Current</h3>
//           {last6MonthsPlusCurrentMonthly.map((month) => {
//             const monthRegularSummary = calculateSummary(month.regularOrders);
//             const monthGiftCardSummary = calculateSummary(month.giftCardOrders);

//             return (
//               <details key={month.monthKey} style={{ marginBottom: "20px" }}>
//                 <summary style={{ 
//                   cursor: "pointer", 
//                   fontWeight: "bold", 
//                   fontSize: "18px",
//                   backgroundColor: "#f8f9fa",
//                   padding: "16px",
//                   borderRadius: "8px",
//                   border: "1px solid #e5e5e5"
//                 }}>
//                   {new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })} 
//                   <span style={{ float: 'right', fontWeight: 'normal', fontSize: '16px' }}>
//                     {monthRegularSummary.totalOrders + monthGiftCardSummary.totalOrders} orders  
//                     ${(monthRegularSummary.totalRevenue + monthGiftCardSummary.totalRevenue).toFixed(2)}
//                   </span>
//                 </summary>
                
//                 <div style={{ marginTop: "16px" }}>
//                   {/* Regular Orders for this month */}
//                   <OrderDisplaySection 
//                     orders={month.regularOrders} 
//                     summary={monthRegularSummary} 
//                     title={`Regular Orders - ${new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`} 
//                     isGiftCard={false}
//                     showIndividualOrders={false}
//                   />

//                   {/* Gift Card Orders for this month */}
//                   <OrderDisplaySection 
                   

//                     orders={month.giftCardOrders} 
//                     summary={monthGiftCardSummary} 
//                     title={`Gift Card Orders - ${new Date(month.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`} 
//                     isGiftCard={true}
//                     showIndividualOrders={false}
//                   />
//                 </div>
//               </details>
//             );
//           })}
//         </div>
//       </div>
//     </div>
//   );
// }



































































































































// // ==================== 1.0 IMPORTS & SETUP ====================

// import { json, type LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import { useState, useEffect, useMemo } from "react";
// import "../styles/orders.css";

// import {
//   Chart as ChartJS,
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   LineElement,
//   PointElement,
//   ArcElement,
//   Title,
//   Tooltip,
//   Legend,
//   Filler,
// } from 'chart.js';
// import { Bar, Line, Pie, Doughnut } from 'react-chartjs-2';

// // Import types
// import type {
//   Order,
//   OrderStats,
//   CustomerData,
//   AnalyticsData,
//   CachedAnalyticsData,
//   OrderData,
//   EventSummary
// } from '../types/analytics';

// // Import core functionality
// import { analyticsLoader } from '../core/analyticsLoader.server';
// import { generatePDFReport } from '../components/analytics/pdfExport';
// import { ChartComponents } from '../components/analytics/charts';

// ChartJS.register(
//   CategoryScale,
//   LinearScale,
//   BarElement,
//   LineElement,
//   PointElement,
//   ArcElement,
//   Title,
//   Tooltip,
//   Legend,
//   Filler
// );

// // ==================== 2.0 ICON COMPONENTS ====================

// const Icon = {
//   Print: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
//     </svg>
//   ),
//   TrendUp: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
//     </svg>
//   ),
//   TrendDown: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/>
//     </svg>
//   ),
//   Export: () => (
//     <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
//     </svg>
//   )
// };

// const SvgIcons = {
//   Chart: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
//     </svg>
//   ),
//   TrendingUp: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
//     </svg>
//   ),
//   Dollar: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.78-1.18 2.73-3.12 3.16z"/>
//     </svg>
//   ),
//   Rocket: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M2.81 14.12L5.64 11.29l-1.41-1.42L1.42 12.7l1.39 1.42zM14.12 2.81L11.29 5.64l1.42 1.41 1.41-1.41-1.41-1.42zm8.03 9.91l-1.39-1.42-2.81 2.81 1.41 1.42 2.79-2.81zM7.34 12.5l4.16-4.16L12.5 7.34 8.34 11.5 7.34 12.5zM19.67 7.34l1.39-1.39c.38-.38.38-1.02 0-1.41l-1.39-1.39c-.38-.38-1.02-.38-1.41 0l-1.39 1.39 1.41 1.41 1.39-1.39zM5.63 19.67l1.39 1.39c.38.38 1.02.38 1.41 0l1.39-1.39-1.41-1.41-1.39 1.39zM3.52 15.62c-.39-.39-.39-1.02 0-1.41l1.39-1.39 1.41 1.41-1.39 1.39c-.38.38-1.02.38-1.41 0z"/>
//     </svg>
//   ),
//   Users: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A2.01 2.01 0 0018.06 7h-.12a2 2 0 00-1.9 1.37l-.86 2.58c1.08.6 1.82 1.73 1.82 3.05v8h3zm-7.5-10.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4zm6.5 0v-4h1v-4c0-.82-.68-1.5-1.5-1.5h-2c-.82 0-1.5.68-1.5 1.5v4h1v4h3z"/>
//     </svg>
//   ),
//   Activity: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M13 7h-2v6h6v-2h-4V7zM3 3v18h18V3H3zm16 16H5V5h14v14z"/>
//     </svg>
//   ),
//   Warning: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
//     </svg>
//   ),
//   Analytics: () => (
//     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
//       <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
//     </svg>
//   )
// };

// // ==================== 3.0 LOADING COMPONENT ====================

// function LoadingProgress() {
//   const loadingSteps = [
//     "Fetching recent orders...",
//     "Analyzing revenue data...", 
//     "Processing customer insights...",
//     "Calculating fulfillment rates...",
//     "Generating sales analytics..."
//   ];

//   return (
//     <div className="loading-progress-container">
//       <div className="loading-header">
//         <h2>Loading Analytics Dashboard</h2>
//         <p>Analyzing your order data and generating insights...</p>
//       </div>
      
//       <div className="progress-bar-container">
//         <div className="progress-bar">
//           <div className="progress-fill"></div>
//         </div>
//       </div>

//       <div className="loading-steps">
//         {loadingSteps.map((step, index) => (
//           <div key={index} className="loading-step">
//             <div className="step-indicator"></div>
//             <div className="step-text">{step}</div>
//           </div>
//         ))}
//       </div>
//     </div>
//   );
// }

// // ==================== 4.0 EVENT SUMMARY COMPONENT ====================

// function EventSummaryDisplay({ eventSummary, title }: { eventSummary: EventSummary, title: string }) {
//   if (!eventSummary || eventSummary.totalEvents === 0) {
//     return null;
//   }

//   const formatValue = (value: number) => {
//     const absValue = Math.abs(value);
//     const sign = value < 0 ? '-' : value > 0 ? '+' : '';
//     return `${sign}$${absValue.toFixed(2)}`;
//   };

//   return (
//     <section className="event-summary-display">
//       <h3>{title} ({eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''})</h3>
      
//       <div className="event-summary-grid">
//         {eventSummary.refunds.count > 0 && (
//           <div className="event-card refunds">
//             <div className="event-label">Full Refunds</div>
//             <div className="event-value">{formatValue(eventSummary.refunds.value)}</div>
//             <div className="event-count">
//               {eventSummary.refunds.count} refund{eventSummary.refunds.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         {eventSummary.partialRefunds.count > 0 && (
//           <div className="event-card partial-refunds">
//             <div className="event-label">Partial Refunds</div>
//             <div className="event-value">{formatValue(eventSummary.partialRefunds.value)}</div>
//             <div className="event-count">
//               {eventSummary.partialRefunds.count} refund{eventSummary.partialRefunds.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         {eventSummary.exchanges.count > 0 && (
//           <div className="event-card exchanges">
//             <div className="event-label">Exchanges</div>
//             <div className="event-value">{formatValue(eventSummary.exchanges.value)}</div>
//             <div className="event-count">
//               {eventSummary.exchanges.count} exchange{eventSummary.exchanges.count !== 1 ? 's' : ''}
//             </div>
//           </div>
//         )}

//         <div className="event-card net-summary">
//           <div className="event-label">Net Impact</div>
//           <div className="event-value">{formatValue(eventSummary.netValue)}</div>
//           <div className="event-count">
//             across {eventSummary.totalEvents} event{eventSummary.totalEvents !== 1 ? 's' : ''}
//           </div>
//         </div>
//       </div>
//     </section>
//   );
// }

// // ==================== 5.0 MISMATCH SUMMARY COMPONENT ====================

// function MismatchSummaryCard({ mismatchSummary, periodType }: { 
//   mismatchSummary: { 
//     totalMismatches: number; 
//     totalDifference: number; 
//     hasMismatches: boolean; 
//   };
//   periodType: 'day' | 'week' | 'month';
// }) {
//   if (!mismatchSummary.hasMismatches) {
//     return null;
//   }

//   const getPeriodLabel = () => {
//     switch (periodType) {
//       case 'day': return 'Days';
//       case 'week': return 'Weeks'; 
//       case 'month': return 'Months';
//       default: return 'Periods';
//     }
//   };

//   const getDifferenceColor = (difference: number) => {
//     return Math.abs(difference) > 0.01 ? '#dc2626' : '#059669';
//   };

//   const getDifferenceText = (difference: number) => {
//     const absDiff = Math.abs(difference);
//     if (absDiff <= 0.01) return 'Perfect Match';
//     return `$${absDiff.toFixed(2)}`;
//   };

//   return (
//     <section className="mismatch-summary-card">
//       <h3>Calculation Verification</h3>
      
//       <div className="mismatch-summary-content">
//         <div className="mismatch-metric">
//           <div className="mismatch-value">{mismatchSummary.totalMismatches}</div>
//           <div className="mismatch-label">{getPeriodLabel()} with Mismatches</div>
//         </div>
        
//         <div className="mismatch-metric">
//           <div 
//             className="mismatch-value" 
//             style={{ color: getDifferenceColor(mismatchSummary.totalDifference) }}
//           >
//             {getDifferenceText(mismatchSummary.totalDifference)}
//           </div>
//           <div className="mismatch-label">Total Difference</div>
//         </div>
//       </div>
      
//       <div className="mismatch-note">
//         {mismatchSummary.totalMismatches > 0 ? (
//           <span style={{ color: '#dc2626' }}>
//             Found {mismatchSummary.totalMismatches} {getPeriodLabel().toLowerCase()} with calculation discrepancies
//           </span>
//         ) : (
//           <span style={{ color: '#059669' }}>
//             All calculations match perfectly!
//           </span>
//         )}
//       </div>
//     </section>
//   );
// }

// // ==================== 6.0 MAIN REACT COMPONENT ====================

// function ShopifyAnalyticsPage() {
//   const data = useLoaderData<typeof loader>();
//   const [isLoading, setIsLoading] = useState(true);
//   const [isExporting, setIsExporting] = useState(false);
//   const [isManualRefresh, setIsManualRefresh] = useState(false);


//   const getWeekOverWeekChange = () => {
//     try {
//       const safeData = getSafeData(data);
//       if (!safeData) return 0;

//       // Get the weekly data keys and reverse to get most recent first
//       const weeklyKeys = [...safeData.weeklyKeys].reverse();
      
//       if (weeklyKeys.length < 2) {
//         console.log(' Not enough weekly data available for week-over-week calculation');
//         return 0;
//       }

//       // Current week (most recent week)
//       const currentWeekKey = weeklyKeys[0];
//       const currentWeekData = getSafeCustomerStats(safeData.weeklyTotals, currentWeekKey);
//       const currentWeekRevenue = currentWeekData.totalSales || 0;

//       // Previous week (week before current week)
//       const previousWeekKey = weeklyKeys[1];
//       const previousWeekData = getSafeCustomerStats(safeData.weeklyTotals, previousWeekKey);
//       const previousWeekRevenue = previousWeekData.totalSales || 0;

//       console.log(' Week-over-Week Calculation:');
//       console.log(`   Current Week (${currentWeekKey}): ${formatCurrency(currentWeekRevenue)}`);
//       console.log(`   Previous Week (${previousWeekKey}): ${formatCurrency(previousWeekRevenue)}`);

//       // Calculate percentage change
//       if (previousWeekRevenue > 0 && currentWeekRevenue > 0) {
//         const change = ((currentWeekRevenue - previousWeekRevenue) / previousWeekRevenue) * 100;
//         console.log(`   Change: ${change.toFixed(1)}%`);
//         return change;
//       } else if (currentWeekRevenue > 0 && previousWeekRevenue === 0) {
//         console.log(`   Change: 100% (current week has revenue, previous week has none)`);
//         return 100;
//       } else if (currentWeekRevenue === 0 && previousWeekRevenue > 0) {
//         const change = -100;
//         console.log(`   Change: ${change}% (current week has no revenue, previous week had revenue)`);
//         return change;
//       } else {
//         console.log(`   Change: 0% (both weeks have no revenue)`);
//         return 0;
//       }
//     } catch (error) {
//       console.error(' Error calculating week-over-week change:', error);
//       return 0;
//     }
//   };

//   const getDaysLeftInWeek = () => {
//     try {
//       const safeData = getSafeData(data);
//       if (!safeData) return 0;

//       const today = new Date();
//       const dayOfWeek = today.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday

//       // If it's Sunday (0), 0 days left. Otherwise, 7 - dayOfWeek
//       const daysLeftInWeek = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);

//       console.log(` Days left in current week: ${daysLeftInWeek} (today: ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]})`);
//       return daysLeftInWeek;
//     } catch (error) {
//       console.error(' Error calculating days left in week:', error);
//       return 0;
//     }
//   };

//   const handleManualRefresh = () => {
//     setIsManualRefresh(true);
//     setIsLoading(true);
//     window.location.reload();
//   }

//   useEffect(() => {
//     if (data && !("error" in data)) {
//       setIsLoading(false);
//     }
//   }, [data]);

//   if (isLoading && isManualRefresh) {
//     return (
//       <div className="orders-dashboard">
//         <div className="dashboard-header">
//           <h1>Analytics Dashboard</h1>
//         </div>
//         <div className="loading-progress-container">
//           <div className="loading-header">
//             <h2>Refreshing Your Data</h2>
//             <p>Please wait while we update your analytics...</p>
//           </div>
          
//           <div className="progress-bar-container">
//             <div className="progress-bar">
//               <div className="progress-fill"></div>
//             </div>
//           </div>

//           <div className="loading-steps">
//             {[
//               "Refreshing order data...",
//               "Updating revenue calculations...", 
//               "Processing customer insights...",
//               "Recalculating metrics...",
//               "Finalizing your dashboard..."
//             ].map((step, index) => (
//               <div key={index} className="loading-step">
//                 <div className="step-indicator"></div>
//                 <div className="step-text">{step}</div>
//               </div>
//             ))}
//           </div>
//         </div>
//       </div>
//     );
//   }

//   if (isLoading) {
//     return (
//       <div className="orders-dashboard">
//         <div className="dashboard-header">
//           <h1>Analytics Dashboard</h1>
//         </div>
//         <LoadingProgress />
//       </div>
//     );
//   }

//   const getSafeData = (data: any): CachedAnalyticsData | null => {
//     if (!data || typeof data !== 'object') return null;
    
//     const safeData: CachedAnalyticsData = {
//       shop: data.shop || 'unknown',
//       totals: data.totals || {},
//       dailyTotals: data.dailyTotals || {},
//       weeklyTotals: data.weeklyTotals || {},
//       monthlyTotals: data.monthlyTotals || {},
//       totalOrders: typeof data.totalOrders === 'number' ? data.totalOrders : 0,
//       totalCustomerData: data.totalCustomerData || { newCustomers: 0, repeatedCustomers: 0, totalCustomers: 0 },
//       monthRanges: Array.isArray(data.monthRanges) ? data.monthRanges : [],
//       dailyKeys: Array.isArray(data.dailyKeys) ? data.dailyKeys : [],
//       weeklyKeys: Array.isArray(data.weeklyKeys) ? data.weeklyKeys : [],
//       lastUpdated: data.lastUpdated || new Date().toISOString(),
//       shopTimeZone: data.shopTimeZone || 'UTC',
//       shopCurrency: data.shopCurrency || 'USD',
//       _cacheInfo: data._cacheInfo || undefined
//     };

//     return safeData;
//   };

//   const safeNumber = (value: unknown) => (typeof value === "number" ? value : 0);
  
//   const getSafeCustomerStats = (stats: Record<string, OrderStats & CustomerData>, key: string): OrderStats & CustomerData => {
//     const stat = stats[key];
//     if (!stat) {
//       return {
//         total: 0,
//         discounts: 0,
//         returns: 0,
//         netSales: 0,
//         shipping: 0,
//         taxes: 0,
//         extraFees: 0,
//         totalSales: 0,
//         shippingRefunds: 0,
//         netReturns: 0,
//         totalRefund: 0,
//         items: 0,
//         fulfilled: 0,
//         unfulfilled: 0,
//         orderCount: 0,
//         hasSubsequentEvents: false,
//         eventSummary: null,
//         refundsCount: 0,
//         financialStatus: 'pending',
//         newCustomers: 0,
//         repeatedCustomers: 0,
//         totalCustomers: 0,
//         discountsReturned: 0,
//         netDiscounts: 0,
//         returnShippingCharges: 0,
//         restockingFees: 0,
//         returnFees: 0,
//         refundDiscrepancy: 0
//       };
//     }
//     return stat;
//   };

//   const getCalculationMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.dailyTotals).forEach(dayData => {
//       const calculatedTotal = dayData.netSales + dayData.shipping + dayData.taxes + dayData.extraFees;
//       const mismatch = Math.abs(dayData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         const difference = calculatedTotal - dayData.totalSales;
//         totalDifference += difference;
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getTodayMismatchSummary = (data: AnalyticsData) => {
//     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: data.shopTimeZone });
//     const todayData = getSafeCustomerStats(data.dailyTotals, todayKey);
    
//     const calculatedTotal = todayData.netSales + todayData.shipping + todayData.taxes + todayData.extraFees;
//     const mismatch = Math.abs(todayData.totalSales - calculatedTotal) > 0.01;
    
//     return {
//       totalMismatches: mismatch ? 1 : 0,
//       totalDifference: mismatch ? (calculatedTotal - todayData.totalSales) : 0,
//       hasMismatches: mismatch
//     };
//   };

//   const getWeeklyMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.weeklyTotals).forEach(weekData => {
//       const calculatedTotal = weekData.netSales + weekData.shipping + weekData.taxes + weekData.extraFees;
//       const mismatch = Math.abs(weekData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         totalDifference += (calculatedTotal - weekData.totalSales);
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getMonthlyMismatchSummary = (data: AnalyticsData) => {
//     let totalMismatches = 0;
//     let totalDifference = 0;

//     Object.values(data.monthlyTotals).forEach(monthData => {
//       const calculatedTotal = monthData.netSales + monthData.shipping + monthData.taxes + monthData.extraFees;
//       const mismatch = Math.abs(monthData.totalSales - calculatedTotal) > 0.01;
      
//       if (mismatch) {
//         totalMismatches++;
//         totalDifference += (calculatedTotal - monthData.totalSales);
//       }
//     });

//     return {
//       totalMismatches,
//       totalDifference: parseFloat(totalDifference.toFixed(2)),
//       hasMismatches: totalMismatches > 0
//     };
//   };

//   const getTodayData = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;
    
//     const todayKey = new Date().toLocaleDateString("en-CA", { timeZone: safeData.shopTimeZone });
//     const todayData = getSafeCustomerStats(safeData.dailyTotals, todayKey);
    
//     return {
//       ...todayData,
//       ordersWithSubsequentEvents: todayData.hasSubsequentEvents ? 1 : 0,
//       subsequentEventsCount: todayData.eventSummary?.totalEvents || 0,
//       subsequentEventsValue: todayData.eventSummary ? Math.abs(todayData.eventSummary.netValue) : 0
//     };
//   };

//   const getLast7DaysData = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalNewCustomers = 0;
//     let totalRepeatCustomers = 0;
//     let totalFulfilled = 0;
//     let totalUnfulfilled = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;


//     const getWeekOverWeekChange = () => {
//   try {
//     const safeData = getSafeData(data);
//     if (!safeData) return 0;

//     // Get the weekly data keys and reverse to get most recent first
//     const weeklyKeys = [...safeData.weeklyKeys].reverse();
    
//     if (weeklyKeys.length < 2) {
//       console.log(' Not enough weekly data available for week-over-week calculation');
//       return 0;
//     }

//     // Current week (most recent week)
//     const currentWeekKey = weeklyKeys[0];
//     const currentWeekData = getSafeCustomerStats(safeData.weeklyTotals, currentWeekKey);
//     const currentWeekRevenue = currentWeekData.totalSales || 0;

//     // Previous week (week before current week)
//     const previousWeekKey = weeklyKeys[1];
//     const previousWeekData = getSafeCustomerStats(safeData.weeklyTotals, previousWeekKey);
//     const previousWeekRevenue = previousWeekData.totalSales || 0;

//     console.log(' Week-over-Week Calculation:');
//     console.log(`   Current Week (${currentWeekKey}): ${formatCurrency(currentWeekRevenue)}`);
//     console.log(`   Previous Week (${previousWeekKey}): ${formatCurrency(previousWeekRevenue)}`);

//     // Calculate percentage change
//     if (previousWeekRevenue > 0 && currentWeekRevenue > 0) {
//       const change = ((currentWeekRevenue - previousWeekRevenue) / previousWeekRevenue) * 100;
//       console.log(`   Change: ${change.toFixed(1)}%`);
//       return change;
//     } else if (currentWeekRevenue > 0 && previousWeekRevenue === 0) {
//       console.log(`   Change: 100% (current week has revenue, previous week has none)`);
//       return 100;
//     } else if (currentWeekRevenue === 0 && previousWeekRevenue > 0) {
//       const change = -100;
//       console.log(`   Change: ${change}% (current week has no revenue, previous week had revenue)`);
//       return change;
//     } else {
//       console.log(`   Change: 0% (both weeks have no revenue)`);
//       return 0;
//     }
//   } catch (error) {
//     console.error(' Error calculating week-over-week change:', error);
//     return 0;
//   }
// };

// const getDaysLeftInWeek = () => {
//   try {
//     const safeData = getSafeData(data);
//     if (!safeData) return 0;

//     const today = new Date();
//     const dayOfWeek = today.getDay(); // 0=Sunday, 1=Monday, ..., 6=Saturday

//     // If it's Sunday (0), 0 days left. Otherwise, 7 - dayOfWeek
//     const daysLeftInWeek = dayOfWeek === 0 ? 0 : (7 - dayOfWeek);

//     console.log(` Days left in current week: ${daysLeftInWeek} (today: ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dayOfWeek]})`);
//     return daysLeftInWeek;
//   } catch (error) {
//     console.error(' Error calculating days left in week:', error);
//     return 0;
//   }
// };


//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.dailyKeys.forEach(day => {
//       const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//       totalRevenue += dayData.total;
//       totalOrders += dayData.orderCount;
//       totalItems += dayData.items;
//       totalNewCustomers += dayData.newCustomers;
//       totalRepeatCustomers += dayData.repeatedCustomers;
//       totalFulfilled += dayData.fulfilled;
//       totalUnfulfilled += dayData.unfulfilled;
//       totalDiscounts += dayData.discounts;
//       totalReturns += dayData.returns;
//       totalNetSales += dayData.netSales;
//       totalShipping += dayData.shipping;
//       totalTaxes += dayData.taxes;
//       totalExtraFees += dayData.extraFees;
//       totalTotalSales += dayData.totalSales;
//       totalShippingRefunds += dayData.shippingRefunds;
//       totalNetReturns += dayData.netReturns;
//       totalTotalRefund += dayData.totalRefund;
      
//       if (dayData.eventSummary) {
//         ordersWithEventsCount += dayData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += dayData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += dayData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += dayData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += dayData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += dayData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += dayData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += dayData.eventSummary.totalEvents;
//         periodEventSummary.netValue += dayData.eventSummary.netValue;

//         totalEventsValue += Math.abs(dayData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalNewCustomers,
//       totalRepeatCustomers,
//       totalFulfilled,
//       totalUnfulfilled,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       avgDailyRevenue: totalRevenue / 7,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const getWeeklyFinancials = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;

//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.weeklyKeys.forEach(week => {
//       const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//       totalRevenue += weekData.total;
//       totalOrders += weekData.orderCount;
//       totalItems += weekData.items;
//       totalDiscounts += weekData.discounts;
//       totalReturns += weekData.returns;
//       totalNetSales += weekData.netSales;
//       totalShipping += weekData.shipping;
//       totalTaxes += weekData.taxes;
//       totalExtraFees += weekData.extraFees;
//       totalTotalSales += weekData.totalSales;
//       totalShippingRefunds += weekData.shippingRefunds;
//       totalNetReturns += weekData.netReturns;
//       totalTotalRefund += weekData.totalRefund;
      
//       if (weekData.eventSummary) {
//         ordersWithEventsCount += weekData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += weekData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += weekData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += weekData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += weekData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += weekData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += weekData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += weekData.eventSummary.totalEvents;
//         periodEventSummary.netValue += weekData.eventSummary.netValue;

//         totalEventsValue += Math.abs(weekData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       netRevenue: totalTotalSales,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const getMonthlyFinancials = () => {
//     const safeData = getSafeData(data);
//     if (!safeData) return null;

//     let totalRevenue = 0;
//     let totalOrders = 0;
//     let totalItems = 0;
//     let totalDiscounts = 0;
//     let totalReturns = 0;
//     let totalNetSales = 0;
//     let totalShipping = 0;
//     let totalTaxes = 0;
//     let totalExtraFees = 0;
//     let totalTotalSales = 0;
//     let totalShippingRefunds = 0;
//     let totalNetReturns = 0;
//     let totalTotalRefund = 0;

//     const periodEventSummary: EventSummary = {
//       refunds: { count: 0, value: 0 },
//       exchanges: { count: 0, value: 0 },
//       partialRefunds: { count: 0, value: 0 },
//       totalEvents: 0,
//       netValue: 0
//     };

//     let ordersWithEventsCount = 0;
//     let totalEventsValue = 0;

//     safeData.monthRanges.forEach(month => {
//       const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//       totalRevenue += monthData.total;
//       totalOrders += monthData.orderCount;
//       totalItems += monthData.items;
//       totalDiscounts += monthData.discounts;
//       totalReturns += monthData.returns;
//       totalNetSales += monthData.netSales;
//       totalShipping += monthData.shipping;
//       totalTaxes += monthData.taxes;
//       totalExtraFees += monthData.extraFees;
//       totalTotalSales += monthData.totalSales;
//       totalShippingRefunds += monthData.shippingRefunds;
//       totalNetReturns += monthData.netReturns;
//       totalTotalRefund += monthData.totalRefund;
      
//       if (monthData.eventSummary) {
//         ordersWithEventsCount += monthData.hasSubsequentEvents ? 1 : 0;
        
//         periodEventSummary.refunds.count += monthData.eventSummary.refunds.count;
//         periodEventSummary.refunds.value += monthData.eventSummary.refunds.value;
//         periodEventSummary.exchanges.count += monthData.eventSummary.exchanges.count;
//         periodEventSummary.exchanges.value += monthData.eventSummary.exchanges.value;
//         periodEventSummary.partialRefunds.count += monthData.eventSummary.partialRefunds.count;
//         periodEventSummary.partialRefunds.value += monthData.eventSummary.partialRefunds.value;
//         periodEventSummary.totalEvents += monthData.eventSummary.totalEvents;
//         periodEventSummary.netValue += monthData.eventSummary.netValue;

//         totalEventsValue += Math.abs(monthData.eventSummary.netValue);
//       }
//     });

//     return {
//       totalRevenue,
//       totalOrders,
//       totalItems,
//       totalDiscounts,
//       totalReturns,
//       totalNetSales,
//       totalShipping,
//       totalTaxes,
//       totalExtraFees,
//       totalTotalSales,
//       totalShippingRefunds,
//       totalNetReturns,
//       totalTotalRefund,
//       eventSummary: periodEventSummary,
//       ordersWithSubsequentEvents: ordersWithEventsCount,
//       subsequentEventsCount: periodEventSummary.totalEvents,
//       subsequentEventsValue: parseFloat(totalEventsValue.toFixed(2)),
//       netRevenue: totalTotalSales,
//       discountRate: totalRevenue > 0 ? (totalDiscounts / totalRevenue) * 100 : 0,
//       shippingRate: totalRevenue > 0 ? (totalShipping / totalRevenue) * 100 : 0,
//       taxRate: totalRevenue > 0 ? (totalTaxes / totalRevenue) * 100 : 0,
//       returnRate: totalRevenue > 0 ? (totalReturns / totalRevenue) * 100 : 0
//     };
//   };

//   const formatNumber = (num: number) => num.toLocaleString('en-US');
//   const formatPercent = (num: number) => `${num.toFixed(1)}%`;
//   const formatCurrency = (amount: number) => {
//     const currency = safeData?.shopCurrency || 'USD';
//     return amount.toLocaleString('en-US', { 
//       style: 'currency', 
//       currency: currency,
//       minimumFractionDigits: 2 
//     });
//   };

//   const exportToPDF = () => {
//     setIsExporting(true);
    
//     const safeData = getSafeData(data);
//     const todayData = getTodayData();
//     const last7DaysData = getLast7DaysData();
//     const weeklyFinancials = getWeeklyFinancials();
//     const monthlyFinancials = getMonthlyFinancials();
    
//     if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
//       setIsExporting(false);
//       return;
//     }

//     const eventData = monthlyFinancials.eventSummary || weeklyFinancials.eventSummary || last7DaysData.eventSummary;
    
//     const totalEvents = eventData ? 
//       (eventData.refunds.count + eventData.exchanges.count + eventData.partialRefunds.count) : 0;
    
//     const ordersWithEvents = monthlyFinancials.ordersWithSubsequentEvents || 
//                             weeklyFinancials.ordersWithSubsequentEvents || 
//                             last7DaysData.ordersWithSubsequentEvents || 0;

//     const pdfData: OrderData = {
//       totalOrders: safeData.totalOrders,
//       totalCustomers: safeData.totalCustomerData.totalCustomers,
//       fulfillmentRate: safeData.totalOrders > 0 ? 
//         ((last7DaysData.totalFulfilled / last7DaysData.totalOrders) * 100) : 0,
//       totalRevenue: monthlyFinancials.totalRevenue,
//       netRevenue: monthlyFinancials.netRevenue,
//       averageOrderValue: safeData.totalOrders > 0 ? 
//         (monthlyFinancials.totalRevenue / safeData.totalOrders) : 0,
//       totalItems: monthlyFinancials.totalItems,
//       todayOrders: todayData.orderCount,
//       todayRevenue: todayData.total,
//       todayItems: todayData.items,
//       ordersChangeVsYesterday: 100.0,
//       revenueChangeVsYesterday: 100.0,
//       itemsChangeVsYesterday: 100.0,
//       newCustomers: safeData.totalCustomerData.newCustomers,
//       repeatCustomers: safeData.totalCustomerData.repeatedCustomers,
//       customerRetentionRate: safeData.totalCustomerData.totalCustomers > 0 ? 
//         ((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100) : 0,
//       averageOrderFrequency: 1.0,
//       shopTimezone: safeData.shopTimeZone,
//       shopCurrency: safeData.shopCurrency,
//       totalRefunds: eventData?.refunds.count || 0,
//       totalExchanges: eventData?.exchanges.count || 0,
//       totalPartialRefunds: eventData?.partialRefunds.count || 0,
//       totalEvents: totalEvents,
//       ordersWithEvents: ordersWithEvents,
//       netEventValue: eventData?.netValue || 0
//     };

//     generatePDFReport(pdfData);
//     setIsExporting(false);
//   };

//   if ("error" in data) {
//     return (
//       <div className="orders-dashboard">
//         <div style={{ padding: "40px", textAlign: "center", background: "#fff5f5", borderRadius: "8px" }}>
//           <h1>We're Sorry</h1>
//           <p>{data.userMessage}</p>
//           <button className="print-button" onClick={handleManualRefresh}>
//             Refresh Page
//           </button>
//         </div>
//       </div>
//     );
//   }

//   const safeData = getSafeData(data);
//   const todayData = getTodayData();
//   const last7DaysData = getLast7DaysData();
//   const weeklyFinancials = getWeeklyFinancials();
//   const monthlyFinancials = getMonthlyFinancials();

//   if (!safeData || !todayData || !last7DaysData || !weeklyFinancials || !monthlyFinancials) {
//     return (
//       <div className="orders-dashboard">
//         <div style={{ padding: "20px", color: "red", textAlign: "center" }}>
//           <h1>Data Validation Failed</h1>
//           <p>Please refresh the page.</p>
//         </div>
//       </div>
//     );
//   }

//   const formatDateDisplay = (dateStr: string) => {
//     const date = new Date(dateStr + 'T00:00:00');
//     return date.toLocaleDateString('en-US', { 
//       month: 'short', 
//       day: 'numeric',
//       timeZone: safeData.shopTimeZone 
//     });
//   };

//   const getDayName = (dateStr: string) => {
//     const date = new Date(dateStr + 'T00:00:00');
//     return date.toLocaleDateString('en-US', { 
//       weekday: 'short',
//       timeZone: safeData.shopTimeZone 
//     });
//   };

//   return (
//     <div className="orders-dashboard">
//       <div className="dashboard-header">
//         <h1>Orders Dashboard</h1>
//         <div className="header-controls">
//           <button 
//             className="export-button"
//             onClick={exportToPDF}
//             disabled={isExporting}
//             title="Export summary PDF report with key metrics"
//           >
//             <Icon.Export />
//             {isExporting ? 'Generating PDF...' : 'Export Summary'}
//           </button>
//         </div>
//       </div>

//       <div id="dashboard-content">
//         {/* Today's Performance Section */}
//         <section className="today-performance">
//           <h2>Today's Performance</h2>
//           <MismatchSummaryCard 
//             mismatchSummary={getTodayMismatchSummary(safeData)} 
//             periodType="day" 
//           />
          
//           <div className="primary-metrics-grid">
//             <div className="metric-card orders">
//               <div className="metric-value">{safeNumber(todayData.orderCount)}</div>
//               <div className="metric-label">Today's Orders</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
            
//             <div className="metric-card revenue">
//               <div className="metric-value">{formatCurrency(safeNumber(todayData.totalSales))}</div>
//               <div className="metric-label">Today's Total Sales</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
            
//             <div className="metric-card items">
//               <div className="metric-value">{safeNumber(todayData.items)}</div>
//               <div className="metric-label">Items Ordered</div>
//               <div className="metric-change positive">
//                 <Icon.TrendUp />
//                 100.0% vs yesterday
//               </div>
//             </div>
//           </div>

//           <div className="fulfillment-metrics-grid">
//             <div className="fulfillment-metric-card today-fulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(todayData.fulfilled)}</div>
//               <div className="fulfillment-metric-label">FULFILLED TODAY</div>
//               <div className="fulfillment-metric-period">Today</div>
//             </div>
            
//             <div className="fulfillment-metric-card today-unfulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(todayData.unfulfilled)}</div>
//               <div className="fulfillment-metric-label">UNFULFILLED TODAY</div>
//               <div className="fulfillment-metric-period">Today</div>
//             </div>
            
//             <div className="fulfillment-metric-card week-fulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalFulfilled)}</div>
//               <div className="fulfillment-metric-label">FULFILLED</div>
//               <div className="fulfillment-metric-period">Last 7 Days</div>
//             </div>
            
//             <div className="fulfillment-metric-card week-unfulfilled">
//               <div className="fulfillment-metric-value">{safeNumber(last7DaysData.totalUnfulfilled)}</div>
//               <div className="fulfillment-metric-label">UNFULFILLED</div>
//               <div className="fulfillment-metric-period">Last 7 Days</div>
//             </div>
//           </div>

//           {todayData?.eventSummary && todayData.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={todayData.eventSummary} 
//               title="Today's Order Activity & Adjustments"
//             />
//           )}
//         </section>

//         {/* Last 7 Days Performance Section */}
//         <section className="last7days-section">
//           <h3>Last 7 Days Performance</h3>
          
//           <div className="last7days-grid">
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{safeNumber(last7DaysData.totalOrders)}</div>
//               <div className="last7days-total-label">TOTAL ORDERS</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales))}</div>
//               <div className="last7days-total-label">TOTAL SALES</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{safeNumber(last7DaysData.totalItems)}</div>
//               <div className="last7days-total-label">TOTAL ITEMS</div>
//             </div>
            
//             <div className="last7days-total-card">
//               <div className="last7days-total-value">{formatCurrency(safeNumber(last7DaysData.totalTotalSales / 7))}</div>
//               <div className="last7days-total-label">AVG DAILY SALES</div>
//             </div>
//           </div>

//           {/* Daily Breakdown Table */}
//           <div className="daily-breakdown">
//             <h4>Daily Breakdown</h4>
//             <div className="daily-cards-container">
//               {safeData.dailyKeys.map((day, index) => {
//                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//                 const isToday = index === safeData.dailyKeys.length - 1;
                
//                 return (
//                   <div key={day} className={`daily-card ${isToday ? 'current-day' : ''}`}>
//                     <div className="daily-card-header">
//                       <div className="daily-date">{formatDateDisplay(day)}</div>
//                       <div className="daily-day">{getDayName(day)}</div>
//                     </div>
                    
//                     <div className="daily-metrics">
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">ORDERS</span>
//                         <span className="daily-metric-value">{safeNumber(dayData.orderCount)}</span>
//                       </div>
                      
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">TOTAL SALES</span>
//                         <span className="daily-metric-value">{formatCurrency(safeNumber(dayData.totalSales))}</span>
//                       </div>
                      
//                       <div className="daily-metric">
//                         <span className="daily-metric-label">ITEMS</span>
//                         <span className="daily-metric-value">{safeNumber(dayData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {last7DaysData?.eventSummary && last7DaysData.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={last7DaysData.eventSummary} 
//               title="Last 7 Days: Refunds, Exchanges & Adjustments"
//             />
//           )}
//         </section>

//         {/* Week-over-Week Insight */}
//         {/* Week-over-Week Insight */}
// {/* Week-over-Week Insight */}
// <div className="secondary-metrics">
//   <div className={`insight-card ${getWeekOverWeekChange() >= 0 ? 'positive' : 'negative'}`}>
//     <h4>Week-over-Week Revenue</h4>
//     <div className="insight-value">
//       {getWeekOverWeekChange() >= 0 ? <Icon.TrendUp /> : <Icon.TrendDown />}
//       {Math.abs(getWeekOverWeekChange()).toFixed(1)}%
//     </div>
//     <div className="insight-label">
//       {getWeekOverWeekChange() >= 0 ? 'Increase' : 'Decrease'} from last week
//     </div>
//     {getDaysLeftInWeek() > 0 && (
//       <div className="insight-note">
//         {getDaysLeftInWeek()} days left in current week
//       </div>
//     )}
//   </div>
// </div>

//         {/* Customer Insights Section */}
//         <section className="customer-metrics">
//           <h3>Customer Insights</h3>
          
//           <div className="customer-metrics-grid">
//             <div className="customer-metric-card total-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.totalCustomers)}</div>
//               <div className="customer-metric-label">TOTAL CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card new-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.newCustomers)}</div>
//               <div className="customer-metric-label">NEW CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card repeat-customers">
//               <div className="customer-metric-value">{safeNumber(safeData.totalCustomerData.repeatedCustomers)}</div>
//               <div className="customer-metric-label">REPEAT CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card loyalty-rate">
//               <div className="customer-metric-value">
//                 {safeData.totalCustomerData.totalCustomers > 0 
//                   ? formatPercent((safeData.totalCustomerData.repeatedCustomers / safeData.totalCustomerData.totalCustomers) * 100)
//                   : '0.0%'
//                 }
//               </div>
//               <div className="customer-metric-label">REPEAT CUSTOMER RATE</div>
//             </div>
//           </div>
//         </section>

//         {/* Last 7 Days Customer Insights */}
//         <section className="customer-metrics">
//           <h3>Last 7 Days Customer Insights</h3>
          
//           <div className="customer-metrics-grid">
//             <div className="customer-metric-card total-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)}</div>
//               <div className="customer-metric-label">7-DAY TOTAL CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card new-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalNewCustomers)}</div>
//               <div className="customer-metric-label">7-DAY NEW CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card repeat-customers">
//               <div className="customer-metric-value">{safeNumber(last7DaysData.totalRepeatCustomers)}</div>
//               <div className="customer-metric-label">7-DAY REPEAT CUSTOMERS</div>
//             </div>
            
//             <div className="customer-metric-card loyalty-rate">
//               <div className="customer-metric-value">
//                 {(last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers) > 0
//                   ? formatPercent((last7DaysData.totalRepeatCustomers / (last7DaysData.totalNewCustomers + last7DaysData.totalRepeatCustomers)) * 100)
//                   : '0.0%'
//                 }
//               </div>
//               <div className="customer-metric-label">7-DAY REPEAT RATE</div>
//             </div>
//           </div>
//         </section>

//         {/* Last 7 Days Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Last 7 Days Financial Breakdown</h3>

//           <MismatchSummaryCard 
//             mismatchSummary={getCalculationMismatchSummary(safeData)} 
//             periodType="day"
//           />

//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">7 Days</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalDiscounts / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalReturns / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalExtraFees / last7DaysData.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalShipping / last7DaysData.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(last7DaysData.totalTaxes / last7DaysData.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(last7DaysData.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Daily Financial Details */}
//           <div className="daily-financial-breakdown">
//             <h4>Daily Financial Details</h4>
//             <div className="daily-financial-cards">
//               {safeData.dailyKeys.map((day, index) => {
//                 const dayData = getSafeCustomerStats(safeData.dailyTotals, day);
//                 const isToday = index === safeData.dailyKeys.length - 1;
                
//                 return (
//                   <div key={day} className={`daily-financial-card ${isToday ? 'current-day' : ''}`}>
//                     <div className="daily-financial-header">
//                       <div className="daily-financial-date">{formatDateDisplay(day)}</div>
//                       <div className="daily-financial-day">{getDayName(day)}</div>
//                     </div>
                    
//                     <div className="daily-financial-metrics">
//                       <div className="daily-financial-metric gross-revenue">
//                         <span className="daily-financial-label">Gross Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.total)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric discounts">
//                         <span className="daily-financial-label">Discounts</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.discounts)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric returns">
//                         <span className="daily-financial-label">Returns</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.returns)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric net-sales">
//                         <span className="daily-financial-label">Net Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.netSales)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric shipping">
//                         <span className="daily-financial-label">Shipping Charges</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.shipping)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric return-fees">
//                         <span className="daily-financial-label">Return Fees</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.extraFees)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric taxes">
//                         <span className="daily-financial-label">Taxes</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.taxes)}</span>
//                       </div>
                      
//                       <div className="daily-financial-metric total-sales">
//                         <span className="daily-financial-label">Total Sales</span>
//                         <span className="daily-financial-value">{formatCurrency(dayData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Weekly Performance */}
//         <section className="weekly-performance">
//           <h3>Weekly Performance (Last 8 Weeks)</h3>
//           <MismatchSummaryCard 
//             mismatchSummary={getWeeklyMismatchSummary(safeData)} 
//             periodType="week"
//           />
//           <div className="weekly-grid">
//             <div className="weekly-card">
//               <div className="weekly-value">{safeNumber(weeklyFinancials.totalOrders)}</div>
//               <div className="weekly-label">Total Orders</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
//               <div className="weekly-label">Total Revenue</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{safeNumber(weeklyFinancials.totalItems)}</div>
//               <div className="weekly-label">Total Items</div>
//             </div>
            
//             <div className="weekly-card">
//               <div className="weekly-value">{formatCurrency(weeklyFinancials.totalRevenue / safeData.weeklyKeys.length)}</div>
//               <div className="weekly-label">Avg Weekly Revenue</div>
//             </div>
//           </div>

//           {/* Weekly Breakdown */}
//           <div className="weekly-breakdown">
//             <h4>Weekly Breakdown</h4>
//             <div className="weekly-cards-container">
//               {safeData.weeklyKeys.map((week, index) => {
//                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
//                 return (
//                   <div key={week} className={`week-card ${isCurrentWeek ? 'current-week' : ''}`}>
//                     <div className="week-header">
//                       <div className="week-label">{week.replace('Week of ', '')}</div>
//                     </div>
                    
//                     <div className="week-metrics">
//                       <div className="week-metric orders">
//                         <span className="week-metric-label">Orders</span>
//                         <span className="week-metric-value">{safeNumber(weekData.orderCount)}</span>
//                       </div>
                      
//                       <div className="week-metric revenue">
//                         <span className="week-metric-label">Total Sales</span>
//                         <span className="week-metric-value">{formatCurrency(weekData.totalSales)}</span>
//                       </div>
                      
//                       <div className="week-metric items">
//                         <span className="week-metric-label">Items</span>
//                         <span className="week-metric-value">{safeNumber(weekData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {weeklyFinancials?.eventSummary && weeklyFinancials.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={weeklyFinancials.eventSummary} 
//               title="8-Week Period: Order Events & Financial Adjustments"
//             />
//           )}
//         </section>

//         {/* Weekly Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Weekly Financial Breakdown (Last 8 Weeks)</h3>
//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">8 Weeks</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalDiscounts / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalReturns / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalExtraFees / weeklyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalShipping / weeklyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(weeklyFinancials.totalTaxes / weeklyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(weeklyFinancials.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Weekly Financial Details */}
//           <div className="weekly-financial-breakdown">
//             <h4>Weekly Financial Details</h4>
//             <div className="weekly-financial-cards">
//               {safeData.weeklyKeys.map((week, index) => {
//                 const weekData = getSafeCustomerStats(safeData.weeklyTotals, week);
//                 const isCurrentWeek = index === safeData.weeklyKeys.length - 1;
                
//                 return (
//                   <div key={week} className={`weekly-financial-card ${isCurrentWeek ? 'current-week' : ''}`}>
//                     <div className="weekly-financial-header">
//                       <div className="weekly-financial-label">{week.replace('Week of ', '')}</div>
//                     </div>
                    
//                     <div className="weekly-financial-metrics">
//                       <div className="weekly-financial-metric gross-revenue">
//                         <span className="weekly-financial-label">Gross Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.total)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric discounts">
//                         <span className="weekly-financial-label">Discounts</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.discounts)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric returns">
//                         <span className="weekly-financial-label">Returns</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.returns)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric net-sales">
//                         <span className="weekly-financial-label">Net Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.netSales)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric shipping">
//                         <span className="weekly-financial-label">Shipping Charges</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.shipping)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric return-fees">
//                         <span className="weekly-financial-label">Return Fees</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.extraFees)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric taxes">
//                         <span className="weekly-financial-label">Taxes</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.taxes)}</span>
//                       </div>
                      
//                       <div className="weekly-financial-metric total-sales">
//                         <span className="weekly-financial-label">Total Sales</span>
//                         <span className="weekly-financial-value">{formatCurrency(weekData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Monthly Performance */}
//         <section className="monthly-performance">
//           <h3>Monthly Performance (Last 6 Months)</h3>
//           <MismatchSummaryCard 
//             mismatchSummary={getMonthlyMismatchSummary(safeData)} 
//             periodType="month"
//           />
//           <div className="monthly-grid">
//             <div className="monthly-card">
//               <div className="monthly-value">{safeNumber(monthlyFinancials.totalOrders)}</div>
//               <div className="monthly-label">Total Orders</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
//               <div className="monthly-label">Total Revenue</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{safeNumber(monthlyFinancials.totalItems)}</div>
//               <div className="monthly-label">Total Items</div>
//             </div>
            
//             <div className="monthly-card">
//               <div className="monthly-value">{formatCurrency(monthlyFinancials.totalRevenue / safeData.monthRanges.length)}</div>
//               <div className="monthly-label">Avg Monthly Revenue</div>
//             </div>
//           </div>

//           {/* Monthly Breakdown */}
//           <div className="monthly-breakdown">
//             <h4>Monthly Breakdown</h4>
//             <div className="monthly-cards-container">
//               {safeData.monthRanges.map((month, index) => {
//                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
//                 const isCurrentMonth = month === currentMonth;
                
//                 const avgRevenue = safeData.monthRanges.reduce((sum, m) => {
//                   const mData = getSafeCustomerStats(safeData.monthlyTotals, m);
//                   return sum + mData.total;
//                 }, 0) / safeData.monthRanges.length;
//                 const performanceLevel = monthData.total > avgRevenue * 1.2 ? 'high' : 
//                                        monthData.total > avgRevenue * 0.8 ? 'medium' : 'low';
                
//                 return (
//                   <div key={month} className={`month-card ${isCurrentMonth ? 'current-month' : ''}`}>
//                     {isCurrentMonth && <div className="current-badge">Current</div>}
//                     <div className="month-header">
//                       <div className="month-label">{month.split(' ')[0]}</div>
//                       <div className="month-period">{month.split(' ')[1]}</div>
//                     </div>
                    
//                     <div className="month-metrics">
//                       <div className="month-metric orders">
//                         <span className="month-metric-label">Orders</span>
//                         <span className="month-metric-value">{safeNumber(monthData.orderCount)}</span>
//                       </div>
                      
//                       <div className="month-metric revenue">
//                         <span className="month-metric-label">Total Sales</span>
//                         <span className="month-metric-value">{formatCurrency(monthData.totalSales)}</span>
//                       </div>
                      
//                       <div className="month-metric items">
//                         <span className="month-metric-label">Items</span>
//                         <span className="month-metric-value">{safeNumber(monthData.items)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>

//           {monthlyFinancials?.eventSummary && monthlyFinancials.eventSummary.totalEvents > 0 && (
//             <EventSummaryDisplay 
//               eventSummary={monthlyFinancials.eventSummary} 
//               title="6-Month Overview: All Order Events & Adjustments"
//             />
//           )}
//         </section>

//         {/* Monthly Financial Breakdown */}
//         <section className="financial-metrics">
//           <h3>Monthly Financial Breakdown (Last 6 Months)</h3>
//           <div className="financial-metrics-grid">
//             <div className="financial-metric-card revenue">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalRevenue)}</div>
//               <div className="financial-metric-label">Gross Sales</div>
//               <div className="financial-metric-period">6 Months</div>
//             </div>
            
//             <div className="financial-metric-card discounts">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalDiscounts)}</div>
//               <div className="financial-metric-label">Total Discounts</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalDiscounts / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card returns">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalReturns)}</div>
//               <div className="financial-metric-label">Returns & Refunds</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalReturns / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card return-fees">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalExtraFees)}</div>
//               <div className="financial-metric-label">Return Fees</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalExtraFees / monthlyFinancials.totalRevenue * 100)} of gross</div>
//             </div>
            
//             <div className="financial-metric-card net-sales">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalNetSales)}</div>
//               <div className="financial-metric-label">Net Sales</div>
//               <div className="financial-metric-period">After ALL deductions</div>
//             </div>
            
//             <div className="financial-metric-card shipping">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalShipping)}</div>
//               <div className="financial-metric-label">Shipping Charges</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalShipping / monthlyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card taxes">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTaxes)}</div>
//               <div className="financial-metric-label">Taxes Collected</div>
//               <div className="financial-metric-rate">{formatPercent(monthlyFinancials.totalTaxes / monthlyFinancials.totalNetSales * 100)} of net sales</div>
//             </div>
            
//             <div className="financial-metric-card total-sales">
//               <div className="financial-metric-value">{formatCurrency(monthlyFinancials.totalTotalSales)}</div>
//               <div className="financial-metric-label">Total Sales</div>
//               <div className="financial-metric-period">Final amount</div>
//             </div>
//           </div>

//           {/* Monthly Financial Details */}
//           <div className="monthly-financial-breakdown">
//             <h4>Monthly Financial Details</h4>
//             <div className="monthly-financial-cards">
//               {safeData.monthRanges.map((month, index) => {
//                 const monthData = getSafeCustomerStats(safeData.monthlyTotals, month);
//                 const currentMonth = new Date().toLocaleString("default", { month: "short", year: "numeric", timeZone: safeData.shopTimeZone });
//                 const isCurrentMonth = month === currentMonth;
                
//                 return (
//                   <div key={month} className={`monthly-financial-card ${isCurrentMonth ? 'current-month' : ''}`}>
//                     {isCurrentMonth && <div className="current-badge">Current</div>}
//                     <div className="monthly-financial-header">
//                       <div className="monthly-financial-label">{month.split(' ')[0]}</div>
//                       <div className="monthly-financial-period">{month.split(' ')[1]}</div>
//                     </div>
                    
//                     <div className="monthly-financial-metrics">
//                       <div className="monthly-financial-metric gross-revenue">
//                         <span className="monthly-financial-label">Gross Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.total)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric discounts">
//                         <span className="monthly-financial-label">Discounts</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.discounts)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric returns">
//                         <span className="monthly-financial-label">Returns</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.returns)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric net-sales">
//                         <span className="monthly-financial-label">Net Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.netSales)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric shipping">
//                         <span className="monthly-financial-label">Shipping Charges</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.shipping)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric return-fees">
//                         <span className="monthly-financial-label">Return Fees</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.extraFees)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric taxes">
//                         <span className="monthly-financial-label">Taxes</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.taxes)}</span>
//                       </div>
                      
//                       <div className="monthly-financial-metric total-sales">
//                         <span className="monthly-financial-label">Total Sales</span>
//                         <span className="monthly-financial-value">{formatCurrency(monthData.totalSales)}</span>
//                       </div>
//                     </div>
//                   </div>
//                 );
//               })}
//             </div>
//           </div>
//         </section>

//         {/* Charts & Analytics Section */}
//         <section className="charts-section">
//           <h2>Analytics & Insights Visualization</h2>
          
//           <div className="charts-grid">
//             <ChartComponents.CustomerDistribution data={safeData} />
//             <ChartComponents.RevenueTrend data={safeData} />
//             <ChartComponents.MonthlyPerformance data={safeData} />
//             <ChartComponents.FinancialBreakdown data={safeData} />
//           </div>
//         </section>

//         {/* Footer */}
//         <footer className="app-footer">
//           <div className="footer-content">
//             <p>
//               <strong>Orders Analyzed:</strong> {safeData.totalOrders} orders  
//               <strong> Net Revenue:</strong> {formatCurrency(monthlyFinancials.netRevenue)}  
//               <strong> Data Updated:</strong> {new Date(safeData.lastUpdated).toLocaleDateString()}
//             </p>
//             <p className="footer-brand">Analytics Dashboard - Nexus Powering Your Business Insights</p>
//           </div>
//         </footer>
//       </div>
//     </div>
//   );
// }

// // ==================== 7.0 LOADER FUNCTION ====================

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   return analyticsLoader({ request });
// };

// // ==================== 8.0 EXPORT COMPONENT ====================

// export default function AnalyticsApp() {
//   return <ShopifyAnalyticsPage />;
// }
































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   return {
//     ...order,
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedTotalReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions - EXACT COPY FROM YOUR CODE
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - create simplified versions for each portion
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true
//         };
        
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingRefunds = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalShippingRefunds;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate total sales using your formula
//   const totalSales = totalGrossSales + totalShippingCharges + totalReturnFees + totalTaxes - totalNetReturns - totalDiscounts;

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalDiscounts,
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns: totalNetReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     totalReturnFees,
//     totalSales,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50; // Reasonable limit for today's orders

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation
//   const todayProcessed = processOrders(todayOrders);

//   // Calculate summaries
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// export default function OrdersToday() {
//   const { today, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Revenue" 
//             value={summaries.regular.totalRevenue + summaries.giftCard.totalRevenue} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Revenue" value={metrics.totalRevenue} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.totalPriceSet.shopMoney.amount} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Refunded: {order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Items: {order.lineItems.edges.length}</div>
//                   {order.calculatedRestockingFees > 0 && (
//                     <div>Restocking: {order.calculatedRestockingFees.toFixed(2)}</div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false }: any) {
//   const isNegative = value < 0;
//   const displayValue = Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isNegative ? '#F44336' : color }}>
//         {isNegative ? '-' : ''}{currency} {displayValue}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   return {
//     ...order,
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping, // FROM REFUNDS
//     calculatedReturnShippingFees: totalReturnShippingFees, // FROM RETURNS
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedTotalReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions - EXACT COPY FROM YOUR CODE
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - create simplified versions for each portion
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true
//         };
        
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics - UPDATED WITH RETURN SHIPPING AND REFUNDED SHIPPING
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalRevenue = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalReceived = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalReceivedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalRefunded = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalRefundedSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalShipping = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   }, 0);

//   // REFUNDED SHIPPING - from refunds data
//   const totalRefundedShipping = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundedShipping || 0);
//   }, 0);

//   const totalShippingCharges = totalShipping - totalRefundedShipping;

//   const totalRefundDiscrepancy = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRefundDiscrepancy || 0);
//   }, 0);

//   const totalGrossReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossReturns || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   // RETURN SHIPPING FEES - from returns data
//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate total sales using your formula
//   const totalSales = totalGrossSales + totalShippingCharges + totalReturnFees + totalTaxes - totalNetReturns - totalDiscounts;

//   return {
//     totalRevenue,
//     totalReceived,
//     totalRefunded,
//     totalDiscounts,
//     totalShipping,
//     totalRefundedShipping, // NEW: Refunded shipping amount
//     totalShippingCharges,
//     totalRefundDiscrepancy,
//     totalReturns: totalNetReturns,
//     totalGrossSales,
//     totalNetSales,
//     totalTaxes,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees, // NEW: Return shipping fees
//     totalReturnFees,
//     totalSales,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50; // Reasonable limit for today's orders

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation
//   const todayProcessed = processOrders(todayOrders);

//   // Calculate summaries
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// export default function OrdersToday() {
//   const { today, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Revenue" 
//             value={summaries.regular.totalRevenue + summaries.giftCard.totalRevenue} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Refunded Shipping" 
//             value={summaries.regular.totalRefundedShipping + summaries.giftCard.totalRefundedShipping} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Shipping" 
//             value={summaries.regular.totalReturnShippingFees + summaries.giftCard.totalReturnShippingFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }

// // Supporting components - UPDATED WITH NEW FIELDS
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Refunded Shipping" value={-metrics.totalRefundedShipping} currency={metrics.currencyCode} color="#FF5722" />
//       <MetricCard title="Return Shipping" value={-metrics.totalReturnShippingFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Revenue" value={metrics.totalRevenue} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Shipping Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.totalPriceSet.shopMoney.amount} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Refunded: {order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedRefundedShipping > 0 && (
//                     <div style={{ color: '#FF5722' }}>
//                       Refunded Shipping: -{order.calculatedRefundedShipping.toFixed(2)}
//                     </div>
//                   )}
//                   {order.calculatedReturnShippingFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Shipping: -{order.calculatedReturnShippingFees.toFixed(2)}
//                     </div>
//                   )}
//                   {order.calculatedRestockingFees > 0 && (
//                     <div>Restocking: {order.calculatedRestockingFees.toFixed(2)}</div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false }: any) {
//   const isNegative = value < 0;
//   const displayValue = Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isNegative ? '#F44336' : color }}>
//         {isNegative ? '-' : ''}{currency} {displayValue}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }






































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees, // Combined return fees
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales, // This is now Total Sales
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - create simplified versions for each portion
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true
//         };
        
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics - UPDATED WITH CORRECT TERMINOLOGY
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales, // This is now Total Sales
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation
//   const todayProcessed = processOrders(todayOrders);

//   // Calculate summaries
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// export default function OrdersToday() {
//   const { today, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }

// // Supporting components - UPDATED WITH CORRECT TERMINOLOGY
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false }: any) {
//   const isNegative = value < 0;
//   const displayValue = Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isNegative ? '#F44336' : color }}>
//         {isNegative ? '-' : ''}{currency} {displayValue}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   // Calculate summaries
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// export default function OrdersToday() {
//   const { today, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }













// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false }: any) {
//   const isNegative = value < 0;
//   const displayValue = Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isNegative ? '#F44336' : color }}>
//         {isNegative ? '-' : ''}{currency} {displayValue}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }



















































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import type { EventSummary, OrderEvent, EventDetectionData } from "../types/analytics";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// // EVENT DETECTION FUNCTIONS
// function parseMoneyAmount(moneySet: any): number {
//   if (!moneySet || !moneySet.shopMoney || !moneySet.shopMoney.amount) {
//     return 0;
//   }
//   return parseFloat(moneySet.shopMoney.amount) || 0;
// }

// function detectRefundEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderRefunds = order.refunds || [];

//   orderRefunds.forEach((refund: any) => {
//     const refundDate = new Date(refund.createdAt);
    
//     if (refundDate >= periodStart && refundDate <= periodEnd && isTodayInStoreTime(refundDate, storeTimezone)) {
//       const refundAmount = parseMoneyAmount(refund.totalRefundedSet);
//       const totalOrderAmount = parseMoneyAmount(order.currentTotalPriceSet);
//       const isFullRefund = Math.abs(refundAmount - totalOrderAmount) < 0.01;

//       if (isFullRefund) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Full refund processed`,
//           details: { refundId: refund.id, note: refund.note }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'partial_refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Partial refund: ${refundAmount.toFixed(2)}`,
//           details: { refundId: refund.id, note: refund.note, refundLineItems: refund.refundLineItems }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectExchangeEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
  
//   // Check for exchanges in returns data
//   const returns = order.returns?.nodes || [];
  
//   returns.forEach((returnItem: any) => {
//     const returnDate = new Date(returnItem.createdAt);
    
//     if (returnDate >= periodStart && returnDate <= periodEnd && isTodayInStoreTime(returnDate, storeTimezone)) {
//       // Calculate return value from return line items
//       let returnValue = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         returnValue += parseMoneyAmount(lineItem.totalPriceSet);
//       });

//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'exchange',
//         eventDate: returnDate.toISOString(),
//         amount: -returnValue,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Exchange processed`,
//         details: { returnId: returnItem.id, status: returnItem.status, returnValue }
//       });
//     }
//   });

//   return events;
// }
















// function detectReturnEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const returns = order.returns?.nodes || [];

//   returns.forEach((returnItem: any) => {
//     const returnDate = new Date(returnItem.createdAt);
    
//     if (returnDate >= periodStart && returnDate <= periodEnd && isTodayInStoreTime(returnDate, storeTimezone)) {
//       // Detect restocking fees
//       let restockingFees = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee) {
//           restockingFees += parseMoneyAmount(lineItem.restockingFee.amountSet);
//         }
//       });

//       // Detect return shipping fees
//       let returnShippingFees = 0;
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         returnShippingFees += parseMoneyAmount(shippingFee.amountSet);
//       });

//       if (restockingFees > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return',
//           eventDate: returnDate.toISOString(),
//           amount: restockingFees,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Restocking fee applied`,
//           details: { returnId: returnItem.id, type: 'restocking_fee', amount: restockingFees }
//         });
//       }

//       if (returnShippingFees > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return',
//           eventDate: returnDate.toISOString(),
//           amount: returnShippingFees,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Return shipping fee`,
//           details: { returnId: returnItem.id, type: 'return_shipping', amount: returnShippingFees }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectModificationEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderCreatedDate = new Date(order.createdAt);
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   if (orderUpdatedDate > orderCreatedDate && isTodayInStoreTime(orderUpdatedDate, storeTimezone) && !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     // Check for significant changes that indicate modifications
//     const originalSubtotal = parseMoneyAmount(order.subtotalPriceSet);
//     const currentSubtotal = parseMoneyAmount(order.currentSubtotalPriceSet);
//     const subtotalDifference = currentSubtotal - originalSubtotal;

//     if (Math.abs(subtotalDifference) > 0.01) {
//       if (subtotalDifference > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_added',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items added to order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_removed',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items removed from order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       }
//     }

//     // Check for discount changes
//     const originalDiscounts = parseMoneyAmount(order.totalDiscountsSet);
//     const currentDiscounts = parseMoneyAmount(order.currentTotalDiscountsSet);
//     const discountDifference = currentDiscounts - originalDiscounts;

//     if (Math.abs(discountDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'discount',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: -discountDifference, // Negative because discount reduces revenue
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Discount modified`,
//         details: { discountChange: discountDifference, originalDiscounts, currentDiscounts }
//       });
//     }
//   }

//   return events;
// }

// // Main function to detect all events for an order
// function detectOrderEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];

//   // Skip orders created today (they're already in today's orders)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     return events;
//   }

//   // Detect all types of events
//   events.push(...detectRefundEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectExchangeEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectReturnEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectModificationEvents(order, periodStart, periodEnd, storeTimezone));

//   return events;
// }

// // Calculate event summary from events
// function calculateEventSummary(events: OrderEvent[]): EventSummary {
//   const summary: EventSummary = {
//     refunds: { count: 0, value: 0 },
//     exchanges: { count: 0, value: 0 },
//     partialRefunds: { count: 0, value: 0 },
//     modifications: { count: 0, value: 0 },
//     returns: { count: 0, value: 0 },
//     discounts: { count: 0, value: 0 },
//     totalEvents: events.length,
//     netValue: 0
//   };

//   events.forEach(event => {
//     switch (event.eventType) {
//       case 'refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//       case 'exchange':
//         summary.exchanges.count++;
//         summary.exchanges.value += event.amount;
//         break;
//       case 'partial_refund':
//         summary.partialRefunds.count++;
//         summary.partialRefunds.value += event.amount;
//         break;
//       case 'item_added':
//       case 'item_removed':
//         summary.modifications.count++;
//         summary.modifications.value += event.amount;
//         break;
//       case 'return':
//         summary.returns.count++;
//         summary.returns.value += event.amount;
//         break;
//       case 'discount':
//         summary.discounts.count++;
//         summary.discounts.value += event.amount;
//         break;
//     }
//     summary.netValue += event.amount;
//   });

//   return summary;
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   // EVENT DETECTION FOR PAST ORDERS
//   const periodStart = new Date(sevenMonthsAgoUTC);
//   const periodEnd = new Date(nowUTC);
  
//   const pastOrderEvents: OrderEvent[] = [];
//   const ordersWithEvents = new Set<string>();

//   allOrders.forEach((order: any) => {
//     const events = detectOrderEvents(order, periodStart, periodEnd, storeTimezone);
//     if (events.length > 0) {
//       pastOrderEvents.push(...events);
//       ordersWithEvents.add(order.id);
//     }
//   });

//   const eventSummary = calculateEventSummary(pastOrderEvents);

//   console.log(`Event detection: Found ${pastOrderEvents.length} events across ${ordersWithEvents.size} past orders`);

//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     // NEW: Event detection data
//     events: {
//       pastOrderEvents,
//       eventSummary,
//       ordersWithEventsCount: ordersWithEvents.size,
//       totalEventsCount: pastOrderEvents.length
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Helper function for event type colors
// function getEventTypeColor(eventType: string): string {
//   const colors: { [key: string]: string } = {
//     refund: '#F44336',
//     exchange: '#2196F3',
//     partial_refund: '#FF9800',
//     modification: '#9C27B0',
//     return: '#795548',
//     discount: '#607D8B',
//     item_added: '#4CAF50',
//     item_removed: '#F44336'
//   };
//   return colors[eventType] || '#666';
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug, events } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>

//       {/* EVENT DETECTION SECTION - NEW */}
//       // Add this to your OrdersToday component, update the event detection section:

// {/* EVENT DETECTION SECTION - ENHANCED */}
// <div style={{ marginBottom: 40, marginTop: 40 }}>
//   <h2 style={{ borderBottom: '2px solid #FF9800', paddingBottom: 8, color: '#FF9800' }}>
//     Today's Activity on Past Orders ({events.ordersWithEventsCount} orders with activity)
//   </h2>
  
//   {events.totalEventsCount === 0 ? (
//     <div style={{ 
//       textAlign: 'center', 
//       padding: '40px', 
//       backgroundColor: '#fff3cd', 
//       borderRadius: 8,
//       border: '1px solid #ffeaa7'
//     }}>
//       <h3 style={{ color: '#856404', marginBottom: 10 }}>No Activity Detected</h3>
//       <p style={{ color: '#856404' }}>No modifications, refunds, or returns detected on past orders today.</p>
//     </div>
//   ) : (
//     <>
//       {/* Event Financial Summary - NEW */}
//       <div style={{ 
//         display: 'grid', 
//         gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//         gap: 16, 
//         marginBottom: 20,
//         padding: 16,
//         backgroundColor: '#fff3cd',
//         borderRadius: 8
//       }}>
//         <MetricCard title="Total Events" value={events.eventSummary.totalEvents} currency="" color="#FF9800" isCount={true} />
//         <MetricCard title="Net Value Impact" value={events.eventSummary.netValue} currency={summaries.regular.currencyCode} color="#FF9800" />
//         <MetricCard title="Orders Affected" value={events.ordersWithEventsCount} currency="" color="#FF9800" isCount={true} />
//         <MetricCard title="Refunds" value={events.eventSummary.refunds.value} currency={summaries.regular.currencyCode} color="#F44336" />
//         <MetricCard title="Exchanges" value={events.eventSummary.exchanges.value} currency={summaries.regular.currencyCode} color="#2196F3" />
//         <MetricCard title="Returns" value={events.eventSummary.returns.value} currency={summaries.regular.currencyCode} color="#795548" />
//         <MetricCard title="Modifications" value={events.eventSummary.modifications.value} currency={summaries.regular.currencyCode} color="#9C27B0" />
//         <MetricCard title="Discounts" value={events.eventSummary.discounts.value} currency={summaries.regular.currencyCode} color="#607D8B" />
//       </div>

//       {/* Detailed Event Orders with Financial Breakdown - NEW */}
//       <div style={{ marginBottom: 30 }}>
//         <h3 style={{ color: '#FF9800', marginBottom: 15 }}>Detailed Order Impact</h3>
        
//         {/* Get unique orders from events */}
//         {Array.from(new Set(events.pastOrderEvents.map(event => event.orderId))).map(orderId => {
//           const orderEvents = events.pastOrderEvents.filter(event => event.orderId === orderId);
//           const firstEvent = orderEvents[0];
//           const totalImpact = orderEvents.reduce((sum, event) => sum + event.amount, 0);
          
//           return (
//             <details key={orderId} style={{ marginBottom: 15, border: '1px solid #ddd', borderRadius: 8 }}>
//               <summary style={{ 
//                 cursor: 'pointer', 
//                 padding: '16px', 
//                 backgroundColor: '#f8f9fa',
//                 fontWeight: 'bold',
//                 fontSize: '16px'
//               }}>
//                 <strong>{firstEvent.orderName}</strong>
//                 <span style={{ float: 'right', fontWeight: 'normal' }}>
//                   Total Impact: 
//                   <strong style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', marginLeft: '8px' }}>
//                     {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//                   </strong>
//                   <span style={{ marginLeft: '16px', color: '#666' }}>
//                     {orderEvents.length} event{orderEvents.length > 1 ? 's' : ''}
//                   </span>
//                 </span>
//               </summary>
              
//               <div style={{ padding: '16px', backgroundColor: 'white' }}>
//                 {/* Event List for this order */}
//                 <div style={{ marginBottom: '16px' }}>
//                   <h4 style={{ marginBottom: '8px', color: '#333' }}>Event Details:</h4>
//                   {orderEvents.map((event, index) => (
//                     <div key={index} style={{ 
//                       padding: '8px', 
//                       marginBottom: '8px', 
//                       backgroundColor: '#f5f5f5',
//                       borderRadius: '4px',
//                       borderLeft: `4px solid ${getEventTypeColor(event.eventType)}`
//                     }}>
//                       <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
//                         <div>
//                           <span style={{
//                             padding: '2px 6px',
//                             borderRadius: '4px',
//                             fontSize: '0.7em',
//                             backgroundColor: getEventTypeColor(event.eventType),
//                             color: 'white',
//                             marginRight: '8px'
//                           }}>
//                             {event.eventType.replace('_', ' ').toUpperCase()}
//                           </span>
//                           <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                             {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                           </strong>
//                         </div>
//                         <div style={{ fontSize: '0.8em', color: '#666' }}>
//                           {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                             hour: '2-digit', 
//                             minute: '2-digit'
//                           })}
//                         </div>
//                       </div>
//                       <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                         {event.description}
//                       </div>
//                     </div>
//                   ))}
//                 </div>

//                 {/* Financial Summary for this order - NEW */}
//                 <div style={{ 
//                   padding: '12px', 
//                   backgroundColor: '#e8f5e8', 
//                   borderRadius: '4px',
//                   border: '1px solid #4CAF50'
//                 }}>
//                   <h4 style={{ marginBottom: '8px', color: '#2e7d32' }}>Financial Impact Summary:</h4>
//                   <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '8px' }}>
//                     <div>
//                       <strong>Total Impact:</strong>
//                       <div style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', fontWeight: 'bold' }}>
//                         {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//                       </div>
//                     </div>
//                     <div>
//                       <strong>Refunds:</strong>
//                       <div style={{ color: '#F44336' }}>
//                         -{orderEvents.filter(e => e.eventType === 'refund' || e.eventType === 'partial_refund').reduce((sum, e) => sum + Math.abs(e.amount), 0).toFixed(2)}
//                       </div>
//                     </div>
//                     <div>
//                       <strong>Returns:</strong>
//                       <div style={{ color: '#795548' }}>
//                         +{orderEvents.filter(e => e.eventType === 'return').reduce((sum, e) => sum + e.amount, 0).toFixed(2)}
//                       </div>
//                     </div>
//                     <div>
//                       <strong>Modifications:</strong>
//                       <div style={{ color: '#9C27B0' }}>
//                         {orderEvents.filter(e => e.eventType === 'item_added' || e.eventType === 'item_removed').reduce((sum, e) => sum + e.amount, 0).toFixed(2)}
//                       </div>
//                     </div>
//                   </div>
//                 </div>
//               </div>
//             </details>
//           );
//         })}
//       </div>

//       {/* Event Details Table (Original) */}
//       <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//         <div style={{ padding: '12px', backgroundColor: '#f5f5f5', borderBottom: '1px solid #ddd' }}>
//           <h4 style={{ margin: 0, color: '#333' }}>All Events Timeline</h4>
//         </div>
//         <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//           <thead style={{ backgroundColor: '#f8f9fa' }}>
//             <tr>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Event Type</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Description</th>
//             </tr>
//           </thead>
//           <tbody>
//             {events.pastOrderEvents.map((event: OrderEvent, index: number) => (
//               <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
//                 <td style={{ padding: '12px' }}>
//                   <strong>{event.orderName}</strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <span style={{
//                     padding: '4px 8px',
//                     borderRadius: '4px',
//                     fontSize: '0.8em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                     {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                   </strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {event.description}
//                   {event.details && (
//                     <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                       {JSON.stringify(event.details)}
//                     </div>
//                   )}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </>
//   )}
// </div>
//     </div>
//   );
// }































































































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import type { EventSummary, OrderEvent, EventDetectionData } from "../types/analytics";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }





// // Add this function right before your event detection loop
// function debugReturnData(orders: any[]) {
//   console.log('=== RETURN DATA DEBUG ===');
  
//   orders.forEach((order: any) => {
//     const returns = order.returns?.nodes || [];
//     if (returns.length > 0) {
//       console.log(`Order ${order.name} has ${returns.length} returns:`, {
//         orderId: order.id,
//         returns: returns.map((ret: any) => ({
//           id: ret.id,
//           createdAt: ret.createdAt,
//           hasRestockingFees: ret.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//           hasReturnShipping: ret.returnShippingFees?.length > 0,
//           hasTaxData: !!ret.totalTaxSet,
//           lineItems: ret.returnLineItems?.nodes?.map((li: any) => ({
//             hasRestockingFee: !!li.restockingFee,
//             restockingFeeAmount: li.restockingFee?.amountSet?.shopMoney?.amount,
//             totalPrice: li.totalPriceSet?.shopMoney?.amount
//           }))
//         }))
//       });
//     }
//   });
  
//   console.log('=== END RETURN DATA DEBUG ===');
// }

// // EVENT DETECTION FUNCTIONS
// function parseMoneyAmount(moneySet: any): number {
//   if (!moneySet || !moneySet.shopMoney || !moneySet.shopMoney.amount) {
//     return 0;
//   }
//   return parseFloat(moneySet.shopMoney.amount) || 0;
// }

// function detectRefundEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderRefunds = order.refunds || [];


//  // ADD DEBUG
//   if (orderRefunds.length > 0) {
//     console.log(` Checking refunds for order ${order.name}:`, {
//       refundsCount: orderRefunds.length,
//       refundDates: orderRefunds.map((r: any) => new Date(r.createdAt)),
//       todayInStore: getStoreLocalDateString(new Date(), storeTimezone)
//     });
//   }


//   orderRefunds.forEach((refund: any) => {
//     const refundDate = new Date(refund.createdAt);
    
//     if (refundDate >= periodStart && refundDate <= periodEnd && isTodayInStoreTime(refundDate, storeTimezone)) {
//       const refundAmount = parseMoneyAmount(refund.totalRefundedSet);
//       const totalOrderAmount = parseMoneyAmount(order.currentTotalPriceSet);
//       const isFullRefund = Math.abs(refundAmount - totalOrderAmount) < 0.01;

//       // Calculate refunded shipping from this refund
//       const refundedShipping = parseMoneyAmount(refund.shipping) || 0;
      
//       // Calculate refund discrepancy if any
//       const refundDiscrepancy = parseMoneyAmount(order.refundDiscrepancySet) || 0;

//       if (isFullRefund) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Full refund processed`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note,
//             refundedShipping: -refundedShipping,
//             refundDiscrepancy: refundDiscrepancy,
//             isFullRefund: true
//           }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'partial_refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Partial refund: ${refundAmount.toFixed(2)}`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note, 
//             refundLineItems: refund.refundLineItems,
//             refundedShipping: -refundedShipping,
//             refundDiscrepancy: refundDiscrepancy
//           }
//         });
//       }

//       // Add separate event for refunded shipping if any
//       if (refundedShipping > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_shipping',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedShipping,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded shipping`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_shipping',
//             amount: -refundedShipping
//           }
//         });
//       }

//       // Add event for refund discrepancy if any
//       if (Math.abs(refundDiscrepancy) > 0.01) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: refundDiscrepancy > 0 ? 'over_refund' : 'under_refund',
//           eventDate: refundDate.toISOString(),
//           amount: refundDiscrepancy > 0 ? -Math.abs(refundDiscrepancy) : Math.abs(refundDiscrepancy),
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: refundDiscrepancy > 0 ? 'Over refund discrepancy' : 'Under refund discrepancy',
//           details: { 
//             refundId: refund.id,
//             type: 'refund_discrepancy',
//             amount: refundDiscrepancy
//           }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectExchangeEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
  
//   // Check for exchanges in returns data
//   const returns = order.returns?.nodes || [];
  
//   returns.forEach((returnItem: any) => {
//     const returnDate = new Date(returnItem.createdAt);
    
//     if (returnDate >= periodStart && returnDate <= periodEnd && isTodayInStoreTime(returnDate, storeTimezone)) {
//       // Calculate return value from return line items
//       let returnValue = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         returnValue += parseMoneyAmount(lineItem.totalPriceSet);
//       });

//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'exchange',
//         eventDate: returnDate.toISOString(),
//         amount: -returnValue,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Exchange processed`,
//         details: { returnId: returnItem.id, status: returnItem.status, returnValue }
//       });
//     }
//   });

//   return events;
// }
















// function detectReturnEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectReturnEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const returns = order.returns?.nodes || [];
  
//   // ADD DEBUG: Check what return data we actually have
//   if (returns.length > 0) {
//     console.log(` Order ${order.name} has ${returns.length} returns:`, returns.map((ret: any) => ({
//       id: ret.id,
//       createdAt: ret.createdAt,
//       hasRestockingFees: ret.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//       hasReturnShipping: ret.returnShippingFees?.length > 0,
//       hasTaxData: !!ret.totalTaxSet,
//       lineItemsCount: ret.returnLineItems?.nodes?.length || 0
//     })));
//   }

//   returns.forEach((returnItem: any) => {
//     const returnDate = new Date(returnItem.createdAt);
    
//     if (returnDate >= periodStart && returnDate <= periodEnd && isTodayInStoreTime(returnDate, storeTimezone)) {
//       console.log(` Processing return for order ${order.name} dated ${returnDate}`);
//       // Calculate restocking fees
//       let totalRestockingFees = 0;
//       let restockingFeeItems = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee) {
//           const feeAmount = parseMoneyAmount(lineItem.restockingFee.amountSet);
//           totalRestockingFees += feeAmount;
//           restockingFeeItems++;
//         }
//       });

//       // Calculate return shipping fees
//       let totalReturnShippingFees = 0;
//       let returnShippingEvents = 0;
      
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         const shippingAmount = parseMoneyAmount(shippingFee.amountSet);
//         totalReturnShippingFees += shippingAmount;
//         returnShippingEvents++;
//       });

//       // Calculate returned products value
//       let returnedProductsValue = 0;
//       let returnedItemsCount = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         const itemValue = parseMoneyAmount(lineItem.totalPriceSet) || 0;
//         returnedProductsValue += itemValue;
//         returnedItemsCount++;
//       });

//       // Create events for what we actually have data for
//       if (totalRestockingFees > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'restocking_fee',
//           eventDate: returnDate.toISOString(),
//           amount: totalRestockingFees,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Restocking fee applied`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'restocking_fee', 
//             amount: totalRestockingFees,
//             itemsCount: restockingFeeItems
//           }
//         });
//       }

//       if (totalReturnShippingFees > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_shipping_fee',
//           eventDate: returnDate.toISOString(),
//           amount: totalReturnShippingFees,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Return shipping fee`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'return_shipping_fee', 
//             amount: totalReturnShippingFees,
//             eventsCount: returnShippingEvents
//           }
//         });
//       }

//       // Main return event for products
//       if (returnedItemsCount > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'product_return',
//           eventDate: returnDate.toISOString(),
//           amount: -returnedProductsValue, // Negative because products are returned
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Products returned (${returnedItemsCount} items)`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'product_return',
//             itemsCount: returnedItemsCount,
//             value: -returnedProductsValue
//           }
//         });
//       }

//       // Calculate and add tax impact from returns
//       const returnTaxImpact = parseMoneyAmount(returnItem.totalTaxSet) || 0;
//       if (returnTaxImpact !== 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_tax',
//           eventDate: returnDate.toISOString(),
//           amount: -returnTaxImpact,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Tax adjustment from return`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'tax_adjustment',
//             amount: -returnTaxImpact
//           }
//         });
//       }
//     }
//   });

//   return events;
// }



// function detectTaxEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectTaxEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const orderUpdatedDate = new Date(order.updatedAt); // FIXED: Define orderUpdatedDate here

//   // Check if taxes were modified today
//   if (isTodayInStoreTime(orderUpdatedDate, storeTimezone)) {
//     const originalTax = parseMoneyAmount(order.totalTaxSet) || 0;
//     const currentTax = parseMoneyAmount(order.currentTotalTaxSet) || 0;
//     const taxDifference = currentTax - originalTax;

//     // ADD DEBUG LOGGING
//     console.log(` Tax check for order ${order.name}:`, {
//       originalTax,
//       currentTax,
//       taxDifference,
//       updatedToday: isTodayInStoreTime(orderUpdatedDate, storeTimezone),
//       orderUpdatedDate: orderUpdatedDate.toISOString()
//     });

//     if (Math.abs(taxDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'tax_adjustment',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: taxDifference,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Tax adjustment applied`,
//         details: { 
//           taxChange: taxDifference, 
//           originalTax, 
//           currentTax 
//         }
//       });
      
//       console.log(` Tax adjustment event created for order ${order.name}: ${taxDifference}`);
//     }
//   }

//   return events;
// }

// function detectModificationEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderCreatedDate = new Date(order.createdAt);
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   if (orderUpdatedDate > orderCreatedDate && isTodayInStoreTime(orderUpdatedDate, storeTimezone) && !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     // Check for significant changes that indicate modifications
//     const originalSubtotal = parseMoneyAmount(order.subtotalPriceSet);
//     const currentSubtotal = parseMoneyAmount(order.currentSubtotalPriceSet);
//     const subtotalDifference = currentSubtotal - originalSubtotal;

//     if (Math.abs(subtotalDifference) > 0.01) {
//       if (subtotalDifference > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_added',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items added to order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_removed',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items removed from order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       }
//     }

//     // Check for discount changes
//     const originalDiscounts = parseMoneyAmount(order.totalDiscountsSet);
//     const currentDiscounts = parseMoneyAmount(order.currentTotalDiscountsSet);
//     const discountDifference = currentDiscounts - originalDiscounts;

//     if (Math.abs(discountDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'discount',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: -discountDifference, // Negative because discount reduces revenue
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Discount modified`,
//         details: { discountChange: discountDifference, originalDiscounts, currentDiscounts }
//       });
//     }
//   }

//   return events;
// }

// // Main function to detect all events for an order
// function detectOrderEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];

//   // Skip orders created today (they're already in today's orders)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     return events;
//   }

//   // Detect all types of events
//   events.push(...detectRefundEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectExchangeEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectReturnEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectModificationEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectTaxEvents(order, periodStart, periodEnd, storeTimezone)); // NEW: Tax events

//   return events;
// }

// // Calculate event summary from events
// function calculateEventSummary(events: OrderEvent[]): EventSummary {
//   const summary: EventSummary = {
//     refunds: { count: 0, value: 0 },
//     exchanges: { count: 0, value: 0 },
//     partialRefunds: { count: 0, value: 0 },
//     modifications: { count: 0, value: 0 },
//     returns: { count: 0, value: 0 },
//     discounts: { count: 0, value: 0 },
//     // NEW PROPERTIES ADDED
//     restockingFees: { count: 0, value: 0 },
//     returnShippingFees: { count: 0, value: 0 },
//     refundShipping: { count: 0, value: 0 },
//     taxAdjustments: { count: 0, value: 0 },
//     totalEvents: events.length,
//     netValue: 0
//   };

//   events.forEach(event => {
//     switch (event.eventType) {
//       case 'refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//       case 'exchange':
//         summary.exchanges.count++;
//         summary.exchanges.value += event.amount;
//         break;
//       case 'partial_refund':
//         summary.partialRefunds.count++;
//         summary.partialRefunds.value += event.amount;
//         break;
//       case 'item_added':
//       case 'item_removed':
//         summary.modifications.count++;
//         summary.modifications.value += event.amount;
//         break;
//       case 'return':
//         summary.returns.count++;
//         summary.returns.value += event.amount;
//         break;
//       case 'discount':
//         summary.discounts.count++;
//         summary.discounts.value += event.amount;
//         break;
//       // NEW EVENT TYPES HANDLED
//       case 'restocking_fee':
//         summary.restockingFees.count++;
//         summary.restockingFees.value += event.amount;
//         break;
//       case 'return_shipping_fee':
//         summary.returnShippingFees.count++;
//         summary.returnShippingFees.value += event.amount;
//         break;
//       case 'refund_shipping':
//         summary.refundShipping.count++;
//         summary.refundShipping.value += event.amount;
//         break;
//       case 'tax_adjustment':
//       case 'return_tax':
//         summary.taxAdjustments.count++;
//         summary.taxAdjustments.value += event.amount;
//         break;
//       case 'over_refund':
//       case 'under_refund':
//         // These can be handled as refund discrepancies if needed
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//       case 'product_return':
//         // Product returns are already counted in the main 'returns' category
//         summary.returns.count++;
//         summary.returns.value += event.amount;
//         break;
//     }
//     summary.netValue += event.amount;
//   });

//   return summary;
// }

// // Calculate event order metrics (MIRRORS TODAY'S ORDERS LOGIC)
// function calculateEventOrderMetrics(orderEvents: OrderEvent[]): any[] {
//   // Group events by order
//   const eventsByOrder: { [orderId: string]: OrderEvent[] } = {};
//   orderEvents.forEach(event => {
//     if (!eventsByOrder[event.orderId]) {
//       eventsByOrder[event.orderId] = [];
//     }
//     eventsByOrder[event.orderId].push(event);
//   });

//   // Calculate metrics for each order with events
//   const orderMetrics = Object.entries(eventsByOrder).map(([orderId, events]) => {
//     const firstEvent = events[0];
    
//     // Calculate financial impact from events
//     const grossSalesImpact = events
//       .filter(e => e.eventType === 'item_added')
//       .reduce((sum, e) => sum + Math.max(0, e.amount), 0);
    
//     const returnsImpact = events
//       .filter(e => e.eventType === 'refund' || e.eventType === 'partial_refund' || e.eventType === 'product_return')
//       .reduce((sum, e) => sum + Math.min(0, e.amount), 0);
    
//     const discountsImpact = events
//       .filter(e => e.eventType === 'discount')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const shippingImpact = events
//       .filter(e => e.eventType === 'refund_shipping' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const returnFeesImpact = events
//       .filter(e => e.eventType === 'restocking_fee' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const taxesImpact = events
//       .filter(e => e.eventType === 'tax_adjustment' || e.eventType === 'return_tax')
//       .reduce((sum, e) => sum + e.amount, 0);

//     const netSalesImpact = grossSalesImpact + returnsImpact + discountsImpact;
//     const totalImpact = netSalesImpact + shippingImpact + returnFeesImpact + taxesImpact;

//     return {
//       orderId,
//       orderName: firstEvent.orderName,
//       currencyCode: firstEvent.currencyCode,
//       events,
//       // Core calculated metrics (MIRRORING TODAY'S ORDERS)
//       calculatedGrossSales: grossSalesImpact,
//       calculatedGrossReturns: Math.abs(returnsImpact),
//       calculatedNetReturns: Math.abs(returnsImpact),
//       calculatedRefundedShipping: events.filter(e => e.eventType === 'refund_shipping').reduce((sum, e) => sum + Math.abs(e.amount), 0),
//       calculatedReturnShippingFees: events.filter(e => e.eventType === 'return_shipping_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedNetSales: netSalesImpact,
//       calculatedRefundDiscrepancy: events.filter(e => e.eventType === 'over_refund' || e.eventType === 'under_refund').reduce((sum, e) => sum + e.amount, 0),
//       calculatedRestockingFees: events.filter(e => e.eventType === 'restocking_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedReturnFees: returnFeesImpact,
//       calculatedShippingCharges: shippingImpact,
//       calculatedTaxes: taxesImpact,
//       calculatedTotalSales: totalImpact,
      
//       // Flags (MIRRORING TODAY'S ORDERS)
//       hasOverRefund: events.some(e => e.eventType === 'over_refund'),
//       hasUnderRefund: events.some(e => e.eventType === 'under_refund'),
//       eventTypes: [...new Set(events.map(e => e.eventType))]
//     };
//   });

//   return orderMetrics;
// }

// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// function calculateEventFinancialMetrics(orderMetrics: any[]): any {
//   const totalGrossSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orderMetrics.reduce((sum: number, order: any) => {
//     const discountEvents = order.events.filter((e: OrderEvent) => e.eventType === 'discount');
//     return sum + discountEvents.reduce((discountSum: number, e: OrderEvent) => discountSum + Math.abs(e.amount), 0);
//   }, 0);

//   const totalNetReturns = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   const totalReturnFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedTaxes || 0);
//   }, 0);

//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orderMetrics.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   const totalRestockingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orderMetrics[0]?.currencyCode || 'USD'
//   };
// }

// // Add this function RIGHT AFTER your calculateEventSummary function

// // Debug function to log all event details
// function debugEventDetection(events: OrderEvent[], eventSummary: EventSummary) {
//   console.log('=== EVENT DETECTION DEBUG ===');
//   console.log(`Total events detected: ${events.length}`);
//   console.log(`Orders with events: ${new Set(events.map(e => e.orderId)).size}`);
  
//   // Log event type breakdown
//   const eventTypeCount: Record<string, number> = {};
//   events.forEach(event => {
//     eventTypeCount[event.eventType] = (eventTypeCount[event.eventType] || 0) + 1;
//   });
  
//   console.log('Event type breakdown:', eventTypeCount);
  
//   // Log financial summary
//   console.log('Financial Summary:', {
//     totalEvents: eventSummary.totalEvents,
//     netValue: eventSummary.netValue,
//     refunds: eventSummary.refunds,
//     exchanges: eventSummary.exchanges,
//     partialRefunds: eventSummary.partialRefunds,
//     modifications: eventSummary.modifications,
//     returns: eventSummary.returns,
//     discounts: eventSummary.discounts,
//     restockingFees: eventSummary.restockingFees,
//     returnShippingFees: eventSummary.returnShippingFees,
//     refundShipping: eventSummary.refundShipping,
//     taxAdjustments: eventSummary.taxAdjustments
//   });
  
//   // Log detailed events for first 5 orders (to avoid console spam)
//   const uniqueOrderIds = [...new Set(events.map(e => e.orderId))].slice(0, 5);
//   uniqueOrderIds.forEach(orderId => {
//     const orderEvents = events.filter(e => e.orderId === orderId);
//     console.log(`Order ${orderId} events:`, orderEvents);
//   });
  
//   console.log('=== END EVENT DEBUG ===');
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   debugReturnData(allOrders);

//   // EVENT DETECTION FOR PAST ORDERS
//   const periodStart = new Date(sevenMonthsAgoUTC);
//   const periodEnd = new Date(nowUTC);
  
//   const pastOrderEvents: OrderEvent[] = [];
//   const ordersWithEvents = new Set<string>();

//   allOrders.forEach((order: any) => {
//     const events = detectOrderEvents(order, periodStart, periodEnd, storeTimezone);
//     if (events.length > 0) {
//       pastOrderEvents.push(...events);
//       ordersWithEvents.add(order.id);
//     }
//   });

//   const eventSummary = calculateEventSummary(pastOrderEvents);

//   console.log(`Event detection: Found ${pastOrderEvents.length} events across ${ordersWithEvents.size} past orders`);


//   // NEW: Calculate event metrics that mirror today's orders
// const eventOrderMetrics = calculateEventOrderMetrics(pastOrderEvents);
// const eventFinancialMetrics = calculateEventFinancialMetrics(eventOrderMetrics);


// debugEventDetection(pastOrderEvents, eventSummary);


//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     // NEW: Event detection data
//     events: {
//       pastOrderEvents,
//       eventSummary,
//       ordersWithEventsCount: ordersWithEvents.size,
//       totalEventsCount: pastOrderEvents.length,
//        eventOrderMetrics,
//     eventFinancialMetrics
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Helper function for event type colors
// function getEventTypeColor(eventType: string): string {
//   const colors: { [key: string]: string } = {
//     refund: '#F44336',
//     exchange: '#2196F3',
//     partial_refund: '#FF9800',
//     modification: '#9C27B0',
//     return: '#795548',
//     discount: '#607D8B',
//     item_added: '#4CAF50',
//     item_removed: '#F44336'
//   };
//   return colors[eventType] || '#666';
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug, events } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>

//       {/* EVENT DETECTION SECTION - NEW */}
    

// {/* EVENT DETECTION SECTION - ENHANCED */}
// <div style={{ marginBottom: 40, marginTop: 40 }}>
//   <h2 style={{ borderBottom: '2px solid #FF9800', paddingBottom: 8, color: '#FF9800' }}>
//     Today's Activity on Past Orders ({events.ordersWithEventsCount} orders with activity)
//   </h2>
  
//   {events.totalEventsCount === 0 ? (
//     <div style={{ 
//       textAlign: 'center', 
//       padding: '40px', 
//       backgroundColor: '#fff3cd', 
//       borderRadius: 8,
//       border: '1px solid #ffeaa7'
//     }}>
//       <h3 style={{ color: '#856404', marginBottom: 10 }}>No Activity Detected</h3>
//       <p style={{ color: '#856404' }}>No modifications, refunds, or returns detected on past orders today.</p>
//     </div>
//   ) : (
//     <>
//       {/* Event Financial Summary - NEW */}
     

// {/* Event Financial Summary - Show only what we detect */}
// <div style={{ 
//   display: 'grid', 
//   gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//   gap: 16, 
//   marginBottom: 20,
//   padding: 16,
//   backgroundColor: '#fff3cd',
//   borderRadius: 8
// }}>
//   <MetricCard title="Total Events" value={events.eventSummary.totalEvents} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Net Value Impact" value={events.eventSummary.netValue} currency={summaries.regular.currencyCode} color="#FF9800" />
//   <MetricCard title="Orders Affected" value={events.ordersWithEventsCount} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Refunds" value={events.eventSummary.refunds.value} currency={summaries.regular.currencyCode} color="#F44336" />
//   <MetricCard title="Exchanges" value={events.eventSummary.exchanges.value} currency={summaries.regular.currencyCode} color="#2196F3" />
//   <MetricCard title="Modifications" value={events.eventSummary.modifications.value} currency={summaries.regular.currencyCode} color="#9C27B0" />
//   <MetricCard title="Returns" value={events.eventSummary.returns.count} currency="" color="#795548" isCount={true} />
//   <MetricCard title="Discounts" value={events.eventSummary.discounts.value} currency={summaries.regular.currencyCode} color="#607D8B" />
// </div>

// {/* Return Events Breakdown - Show actual detected return events */}
// {events.eventSummary.returns.count > 0 && (
//   <div style={{ 
//     marginBottom: 20,
//     padding: 16,
//     backgroundColor: '#f3e5f5',
//     borderRadius: 8,
//     border: '1px solid #e1bee7'
//   }}>
//     <h4 style={{ marginBottom: 12, color: '#7b1fa2' }}>Return Events Detected</h4>
    
//     {/* Calculate actual return fees from events */}
//     {(() => {
//       const returnEvents = events.pastOrderEvents.filter(event => event.eventType === 'return');
//       const restockingFees = returnEvents
//         .filter(event => event.details?.type === 'restocking_fee')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const returnShippingFees = returnEvents
//         .filter(event => event.details?.type === 'return_shipping')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const productReturns = returnEvents
//         .filter(event => event.details?.type === 'product_return')
//         .length;

//       return (
//         <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12 }}>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Restocking Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {restockingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'restocking_fee').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Return Shipping</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {returnShippingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'return_shipping').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Product Returns</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#f44336' }}>
//               {productReturns} returns
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Items returned to inventory
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Total Return Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#4CAF50' }}>
//               {summaries.regular.currencyCode} {(restockingFees + returnShippingFees).toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Combined fees
//             </div>
//           </div>
//         </div>
//       );
//     })()}
//   </div>
// )}

// {/* Enhanced Order Details with Return Fee Breakdown */}
// {Array.from(new Set(events.pastOrderEvents.map(event => event.orderId))).map(orderId => {
//   const orderEvents = events.pastOrderEvents.filter(event => event.orderId === orderId);
//   const firstEvent = orderEvents[0];
  
//   // Calculate financial impact for this order
//   const totalImpact = orderEvents.reduce((sum, event) => sum + event.amount, 0);
  
//   // Calculate return fee breakdown for this order
//   const orderReturnEvents = orderEvents.filter(event => event.eventType === 'return');
//   const orderRestockingFees = orderReturnEvents
//     .filter(event => event.details?.type === 'restocking_fee')
//     .reduce((sum, event) => sum + event.amount, 0);
  
//   const orderReturnShipping = orderReturnEvents
//     .filter(event => event.details?.type === 'return_shipping')
//     .reduce((sum, event) => sum + event.amount, 0);

//   return (
//     <details key={orderId} style={{ marginBottom: 15, border: '1px solid #ddd', borderRadius: 8 }}>
//       <summary style={{ 
//         cursor: 'pointer', 
//         padding: '16px', 
//         backgroundColor: '#f8f9fa',
//         fontWeight: 'bold',
//         fontSize: '16px'
//       }}>
//         <strong>{firstEvent.orderName}</strong>
//         <span style={{ float: 'right', fontWeight: 'normal' }}>
//           Impact: 
//           <strong style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', marginLeft: '8px' }}>
//             {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//           </strong>
//           <span style={{ marginLeft: '16px', color: '#666' }}>
//             {orderEvents.length} event{orderEvents.length > 1 ? 's' : ''}
//           </span>
//         </span>
//       </summary>
      
//       <div style={{ padding: '16px', backgroundColor: 'white' }}>
//         {/* Event List */}
//         <div style={{ marginBottom: '16px' }}>
//           <h4 style={{ marginBottom: '8px', color: '#333' }}>Event Details:</h4>
//           {orderEvents.map((event, index) => (
//             <div key={index} style={{ 
//               padding: '8px', 
//               marginBottom: '8px', 
//               backgroundColor: '#f5f5f5',
//               borderRadius: '4px',
//               borderLeft: `4px solid ${getEventTypeColor(event.eventType)}`
//             }}>
//               <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
//                 <div>
//                   <span style={{
//                     padding: '2px 6px',
//                     borderRadius: '4px',
//                     fontSize: '0.7em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white',
//                     marginRight: '8px'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                   {event.amount !== 0 && (
//                     <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                       {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                     </strong>
//                   )}
//                   <span style={{ marginLeft: '8px' }}>{event.description}</span>
//                 </div>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </div>
//               </div>
//               {event.details && (
//                 <div style={{ fontSize: '0.7em', color: '#666', marginTop: '4px' }}>
//                   {Object.entries(event.details).map(([key, value]) => (
//                     <span key={key} style={{ marginRight: '8px' }}>
//                       {key}: {String(value)}
//                     </span>
//                   ))}
//                 </div>
//               )}
//             </div>
//           ))}
//         </div>

//         {/* Financial Summary */}
//         {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//           <div style={{ 
//             padding: '12px', 
//             backgroundColor: '#e8f5e8', 
//             borderRadius: '4px',
//             border: '1px solid #4CAF50',
//             marginBottom: '12px'
//           }}>
//             <h4 style={{ marginBottom: '8px', color: '#2e7d32' }}>Return Fees Summary:</h4>
//             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '8px' }}>
//               {orderRestockingFees > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Restocking Fees</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderRestockingFees.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {orderReturnShipping > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Return Shipping</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderReturnShipping.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Total Return Fees</div>
//                   <div style={{ color: '#4CAF50', fontWeight: 'bold' }}>
//                     +{(orderRestockingFees + orderReturnShipping).toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//             </div>
//           </div>
//         )}
//       </div>
//     </details>
//   );
// })}
     

//       {/* Event Details Table (Original) */}
//       <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//         <div style={{ padding: '12px', backgroundColor: '#f5f5f5', borderBottom: '1px solid #ddd' }}>
//           <h4 style={{ margin: 0, color: '#333' }}>All Events Timeline</h4>
//         </div>
//         <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//           <thead style={{ backgroundColor: '#f8f9fa' }}>
//             <tr>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Event Type</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Description</th>
//             </tr>
//           </thead>
//           <tbody>
//             {events.pastOrderEvents.map((event: OrderEvent, index: number) => (
//               <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
//                 <td style={{ padding: '12px' }}>
//                   <strong>{event.orderName}</strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <span style={{
//                     padding: '4px 8px',
//                     borderRadius: '4px',
//                     fontSize: '0.8em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                     {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                   </strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {event.description}
//                   {event.details && (
//                     <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                       {JSON.stringify(event.details)}
//                     </div>
//                   )}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </>
//   )}
// </div>
//     </div>
//   );
// }

























































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import type { EventSummary, OrderEvent, EventDetectionData } from "../types/analytics";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }





// // Add this function right before your event detection loop
// function debugReturnData(orders: any[]) {
//   console.log('=== RETURN DATA DEBUG ===');
  
//   orders.forEach((order: any) => {
//     const returns = order.returns?.nodes || [];
//     if (returns.length > 0) {
//       console.log(`Order ${order.name} has ${returns.length} returns:`, {
//         orderId: order.id,
//         returns: returns.map((ret: any) => ({
//           id: ret.id,
//           createdAt: ret.createdAt,
//           hasRestockingFees: ret.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//           hasReturnShipping: ret.returnShippingFees?.length > 0,
//           hasTaxData: !!ret.totalTaxSet,
//           lineItems: ret.returnLineItems?.nodes?.map((li: any) => ({
//             hasRestockingFee: !!li.restockingFee,
//             restockingFeeAmount: li.restockingFee?.amountSet?.shopMoney?.amount,
//             totalPrice: li.totalPriceSet?.shopMoney?.amount
//           }))
//         }))
//       });
//     }
//   });
  
//   console.log('=== END RETURN DATA DEBUG ===');
// }

// // EVENT DETECTION FUNCTIONS
// function parseMoneyAmount(moneySet: any): number {
//   if (!moneySet || !moneySet.shopMoney || !moneySet.shopMoney.amount) {
//     return 0;
//   }
//   return parseFloat(moneySet.shopMoney.amount) || 0;
// }

// function detectRefundEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderRefunds = order.refunds || [];

//   orderRefunds.forEach((refund: any) => {
//     const refundDate = new Date(refund.createdAt);
    
//     if (refundDate >= periodStart && refundDate <= periodEnd && isTodayInStoreTime(refundDate, storeTimezone)) {
//       const refundAmount = parseMoneyAmount(refund.totalRefundedSet);
//       const totalOrderAmount = parseMoneyAmount(order.currentTotalPriceSet);
//       const isFullRefund = Math.abs(refundAmount - totalOrderAmount) < 0.01;

//       // Calculate refunded shipping from this refund
//       const refundedShipping = parseMoneyAmount(refund.shipping) || 0;
      
//       // Calculate refunded taxes
//       const refundedTaxes = refund.refundLineItems?.edges?.reduce((sum: number, edge: any) => {
//         return sum + parseMoneyAmount(edge.node.totalTaxSet);
//       }, 0) || 0;
      
//       // Calculate refund discrepancy if any
//       const refundDiscrepancy = parseMoneyAmount(order.refundDiscrepancySet) || 0;

//       if (isFullRefund) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Full refund processed`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy,
//             isFullRefund: true
//           }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'partial_refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Partial refund: ${refundAmount.toFixed(2)}`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note, 
//             refundLineItems: refund.refundLineItems,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy
//           }
//         });
//       }

//       // Add separate event for refunded shipping if any
//       if (refundedShipping > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_shipping',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedShipping,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded shipping`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_shipping',
//             amount: -refundedShipping
//           }
//         });
//       }

//       // Add separate event for refunded taxes if any
//       if (refundedTaxes > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_tax',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedTaxes,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded taxes`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_tax',
//             amount: -refundedTaxes
//           }
//         });
//       }

//       // Add event for refund discrepancy if any
//       if (Math.abs(refundDiscrepancy) > 0.01) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: refundDiscrepancy > 0 ? 'over_refund' : 'under_refund',
//           eventDate: refundDate.toISOString(),
//           amount: refundDiscrepancy > 0 ? -Math.abs(refundDiscrepancy) : Math.abs(refundDiscrepancy),
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: refundDiscrepancy > 0 ? 'Over refund discrepancy' : 'Under refund discrepancy',
//           details: { 
//             refundId: refund.id,
//             type: 'refund_discrepancy',
//             amount: refundDiscrepancy
//           }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectExchangeEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
  
//   // Check for exchanges in returns data
//   const returns = order.returns?.nodes || [];
  
//   returns.forEach((returnItem: any) => {
//     const returnDate = new Date(returnItem.createdAt);
    
//     if (returnDate >= periodStart && returnDate <= periodEnd && isTodayInStoreTime(returnDate, storeTimezone)) {
//       // Calculate return value from return line items
//       let returnValue = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         returnValue += parseMoneyAmount(lineItem.totalPriceSet);
//       });

//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'exchange',
//         eventDate: returnDate.toISOString(),
//         amount: -returnValue,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Exchange processed`,
//         details: { returnId: returnItem.id, status: returnItem.status, returnValue }
//       });
//     }
//   });

//   return events;
// }











// function detectReturnEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectReturnEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const returns = order.returns?.nodes || [];
  
//   console.log(` Order ${order.name} has ${returns.length} returns`);
  
//   returns.forEach((returnItem: any, index: number) => {
//     // Validate and safely parse the return date
//     let returnDate: Date | null = null;
//     let isValidDate = false;
    
//     try {
//       if (returnItem.createdAt) {
//         returnDate = new Date(returnItem.createdAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       }
//     } catch (error) {
//       console.log(` Invalid date for return:`, returnItem.createdAt);
//       isValidDate = false;
//     }
    
//     // If no valid date, use order updated date as fallback
//     if (!isValidDate) {
//       try {
//         returnDate = new Date(order.updatedAt);
//         isValidDate = !isNaN(returnDate.getTime());
//         console.log(` Using order updated date as fallback for return: ${returnDate.toISOString()}`);
//       } catch (error) {
//         console.log(` No valid date available for return`);
//         return; // Skip this return if no valid date
//       }
//     }
    
//     console.log(`Return ${index + 1}:`, {
//       id: returnItem.id,
//       createdAt: returnItem.createdAt,
//       returnDate: returnDate?.toISOString(),
//       status: returnItem.status,
//       hasRestockingFees: returnItem.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//       hasReturnShipping: returnItem.returnShippingFees?.length > 0,
//       restockingFees: returnItem.returnLineItems?.nodes?.map((li: any) => ({
//         hasFee: !!li.restockingFee,
//         amount: li.restockingFee?.amountSet?.shopMoney?.amount
//       })),
//       returnShippingFees: returnItem.returnShippingFees?.map((fee: any) => ({
//         amount: fee?.amountSet?.shopMoney?.amount
//       }))
//     });
    
//     // TEMPORARY: Remove date filtering for debugging (but keep date validation)
//     if (true && returnDate) { // Ensure returnDate exists
//       console.log(` Processing return for order ${order.name} (date filtering disabled)`);
      
//       // Calculate restocking fees
//       let totalRestockingFees = 0;
//       let restockingFeeItems = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee) {
//           const feeAmount = parseMoneyAmount(lineItem.restockingFee.amountSet);
//           totalRestockingFees += feeAmount;
//           restockingFeeItems++;
          
//           console.log(` Restocking fee detected: ${feeAmount} for line item ${lineItem.id}`);
          
//           // Create individual restocking fee event
//           events.push({
//             orderId: order.id,
//             orderName: order.name,
//             eventType: 'restocking_fee',
//             eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//             amount: feeAmount,
//             currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//             description: `Restocking fee for item`,
//             details: { 
//               returnId: returnItem.id, 
//               type: 'restocking_fee', 
//               amount: feeAmount,
//               lineItemId: lineItem.id
//             }
//           });
//         }
//       });

//       // Calculate return shipping fees
//       let totalReturnShippingFees = 0;
//       let returnShippingEvents = 0;
      
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         const shippingAmount = parseMoneyAmount(shippingFee.amountSet);
//         totalReturnShippingFees += shippingAmount;
//         returnShippingEvents++;
        
//         console.log(` Return shipping fee detected: ${shippingAmount}`);
        
//         // Create individual return shipping fee event
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_shipping_fee',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: shippingAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Return shipping fee`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'return_shipping_fee', 
//             amount: shippingAmount
//           }
//         });
//       });

//       // Calculate returned products value
//       let returnedProductsValue = 0;
//       let returnedItemsCount = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         const itemValue = parseMoneyAmount(lineItem.totalPriceSet) || 0;
//         returnedProductsValue += itemValue;
//         returnedItemsCount++;
//       });

//       // Main return event for products
//       if (returnedItemsCount > 0) {
//         console.log(` Product return detected: ${returnedItemsCount} items worth ${returnedProductsValue}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'product_return',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnedProductsValue,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Products returned (${returnedItemsCount} items)`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'product_return',
//             itemsCount: returnedItemsCount,
//             value: -returnedProductsValue
//           }
//         });
//       }

//       // Calculate and add tax impact from returns
//       const returnTaxImpact = parseMoneyAmount(returnItem.totalTaxSet) || 0;
//       if (returnTaxImpact !== 0) {
//         console.log(` Return tax impact detected: ${returnTaxImpact}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_tax',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnTaxImpact,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Tax adjustment from return`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'tax_adjustment',
//             amount: -returnTaxImpact
//           }
//         });
//       }

//       // Summary of what was detected for this return
//       console.log(` Return ${returnItem.id} summary:`, {
//         restockingFees: totalRestockingFees,
//         returnShippingFees: totalReturnShippingFees,
//         returnedProductsValue: returnedProductsValue,
//         taxImpact: returnTaxImpact,
//         totalEventsCreated: events.length
//       });
//     } else {
//       console.log(` Return filtered out: no valid date available`);
//     }
//   });

//   console.log(` Total events created for order ${order.name}: ${events.length}`);
//   return events;
// }









// function detectTaxEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectTaxEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if taxes were modified today
//   if (orderUpdatedDate >= periodStart && orderUpdatedDate <= periodEnd && isTodayInStoreTime(orderUpdatedDate, storeTimezone)) {
//     const originalTax = parseMoneyAmount(order.totalTaxSet) || 0;
//     const currentTax = parseMoneyAmount(order.currentTotalTaxSet) || 0;
//     const taxDifference = currentTax - originalTax;

//     console.log(` Tax check for order ${order.name}:`, {
//       originalTax,
//       currentTax,
//       taxDifference,
//       updatedToday: isTodayInStoreTime(orderUpdatedDate, storeTimezone),
//       orderUpdatedDate: orderUpdatedDate.toISOString()
//     });

//     if (Math.abs(taxDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'tax_adjustment',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: taxDifference,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Tax adjustment applied`,
//         details: { 
//           taxChange: taxDifference, 
//           originalTax, 
//           currentTax,
//           type: 'tax_adjustment'
//         }
//       });
      
//       console.log(` Tax adjustment event created for order ${order.name}: ${taxDifference}`);
//     }
//   }

//   return events;
// }

// function detectModificationEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderCreatedDate = new Date(order.createdAt);
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   if (orderUpdatedDate > orderCreatedDate && isTodayInStoreTime(orderUpdatedDate, storeTimezone) && !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     // Check for significant changes that indicate modifications
//     const originalSubtotal = parseMoneyAmount(order.subtotalPriceSet);
//     const currentSubtotal = parseMoneyAmount(order.currentSubtotalPriceSet);
//     const subtotalDifference = currentSubtotal - originalSubtotal;

//     if (Math.abs(subtotalDifference) > 0.01) {
//       if (subtotalDifference > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_added',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items added to order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_removed',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items removed from order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       }
//     }

//     // Check for discount changes
//     const originalDiscounts = parseMoneyAmount(order.totalDiscountsSet);
//     const currentDiscounts = parseMoneyAmount(order.currentTotalDiscountsSet);
//     const discountDifference = currentDiscounts - originalDiscounts;

//     if (Math.abs(discountDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'discount',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: -discountDifference, // Negative because discount reduces revenue
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Discount modified`,
//         details: { discountChange: discountDifference, originalDiscounts, currentDiscounts }
//       });
//     }
//   }

//   return events;
// }

// // Main function to detect all events for an order
// function detectOrderEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];

//   // Skip orders created today (they're already in today's orders)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     return events;
//   }

//   // Detect all types of events
//   events.push(...detectRefundEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectExchangeEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectReturnEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectModificationEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectTaxEvents(order, periodStart, periodEnd, storeTimezone)); // NEW: Tax events

//   return events;
// }

// // Calculate event summary from events
// function calculateEventSummary(events: OrderEvent[]): EventSummary {
//   const summary: EventSummary = {
//     refunds: { count: 0, value: 0 },
//     exchanges: { count: 0, value: 0 },
//     partialRefunds: { count: 0, value: 0 },
//     modifications: { count: 0, value: 0 },
//     returns: { count: 0, value: 0 },
//     discounts: { count: 0, value: 0 },
//     restockingFees: { count: 0, value: 0 },
//     returnShippingFees: { count: 0, value: 0 },
//     refundShipping: { count: 0, value: 0 },
//     taxAdjustments: { count: 0, value: 0 },
//     refundTaxes: { count: 0, value: 0 }, // NEW: Track refunded taxes
//     totalEvents: events.length,
//     netValue: 0
//   };

//   events.forEach(event => {
//     switch (event.eventType) {
//       case 'refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//       case 'exchange':
//         summary.exchanges.count++;
//         summary.exchanges.value += event.amount;
//         break;
//       case 'partial_refund':
//         summary.partialRefunds.count++;
//         summary.partialRefunds.value += event.amount;
//         break;
//       case 'item_added':
//       case 'item_removed':
//         summary.modifications.count++;
//         summary.modifications.value += event.amount;
//         break;
//       case 'product_return':
//         summary.returns.count++;
//         summary.returns.value += event.amount;
//         break;
//       case 'discount':
//         summary.discounts.count++;
//         summary.discounts.value += event.amount;
//         break;
//       case 'restocking_fee':
//         summary.restockingFees.count++;
//         summary.restockingFees.value += event.amount;
//         break;
//       case 'return_shipping_fee':
//         summary.returnShippingFees.count++;
//         summary.returnShippingFees.value += event.amount;
//         break;
//       case 'refund_shipping':
//         summary.refundShipping.count++;
//         summary.refundShipping.value += event.amount;
//         break;
//       case 'tax_adjustment':
//       case 'return_tax':
//         summary.taxAdjustments.count++;
//         summary.taxAdjustments.value += event.amount;
//         break;
//       case 'refund_tax':
//         summary.refundTaxes.count++;
//         summary.refundTaxes.value += event.amount;
//         break;
//       case 'over_refund':
//       case 'under_refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//     }
//     summary.netValue += event.amount;
//   });

//   return summary;
// }

// // Calculate event order metrics (MIRRORS TODAY'S ORDERS LOGIC)
// function calculateEventOrderMetrics(orderEvents: OrderEvent[]): any[] {
//   // Group events by order
//   const eventsByOrder: { [orderId: string]: OrderEvent[] } = {};
//   orderEvents.forEach(event => {
//     if (!eventsByOrder[event.orderId]) {
//       eventsByOrder[event.orderId] = [];
//     }
//     eventsByOrder[event.orderId].push(event);
//   });

//   // Calculate metrics for each order with events
//   const orderMetrics = Object.entries(eventsByOrder).map(([orderId, events]) => {
//     const firstEvent = events[0];
    
//     // Calculate financial impact from events
//     const grossSalesImpact = events
//       .filter(e => e.eventType === 'item_added')
//       .reduce((sum, e) => sum + Math.max(0, e.amount), 0);
    
//     const returnsImpact = events
//       .filter(e => e.eventType === 'refund' || e.eventType === 'partial_refund' || e.eventType === 'product_return')
//       .reduce((sum, e) => sum + Math.min(0, e.amount), 0);
    
//     const discountsImpact = events
//       .filter(e => e.eventType === 'discount')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const shippingImpact = events
//       .filter(e => e.eventType === 'refund_shipping' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const returnFeesImpact = events
//       .filter(e => e.eventType === 'restocking_fee' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const taxesImpact = events
//       .filter(e => e.eventType === 'tax_adjustment' || e.eventType === 'return_tax' || e.eventType === 'refund_tax')
//       .reduce((sum, e) => sum + e.amount, 0);

//     const netSalesImpact = grossSalesImpact + returnsImpact + discountsImpact;
//     const totalImpact = netSalesImpact + shippingImpact + returnFeesImpact + taxesImpact;

//     return {
//       orderId,
//       orderName: firstEvent.orderName,
//       currencyCode: firstEvent.currencyCode,
//       events,
//       // Core calculated metrics (MIRRORING TODAY'S ORDERS)
//       calculatedGrossSales: grossSalesImpact,
//       calculatedGrossReturns: Math.abs(returnsImpact),
//       calculatedNetReturns: Math.abs(returnsImpact),
//       calculatedRefundedShipping: events.filter(e => e.eventType === 'refund_shipping').reduce((sum, e) => sum + Math.abs(e.amount), 0),
//       calculatedReturnShippingFees: events.filter(e => e.eventType === 'return_shipping_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedNetSales: netSalesImpact,
//       calculatedRefundDiscrepancy: events.filter(e => e.eventType === 'over_refund' || e.eventType === 'under_refund').reduce((sum, e) => sum + e.amount, 0),
//       calculatedRestockingFees: events.filter(e => e.eventType === 'restocking_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedReturnFees: returnFeesImpact,
//       calculatedShippingCharges: shippingImpact,
//       calculatedTaxes: taxesImpact,
//       calculatedTotalSales: totalImpact,
      
//       // Flags (MIRRORING TODAY'S ORDERS)
//       hasOverRefund: events.some(e => e.eventType === 'over_refund'),
//       hasUnderRefund: events.some(e => e.eventType === 'under_refund'),
//       eventTypes: [...new Set(events.map(e => e.eventType))]
//     };
//   });

//   return orderMetrics;
// }

// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// function calculateEventFinancialMetrics(orderMetrics: any[]): any {
//   const totalGrossSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orderMetrics.reduce((sum: number, order: any) => {
//     const discountEvents = order.events.filter((e: OrderEvent) => e.eventType === 'discount');
//     return sum + discountEvents.reduce((discountSum: number, e: OrderEvent) => discountSum + Math.abs(e.amount), 0);
//   }, 0);

//   const totalNetReturns = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   const totalReturnFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedTaxes || 0);
//   }, 0);

//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orderMetrics.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   const totalRestockingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orderMetrics[0]?.currencyCode || 'USD'
//   };
// }

// // Add this function RIGHT AFTER your calculateEventSummary function

// // Debug function to log all event details
// function debugEventDetection(events: OrderEvent[], eventSummary: EventSummary) {
//   console.log('=== EVENT DETECTION DEBUG ===');
//   console.log(`Total events detected: ${events.length}`);
//   console.log(`Orders with events: ${new Set(events.map(e => e.orderId)).size}`);
  
//   // Log event type breakdown
//   const eventTypeCount: Record<string, number> = {};
//   events.forEach(event => {
//     eventTypeCount[event.eventType] = (eventTypeCount[event.eventType] || 0) + 1;
//   });
  
//   console.log('Event type breakdown:', eventTypeCount);
  
//   // Log financial summary
//   console.log('Financial Summary:', {
//     totalEvents: eventSummary.totalEvents,
//     netValue: eventSummary.netValue,
//     refunds: eventSummary.refunds,
//     exchanges: eventSummary.exchanges,
//     partialRefunds: eventSummary.partialRefunds,
//     modifications: eventSummary.modifications,
//     returns: eventSummary.returns,
//     discounts: eventSummary.discounts,
//     restockingFees: eventSummary.restockingFees,
//     returnShippingFees: eventSummary.returnShippingFees,
//     refundShipping: eventSummary.refundShipping,
//     taxAdjustments: eventSummary.taxAdjustments
//   });
  
//   // Log detailed events for first 5 orders (to avoid console spam)
//   const uniqueOrderIds = [...new Set(events.map(e => e.orderId))].slice(0, 5);
//   uniqueOrderIds.forEach(orderId => {
//     const orderEvents = events.filter(e => e.orderId === orderId);
//     console.log(`Order ${orderId} events:`, orderEvents);
//   });
  
//   console.log('=== END EVENT DEBUG ===');
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   debugReturnData(allOrders);

//   // EVENT DETECTION FOR PAST ORDERS
//   const periodStart = new Date(sevenMonthsAgoUTC);
//   const periodEnd = new Date(nowUTC);
  
//   const pastOrderEvents: OrderEvent[] = [];
//   const ordersWithEvents = new Set<string>();

//   allOrders.forEach((order: any) => {
//     const events = detectOrderEvents(order, periodStart, periodEnd, storeTimezone);
//     if (events.length > 0) {
//       pastOrderEvents.push(...events);
//       ordersWithEvents.add(order.id);
//     }
//   });

//   const eventSummary = calculateEventSummary(pastOrderEvents);

//   console.log(`Event detection: Found ${pastOrderEvents.length} events across ${ordersWithEvents.size} past orders`);


//   // NEW: Calculate event metrics that mirror today's orders
// const eventOrderMetrics = calculateEventOrderMetrics(pastOrderEvents);
// const eventFinancialMetrics = calculateEventFinancialMetrics(eventOrderMetrics);


// debugEventDetection(pastOrderEvents, eventSummary);


//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     // NEW: Event detection data
//     events: {
//       pastOrderEvents,
//       eventSummary,
//       ordersWithEventsCount: ordersWithEvents.size,
//       totalEventsCount: pastOrderEvents.length,
//        eventOrderMetrics,
//     eventFinancialMetrics
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Helper function for event type colors
// function getEventTypeColor(eventType: string): string {
//   const colors: { [key: string]: string } = {
//     refund: '#F44336',
//     exchange: '#2196F3',
//     partial_refund: '#FF9800',
//     modification: '#9C27B0',
//     return: '#795548',
//     discount: '#607D8B',
//     item_added: '#4CAF50',
//     item_removed: '#F44336'
//   };
//   return colors[eventType] || '#666';
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug, events } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>

//       {/* EVENT DETECTION SECTION - NEW */}
    

// {/* EVENT DETECTION SECTION - ENHANCED */}
// <div style={{ marginBottom: 40, marginTop: 40 }}>
//   <h2 style={{ borderBottom: '2px solid #FF9800', paddingBottom: 8, color: '#FF9800' }}>
//     Today's Activity on Past Orders ({events.ordersWithEventsCount} orders with activity)
//   </h2>
  
//   {events.totalEventsCount === 0 ? (
//     <div style={{ 
//       textAlign: 'center', 
//       padding: '40px', 
//       backgroundColor: '#fff3cd', 
//       borderRadius: 8,
//       border: '1px solid #ffeaa7'
//     }}>
//       <h3 style={{ color: '#856404', marginBottom: 10 }}>No Activity Detected</h3>
//       <p style={{ color: '#856404' }}>No modifications, refunds, or returns detected on past orders today.</p>
//     </div>
//   ) : (
//     <>
//       {/* Event Financial Summary - NEW */}
     

// {/* Event Financial Summary - Show only what we detect */}
// <div style={{ 
//   display: 'grid', 
//   gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//   gap: 16, 
//   marginBottom: 20,
//   padding: 16,
//   backgroundColor: '#fff3cd',
//   borderRadius: 8
// }}>
//   <MetricCard title="Total Events" value={events.eventSummary.totalEvents} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Net Value Impact" value={events.eventSummary.netValue} currency={summaries.regular.currencyCode} color="#FF9800" />
//   <MetricCard title="Orders Affected" value={events.ordersWithEventsCount} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Refunds" value={events.eventSummary.refunds.value} currency={summaries.regular.currencyCode} color="#F44336" />
//   <MetricCard title="Exchanges" value={events.eventSummary.exchanges.value} currency={summaries.regular.currencyCode} color="#2196F3" />
//   <MetricCard title="Modifications" value={events.eventSummary.modifications.value} currency={summaries.regular.currencyCode} color="#9C27B0" />
//   <MetricCard title="Returns" value={events.eventSummary.returns.count} currency="" color="#795548" isCount={true} />
//   <MetricCard title="Discounts" value={events.eventSummary.discounts.value} currency={summaries.regular.currencyCode} color="#607D8B" />
// </div>

// {/* Return Events Breakdown - Show actual detected return events */}
// {events.eventSummary.returns.count > 0 && (
//   <div style={{ 
//     marginBottom: 20,
//     padding: 16,
//     backgroundColor: '#f3e5f5',
//     borderRadius: 8,
//     border: '1px solid #e1bee7'
//   }}>
//     <h4 style={{ marginBottom: 12, color: '#7b1fa2' }}>Return Events Detected</h4>
    
//     {/* Calculate actual return fees from events */}
//     {(() => {
//       const returnEvents = events.pastOrderEvents.filter(event => event.eventType === 'return');
//       const restockingFees = returnEvents
//         .filter(event => event.details?.type === 'restocking_fee')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const returnShippingFees = returnEvents
//         .filter(event => event.details?.type === 'return_shipping')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const productReturns = returnEvents
//         .filter(event => event.details?.type === 'product_return')
//         .length;

//       return (
//         <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12 }}>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Restocking Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {restockingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'restocking_fee').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Return Shipping</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {returnShippingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'return_shipping').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Product Returns</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#f44336' }}>
//               {productReturns} returns
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Items returned to inventory
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Total Return Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#4CAF50' }}>
//               {summaries.regular.currencyCode} {(restockingFees + returnShippingFees).toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Combined fees
//             </div>
//           </div>
//         </div>
//       );
//     })()}
//   </div>
// )}

// {/* Enhanced Order Details with Return Fee Breakdown */}
// {Array.from(new Set(events.pastOrderEvents.map(event => event.orderId))).map(orderId => {
//   const orderEvents = events.pastOrderEvents.filter(event => event.orderId === orderId);
//   const firstEvent = orderEvents[0];
  
//   // Calculate financial impact for this order
//   const totalImpact = orderEvents.reduce((sum, event) => sum + event.amount, 0);
  
//   // Calculate return fee breakdown for this order
//   const orderReturnEvents = orderEvents.filter(event => event.eventType === 'return');
//   const orderRestockingFees = orderReturnEvents
//     .filter(event => event.details?.type === 'restocking_fee')
//     .reduce((sum, event) => sum + event.amount, 0);
  
//   const orderReturnShipping = orderReturnEvents
//     .filter(event => event.details?.type === 'return_shipping')
//     .reduce((sum, event) => sum + event.amount, 0);

//   return (
//     <details key={orderId} style={{ marginBottom: 15, border: '1px solid #ddd', borderRadius: 8 }}>
//       <summary style={{ 
//         cursor: 'pointer', 
//         padding: '16px', 
//         backgroundColor: '#f8f9fa',
//         fontWeight: 'bold',
//         fontSize: '16px'
//       }}>
//         <strong>{firstEvent.orderName}</strong>
//         <span style={{ float: 'right', fontWeight: 'normal' }}>
//           Impact: 
//           <strong style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', marginLeft: '8px' }}>
//             {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//           </strong>
//           <span style={{ marginLeft: '16px', color: '#666' }}>
//             {orderEvents.length} event{orderEvents.length > 1 ? 's' : ''}
//           </span>
//         </span>
//       </summary>
      
//       <div style={{ padding: '16px', backgroundColor: 'white' }}>
//         {/* Event List */}
//         <div style={{ marginBottom: '16px' }}>
//           <h4 style={{ marginBottom: '8px', color: '#333' }}>Event Details:</h4>
//           {orderEvents.map((event, index) => (
//             <div key={index} style={{ 
//               padding: '8px', 
//               marginBottom: '8px', 
//               backgroundColor: '#f5f5f5',
//               borderRadius: '4px',
//               borderLeft: `4px solid ${getEventTypeColor(event.eventType)}`
//             }}>
//               <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
//                 <div>
//                   <span style={{
//                     padding: '2px 6px',
//                     borderRadius: '4px',
//                     fontSize: '0.7em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white',
//                     marginRight: '8px'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                   {event.amount !== 0 && (
//                     <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                       {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                     </strong>
//                   )}
//                   <span style={{ marginLeft: '8px' }}>{event.description}</span>
//                 </div>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </div>
//               </div>
//               {event.details && (
//                 <div style={{ fontSize: '0.7em', color: '#666', marginTop: '4px' }}>
//                   {Object.entries(event.details).map(([key, value]) => (
//                     <span key={key} style={{ marginRight: '8px' }}>
//                       {key}: {String(value)}
//                     </span>
//                   ))}
//                 </div>
//               )}
//             </div>
//           ))}
//         </div>

//         {/* Financial Summary */}
//         {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//           <div style={{ 
//             padding: '12px', 
//             backgroundColor: '#e8f5e8', 
//             borderRadius: '4px',
//             border: '1px solid #4CAF50',
//             marginBottom: '12px'
//           }}>
//             <h4 style={{ marginBottom: '8px', color: '#2e7d32' }}>Return Fees Summary:</h4>
//             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '8px' }}>
//               {orderRestockingFees > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Restocking Fees</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderRestockingFees.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {orderReturnShipping > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Return Shipping</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderReturnShipping.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Total Return Fees</div>
//                   <div style={{ color: '#4CAF50', fontWeight: 'bold' }}>
//                     +{(orderRestockingFees + orderReturnShipping).toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//             </div>
//           </div>
//         )}
//       </div>
//     </details>
//   );
// })}
     

//       {/* Event Details Table (Original) */}
//       <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//         <div style={{ padding: '12px', backgroundColor: '#f5f5f5', borderBottom: '1px solid #ddd' }}>
//           <h4 style={{ margin: 0, color: '#333' }}>All Events Timeline</h4>
//         </div>
//         <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//           <thead style={{ backgroundColor: '#f8f9fa' }}>
//             <tr>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Event Type</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Description</th>
//             </tr>
//           </thead>
//           <tbody>
//             {events.pastOrderEvents.map((event: OrderEvent, index: number) => (
//               <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
//                 <td style={{ padding: '12px' }}>
//                   <strong>{event.orderName}</strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <span style={{
//                     padding: '4px 8px',
//                     borderRadius: '4px',
//                     fontSize: '0.8em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                     {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                   </strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {event.description}
//                   {event.details && (
//                     <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                       {JSON.stringify(event.details)}
//                     </div>
//                   )}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </>
//   )}
// </div>
//     </div>
//   );
// }






































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import type { EventSummary, OrderEvent, EventDetectionData } from "../types/analytics";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }





// // Add this function right before your event detection loop
// function debugReturnData(orders: any[]) {
//   console.log('=== RETURN DATA DEBUG ===');
  
//   orders.forEach((order: any) => {
//     const returns = order.returns?.nodes || [];
//     if (returns.length > 0) {
//       console.log(`Order ${order.name} has ${returns.length} returns:`, {
//         orderId: order.id,
//         returns: returns.map((ret: any) => ({
//           id: ret.id,
//           createdAt: ret.createdAt,
//           hasRestockingFees: ret.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//           hasReturnShipping: ret.returnShippingFees?.length > 0,
//           hasTaxData: !!ret.totalTaxSet,
//           lineItems: ret.returnLineItems?.nodes?.map((li: any) => ({
//             hasRestockingFee: !!li.restockingFee,
//             restockingFeeAmount: li.restockingFee?.amountSet?.shopMoney?.amount,
//             totalPrice: li.totalPriceSet?.shopMoney?.amount
//           }))
//         }))
//       });
//     }
//   });
  
//   console.log('=== END RETURN DATA DEBUG ===');
// }

// // EVENT DETECTION FUNCTIONS
// function parseMoneyAmount(moneySet: any): number {
//   if (!moneySet || !moneySet.shopMoney || !moneySet.shopMoney.amount) {
//     return 0;
//   }
//   return parseFloat(moneySet.shopMoney.amount) || 0;
// }

// function detectRefundEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderRefunds = order.refunds || [];

//   orderRefunds.forEach((refund: any) => {
//     const refundDate = new Date(refund.createdAt);
    
//     if (refundDate >= periodStart && refundDate <= periodEnd && isTodayInStoreTime(refundDate, storeTimezone)) {
//       const refundAmount = parseMoneyAmount(refund.totalRefundedSet);
//       const totalOrderAmount = parseMoneyAmount(order.currentTotalPriceSet);
//       const isFullRefund = Math.abs(refundAmount - totalOrderAmount) < 0.01;

//       // Calculate refunded shipping from this refund
//       const refundedShipping = parseMoneyAmount(refund.shipping) || 0;
      
//       // Calculate refunded taxes
//       const refundedTaxes = refund.refundLineItems?.edges?.reduce((sum: number, edge: any) => {
//         return sum + parseMoneyAmount(edge.node.totalTaxSet);
//       }, 0) || 0;
      
//       // Calculate refund discrepancy if any
//       const refundDiscrepancy = parseMoneyAmount(order.refundDiscrepancySet) || 0;

//       if (isFullRefund) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Full refund processed`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy,
//             isFullRefund: true
//           }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'partial_refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Partial refund: ${refundAmount.toFixed(2)}`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note, 
//             refundLineItems: refund.refundLineItems,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy
//           }
//         });
//       }

//       // Add separate event for refunded shipping if any
//       if (refundedShipping > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_shipping',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedShipping,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded shipping`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_shipping',
//             amount: -refundedShipping
//           }
//         });
//       }

//       // Add separate event for refunded taxes if any
//       if (refundedTaxes > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_tax',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedTaxes,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded taxes`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_tax',
//             amount: -refundedTaxes
//           }
//         });
//       }

//       // Add event for refund discrepancy if any
//       if (Math.abs(refundDiscrepancy) > 0.01) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: refundDiscrepancy > 0 ? 'over_refund' : 'under_refund',
//           eventDate: refundDate.toISOString(),
//           amount: refundDiscrepancy > 0 ? -Math.abs(refundDiscrepancy) : Math.abs(refundDiscrepancy),
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: refundDiscrepancy > 0 ? 'Over refund discrepancy' : 'Under refund discrepancy',
//           details: { 
//             refundId: refund.id,
//             type: 'refund_discrepancy',
//             amount: refundDiscrepancy
//           }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectExchangeEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectExchangeEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
  
//   // Check for exchanges in returns data - SAME LOGIC AS TODAY'S ORDERS
//   const returns = order.returns?.nodes || [];
  
//   console.log(` Order ${order.name} has ${returns.length} returns for exchange detection`);
  
//   returns.forEach((returnItem: any, index: number) => {
//     // Use the same date handling as detectReturnEvents
//     let returnDate: Date | null = null;
//     let isValidDate = false;
    
//     try {
//       if (returnItem.createdAt) {
//         returnDate = new Date(returnItem.createdAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       }
//     } catch (error) {
//       console.log(` Invalid date for return in exchange detection:`, returnItem.createdAt);
//       isValidDate = false;
//     }
    
//     // If no valid date, use order updated date as fallback
//     if (!isValidDate) {
//       try {
//         returnDate = new Date(order.updatedAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       } catch (error) {
//         console.log(` No valid date available for exchange detection`);
//         return;
//       }
//     }

//     // Add null check here
//     if (!returnDate) {
//       console.log(` No return date available for exchange detection`);
//       return;
//     }

//     const isInPeriod = returnDate >= periodStart && returnDate <= periodEnd;
//     const isToday = isTodayInStoreTime(returnDate, storeTimezone);
    
//     console.log(` Exchange date check for ${order.name}:`, {
//       returnDate: returnDate.toISOString(),
//       isInPeriod,
//       isToday,
//       storeTimezone
//     });

//     // Check if this return represents an exchange (you might need to adjust this condition)
//     // Look for returns that have specific characteristics of exchanges
//     const mightBeExchange = returnItem.returnLineItems?.nodes?.length > 0 && 
//                            returnItem.status !== 'cancelled'; // Adjust based on your exchange patterns
    
//     if (isInPeriod && isToday && mightBeExchange) {
//       console.log(` Processing potential exchange for order ${order.name}`);
      
//       // Calculate return value from return line items
//       let returnValue = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         returnValue += parseMoneyAmount(lineItem.totalPriceSet) || 0;
//       });

//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'exchange',
//         eventDate: returnDate.toISOString(),
//         amount: -returnValue,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Exchange processed`,
//         details: { returnId: returnItem.id, status: returnItem.status, returnValue }
//       });
//     } else {
//       console.log(` Exchange filtered out for ${order.name}:`, {
//         reason: !isInPeriod ? 'Not in period' : !isToday ? 'Not today' : !mightBeExchange ? 'Not exchange pattern' : 'Unknown',
//         returnDate: returnDate.toISOString()
//       });
//     }
//   });

//   console.log(` Total exchange events created for order ${order.name}: ${events.length}`);
//   return events;
// }






// function detectReturnEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectReturnEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const returns = order.returns?.nodes || [];
  
//   console.log(` Order ${order.name} has ${returns.length} returns`);
  
//   returns.forEach((returnItem: any, index: number) => {
//     // Validate and safely parse the return date
//     let returnDate: Date | null = null;
//     let isValidDate = false;
    
//     try {
//       if (returnItem.createdAt) {
//         returnDate = new Date(returnItem.createdAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       }
//     } catch (error) {
//       console.log(` Invalid date for return:`, returnItem.createdAt);
//       isValidDate = false;
//     }
    
//     // If no valid date, use order updated date as fallback
//     if (!isValidDate) {
//       try {
//         returnDate = new Date(order.updatedAt);
//         isValidDate = !isNaN(returnDate.getTime());
//         console.log(` Using order updated date as fallback for return: ${returnDate.toISOString()}`);
//       } catch (error) {
//         console.log(` No valid date available for return`);
//         return; // Skip this return if no valid date
//       }
//     }
    
//     console.log(`Return ${index + 1}:`, {
//       id: returnItem.id,
//       createdAt: returnItem.createdAt,
//       returnDate: returnDate?.toISOString(),
//       status: returnItem.status,
//       hasRestockingFees: returnItem.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//       hasReturnShipping: returnItem.returnShippingFees?.length > 0,
//       restockingFees: returnItem.returnLineItems?.nodes?.map((li: any) => ({
//         hasFee: !!li.restockingFee,
//         amount: li.restockingFee?.amountSet?.shopMoney?.amount
//       })),
//       returnShippingFees: returnItem.returnShippingFees?.map((fee: any) => ({
//         amount: fee?.amountSet?.shopMoney?.amount
//       }))
//     });
    
//     // TEMPORARY: Remove date filtering for debugging (but keep date validation)
//     if (true && returnDate) { // Ensure returnDate exists
//       console.log(` Processing return for order ${order.name} (date filtering disabled)`);
      
//       // Calculate restocking fees
//       let totalRestockingFees = 0;
//       let restockingFeeItems = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee) {
//           const feeAmount = parseMoneyAmount(lineItem.restockingFee.amountSet);
//           totalRestockingFees += feeAmount;
//           restockingFeeItems++;
          
//           console.log(` Restocking fee detected: ${feeAmount} for line item ${lineItem.id}`);
          
//           // Create individual restocking fee event
//           events.push({
//             orderId: order.id,
//             orderName: order.name,
//             eventType: 'restocking_fee',
//             eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//             amount: feeAmount,
//             currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//             description: `Restocking fee for item`,
//             details: { 
//               returnId: returnItem.id, 
//               type: 'restocking_fee', 
//               amount: feeAmount,
//               lineItemId: lineItem.id
//             }
//           });
//         }
//       });

//       // Calculate return shipping fees
//       let totalReturnShippingFees = 0;
//       let returnShippingEvents = 0;
      
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         const shippingAmount = parseMoneyAmount(shippingFee.amountSet);
//         totalReturnShippingFees += shippingAmount;
//         returnShippingEvents++;
        
//         console.log(` Return shipping fee detected: ${shippingAmount}`);
        
//         // Create individual return shipping fee event
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_shipping_fee',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: shippingAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Return shipping fee`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'return_shipping_fee', 
//             amount: shippingAmount
//           }
//         });
//       });

//       // Calculate returned products value
//       let returnedProductsValue = 0;
//       let returnedItemsCount = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         const itemValue = parseMoneyAmount(lineItem.totalPriceSet) || 0;
//         returnedProductsValue += itemValue;
//         returnedItemsCount++;
//       });

//       // Main return event for products
//       if (returnedItemsCount > 0) {
//         console.log(` Product return detected: ${returnedItemsCount} items worth ${returnedProductsValue}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'product_return',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnedProductsValue,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Products returned (${returnedItemsCount} items)`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'product_return',
//             itemsCount: returnedItemsCount,
//             value: -returnedProductsValue
//           }
//         });
//       }

//       // Calculate and add tax impact from returns
//       const returnTaxImpact = parseMoneyAmount(returnItem.totalTaxSet) || 0;
//       if (returnTaxImpact !== 0) {
//         console.log(` Return tax impact detected: ${returnTaxImpact}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_tax',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnTaxImpact,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Tax adjustment from return`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'tax_adjustment',
//             amount: -returnTaxImpact
//           }
//         });
//       }

//       // Summary of what was detected for this return
//       console.log(` Return ${returnItem.id} summary:`, {
//         restockingFees: totalRestockingFees,
//         returnShippingFees: totalReturnShippingFees,
//         returnedProductsValue: returnedProductsValue,
//         taxImpact: returnTaxImpact,
//         totalEventsCreated: events.length
//       });
//     } else {
//       console.log(` Return filtered out: no valid date available`);
//     }
//   });

//   console.log(` Total events created for order ${order.name}: ${events.length}`);
//   return events;
// }









// function detectTaxEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectTaxEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if taxes were modified today
//   if (orderUpdatedDate >= periodStart && orderUpdatedDate <= periodEnd && isTodayInStoreTime(orderUpdatedDate, storeTimezone)) {
//     const originalTax = parseMoneyAmount(order.totalTaxSet) || 0;
//     const currentTax = parseMoneyAmount(order.currentTotalTaxSet) || 0;
//     const taxDifference = currentTax - originalTax;

//     console.log(` Tax check for order ${order.name}:`, {
//       originalTax,
//       currentTax,
//       taxDifference,
//       updatedToday: isTodayInStoreTime(orderUpdatedDate, storeTimezone),
//       orderUpdatedDate: orderUpdatedDate.toISOString()
//     });

//     if (Math.abs(taxDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'tax_adjustment',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: taxDifference,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Tax adjustment applied`,
//         details: { 
//           taxChange: taxDifference, 
//           originalTax, 
//           currentTax,
//           type: 'tax_adjustment'
//         }
//       });
      
//       console.log(` Tax adjustment event created for order ${order.name}: ${taxDifference}`);
//     }
//   }

//   return events;
// }

// function detectModificationEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderCreatedDate = new Date(order.createdAt);
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   if (orderUpdatedDate > orderCreatedDate && isTodayInStoreTime(orderUpdatedDate, storeTimezone) && !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     // Check for significant changes that indicate modifications
//     const originalSubtotal = parseMoneyAmount(order.subtotalPriceSet);
//     const currentSubtotal = parseMoneyAmount(order.currentSubtotalPriceSet);
//     const subtotalDifference = currentSubtotal - originalSubtotal;

//     if (Math.abs(subtotalDifference) > 0.01) {
//       if (subtotalDifference > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_added',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items added to order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_removed',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items removed from order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       }
//     }

//     // Check for discount changes
//     const originalDiscounts = parseMoneyAmount(order.totalDiscountsSet);
//     const currentDiscounts = parseMoneyAmount(order.currentTotalDiscountsSet);
//     const discountDifference = currentDiscounts - originalDiscounts;

//     if (Math.abs(discountDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'discount',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: -discountDifference, // Negative because discount reduces revenue
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Discount modified`,
//         details: { discountChange: discountDifference, originalDiscounts, currentDiscounts }
//       });
//     }
//   }

//   return events;
// }

// // Main function to detect all events for an order
// function detectOrderEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];

//   // Skip orders created today (they're already in today's orders)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     return events;
//   }

//   // Detect all types of events
//   events.push(...detectRefundEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectExchangeEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectReturnEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectModificationEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectTaxEvents(order, periodStart, periodEnd, storeTimezone)); // NEW: Tax events

//   return events;
// }

// // Calculate event summary from events
// function calculateEventSummary(events: OrderEvent[]): EventSummary {
//   const summary: EventSummary = {
//     refunds: { count: 0, value: 0 },
//     exchanges: { count: 0, value: 0 },
//     partialRefunds: { count: 0, value: 0 },
//     modifications: { count: 0, value: 0 },
//     returns: { count: 0, value: 0 },
//     discounts: { count: 0, value: 0 },
//     restockingFees: { count: 0, value: 0 },
//     returnShippingFees: { count: 0, value: 0 },
//     refundShipping: { count: 0, value: 0 },
//     taxAdjustments: { count: 0, value: 0 },
//     refundTaxes: { count: 0, value: 0 }, // NEW: Track refunded taxes
//     totalEvents: events.length,
//     netValue: 0
//   };

//   events.forEach(event => {
//     switch (event.eventType) {
//       case 'refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//       case 'exchange':
//         summary.exchanges.count++;
//         summary.exchanges.value += event.amount;
//         break;
//       case 'partial_refund':
//         summary.partialRefunds.count++;
//         summary.partialRefunds.value += event.amount;
//         break;
//       case 'item_added':
//       case 'item_removed':
//         summary.modifications.count++;
//         summary.modifications.value += event.amount;
//         break;
//       case 'product_return':
//         summary.returns.count++;
//         summary.returns.value += event.amount;
//         break;
//       case 'discount':
//         summary.discounts.count++;
//         summary.discounts.value += event.amount;
//         break;
//       case 'restocking_fee':
//         summary.restockingFees.count++;
//         summary.restockingFees.value += event.amount;
//         break;
//       case 'return_shipping_fee':
//         summary.returnShippingFees.count++;
//         summary.returnShippingFees.value += event.amount;
//         break;
//       case 'refund_shipping':
//         summary.refundShipping.count++;
//         summary.refundShipping.value += event.amount;
//         break;
//       case 'tax_adjustment':
//       case 'return_tax':
//         summary.taxAdjustments.count++;
//         summary.taxAdjustments.value += event.amount;
//         break;
//       case 'refund_tax':
//         summary.refundTaxes.count++;
//         summary.refundTaxes.value += event.amount;
//         break;
//       case 'over_refund':
//       case 'under_refund':
//         summary.refunds.count++;
//         summary.refunds.value += event.amount;
//         break;
//     }
//     summary.netValue += event.amount;
//   });

//   return summary;
// }

// // Calculate event order metrics (MIRRORS TODAY'S ORDERS LOGIC)
// function calculateEventOrderMetrics(orderEvents: OrderEvent[]): any[] {
//   // Group events by order
//   const eventsByOrder: { [orderId: string]: OrderEvent[] } = {};
//   orderEvents.forEach(event => {
//     if (!eventsByOrder[event.orderId]) {
//       eventsByOrder[event.orderId] = [];
//     }
//     eventsByOrder[event.orderId].push(event);
//   });

//   // Calculate metrics for each order with events
//   const orderMetrics = Object.entries(eventsByOrder).map(([orderId, events]) => {
//     const firstEvent = events[0];
    
//     // Calculate financial impact from events
//     const grossSalesImpact = events
//       .filter(e => e.eventType === 'item_added')
//       .reduce((sum, e) => sum + Math.max(0, e.amount), 0);
    
//     const returnsImpact = events
//       .filter(e => e.eventType === 'refund' || e.eventType === 'partial_refund' || e.eventType === 'product_return')
//       .reduce((sum, e) => sum + Math.min(0, e.amount), 0);
    
//     const discountsImpact = events
//       .filter(e => e.eventType === 'discount')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const shippingImpact = events
//       .filter(e => e.eventType === 'refund_shipping' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const returnFeesImpact = events
//       .filter(e => e.eventType === 'restocking_fee' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const taxesImpact = events
//       .filter(e => e.eventType === 'tax_adjustment' || e.eventType === 'return_tax' || e.eventType === 'refund_tax')
//       .reduce((sum, e) => sum + e.amount, 0);

//     const netSalesImpact = grossSalesImpact + returnsImpact + discountsImpact;
//     const totalImpact = netSalesImpact + shippingImpact + returnFeesImpact + taxesImpact;

//     return {
//       orderId,
//       orderName: firstEvent.orderName,
//       currencyCode: firstEvent.currencyCode,
//       events,
//       // Core calculated metrics (MIRRORING TODAY'S ORDERS)
//       calculatedGrossSales: grossSalesImpact,
//       calculatedGrossReturns: Math.abs(returnsImpact),
//       calculatedNetReturns: Math.abs(returnsImpact),
//       calculatedRefundedShipping: events.filter(e => e.eventType === 'refund_shipping').reduce((sum, e) => sum + Math.abs(e.amount), 0),
//       calculatedReturnShippingFees: events.filter(e => e.eventType === 'return_shipping_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedNetSales: netSalesImpact,
//       calculatedRefundDiscrepancy: events.filter(e => e.eventType === 'over_refund' || e.eventType === 'under_refund').reduce((sum, e) => sum + e.amount, 0),
//       calculatedRestockingFees: events.filter(e => e.eventType === 'restocking_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedReturnFees: returnFeesImpact,
//       calculatedShippingCharges: shippingImpact,
//       calculatedTaxes: taxesImpact,
//       calculatedTotalSales: totalImpact,
      
//       // Flags (MIRRORING TODAY'S ORDERS)
//       hasOverRefund: events.some(e => e.eventType === 'over_refund'),
//       hasUnderRefund: events.some(e => e.eventType === 'under_refund'),
//       eventTypes: [...new Set(events.map(e => e.eventType))]
//     };
//   });

//   return orderMetrics;
// }

// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// function calculateEventFinancialMetrics(orderMetrics: any[]): any {
//   const totalGrossSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orderMetrics.reduce((sum: number, order: any) => {
//     const discountEvents = order.events.filter((e: OrderEvent) => e.eventType === 'discount');
//     return sum + discountEvents.reduce((discountSum: number, e: OrderEvent) => discountSum + Math.abs(e.amount), 0);
//   }, 0);

//   const totalNetReturns = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   const totalReturnFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedTaxes || 0);
//   }, 0);

//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orderMetrics.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   const totalRestockingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orderMetrics[0]?.currencyCode || 'USD'
//   };
// }

// // Add this function RIGHT AFTER your calculateEventSummary function

// // Debug function to log all event details
// function debugEventDetection(events: OrderEvent[], eventSummary: EventSummary) {
//   console.log('=== EVENT DETECTION DEBUG ===');
//   console.log(`Total events detected: ${events.length}`);
//   console.log(`Orders with events: ${new Set(events.map(e => e.orderId)).size}`);
  
//   // Log event type breakdown
//   const eventTypeCount: Record<string, number> = {};
//   events.forEach(event => {
//     eventTypeCount[event.eventType] = (eventTypeCount[event.eventType] || 0) + 1;
//   });
  
//   console.log('Event type breakdown:', eventTypeCount);
  
//   // Log financial summary
//   console.log('Financial Summary:', {
//     totalEvents: eventSummary.totalEvents,
//     netValue: eventSummary.netValue,
//     refunds: eventSummary.refunds,
//     exchanges: eventSummary.exchanges,
//     partialRefunds: eventSummary.partialRefunds,
//     modifications: eventSummary.modifications,
//     returns: eventSummary.returns,
//     discounts: eventSummary.discounts,
//     restockingFees: eventSummary.restockingFees,
//     returnShippingFees: eventSummary.returnShippingFees,
//     refundShipping: eventSummary.refundShipping,
//     taxAdjustments: eventSummary.taxAdjustments
//   });
  
//   // Log detailed events for first 5 orders (to avoid console spam)
//   const uniqueOrderIds = [...new Set(events.map(e => e.orderId))].slice(0, 5);
//   uniqueOrderIds.forEach(orderId => {
//     const orderEvents = events.filter(e => e.orderId === orderId);
//     console.log(`Order ${orderId} events:`, orderEvents);
//   });
  
//   console.log('=== END EVENT DEBUG ===');
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   debugReturnData(allOrders);

//   // EVENT DETECTION FOR PAST ORDERS
//   const periodStart = new Date(sevenMonthsAgoUTC);
//   const periodEnd = new Date(nowUTC);
  
//   const pastOrderEvents: OrderEvent[] = [];
//   const ordersWithEvents = new Set<string>();

//   allOrders.forEach((order: any) => {
//     const events = detectOrderEvents(order, periodStart, periodEnd, storeTimezone);
//     if (events.length > 0) {
//       pastOrderEvents.push(...events);
//       ordersWithEvents.add(order.id);
//     }
//   });

//   const eventSummary = calculateEventSummary(pastOrderEvents);

//   console.log(`Event detection: Found ${pastOrderEvents.length} events across ${ordersWithEvents.size} past orders`);


//   // NEW: Calculate event metrics that mirror today's orders
// const eventOrderMetrics = calculateEventOrderMetrics(pastOrderEvents);
// const eventFinancialMetrics = calculateEventFinancialMetrics(eventOrderMetrics);


// debugEventDetection(pastOrderEvents, eventSummary);


//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     // NEW: Event detection data
//     events: {
//       pastOrderEvents,
//       eventSummary,
//       ordersWithEventsCount: ordersWithEvents.size,
//       totalEventsCount: pastOrderEvents.length,
//        eventOrderMetrics,
//     eventFinancialMetrics
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Helper function for event type colors
// function getEventTypeColor(eventType: string): string {
//   const colors: { [key: string]: string } = {
//     refund: '#F44336',
//     exchange: '#2196F3',
//     partial_refund: '#FF9800',
//     modification: '#9C27B0',
//     return: '#795548',
//     discount: '#607D8B',
//     item_added: '#4CAF50',
//     item_removed: '#F44336'
//   };
//   return colors[eventType] || '#666';
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug, events } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>

//       {/* EVENT DETECTION SECTION - NEW */}
    

// {/* EVENT DETECTION SECTION - ENHANCED */}
// <div style={{ marginBottom: 40, marginTop: 40 }}>
//   <h2 style={{ borderBottom: '2px solid #FF9800', paddingBottom: 8, color: '#FF9800' }}>
//     Today's Activity on Past Orders ({events.ordersWithEventsCount} orders with activity)
//   </h2>
  
//   {events.totalEventsCount === 0 ? (
//     <div style={{ 
//       textAlign: 'center', 
//       padding: '40px', 
//       backgroundColor: '#fff3cd', 
//       borderRadius: 8,
//       border: '1px solid #ffeaa7'
//     }}>
//       <h3 style={{ color: '#856404', marginBottom: 10 }}>No Activity Detected</h3>
//       <p style={{ color: '#856404' }}>No modifications, refunds, or returns detected on past orders today.</p>
//     </div>
//   ) : (
//     <>
//       {/* Event Financial Summary - NEW */}
     

// {/* Event Financial Summary - Show only what we detect */}
// <div style={{ 
//   display: 'grid', 
//   gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//   gap: 16, 
//   marginBottom: 20,
//   padding: 16,
//   backgroundColor: '#fff3cd',
//   borderRadius: 8
// }}>
//   <MetricCard title="Total Events" value={events.eventSummary.totalEvents} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Net Value Impact" value={events.eventSummary.netValue} currency={summaries.regular.currencyCode} color="#FF9800" />
//   <MetricCard title="Orders Affected" value={events.ordersWithEventsCount} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Refunds" value={events.eventSummary.refunds.value} currency={summaries.regular.currencyCode} color="#F44336" />
//   <MetricCard title="Exchanges" value={events.eventSummary.exchanges.value} currency={summaries.regular.currencyCode} color="#2196F3" />
//   <MetricCard title="Modifications" value={events.eventSummary.modifications.value} currency={summaries.regular.currencyCode} color="#9C27B0" />
//   <MetricCard title="Returns" value={events.eventSummary.returns.count} currency="" color="#795548" isCount={true} />
//   <MetricCard title="Discounts" value={events.eventSummary.discounts.value} currency={summaries.regular.currencyCode} color="#607D8B" />
// </div>

// {/* Return Events Breakdown - Show actual detected return events */}
// {events.eventSummary.returns.count > 0 && (
//   <div style={{ 
//     marginBottom: 20,
//     padding: 16,
//     backgroundColor: '#f3e5f5',
//     borderRadius: 8,
//     border: '1px solid #e1bee7'
//   }}>
//     <h4 style={{ marginBottom: 12, color: '#7b1fa2' }}>Return Events Detected</h4>
    
//     {/* Calculate actual return fees from events */}
//     {(() => {
//       const returnEvents = events.pastOrderEvents.filter(event => event.eventType === 'return');
//       const restockingFees = returnEvents
//         .filter(event => event.details?.type === 'restocking_fee')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const returnShippingFees = returnEvents
//         .filter(event => event.details?.type === 'return_shipping')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const productReturns = returnEvents
//         .filter(event => event.details?.type === 'product_return')
//         .length;

//       return (
//         <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12 }}>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Restocking Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {restockingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'restocking_fee').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Return Shipping</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {returnShippingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'return_shipping').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Product Returns</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#f44336' }}>
//               {productReturns} returns
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Items returned to inventory
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Total Return Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#4CAF50' }}>
//               {summaries.regular.currencyCode} {(restockingFees + returnShippingFees).toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Combined fees
//             </div>
//           </div>
//         </div>
//       );
//     })()}
//   </div>
// )}

// {/* Enhanced Order Details with Return Fee Breakdown */}
// {Array.from(new Set(events.pastOrderEvents.map(event => event.orderId))).map(orderId => {
//   const orderEvents = events.pastOrderEvents.filter(event => event.orderId === orderId);
//   const firstEvent = orderEvents[0];
  
//   // Calculate financial impact for this order
//   const totalImpact = orderEvents.reduce((sum, event) => sum + event.amount, 0);
  
//   // Calculate return fee breakdown for this order
//   const orderReturnEvents = orderEvents.filter(event => event.eventType === 'return');
//   const orderRestockingFees = orderReturnEvents
//     .filter(event => event.details?.type === 'restocking_fee')
//     .reduce((sum, event) => sum + event.amount, 0);
  
//   const orderReturnShipping = orderReturnEvents
//     .filter(event => event.details?.type === 'return_shipping')
//     .reduce((sum, event) => sum + event.amount, 0);

//   return (
//     <details key={orderId} style={{ marginBottom: 15, border: '1px solid #ddd', borderRadius: 8 }}>
//       <summary style={{ 
//         cursor: 'pointer', 
//         padding: '16px', 
//         backgroundColor: '#f8f9fa',
//         fontWeight: 'bold',
//         fontSize: '16px'
//       }}>
//         <strong>{firstEvent.orderName}</strong>
//         <span style={{ float: 'right', fontWeight: 'normal' }}>
//           Impact: 
//           <strong style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', marginLeft: '8px' }}>
//             {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//           </strong>
//           <span style={{ marginLeft: '16px', color: '#666' }}>
//             {orderEvents.length} event{orderEvents.length > 1 ? 's' : ''}
//           </span>
//         </span>
//       </summary>
      
//       <div style={{ padding: '16px', backgroundColor: 'white' }}>
//         {/* Event List */}
//         <div style={{ marginBottom: '16px' }}>
//           <h4 style={{ marginBottom: '8px', color: '#333' }}>Event Details:</h4>
//           {orderEvents.map((event, index) => (
//             <div key={index} style={{ 
//               padding: '8px', 
//               marginBottom: '8px', 
//               backgroundColor: '#f5f5f5',
//               borderRadius: '4px',
//               borderLeft: `4px solid ${getEventTypeColor(event.eventType)}`
//             }}>
//               <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
//                 <div>
//                   <span style={{
//                     padding: '2px 6px',
//                     borderRadius: '4px',
//                     fontSize: '0.7em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white',
//                     marginRight: '8px'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                   {event.amount !== 0 && (
//                     <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                       {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                     </strong>
//                   )}
//                   <span style={{ marginLeft: '8px' }}>{event.description}</span>
//                 </div>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </div>
//               </div>
//               {event.details && (
//                 <div style={{ fontSize: '0.7em', color: '#666', marginTop: '4px' }}>
//                   {Object.entries(event.details).map(([key, value]) => (
//                     <span key={key} style={{ marginRight: '8px' }}>
//                       {key}: {String(value)}
//                     </span>
//                   ))}
//                 </div>
//               )}
//             </div>
//           ))}
//         </div>

//         {/* Financial Summary */}
//         {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//           <div style={{ 
//             padding: '12px', 
//             backgroundColor: '#e8f5e8', 
//             borderRadius: '4px',
//             border: '1px solid #4CAF50',
//             marginBottom: '12px'
//           }}>
//             <h4 style={{ marginBottom: '8px', color: '#2e7d32' }}>Return Fees Summary:</h4>
//             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '8px' }}>
//               {orderRestockingFees > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Restocking Fees</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderRestockingFees.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {orderReturnShipping > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Return Shipping</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderReturnShipping.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Total Return Fees</div>
//                   <div style={{ color: '#4CAF50', fontWeight: 'bold' }}>
//                     +{(orderRestockingFees + orderReturnShipping).toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//             </div>
//           </div>
//         )}
//       </div>
//     </details>
//   );
// })}
     

//       {/* Event Details Table (Original) */}
//       <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//         <div style={{ padding: '12px', backgroundColor: '#f5f5f5', borderBottom: '1px solid #ddd' }}>
//           <h4 style={{ margin: 0, color: '#333' }}>All Events Timeline</h4>
//         </div>
//         <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//           <thead style={{ backgroundColor: '#f8f9fa' }}>
//             <tr>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Event Type</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Description</th>
//             </tr>
//           </thead>
//           <tbody>
//             {events.pastOrderEvents.map((event: OrderEvent, index: number) => (
//               <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
//                 <td style={{ padding: '12px' }}>
//                   <strong>{event.orderName}</strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <span style={{
//                     padding: '4px 8px',
//                     borderRadius: '4px',
//                     fontSize: '0.8em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                     {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                   </strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {event.description}
//                   {event.details && (
//                     <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                       {JSON.stringify(event.details)}
//                     </div>
//                   )}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </>
//   )}
// </div>
//     </div>
//   );
// }

















































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";
// import type { EventSummary, OrderEvent, EventDetectionData } from "../types/analytics";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }





// // Add this function right before your event detection loop
// function debugReturnData(orders: any[]) {
//   console.log('=== RETURN DATA DEBUG ===');
  
//   orders.forEach((order: any) => {
//     const returns = order.returns?.nodes || [];
//     if (returns.length > 0) {
//       console.log(`Order ${order.name} has ${returns.length} returns:`, {
//         orderId: order.id,
//         returns: returns.map((ret: any) => ({
//           id: ret.id,
//           createdAt: ret.createdAt,
//           hasRestockingFees: ret.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//           hasReturnShipping: ret.returnShippingFees?.length > 0,
//           hasTaxData: !!ret.totalTaxSet,
//           lineItems: ret.returnLineItems?.nodes?.map((li: any) => ({
//             hasRestockingFee: !!li.restockingFee,
//             restockingFeeAmount: li.restockingFee?.amountSet?.shopMoney?.amount,
//             totalPrice: li.totalPriceSet?.shopMoney?.amount
//           }))
//         }))
//       });
//     }
//   });
  
//   console.log('=== END RETURN DATA DEBUG ===');
// }

// // EVENT DETECTION FUNCTIONS
// function parseMoneyAmount(moneySet: any): number {
//   if (!moneySet || !moneySet.shopMoney || !moneySet.shopMoney.amount) {
//     return 0;
//   }
//   return parseFloat(moneySet.shopMoney.amount) || 0;
// }

// function detectRefundEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderRefunds = order.refunds || [];

//   orderRefunds.forEach((refund: any) => {
//     const refundDate = new Date(refund.createdAt);
    
//     if (refundDate >= periodStart && refundDate <= periodEnd && isTodayInStoreTime(refundDate, storeTimezone)) {
//       const refundAmount = parseMoneyAmount(refund.totalRefundedSet);
//       const totalOrderAmount = parseMoneyAmount(order.currentTotalPriceSet);
//       const isFullRefund = Math.abs(refundAmount - totalOrderAmount) < 0.01;

//       // Calculate refunded shipping from this refund
//       const refundedShipping = parseMoneyAmount(refund.shipping) || 0;
      
//       // Calculate refunded taxes
//       const refundedTaxes = refund.refundLineItems?.edges?.reduce((sum: number, edge: any) => {
//         return sum + parseMoneyAmount(edge.node.totalTaxSet);
//       }, 0) || 0;
      
//       // Calculate refund discrepancy if any
//       const refundDiscrepancy = parseMoneyAmount(order.refundDiscrepancySet) || 0;

//       if (isFullRefund) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Full refund processed`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy,
//             isFullRefund: true
//           }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'partial_refund',
//           eventDate: refundDate.toISOString(),
//           amount: -refundAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Partial refund: ${refundAmount.toFixed(2)}`,
//           details: { 
//             refundId: refund.id, 
//             note: refund.note, 
//             refundLineItems: refund.refundLineItems,
//             refundedShipping: -refundedShipping,
//             refundedTaxes: -refundedTaxes,
//             refundDiscrepancy: refundDiscrepancy
//           }
//         });
//       }

//       // Add separate event for refunded shipping if any
//       if (refundedShipping > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_shipping',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedShipping,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded shipping`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_shipping',
//             amount: -refundedShipping
//           }
//         });
//       }

//       // Add separate event for refunded taxes if any
//       if (refundedTaxes > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'refund_tax',
//           eventDate: refundDate.toISOString(),
//           amount: -refundedTaxes,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Refunded taxes`,
//           details: { 
//             refundId: refund.id,
//             type: 'refund_tax',
//             amount: -refundedTaxes
//           }
//         });
//       }

//       // Add event for refund discrepancy if any
//       if (Math.abs(refundDiscrepancy) > 0.01) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: refundDiscrepancy > 0 ? 'over_refund' : 'under_refund',
//           eventDate: refundDate.toISOString(),
//           amount: refundDiscrepancy > 0 ? -Math.abs(refundDiscrepancy) : Math.abs(refundDiscrepancy),
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: refundDiscrepancy > 0 ? 'Over refund discrepancy' : 'Under refund discrepancy',
//           details: { 
//             refundId: refund.id,
//             type: 'refund_discrepancy',
//             amount: refundDiscrepancy
//           }
//         });
//       }
//     }
//   });

//   return events;
// }

// function detectExchangeEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectExchangeEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
  
//   // Check for exchanges in returns data - SAME LOGIC AS TODAY'S ORDERS
//   const returns = order.returns?.nodes || [];
  
//   console.log(` Order ${order.name} has ${returns.length} returns for exchange detection`);
  
//   returns.forEach((returnItem: any, index: number) => {
//     // Use the same date handling as detectReturnEvents
//     let returnDate: Date | null = null;
//     let isValidDate = false;
    
//     try {
//       if (returnItem.createdAt) {
//         returnDate = new Date(returnItem.createdAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       }
//     } catch (error) {
//       console.log(` Invalid date for return in exchange detection:`, returnItem.createdAt);
//       isValidDate = false;
//     }
    
//     // If no valid date, use order updated date as fallback
//     if (!isValidDate) {
//       try {
//         returnDate = new Date(order.updatedAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       } catch (error) {
//         console.log(` No valid date available for exchange detection`);
//         return;
//       }
//     }

//     // Add null check here
//     if (!returnDate) {
//       console.log(` No return date available for exchange detection`);
//       return;
//     }

//     const isInPeriod = returnDate >= periodStart && returnDate <= periodEnd;
//     const isToday = isTodayInStoreTime(returnDate, storeTimezone);
    
//     console.log(` Exchange date check for ${order.name}:`, {
//       returnDate: returnDate.toISOString(),
//       isInPeriod,
//       isToday,
//       storeTimezone
//     });

//     // Check if this return represents an exchange (you might need to adjust this condition)
//     // Look for returns that have specific characteristics of exchanges
//     const mightBeExchange = returnItem.returnLineItems?.nodes?.length > 0 && 
//                            returnItem.status !== 'cancelled'; // Adjust based on your exchange patterns
    
//     if (isInPeriod && isToday && mightBeExchange) {
//       console.log(` Processing potential exchange for order ${order.name}`);
//       debugReturnStructure(returnItem); // Add this line
      
//       // Calculate return value from return line items
//       let returnValue = 0;
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         returnValue += parseMoneyAmount(lineItem.totalPriceSet) || 0;
//       });

//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'exchange',
//         eventDate: returnDate.toISOString(),
//         amount: -returnValue,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Exchange processed`,
//         details: { returnId: returnItem.id, status: returnItem.status, returnValue }
//       });
//     } else {
//       console.log(` Exchange filtered out for ${order.name}:`, {
//         reason: !isInPeriod ? 'Not in period' : !isToday ? 'Not today' : !mightBeExchange ? 'Not exchange pattern' : 'Unknown',
//         returnDate: returnDate.toISOString()
//       });
//     }
//   });

//   console.log(` Total exchange events created for order ${order.name}: ${events.length}`);
//   return events;
// }







// // Add this function to help debug return data structure
// function debugReturnStructure(returnItem: any) {
//   console.log(' RETURN ITEM STRUCTURE DEBUG:', {
//     id: returnItem.id,
//     createdAt: returnItem.createdAt,
//     status: returnItem.status,
//     type: returnItem.type,
//     notes: returnItem.notes,
//     adminNote: returnItem.adminNote,
//     returnLineItems: returnItem.returnLineItems?.nodes?.map((li: any, index: number) => ({
//       index,
//       id: li.id,
//       lineItemId: li.lineItemId,
//       name: li.name,
//       title: li.title,
//       quantity: li.quantity,
//       reason: li.reason,
//       availableFields: Object.keys(li),
//       priceFields: {
//         totalPriceSet: li.totalPriceSet,
//         priceSet: li.priceSet,
//         subtotalSet: li.subtotalSet,
//         originalPriceSet: li.originalPriceSet
//       }
//     }))
//   });
// }


// function findExchangeGroup(events: OrderEvent[], startIndex: number, processedIds: Set<number>): OrderEvent[] {
//   const group: OrderEvent[] = [events[startIndex]];
//   const startTime = new Date(events[startIndex].eventDate).getTime();
//   const timeWindow = 10 * 60 * 1000; // 10 minute window for exchange events
  
//   // Look for related events within time window
//   for (let i = startIndex + 1; i < events.length; i++) {
//     if (processedIds.has(events[i].internalId!)) continue;
    
//     const eventTime = new Date(events[i].eventDate).getTime();
//     if (eventTime - startTime <= timeWindow) {
//       // Check if this event type fits exchange pattern
//       if (isExchangeRelatedEvent(events[i])) {
//         group.push(events[i]);
//       }
//     } else {
//       break; // Outside time window
//     }
//   }
  
//   return group;
// }

// function isExchangeRelatedEvent(event: OrderEvent): boolean {
//   const exchangeRelatedTypes = [
//     'item_removed', 'item_added', 'product_return', 'restocking_fee', 
//     'return_shipping_fee', 'partial_refund', 'exchange'
//   ];
//   return exchangeRelatedTypes.includes(event.eventType);
// }


// function createCombinedExchangeEvent(events: OrderEvent[]): OrderEvent {
//   const firstEvent = events[0];
//   const totalAmount = events.reduce((sum, event) => sum + event.amount, 0);
  
//   // Calculate components for details
//   const returnedValue = events
//     .filter(e => e.eventType === 'item_removed' || e.eventType === 'product_return')
//     .reduce((sum, e) => sum + Math.min(0, e.amount), 0);
  
//   const newItemsValue = events
//     .filter(e => e.eventType === 'item_added')
//     .reduce((sum, e) => sum + Math.max(0, e.amount), 0);
  
//   const fees = events
//     .filter(e => e.eventType === 'restocking_fee' || e.eventType === 'return_shipping_fee')
//     .reduce((sum, e) => sum + e.amount, 0);
  
//   const refunds = events
//     .filter(e => e.eventType === 'partial_refund')
//     .reduce((sum, e) => sum + e.amount, 0);
  
//   return {
//     orderId: firstEvent.orderId,
//     orderName: firstEvent.orderName,
//     eventType: 'exchange',
//     eventDate: firstEvent.eventDate,
//     amount: totalAmount,
//     currencyCode: firstEvent.currencyCode,
//     description: `Exchange processed (${events.length} actions)`,
//     details: {
//       isExchange: true,
//       componentEvents: events.length,
//       returnedValue: Math.abs(returnedValue),
//       newItemsValue: newItemsValue,
//       fees: fees,
//       refunds: refunds,
//       netValue: totalAmount,
//       originalEvents: events.map(e => ({
//         type: e.eventType,
//         amount: e.amount,
//         description: e.description
//       }))
//     }
//   };
// }


// function detectReturnEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectReturnEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const returns = order.returns?.nodes || [];
  
//   console.log(` Order ${order.name} has ${returns.length} returns`);
  
//   returns.forEach((returnItem: any, index: number) => {
//     // Validate and safely parse the return date
//     let returnDate: Date | null = null;
//     let isValidDate = false;
    
//     try {
//       if (returnItem.createdAt) {
//         returnDate = new Date(returnItem.createdAt);
//         isValidDate = !isNaN(returnDate.getTime());
//       }
//     } catch (error) {
//       console.log(` Invalid date for return:`, returnItem.createdAt);
//       isValidDate = false;
//     }
    
//     // If no valid date, use order updated date as fallback
//     if (!isValidDate) {
//       try {
//         returnDate = new Date(order.updatedAt);
//         isValidDate = !isNaN(returnDate.getTime());
//         console.log(` Using order updated date as fallback for return: ${returnDate.toISOString()}`);
//       } catch (error) {
//         console.log(` No valid date available for return`);
//         return; // Skip this return if no valid date
//       }
//     }
    
//     console.log(`Return ${index + 1}:`, {
//       id: returnItem.id,
//       createdAt: returnItem.createdAt,
//       returnDate: returnDate?.toISOString(),
//       status: returnItem.status,
//       hasRestockingFees: returnItem.returnLineItems?.nodes?.some((li: any) => li.restockingFee),
//       hasReturnShipping: returnItem.returnShippingFees?.length > 0,
//       restockingFees: returnItem.returnLineItems?.nodes?.map((li: any) => ({
//         hasFee: !!li.restockingFee,
//         amount: li.restockingFee?.amountSet?.shopMoney?.amount
//       })),
//       returnShippingFees: returnItem.returnShippingFees?.map((fee: any) => ({
//         amount: fee?.amountSet?.shopMoney?.amount
//       }))
//     });
    
//     // TEMPORARY: Remove date filtering for debugging (but keep date validation)
//     if (true && returnDate) { // Ensure returnDate exists
//       console.log(` Processing return for order ${order.name} (date filtering disabled)`);
      
//       // Calculate restocking fees
//       let totalRestockingFees = 0;
//       let restockingFeeItems = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         if (lineItem.restockingFee) {
//           const feeAmount = parseMoneyAmount(lineItem.restockingFee.amountSet);
//           totalRestockingFees += feeAmount;
//           restockingFeeItems++;
          
//           console.log(` Restocking fee detected: ${feeAmount} for line item ${lineItem.id}`);
          
//           // Create individual restocking fee event
//           events.push({
//             orderId: order.id,
//             orderName: order.name,
//             eventType: 'restocking_fee',
//             eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//             amount: feeAmount,
//             currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//             description: `Restocking fee for item`,
//             details: { 
//               returnId: returnItem.id, 
//               type: 'restocking_fee', 
//               amount: feeAmount,
//               lineItemId: lineItem.id
//             }
//           });
//         }
//       });

//       // Calculate return shipping fees
//       let totalReturnShippingFees = 0;
//       let returnShippingEvents = 0;
      
//       returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//         const shippingAmount = parseMoneyAmount(shippingFee.amountSet);
//         totalReturnShippingFees += shippingAmount;
//         returnShippingEvents++;
        
//         console.log(` Return shipping fee detected: ${shippingAmount}`);
        
//         // Create individual return shipping fee event
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_shipping_fee',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: shippingAmount,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Return shipping fee`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'return_shipping_fee', 
//             amount: shippingAmount
//           }
//         });
//       });

//       // Calculate returned products value
//       let returnedProductsValue = 0;
//       let returnedItemsCount = 0;
      
//       returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//         const itemValue = parseMoneyAmount(lineItem.totalPriceSet) || 0;
//         returnedProductsValue += itemValue;
//         returnedItemsCount++;
//       });

//       // Main return event for products
//       if (returnedItemsCount > 0) {
//         console.log(` Product return detected: ${returnedItemsCount} items worth ${returnedProductsValue}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'product_return',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnedProductsValue,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Products returned (${returnedItemsCount} items)`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'product_return',
//             itemsCount: returnedItemsCount,
//             value: -returnedProductsValue
//           }
//         });
//       }

//       // Calculate and add tax impact from returns
//       const returnTaxImpact = parseMoneyAmount(returnItem.totalTaxSet) || 0;
//       if (returnTaxImpact !== 0) {
//         console.log(` Return tax impact detected: ${returnTaxImpact}`);
        
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'return_tax',
//           eventDate: returnDate!.toISOString(), // Use non-null assertion since we checked
//           amount: -returnTaxImpact,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Tax adjustment from return`,
//           details: { 
//             returnId: returnItem.id, 
//             type: 'tax_adjustment',
//             amount: -returnTaxImpact
//           }
//         });
//       }

//       // Summary of what was detected for this return
//       console.log(` Return ${returnItem.id} summary:`, {
//         restockingFees: totalRestockingFees,
//         returnShippingFees: totalReturnShippingFees,
//         returnedProductsValue: returnedProductsValue,
//         taxImpact: returnTaxImpact,
//         totalEventsCreated: events.length
//       });
//     } else {
//       console.log(` Return filtered out: no valid date available`);
//     }
//   });

//   console.log(` Total events created for order ${order.name}: ${events.length}`);
//   return events;
// }









// function detectTaxEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectTaxEvents CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if taxes were modified today
//   if (orderUpdatedDate >= periodStart && orderUpdatedDate <= periodEnd && isTodayInStoreTime(orderUpdatedDate, storeTimezone)) {
//     const originalTax = parseMoneyAmount(order.totalTaxSet) || 0;
//     const currentTax = parseMoneyAmount(order.currentTotalTaxSet) || 0;
//     const taxDifference = currentTax - originalTax;

//     console.log(` Tax check for order ${order.name}:`, {
//       originalTax,
//       currentTax,
//       taxDifference,
//       updatedToday: isTodayInStoreTime(orderUpdatedDate, storeTimezone),
//       orderUpdatedDate: orderUpdatedDate.toISOString()
//     });

//     if (Math.abs(taxDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'tax_adjustment',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: taxDifference,
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Tax adjustment applied`,
//         details: { 
//           taxChange: taxDifference, 
//           originalTax, 
//           currentTax,
//           type: 'tax_adjustment'
//         }
//       });
      
//       console.log(` Tax adjustment event created for order ${order.name}: ${taxDifference}`);
//     }
//   }

//   return events;
// }


// // NEW FUNCTION: Detect newly added line items to existing orders
// function detectNewLineItems(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   console.log(` detectNewLineItems CALLED for order: ${order.name}`);
//   const events: OrderEvent[] = [];
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (orderUpdatedDate > orderCreatedDate && 
//       isTodayInStoreTime(orderUpdatedDate, storeTimezone) && 
//       !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
    
//     // Get all line items
//     const lineItems = order.lineItems?.edges || [];
    
//     // Try to identify newly added line items by looking for items with later creation dates
//     // or items that don't appear in the original order data
//     lineItems.forEach((edge: any) => {
//       const lineItem = edge.node;
      
//       // Check if this line item was likely added today
//       // You might need to adjust this logic based on your actual data structure
//       const lineItemCreatedAt = lineItem.createdAt ? new Date(lineItem.createdAt) : orderUpdatedDate;
      
//       if (lineItemCreatedAt >= periodStart && 
//           lineItemCreatedAt <= periodEnd && 
//           isTodayInStoreTime(lineItemCreatedAt, storeTimezone) &&
//           lineItemCreatedAt > orderCreatedDate) {
        
//         const itemValue = parseMoneyAmount(lineItem.originalTotalSet) || 0;
        
//         if (itemValue > 0) {
//           console.log(` New line item detected in order ${order.name}:`, {
//             lineItemId: lineItem.id,
//             name: lineItem.name,
//             value: itemValue,
//             createdAt: lineItemCreatedAt.toISOString()
//           });
          
//           events.push({
//             orderId: order.id,
//             orderName: order.name,
//             eventType: 'item_added',
//             eventDate: lineItemCreatedAt.toISOString(),
//             amount: itemValue,
//             currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//             description: `New item added: ${lineItem.name}`,
//             details: { 
//               lineItemId: lineItem.id,
//               lineItemName: lineItem.name,
//               quantity: lineItem.quantity,
//               value: itemValue,
//               type: 'new_line_item'
//             }
//           });
//         }
//       }
//     });
//   }

//   console.log(` New line items detected for order ${order.name}: ${events.length}`);
//   return events;
// }

// function detectModificationEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];
//   const orderCreatedDate = new Date(order.createdAt);
//   const orderUpdatedDate = new Date(order.updatedAt);

//   // Check if order was modified today (but not created today)
//   if (orderUpdatedDate > orderCreatedDate && isTodayInStoreTime(orderUpdatedDate, storeTimezone) && !isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     // Check for significant changes that indicate modifications
//     const originalSubtotal = parseMoneyAmount(order.subtotalPriceSet);
//     const currentSubtotal = parseMoneyAmount(order.currentSubtotalPriceSet);
//     const subtotalDifference = currentSubtotal - originalSubtotal;

//     if (Math.abs(subtotalDifference) > 0.01) {
//       if (subtotalDifference > 0) {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_added',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items added to order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       } else {
//         events.push({
//           orderId: order.id,
//           orderName: order.name,
//           eventType: 'item_removed',
//           eventDate: orderUpdatedDate.toISOString(),
//           amount: subtotalDifference,
//           currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//           description: `Items removed from order`,
//           details: { subtotalChange: subtotalDifference, originalSubtotal, currentSubtotal }
//         });
//       }
//     }

//     // Check for discount changes
//     const originalDiscounts = parseMoneyAmount(order.totalDiscountsSet);
//     const currentDiscounts = parseMoneyAmount(order.currentTotalDiscountsSet);
//     const discountDifference = currentDiscounts - originalDiscounts;

//     if (Math.abs(discountDifference) > 0.01) {
//       events.push({
//         orderId: order.id,
//         orderName: order.name,
//         eventType: 'discount',
//         eventDate: orderUpdatedDate.toISOString(),
//         amount: -discountDifference, // Negative because discount reduces revenue
//         currencyCode: order.totalPriceSet?.shopMoney?.currencyCode || 'USD',
//         description: `Discount modified`,
//         details: { discountChange: discountDifference, originalDiscounts, currentDiscounts }
//       });
//     }
//   }

//   return events;
// }

// // Main function to detect all events for an order
// function detectOrderEvents(order: any, periodStart: Date, periodEnd: Date, storeTimezone: string): OrderEvent[] {
//   const events: OrderEvent[] = [];

//   // Skip orders created today (they're already in today's orders)
//   const orderCreatedDate = new Date(order.createdAt);
//   if (isTodayInStoreTime(orderCreatedDate, storeTimezone)) {
//     return events;
//   }

//   // Detect all types of events
//   events.push(...detectRefundEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectExchangeEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectReturnEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectModificationEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectTaxEvents(order, periodStart, periodEnd, storeTimezone));
//   events.push(...detectNewLineItems(order, periodStart, periodEnd, storeTimezone)); // NEW: Detect newly added line items

//   return events;
// }

// // Calculate event summary from events
// function calculateEventSummary(events: OrderEvent[]): EventSummary {
//   const summary: EventSummary = {
//     refunds: { count: 0, value: 0 },
//     exchanges: { count: 0, value: 0 },
//     partialRefunds: { count: 0, value: 0 },
//     modifications: { count: 0, value: 0 },
//     returns: { count: 0, value: 0 },
//     discounts: { count: 0, value: 0 },
//     restockingFees: { count: 0, value: 0 },
//     returnShippingFees: { count: 0, value: 0 },
//     refundShipping: { count: 0, value: 0 },
//     taxAdjustments: { count: 0, value: 0 },
//     refundTaxes: { count: 0, value: 0 },
//     newLineItems: { count: 0, value: 0 }, // NEW: Track newly added line items
//     totalEvents: events.length,
//     netValue: 0
//   };

//  events.forEach(event => {
//   switch (event.eventType) {
//     case 'refund':
//       summary.refunds.count++;
//       summary.refunds.value += event.amount;
//       break;
//     case 'exchange':
//       summary.exchanges.count++;
//       summary.exchanges.value += event.amount;
//       break;
//     case 'partial_refund':
//       summary.partialRefunds.count++;
//       summary.partialRefunds.value += event.amount;
//       break;
//     case 'item_added':
//       // Only count as new line item if it's specifically a new line item addition
//       if (event.details?.type === 'new_line_item') {
//         summary.newLineItems.count++;
//         summary.newLineItems.value += event.amount;
//       } else {
//         // Regular modification tracking
//         summary.modifications.count++;
//         summary.modifications.value += event.amount;
//       }
//       break;
//     case 'item_removed':
//       summary.modifications.count++;
//       summary.modifications.value += event.amount;
//       break;
//     case 'product_return':
//       summary.returns.count++;
//       summary.returns.value += event.amount;
//       break;
//     case 'discount':
//       summary.discounts.count++;
//       summary.discounts.value += event.amount;
//       break;
//     case 'restocking_fee':
//       summary.restockingFees.count++;
//       summary.restockingFees.value += event.amount;
//       break;
//     case 'return_shipping_fee':
//       summary.returnShippingFees.count++;
//       summary.returnShippingFees.value += event.amount;
//       break;
//     case 'refund_shipping':
//       summary.refundShipping.count++;
//       summary.refundShipping.value += event.amount;
//       break;
//     case 'tax_adjustment':
//     case 'return_tax':
//       summary.taxAdjustments.count++;
//       summary.taxAdjustments.value += event.amount;
//       break;
//     case 'refund_tax':
//       summary.refundTaxes.count++;
//       summary.refundTaxes.value += event.amount;
//       break;
//     case 'over_refund':
//     case 'under_refund':
//       summary.refunds.count++;
//       summary.refunds.value += event.amount;
//       break;
//   }
//   summary.netValue += event.amount;
// });

// return summary;
// }

// // Calculate event order metrics (MIRRORS TODAY'S ORDERS LOGIC)
// function calculateEventOrderMetrics(orderEvents: OrderEvent[]): any[] {
//   // Group events by order
//   const eventsByOrder: { [orderId: string]: OrderEvent[] } = {};
//   orderEvents.forEach(event => {
//     if (!eventsByOrder[event.orderId]) {
//       eventsByOrder[event.orderId] = [];
//     }
//     eventsByOrder[event.orderId].push(event);
//   });

//   // Calculate metrics for each order with events
//   const orderMetrics = Object.entries(eventsByOrder).map(([orderId, events]) => {
//     const firstEvent = events[0];
    
//     // Calculate financial impact from events
//     const grossSalesImpact = events
//       .filter(e => e.eventType === 'item_added')
//       .reduce((sum, e) => sum + Math.max(0, e.amount), 0);
    
//     const returnsImpact = events
//       .filter(e => e.eventType === 'refund' || e.eventType === 'partial_refund' || e.eventType === 'product_return')
//       .reduce((sum, e) => sum + Math.min(0, e.amount), 0);
    
//     const discountsImpact = events
//       .filter(e => e.eventType === 'discount')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const shippingImpact = events
//       .filter(e => e.eventType === 'refund_shipping' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const returnFeesImpact = events
//       .filter(e => e.eventType === 'restocking_fee' || e.eventType === 'return_shipping_fee')
//       .reduce((sum, e) => sum + e.amount, 0);
    
//     const taxesImpact = events
//       .filter(e => e.eventType === 'tax_adjustment' || e.eventType === 'return_tax' || e.eventType === 'refund_tax')
//       .reduce((sum, e) => sum + e.amount, 0);

//     const netSalesImpact = grossSalesImpact + returnsImpact + discountsImpact;
//     const totalImpact = netSalesImpact + shippingImpact + returnFeesImpact + taxesImpact;

//     return {
//       orderId,
//       orderName: firstEvent.orderName,
//       currencyCode: firstEvent.currencyCode,
//       events,
//       // Core calculated metrics (MIRRORING TODAY'S ORDERS)
//       calculatedGrossSales: grossSalesImpact,
//       calculatedGrossReturns: Math.abs(returnsImpact),
//       calculatedNetReturns: Math.abs(returnsImpact),
//       calculatedRefundedShipping: events.filter(e => e.eventType === 'refund_shipping').reduce((sum, e) => sum + Math.abs(e.amount), 0),
//       calculatedReturnShippingFees: events.filter(e => e.eventType === 'return_shipping_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedNetSales: netSalesImpact,
//       calculatedRefundDiscrepancy: events.filter(e => e.eventType === 'over_refund' || e.eventType === 'under_refund').reduce((sum, e) => sum + e.amount, 0),
//       calculatedRestockingFees: events.filter(e => e.eventType === 'restocking_fee').reduce((sum, e) => sum + e.amount, 0),
//       calculatedReturnFees: returnFeesImpact,
//       calculatedShippingCharges: shippingImpact,
//       calculatedTaxes: taxesImpact,
//       calculatedTotalSales: totalImpact,
      
//       // Flags (MIRRORING TODAY'S ORDERS)
//       hasOverRefund: events.some(e => e.eventType === 'over_refund'),
//       hasUnderRefund: events.some(e => e.eventType === 'under_refund'),
//       eventTypes: [...new Set(events.map(e => e.eventType))]
//     };
//   });

//   return orderMetrics;
// }

// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// // Calculate financial metrics for events (MIRRORING calculateFinancialMetrics)
// function calculateEventFinancialMetrics(orderMetrics: any[]): any {
//   const totalGrossSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orderMetrics.reduce((sum: number, order: any) => {
//     const discountEvents = order.events.filter((e: OrderEvent) => e.eventType === 'discount');
//     return sum + discountEvents.reduce((discountSum: number, e: OrderEvent) => discountSum + Math.abs(e.amount), 0);
//   }, 0);

//   const totalNetReturns = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   const totalReturnFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedTaxes || 0);
//   }, 0);

//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orderMetrics.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   const totalRestockingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orderMetrics.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orderMetrics[0]?.currencyCode || 'USD'
//   };
// }

// // Add this function RIGHT AFTER your calculateEventSummary function

// // Debug function to log all event details
// function debugEventDetection(events: OrderEvent[], eventSummary: EventSummary) {
//   console.log('=== EVENT DETECTION DEBUG ===');
//   console.log(`Total events detected: ${events.length}`);
//   console.log(`Orders with events: ${new Set(events.map(e => e.orderId)).size}`);
  
//   // Log event type breakdown
//   const eventTypeCount: Record<string, number> = {};
//   events.forEach(event => {
//     eventTypeCount[event.eventType] = (eventTypeCount[event.eventType] || 0) + 1;
//   });
  
//   console.log('Event type breakdown:', eventTypeCount);
  
//   // Log financial summary
//   console.log('Financial Summary:', {
//     totalEvents: eventSummary.totalEvents,
//     netValue: eventSummary.netValue,
//     refunds: eventSummary.refunds,
//     exchanges: eventSummary.exchanges,
//     partialRefunds: eventSummary.partialRefunds,
//     modifications: eventSummary.modifications,
//     returns: eventSummary.returns,
//     discounts: eventSummary.discounts,
//     restockingFees: eventSummary.restockingFees,
//     returnShippingFees: eventSummary.returnShippingFees,
//     refundShipping: eventSummary.refundShipping,
//     taxAdjustments: eventSummary.taxAdjustments
//   });
  
//   // Log detailed events for first 5 orders (to avoid console spam)
//   const uniqueOrderIds = [...new Set(events.map(e => e.orderId))].slice(0, 5);
//   uniqueOrderIds.forEach(orderId => {
//     const orderEvents = events.filter(e => e.orderId === orderId);
//     console.log(`Order ${orderId} events:`, orderEvents);
//   });
  
//   console.log('=== END EVENT DEBUG ===');
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   debugReturnData(allOrders);

//   // EVENT DETECTION FOR PAST ORDERS
//   const periodStart = new Date(sevenMonthsAgoUTC);
//   const periodEnd = new Date(nowUTC);
  
//   const pastOrderEvents: OrderEvent[] = [];
//   const ordersWithEvents = new Set<string>();

//   allOrders.forEach((order: any) => {
//     const events = detectOrderEvents(order, periodStart, periodEnd, storeTimezone);
//     if (events.length > 0) {
//       pastOrderEvents.push(...events);
//       ordersWithEvents.add(order.id);
//     }
//   });

//   const eventSummary = calculateEventSummary(pastOrderEvents);

//   console.log(`Event detection: Found ${pastOrderEvents.length} events across ${ordersWithEvents.size} past orders`);


//   // NEW: Calculate event metrics that mirror today's orders
// const eventOrderMetrics = calculateEventOrderMetrics(pastOrderEvents);
// const eventFinancialMetrics = calculateEventFinancialMetrics(eventOrderMetrics);


// debugEventDetection(pastOrderEvents, eventSummary);


//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     // NEW: Event detection data
//     events: {
//       pastOrderEvents,
//       eventSummary,
//       ordersWithEventsCount: ordersWithEvents.size,
//       totalEventsCount: pastOrderEvents.length,
//        eventOrderMetrics,
//     eventFinancialMetrics
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Helper function for event type colors
// function getEventTypeColor(eventType: string): string {
//   const colors: { [key: string]: string } = {
//     refund: '#F44336',
//     exchange: '#2196F3',
//     partial_refund: '#FF9800',
//     modification: '#9C27B0',
//     return: '#795548',
//     discount: '#607D8B',
//     item_added: '#4CAF50',
//     item_removed: '#F44336'
//   };
//   return colors[eventType] || '#666';
// }

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug, events } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>

//       {/* EVENT DETECTION SECTION - NEW */}
    

// {/* EVENT DETECTION SECTION - ENHANCED */}
// <div style={{ marginBottom: 40, marginTop: 40 }}>
//   <h2 style={{ borderBottom: '2px solid #FF9800', paddingBottom: 8, color: '#FF9800' }}>
//     Today's Activity on Past Orders ({events.ordersWithEventsCount} orders with activity)
//   </h2>
  
//   {events.totalEventsCount === 0 ? (
//     <div style={{ 
//       textAlign: 'center', 
//       padding: '40px', 
//       backgroundColor: '#fff3cd', 
//       borderRadius: 8,
//       border: '1px solid #ffeaa7'
//     }}>
//       <h3 style={{ color: '#856404', marginBottom: 10 }}>No Activity Detected</h3>
//       <p style={{ color: '#856404' }}>No modifications, refunds, or returns detected on past orders today.</p>
//     </div>
//   ) : (
//     <>
//       {/* Event Financial Summary - NEW */}
     

// {/* Event Financial Summary - Show only what we detect */}
// {/* Event Financial Summary - Show only what we detect */}
// <div style={{ 
//   display: 'grid', 
//   gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//   gap: 16, 
//   marginBottom: 20,
//   padding: 16,
//   backgroundColor: '#fff3cd',
//   borderRadius: 8
// }}>
//   <MetricCard title="Total Events" value={events.eventSummary.totalEvents} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Net Value Impact" value={events.eventSummary.netValue} currency={summaries.regular.currencyCode} color="#FF9800" />
//   <MetricCard title="Orders Affected" value={events.ordersWithEventsCount} currency="" color="#FF9800" isCount={true} />
//   <MetricCard title="Refunds" value={events.eventSummary.refunds.value} currency={summaries.regular.currencyCode} color="#F44336" />
//   <MetricCard title="Exchanges" value={events.eventSummary.exchanges.value} currency={summaries.regular.currencyCode} color="#2196F3" />
//   <MetricCard title="Modifications" value={events.eventSummary.modifications.value} currency={summaries.regular.currencyCode} color="#9C27B0" />
//   <MetricCard title="New Items Added" value={events.eventSummary.newLineItems.value} currency={summaries.regular.currencyCode} color="#4CAF50" /> {/* ADD THIS LINE */}
//   <MetricCard title="Returns" value={events.eventSummary.returns.count} currency="" color="#795548" isCount={true} />
//   <MetricCard title="Discounts" value={events.eventSummary.discounts.value} currency={summaries.regular.currencyCode} color="#607D8B" />
// </div>

// {/* Return Events Breakdown - Show actual detected return events */}
// {events.eventSummary.returns.count > 0 && (
//   <div style={{ 
//     marginBottom: 20,
//     padding: 16,
//     backgroundColor: '#f3e5f5',
//     borderRadius: 8,
//     border: '1px solid #e1bee7'
//   }}>
//     <h4 style={{ marginBottom: 12, color: '#7b1fa2' }}>Return Events Detected</h4>
    
//     {/* Calculate actual return fees from events */}
//     {(() => {
//       const returnEvents = events.pastOrderEvents.filter(event => event.eventType === 'return');
//       const restockingFees = returnEvents
//         .filter(event => event.details?.type === 'restocking_fee')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const returnShippingFees = returnEvents
//         .filter(event => event.details?.type === 'return_shipping')
//         .reduce((sum, event) => sum + event.amount, 0);
      
//       const productReturns = returnEvents
//         .filter(event => event.details?.type === 'product_return')
//         .length;

//       return (
//         <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12 }}>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Restocking Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {restockingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'restocking_fee').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Return Shipping</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#7b1fa2' }}>
//               {summaries.regular.currencyCode} {returnShippingFees.toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               {returnEvents.filter(e => e.details?.type === 'return_shipping').length} events
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Product Returns</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#f44336' }}>
//               {productReturns} returns
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Items returned to inventory
//             </div>
//           </div>
//           <div>
//             <div style={{ fontSize: '0.9em', color: '#666' }}>Total Return Fees</div>
//             <div style={{ fontSize: '1.1em', fontWeight: 'bold', color: '#4CAF50' }}>
//               {summaries.regular.currencyCode} {(restockingFees + returnShippingFees).toFixed(2)}
//             </div>
//             <div style={{ fontSize: '0.8em', color: '#666' }}>
//               Combined fees
//             </div>
//           </div>
//         </div>
//       );
//     })()}
//   </div>
// )}

// {/* Enhanced Order Details with Return Fee Breakdown */}
// {Array.from(new Set(events.pastOrderEvents.map(event => event.orderId))).map(orderId => {
//   const orderEvents = events.pastOrderEvents.filter(event => event.orderId === orderId);
//   const firstEvent = orderEvents[0];
  
//   // Calculate financial impact for this order
//   const totalImpact = orderEvents.reduce((sum, event) => sum + event.amount, 0);
  
//   // Calculate return fee breakdown for this order
//   const orderReturnEvents = orderEvents.filter(event => event.eventType === 'return');
//   const orderRestockingFees = orderReturnEvents
//     .filter(event => event.details?.type === 'restocking_fee')
//     .reduce((sum, event) => sum + event.amount, 0);
  
//   const orderReturnShipping = orderReturnEvents
//     .filter(event => event.details?.type === 'return_shipping')
//     .reduce((sum, event) => sum + event.amount, 0);

//   return (
//     <details key={orderId} style={{ marginBottom: 15, border: '1px solid #ddd', borderRadius: 8 }}>
//       <summary style={{ 
//         cursor: 'pointer', 
//         padding: '16px', 
//         backgroundColor: '#f8f9fa',
//         fontWeight: 'bold',
//         fontSize: '16px'
//       }}>
//         <strong>{firstEvent.orderName}</strong>
//         <span style={{ float: 'right', fontWeight: 'normal' }}>
//           Impact: 
//           <strong style={{ color: totalImpact >= 0 ? '#4CAF50' : '#F44336', marginLeft: '8px' }}>
//             {totalImpact >= 0 ? '+' : ''}{totalImpact.toFixed(2)} {firstEvent.currencyCode}
//           </strong>
//           <span style={{ marginLeft: '16px', color: '#666' }}>
//             {orderEvents.length} event{orderEvents.length > 1 ? 's' : ''}
//           </span>
//         </span>
//       </summary>
      
//       <div style={{ padding: '16px', backgroundColor: 'white' }}>
//         {/* Event List */}
//         <div style={{ marginBottom: '16px' }}>
//           <h4 style={{ marginBottom: '8px', color: '#333' }}>Event Details:</h4>
//           {orderEvents.map((event, index) => (
//             <div key={index} style={{ 
//               padding: '8px', 
//               marginBottom: '8px', 
//               backgroundColor: '#f5f5f5',
//               borderRadius: '4px',
//               borderLeft: `4px solid ${getEventTypeColor(event.eventType)}`
//             }}>
//               <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
//                 <div>
//                   <span style={{
//                     padding: '2px 6px',
//                     borderRadius: '4px',
//                     fontSize: '0.7em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white',
//                     marginRight: '8px'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                   {event.amount !== 0 && (
//                     <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                       {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                     </strong>
//                   )}
//                   <span style={{ marginLeft: '8px' }}>{event.description}</span>
//                 </div>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </div>
//               </div>
//               {event.details && (
//                 <div style={{ fontSize: '0.7em', color: '#666', marginTop: '4px' }}>
//                   {Object.entries(event.details).map(([key, value]) => (
//                     <span key={key} style={{ marginRight: '8px' }}>
//                       {key}: {String(value)}
//                     </span>
//                   ))}
//                 </div>
//               )}
//             </div>
//           ))}
//         </div>

//         {/* Financial Summary */}
//         {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//           <div style={{ 
//             padding: '12px', 
//             backgroundColor: '#e8f5e8', 
//             borderRadius: '4px',
//             border: '1px solid #4CAF50',
//             marginBottom: '12px'
//           }}>
//             <h4 style={{ marginBottom: '8px', color: '#2e7d32' }}>Return Fees Summary:</h4>
//             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '8px' }}>
//               {orderRestockingFees > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Restocking Fees</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderRestockingFees.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {orderReturnShipping > 0 && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Return Shipping</div>
//                   <div style={{ color: '#7b1fa2', fontWeight: 'bold' }}>
//                     +{orderReturnShipping.toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//               {(orderRestockingFees > 0 || orderReturnShipping > 0) && (
//                 <div>
//                   <div style={{ fontSize: '0.8em', color: '#666' }}>Total Return Fees</div>
//                   <div style={{ color: '#4CAF50', fontWeight: 'bold' }}>
//                     +{(orderRestockingFees + orderReturnShipping).toFixed(2)} {firstEvent.currencyCode}
//                   </div>
//                 </div>
//               )}
//             </div>
//           </div>
//         )}
//       </div>
//     </details>
//   );
// })}
     

//       {/* Event Details Table (Original) */}
//       <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//         <div style={{ padding: '12px', backgroundColor: '#f5f5f5', borderBottom: '1px solid #ddd' }}>
//           <h4 style={{ margin: 0, color: '#333' }}>All Events Timeline</h4>
//         </div>
//         <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//           <thead style={{ backgroundColor: '#f8f9fa' }}>
//             <tr>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Event Type</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Amount</th>
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Description</th>
//             </tr>
//           </thead>
//           <tbody>
//             {events.pastOrderEvents.map((event: OrderEvent, index: number) => (
//               <tr key={index} style={{ borderBottom: '1px solid #eee' }}>
//                 <td style={{ padding: '12px' }}>
//                   <strong>{event.orderName}</strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <span style={{
//                     padding: '4px 8px',
//                     borderRadius: '4px',
//                     fontSize: '0.8em',
//                     backgroundColor: getEventTypeColor(event.eventType),
//                     color: 'white'
//                   }}>
//                     {event.eventType.replace('_', ' ').toUpperCase()}
//                   </span>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {new Date(event.eventDate).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   <strong style={{ color: event.amount >= 0 ? '#4CAF50' : '#F44336' }}>
//                     {event.amount >= 0 ? '+' : ''}{event.amount.toFixed(2)} {event.currencyCode}
//                   </strong>
//                 </td>
//                 <td style={{ padding: '12px' }}>
//                   {event.description}
//                   {event.details && (
//                     <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                       {JSON.stringify(event.details)}
//                     </div>
//                   )}
//                 </td>
//               </tr>
//             ))}
//           </tbody>
//         </table>
//       </div>
//     </>
//   )}
// </div>
//     </div>
//   );
// }












































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   // Calculate taxes
//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Fetch orders for all time periods - use UTC for the API query
//   const dateQuery = `created_at:>=${sevenMonthsAgoUTC.toISOString()} created_at:<=${nowUTC.toISOString()}`;

//   console.log('Fetching today\'s orders with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: dateQuery,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query TodayOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);

//   // Filter orders for today using STORE LOCAL TIME
//   const todayOrders = allOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   console.log(`Today's orders after filtering: ${todayOrders.length}`);

//   // Process orders with gift card separation and proportional discount allocation
//   const todayProcessed = processOrders(todayOrders);

//   // Calculate summaries for today's orders
//   const todayRegularSummary = calculateFinancialMetrics(todayProcessed.regularOrders);
//   const todayGiftCardSummary = calculateFinancialMetrics(todayProcessed.giftCardOrders);

//   return json({ 
//     today: todayProcessed,
//     summaries: {
//       regular: todayRegularSummary,
//       giftCard: todayGiftCardSummary
//     },
//     summary: {
//       orderCount: todayOrders.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allOrders.length,
//       todayFiltered: todayOrders.length,
//       regularOrders: todayProcessed.regularOrders.length,
//       giftCardOrders: todayProcessed.giftCardOrders.length
//     }
//   });
// };

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Time</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT
// export default function OrdersToday() {
//   const { today, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} orders today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={today.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {today.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={today.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Charges" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }










































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Reuse your existing helper functions
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Reuse your existing calculation functions
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// function calculateOrderMetrics(order: any) {
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;
//   const grossSales = lineItemsTotal;

//   let netSales = grossSales - grossReturns - discounts;

//   if (refundDiscrepancy > 0) {
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }

//   const taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         const giftCardOrder = {
//           ...order,
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }

// // NEW LOADER FOR MODIFIED ORDERS
// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   const storeTimezone = 'America/New_York';
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Get UTC date range for today
//   const todayStart = new Date(`${todayStore}T00:00:00`);
//   const todayEnd = new Date(`${todayStore}T23:59:59`);
//   const todayStartUTC = todayStart.toISOString();
//   const todayEndUTC = todayEnd.toISOString();

//   console.log('Fetching orders modified today with pagination...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);
//   console.log('UTC date range:', todayStartUTC, 'to', todayEndUTC);

//   let allModifiedOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: `updated_at:>=${todayStartUTC} updated_at:<=${todayEndUTC}`,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query ModifiedOrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: UPDATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount}: Fetched ${pageOrders.length} modified orders`);

//       allModifiedOrders = [...allModifiedOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total modified orders so far: ${allModifiedOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount}:`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete. Total modified orders fetched: ${allModifiedOrders.length} over ${pageCount} pages`);

//   // Filter to only include orders that were CREATED before today but MODIFIED today
//   const pastOrdersModifiedToday = allModifiedOrders.filter((order: any) => {
//     const orderCreatedUTC = new Date(order.createdAt);
//     return !isTodayInStoreTime(orderCreatedUTC, storeTimezone);
//   });

//   console.log(`Past orders modified today: ${pastOrdersModifiedToday.length}`);

//   // Process orders with the same logic as your original component
//   const processed = processOrders(pastOrdersModifiedToday);

//   // Calculate summaries
//   const regularSummary = calculateFinancialMetrics(processed.regularOrders);
//   const giftCardSummary = calculateFinancialMetrics(processed.giftCardOrders);

//   return json({ 
//     modifiedOrders: processed,
//     summaries: {
//       regular: regularSummary,
//       giftCard: giftCardSummary
//     },
//     summary: {
//       orderCount: pastOrdersModifiedToday.length,
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone
//     },
//     debug: {
//       totalFetched: allModifiedOrders.length,
//       modifiedFiltered: pastOrdersModifiedToday.length,
//       regularOrders: processed.regularOrders.length,
//       giftCardOrders: processed.giftCardOrders.length
//     }
//   });
// };

// // REUSE YOUR EXACT UI COMPONENTS
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders modified today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Created</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Modified</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//                 <div style={{ fontSize: '0.7em', color: '#FF6B35', marginTop: '2px', fontWeight: 'bold' }}>
//                   MODIFIED TODAY
//                 </div>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.createdAt).toLocaleDateString('en-US')}
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </div>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {new Date(order.updatedAt).toLocaleTimeString('en-US', { 
//                   hour: '2-digit', 
//                   minute: '2-digit'
//                 })}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // NEW COMPONENT FOR MODIFIED ORDERS
// export default function OrdersModifiedToday() {
//   const { modifiedOrders, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Past Orders Modified Today - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.orderCount} past orders modified today
//         {debug && (
//           <span style={{ fontSize: '0.8em', color: '#999' }}>
//             {' '}({debug.regularOrders} regular + {debug.giftCardOrders} gift card)
//           </span>
//         )}
//       </p>

//       {/* Regular Orders */}
//       <div style={{ marginBottom: 40 }}>
//         <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//           Regular Orders ({summaries.regular.totalOrders} orders)
//         </h3>
//         <MetricsGrid metrics={summaries.regular} />
//         <OrdersTable orders={modifiedOrders.regularOrders} currencyCode={summaries.regular.currencyCode} />
//       </div>

//       {/* Gift Card Orders */}
//       {modifiedOrders.giftCardOrders.length > 0 && (
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//             Gift Card Orders ({summaries.giftCard.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.giftCard} />
//           <OrdersTable orders={modifiedOrders.giftCardOrders} currencyCode={summaries.giftCard.currencyCode} isGiftCard={true} />
//         </div>
//       )}

//       {/* Combined Summary */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#FF6B35', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Modification Impact Today</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales Impact" 
//             value={summaries.regular.totalSales + summaries.giftCard.totalSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Orders Modified" 
//             value={summaries.regular.totalOrders + summaries.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales Impact" 
//             value={summaries.regular.totalNetSales + summaries.giftCard.totalNetSales} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Shipping Impact" 
//             value={summaries.regular.totalShippingCharges + summaries.giftCard.totalShippingCharges} 
//             currency={summaries.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Return Fees Impact" 
//             value={summaries.regular.totalReturnFees + summaries.giftCard.totalReturnFees} 
//             currency={summaries.regular.currencyCode}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }






































// import { json, LoaderFunctionArgs } from "@remix-run/node";
// import { useLoaderData } from "@remix-run/react";
// import { authenticate } from "../shopify.server";

// // Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
// const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
//   return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
// };

// // Helper to check if a UTC date is today in store timezone
// const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
//   const nowUTC = new Date();
//   const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
//   return orderDateStore === todayStore;
// };

// // Proportional discount allocation function (matches Shopify's rounding)
// function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
//   const totalSubtotal = subtotalA + subtotalB;
  
//   if (totalSubtotal === 0) {
//     return { portionADiscount: 0, portionBDiscount: 0 };
//   }
  
//   // Calculate first portion with rounding to match Shopify
//   const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
//   // Derive second portion to ensure exact total
//   const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
//   return {
//     portionADiscount,
//     portionBDiscount
//   };
// }

// // Calculate order metrics following your exact logic
// function calculateOrderMetrics(order: any) {
//   // Calculate line items total (ORIGINAL prices before discounts)
//   const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
//     return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//   }, 0) || 0;

//   // Get discounts from the order data
//   const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

//   // Get refund discrepancy directly from Shopify
//   const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);

//   // Calculate gross returns (sum of refunded line items)
//   let grossReturns = 0;
//   order.refunds?.forEach((refund: any) => {
//     refund.refundLineItems?.edges?.forEach((edge: any) => {
//       grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
//     });
//   });

//   // Calculate refunded shipping - FROM REFUNDS DATA
//   const refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);

//   // Calculate shipping charges
//   const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
//   const shippingCharges = shippingAmount - refundedShipping;

//   // Calculate restocking fees and return shipping fees - FROM RETURNS DATA
//   let totalRestockingFees = 0;
//   let totalReturnShippingFees = 0;
  
//   order.returns?.nodes?.forEach((returnItem: any) => {
//     returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
//       if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
//         totalRestockingFees += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
//       }
//     });
    
//     // Calculate return shipping fees from returns
//     returnItem.returnShippingFees?.forEach((shippingFee: any) => {
//       if (shippingFee?.amountSet?.shopMoney?.amount) {
//         totalReturnShippingFees += parseFloat(shippingFee.amountSet.shopMoney.amount);
//       }
//     });
//   });

//   // Calculate total return fees (restocking + return shipping)
//   const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

//   // Calculate sales metrics using accurate data
//   // Gross Sales = Original line items total (BEFORE any discounts)
//   const grossSales = lineItemsTotal;

//   // Net Sales = Gross Sales - Returns - Discounts
//   let netSales = grossSales - grossReturns - discounts;

//   // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
//   if (refundDiscrepancy > 0) {
//     // Positive discrepancy = OVER-refund (we refunded more than we should have)
//     netSales += refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     // Negative discrepancy = UNDER-refund (we refunded less than we should have)
//     netSales -= Math.abs(refundDiscrepancy);
//   }

//   // Calculate net returns (gross returns adjusted for discrepancies)
//   let netReturns = grossReturns;
//   if (refundDiscrepancy > 0) {
//     netReturns = grossReturns - refundDiscrepancy;
//   } else if (refundDiscrepancy < 0) {
//     netReturns = grossReturns + Math.abs(refundDiscrepancy);
//   }





//   // Calculate taxes from line item tax lines (most reliable for modified orders)
// // Calculate taxes from line item tax lines (most reliable for modified orders)
// let taxes = 0;
// order.lineItems?.edges?.forEach((li: any) => {
//   li.node.taxLines?.forEach((taxLine: any) => {
//     taxes += parseFloat(taxLine.priceSet?.shopMoney?.amount || 0);
//   });
// });

// // If no tax from line items, fallback to currentTotalTaxSet
// if (taxes === 0) {
//   taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
// }

// // If this is a refunded order, make taxes negative
// // If there are refunds on this order, make taxes negative to reflect tax refund
// if (order.refunds && order.refunds.length > 0) {
//   taxes = -Math.abs(taxes);
// }

//   // Pull taxes directly from Shopify - use totalTaxSet for accurate tax data
// //const taxes = parseFloat(order.totalTaxSet?.shopMoney?.amount || order.currentTotalTaxSet?.shopMoney?.amount || 0);


//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

//   return {
//     ...order,
//     // Core calculated metrics
//     calculatedGrossSales: grossSales,
//     calculatedGrossReturns: grossReturns,
//     calculatedNetReturns: netReturns,
//     calculatedRefundedShipping: refundedShipping,
//     calculatedReturnShippingFees: totalReturnShippingFees,
//     calculatedNetSales: netSales,
//     calculatedRefundDiscrepancy: refundDiscrepancy,
//     calculatedRestockingFees: totalRestockingFees,
//     calculatedReturnFees: totalReturnFees,
//     calculatedShippingCharges: shippingCharges,
//     calculatedTaxes: taxes,
//     calculatedTotalSales: totalSales,
    
//     // Add flags for display purposes
//     hasOverRefund: refundDiscrepancy > 0,
//     hasUnderRefund: refundDiscrepancy < 0
//   };
// }

// // Process orders and separate gift card transactions with proportional discount allocation
// const processOrders = (orders: any[]) => {
//   const regularOrders: any[] = [];
//   const giftCardOrders: any[] = [];
//   const mixedOrdersRegular: any[] = [];
//   const mixedOrdersGiftCard: any[] = [];

//   orders.forEach((order: any) => {
//     // Check if order contains gift cards
//     const hasGiftCards = order.lineItems?.edges?.some((li: any) => 
//       li.node.name?.toLowerCase().includes('gift card') || 
//       li.node.title?.toLowerCase().includes('gift card') || 
//       li.node.product?.title?.toLowerCase().includes('gift card')
//     );

//     if (!hasGiftCards) {
//       // Pure regular order
//       const processed = calculateOrderMetrics(order);
//       regularOrders.push(processed);
//     } else {
//       // Order contains gift cards - check if mixed or pure gift card
//       const giftCardLineItems = order.lineItems?.edges?.filter((li: any) => 
//         li.node.name?.toLowerCase().includes('gift card') || 
//         li.node.title?.toLowerCase().includes('gift card') || 
//         li.node.product?.title?.toLowerCase().includes('gift card')
//       );
      
//       const regularLineItems = order.lineItems?.edges?.filter((li: any) => 
//         !li.node.name?.toLowerCase().includes('gift card') && 
//         !li.node.title?.toLowerCase().includes('gift card') && 
//         !li.node.product?.title?.toLowerCase().includes('gift card')
//       );

//       if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
//         // Mixed order - use proportional discount allocation
        
//         // Calculate subtotals for each portion
//         const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
//           return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
//         }, 0);
        
//         const totalOrderDiscount = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
        
//         // Allocate discount proportionally (matching Shopify's rounding)
//         const discountAllocation = allocateDiscountProportional(
//           totalOrderDiscount, 
//           giftCardSubtotal, 
//           regularSubtotal
//         );
        
//         const giftCardDiscount = discountAllocation.portionADiscount;
//         const regularDiscount = discountAllocation.portionBDiscount;

//         // Helper function to create money set
//         const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
//           return {
//             shopMoney: { 
//               amount: amount.toFixed(2), 
//               currencyCode: currencyCode || order.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
//             }
//           };
//         };

//         // Create regular portion with proportional discount
//         const regularPortion = {
//           ...order,
//           lineItems: { edges: regularLineItems },
//           isMixedOrderRegular: true,
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(regularDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };
        
//         // Create gift card portion with proportional discount and NO shipping
//         const giftCardPortion = {
//           ...order,
//           lineItems: { edges: giftCardLineItems },
//           isMixedOrderGiftCard: true,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: createMoneySet(0),
//           totalRefundedShippingSet: createMoneySet(0),
//           // Apply proportional discount
//           totalDiscountsSet: createMoneySet(giftCardDiscount),
//           calculatedDiscountAllocation: {
//             method: 'proportional',
//             regularDiscount,
//             giftCardDiscount,
//             totalOrderDiscount
//           }
//         };

//         const processedRegular = calculateOrderMetrics(regularPortion);
//         const processedGiftCard = calculateOrderMetrics(giftCardPortion);
        
//         mixedOrdersRegular.push(processedRegular);
//         mixedOrdersGiftCard.push(processedGiftCard);
//       } else {
//         // Pure gift card order
//         const giftCardOrder = {
//           ...order,
//           // Gift cards get NO shipping
//           totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: order.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
//           totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: order.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
//         };
//         const processed = calculateOrderMetrics(giftCardOrder);
//         processed.isGiftCardOrder = true;
//         giftCardOrders.push(processed);
//       }
//     }
//   });

//   // Combine all regular orders (pure regular + mixed regular portions)
//   const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
//   const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
//   return {
//     regularOrders: allRegularOrders,
//     giftCardOrders: allGiftCardOrders
//   };
// };

// // // Calculate financial metrics
// // function calculateFinancialMetrics(orders: any[]): any {
// //   const totalGrossSales = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedGrossSales || 0);
// //   }, 0);

// //   const totalDiscounts = orders.reduce((sum: number, order: any) => {
// //     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
// //   }, 0);

// //   const totalNetReturns = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedNetReturns || 0);
// //   }, 0);

// //   const totalNetSales = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedNetSales || 0);
// //   }, 0);

// //   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedShippingCharges || 0);
// //   }, 0);

// //   // Return fees (restocking + return shipping)
// //   const totalReturnFees = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedReturnFees || 0);
// //   }, 0);

// //   const totalTaxes = orders.reduce((sum: number, order: any) => {
// //     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
// //   }, 0);



// // // const totalTaxes = orders.reduce((sum: number, order: any) => {
// // //   return sum + (order.calculatedTaxes || 0);
// // // }, 0);

// //   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
// //   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

// //   const totalOrders = orders.length;
// //   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

// //   // Breakdown of return fees
// //   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedRestockingFees || 0);
// //   }, 0);

// //   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
// //     return sum + (order.calculatedReturnShippingFees || 0);
// //   }, 0);

// //   return {
// //     totalGrossSales,
// //     totalDiscounts,
// //     totalReturns: totalNetReturns,
// //     totalNetSales,
// //     totalShippingCharges,
// //     totalReturnFees,
// //     totalTaxes,
// //     totalSales,
// //     totalOrders,
// //     averageOrderValue,
// //     totalRestockingFees,
// //     totalReturnShippingFees,
// //     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
// //   };
// // }





// function calculateFinancialMetrics(orders: any[], useCalculatedTaxes: boolean = false): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   // TAX CALCULATION - Use parameter to determine which method to use
//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     if (useCalculatedTaxes) {
//       // For modified orders - use calculatedTaxes (handles refund scenarios)
//       return sum + (order.calculatedTaxes || 0);
//     } else {
//       // For today's orders - use currentTotalTaxSet (original approach)
//       return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//     }
//   }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }


// // Generic function to fetch orders with pagination
// async function fetchOrdersWithPagination(admin: any, query: string, description: string) {
//   let allOrders: any[] = [];
//   let hasNextPage = true;
//   let afterCursor = null;
//   let pageCount = 0;
//   const maxPages = 50;

//   while (hasNextPage && pageCount < maxPages) {
//     pageCount++;
    
//     const paginationVariables: any = {
//       query: query,
//       first: 100
//     };
    
//     if (afterCursor) {
//       paginationVariables.after = afterCursor;
//     }

//     try {
//       const response = await admin.graphql(
//         `#graphql
//         query OrdersPaginated($query: String!, $first: Int!, $after: String) {
//           orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
//             pageInfo {
//               hasNextPage
//               endCursor
//             }
//             edges {
//               cursor
//               node {
//                 id
//                 name
//                 createdAt
//                 updatedAt
//                 displayFinancialStatus
//                 displayFulfillmentStatus
//                 confirmed
//                 cancelledAt
//                 cancelReason
//                 note
//                 fullyPaid
//                 totalReceivedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalOutstandingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalShippingPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalRefundedShippingSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 refundDiscrepancySet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 returns(first: 7) {
//                   nodes {
//                     returnLineItems(first: 10) {
//                       nodes {
//                         ... on ReturnLineItem {
//                           restockingFee {
//                             amountSet {
//                               shopMoney {
//                                 amount
//                                 currencyCode
//                               }
//                             }
//                           }
//                         }
//                       }
//                     }
//                     returnShippingFees {
//                       amountSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                     }
//                   }
//                 }
//                 refunds {
//                   id
//                   createdAt
//                   note
//                   totalRefundedSet {
//                     shopMoney {
//                       amount
//                       currencyCode
//                     }
//                   }
//                   refundLineItems(first: 10) {
//                     edges {
//                       node {
//                         lineItem {
//                           id
//                           name
//                         }
//                         quantity
//                         subtotalSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         totalTaxSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                       }
//                     }
//                   }
//                 }
//                 currentSubtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalTaxSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalTaxSet {
//   shopMoney {
//     amount
//     currencyCode
//   }
// }
//                 currentTotalDiscountsSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 currentTotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 subtotalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 totalPriceSet {
//                   shopMoney {
//                     amount
//                     currencyCode
//                   }
//                 }
//                 lineItems(first: 50) {
//                   edges {
//                     node {
//                       id
//                       name
//                       title
//                       quantity
//                       sku
//                       variantTitle
//                       product {
//                         id
//                         title
//                       }
//                       variant {
//                         id
//                         title
//                         sku
//                         price
//                       }
//                       originalUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedUnitPriceSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       discountedTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       originalTotalSet {
//                         shopMoney {
//                           amount
//                           currencyCode
//                         }
//                       }
//                       taxLines {
//                         priceSet {
//                           shopMoney {
//                             amount
//                             currencyCode
//                           }
//                         }
//                         rate
//                         title
//                       }
//                     }
//                   }
//                 }
//               }
//             }
//           }
//         }`,
//         { variables: paginationVariables }
//       );

//       const responseData: any = await response.json();
      
//       // Handle GraphQL errors
//       if (responseData.errors && Array.isArray(responseData.errors)) {
//         console.error('GraphQL Errors:', responseData.errors);
//         throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
//       }

//       const ordersData = responseData?.data?.orders;
//       if (!ordersData) {
//         console.error('No orders data in response:', responseData);
//         break;
//       }

//       const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
//       console.log(`Page ${pageCount} (${description}): Fetched ${pageOrders.length} orders`);

//       allOrders = [...allOrders, ...pageOrders];
//       hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
//       afterCursor = ordersData?.pageInfo?.endCursor;

//       // Add a small delay to be respectful of API limits
//       if (hasNextPage) {
//         await new Promise(resolve => setTimeout(resolve, 200));
//       }

//       console.log(`Total ${description} orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

//     } catch (error: any) {
//       console.error(`Error fetching page ${pageCount} (${description}):`, error);
//       break;
//     }
//   }

//   console.log(`Pagination complete for ${description}. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);
//   return allOrders;
// }

// export const loader = async ({ request }: LoaderFunctionArgs) => {
//   const { admin, session } = await authenticate.admin(request);
//   const shop = session.shop;

//   // Get store timezone (default to Eastern Time)
//   const storeTimezone = 'America/New_York';
  
//   // Get current UTC time
//   const nowUTC = new Date();
//   const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

//   // Calculate reference dates for the queries - 7 months ago to cover all time ranges
//   const sevenMonthsAgoUTC = new Date(nowUTC);
//   sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

//   // Get UTC date range for today
//   const todayStart = new Date(`${todayStore}T00:00:00`);
//   const todayEnd = new Date(`${todayStore}T23:59:59`);
//   const todayStartUTC = todayStart.toISOString();
//   const todayEndUTC = todayEnd.toISOString();

//   console.log('Fetching all relevant orders for today...');
//   console.log('Store timezone:', storeTimezone);
//   console.log('Today in store time:', todayStore);

//   // Fetch orders CREATED today
//   const createdTodayQuery = `created_at:>=${todayStartUTC} created_at:<=${todayEndUTC}`;
//   const createdTodayOrders = await fetchOrdersWithPagination(admin, createdTodayQuery, "created today");

//   // Fetch orders MODIFIED today but CREATED before today
//   const modifiedTodayQuery = `updated_at:>=${todayStartUTC} updated_at:<=${todayEndUTC} created_at:<${todayStartUTC}`;
//   const modifiedTodayOrders = await fetchOrdersWithPagination(admin, modifiedTodayQuery, "modified today");

//   // Filter created today orders to only include those created today (in store timezone)
//   const filteredCreatedToday = createdTodayOrders.filter((order: any) => {
//     const orderDateUTC = new Date(order.createdAt);
//     return isTodayInStoreTime(orderDateUTC, storeTimezone);
//   });

//   // Filter modified today orders to only include those created before today
//   const filteredModifiedToday = modifiedTodayOrders.filter((order: any) => {
//     const orderCreatedUTC = new Date(order.createdAt);
//     return !isTodayInStoreTime(orderCreatedUTC, storeTimezone);
//   });



//   // DEBUG: Check raw tax data from API for modified orders
// console.log('=== RAW MODIFIED ORDERS TAX DATA ===');
// filteredModifiedToday.slice(0, 3).forEach((order: any, index: number) => {
//   console.log(`Modified order ${index + 1} (${order.name}):`, {
//     currentTotalTaxSet: order.currentTotalTaxSet,
//     totalPriceSet: order.totalPriceSet,
//     financialStatus: order.displayFinancialStatus
//   });
// });

//   console.log(`Created today after filtering: ${filteredCreatedToday.length}`);
//   console.log(`Modified today after filtering: ${filteredModifiedToday.length}`);

//   // Process both sets of orders
//   const todayCreatedProcessed = processOrders(filteredCreatedToday);
//   const todayModifiedProcessed = processOrders(filteredModifiedToday);




  




// // DEBUG: Check tax data in modified orders
// console.log('=== MODIFIED ORDERS TAX DEBUG ===');
// todayModifiedProcessed.regularOrders.forEach((order: any) => {
//   console.log(`Modified order ${order.name}:`, {
//     taxes: order.calculatedTaxes,
//     currentTotalTaxSet: order.currentTotalTaxSet
//   });
// });


//   // Calculate summaries for both sets
// //   const todayCreatedSummary = calculateFinancialMetrics(todayCreatedProcessed.regularOrders);
// //   const todayCreatedGiftCardSummary = calculateFinancialMetrics(todayCreatedProcessed.giftCardOrders);
// //   const todayModifiedSummary = calculateFinancialMetrics(todayModifiedProcessed.regularOrders);
// //   const todayModifiedGiftCardSummary = calculateFinancialMetrics(todayModifiedProcessed.giftCardOrders);




// // Today's orders - use currentTotalTaxSet (false)
// const todayCreatedSummary = calculateFinancialMetrics(todayCreatedProcessed.regularOrders, false);
// const todayCreatedGiftCardSummary = calculateFinancialMetrics(todayCreatedProcessed.giftCardOrders, false);

// // Modified orders - use calculatedTaxes (true)  
// const todayModifiedSummary = calculateFinancialMetrics(todayModifiedProcessed.regularOrders, true);
// const todayModifiedGiftCardSummary = calculateFinancialMetrics(todayModifiedProcessed.giftCardOrders, true);


//   return json({ 
//     todayCreated: todayCreatedProcessed,
//     todayModified: todayModifiedProcessed,
//     summaries: {
//       created: {
//         regular: todayCreatedSummary,
//         giftCard: todayCreatedGiftCardSummary
//       },
//       modified: {
//         regular: todayModifiedSummary,
//         giftCard: todayModifiedGiftCardSummary
//       }
//     },
//     summary: {
//       date: new Date().toLocaleDateString('en-US', { 
//         weekday: 'long', 
//         year: 'numeric', 
//         month: 'long', 
//         day: 'numeric',
//         timeZone: storeTimezone 
//       }),
//       storeTimezone,
//       createdOrderCount: filteredCreatedToday.length,
//       modifiedOrderCount: filteredModifiedToday.length
//     },
//     debug: {
//       created: {
//         totalFetched: createdTodayOrders.length,
//         todayFiltered: filteredCreatedToday.length,
//         regularOrders: todayCreatedProcessed.regularOrders.length,
//         giftCardOrders: todayCreatedProcessed.giftCardOrders.length
//       },
//       modified: {
//         totalFetched: modifiedTodayOrders.length,
//         modifiedFiltered: filteredModifiedToday.length,
//         regularOrders: todayModifiedProcessed.regularOrders.length,
//         giftCardOrders: todayModifiedProcessed.giftCardOrders.length
//       }
//     }
//   });
// };

// // Supporting components
// function MetricsGrid({ metrics }: { metrics: any }) {
//   return (
//     <div style={{ 
//       display: 'grid', 
//       gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
//       gap: 16, 
//       marginBottom: 20,
//       padding: 16,
//       backgroundColor: '#f5f5f5',
//       borderRadius: 8
//     }}>
//       <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
//       <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
//       <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
//       <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
//       <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
//       <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
//       <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
//       <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
//     </div>
//   );
// }

// function OrdersTable({ orders, currencyCode, isGiftCard = false, showModified = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean, showModified?: boolean }) {
//   if (orders.length === 0) {
//     return (
//       <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
//         No {isGiftCard ? 'gift card ' : ''}orders {showModified ? 'modified' : 'created'} today.
//       </div>
//     );
//   }

//   return (
//     <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
//       <table style={{ width: '100%', borderCollapse: 'collapse' }}>
//         <thead style={{ backgroundColor: '#f5f5f5' }}>
//           <tr>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>
//               {showModified ? 'Created' : 'Time'}
//             </th>
//             {showModified && (
//               <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Modified</th>
//             )}
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
//             <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
//           </tr>
//         </thead>
//         <tbody>
//           {orders.map((order: any) => (
//             <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
//               <td style={{ padding: '12px' }}>
//                 <strong>{order.name}</strong>
//                 {order.note && (
//                   <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
//                      {order.note}
//                   </div>
//                 )}
//                 {order.isMixedOrderRegular && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Mixed Order (Regular Portion)
//                   </div>
//                 )}
//                 {order.isMixedOrderGiftCard && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Mixed Order (Gift Card Portion)
//                   </div>
//                 )}
//                 {order.isGiftCardOrder && (
//                   <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
//                     Gift Card Order
//                   </div>
//                 )}
//                 {order.calculatedDiscountAllocation && (
//                   <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
//                     Proportional Discount Applied
//                   </div>
//                 )}
//                 {showModified && (
//                   <div style={{ fontSize: '0.7em', color: '#FF6B35', marginTop: '2px', fontWeight: 'bold' }}>
//                     MODIFIED TODAY
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 {showModified ? (
//                   <>
//                     {new Date(order.createdAt).toLocaleDateString('en-US')}
//                     <div style={{ fontSize: '0.8em', color: '#666' }}>
//                       {new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                         hour: '2-digit', 
//                         minute: '2-digit'
//                       })}
//                     </div>
//                   </>
//                 ) : (
//                   new Date(order.createdAt).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })
//                 )}
//               </td>
//               {showModified && (
//                 <td style={{ padding: '12px' }}>
//                   {new Date(order.updatedAt).toLocaleTimeString('en-US', { 
//                     hour: '2-digit', 
//                     minute: '2-digit'
//                   })}
//                 </td>
//               )}
//               <td style={{ padding: '12px' }}>
//                 <span style={{
//                   padding: '4px 8px',
//                   borderRadius: '4px',
//                   fontSize: '0.8em',
//                   backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
//                                  order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
//                   color: 'white'
//                 }}>
//                   {order.displayFinancialStatus}
//                 </span>
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <strong>
//                   {order.calculatedTotalSales.toFixed(2)} {currencyCode}
//                 </strong>
//                 {order.calculatedGrossReturns > 0 && (
//                   <div style={{ fontSize: '0.8em', color: '#F44336' }}>
//                     Returns: -{order.calculatedGrossReturns.toFixed(2)}
//                   </div>
//                 )}
//               </td>
//               <td style={{ padding: '12px' }}>
//                 <div style={{ fontSize: '0.8em', color: '#666' }}>
//                   <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
//                   <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
//                   {order.calculatedReturnFees > 0 && (
//                     <div style={{ color: '#795548' }}>
//                       Return Fees: {order.calculatedReturnFees.toFixed(2)}
//                     </div>
//                   )}
//                   <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
//                   {order.calculatedDiscountAllocation && (
//                     <div style={{ color: '#FF9800' }}>
//                       Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
//                     </div>
//                   )}
//                   {order.hasOverRefund && (
//                     <div style={{ color: '#F44336' }}>Over Refund</div>
//                   )}
//                   {order.hasUnderRefund && (
//                     <div style={{ color: '#FF9800' }}>Under Refund</div>
//                   )}
//                 </div>
//               </td>
//             </tr>
//           ))}
//         </tbody>
//       </table>
//     </div>
//   );
// }

// function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
//   const isNegative = value < 0 && !isCount;
//   const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
//   return (
//     <div style={{
//       padding: '16px',
//       backgroundColor: 'white',
//       borderRadius: '8px',
//       border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
//       textAlign: 'center',
//       boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
//     }}>
//       <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
//         {title}
//       </div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
//         {!isCount && isNegative ? '-' : ''}
//         {currency && !isCount ? `${currency} ` : ''}
//         {displayValue}
//         {isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// function MetricItem({ title, value, currency, isCount = false }: any) {
//   const displayValue = isCount ? value : value.toFixed(2);
  
//   return (
//     <div>
//       <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
//       <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
//         {!isCount && currency}{displayValue}{isCount && ' orders'}
//       </div>
//     </div>
//   );
// }

// // SINGLE DEFAULT EXPORT - MERGED COMPONENT
// export default function OrdersToday() {
//   const { todayCreated, todayModified, summaries, summary, debug } = useLoaderData<typeof loader>();

//   return (
//     <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
//       <h2>Today's Orders & Modifications - {summary.date}</h2>
//       <p style={{ color: '#666', marginBottom: 20 }}>
//         Store Timezone: {summary.storeTimezone}  {summary.createdOrderCount} orders created today  {summary.modifiedOrderCount} past orders modified today
//       </p>

//       {/* TODAY'S ORDERS SECTION */}
//       <div style={{ marginBottom: 40, padding: 20, backgroundColor: '#f8f9fa', borderRadius: 8 }}>
//         <h2 style={{ borderBottom: '3px solid #4CAF50', paddingBottom: 8, color: '#4CAF50', marginBottom: 20 }}>
//            Orders Created Today
//         </h2>
        
//         {/* Regular Orders Created Today */}
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//             Regular Orders ({summaries.created.regular.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.created.regular} />
//           <OrdersTable 
//             orders={todayCreated.regularOrders} 
//             currencyCode={summaries.created.regular.currencyCode} 
//           />
//         </div>

//         {/* Gift Card Orders Created Today */}
//         {todayCreated.giftCardOrders.length > 0 && (
//           <div style={{ marginBottom: 40 }}>
//             <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//               Gift Card Orders ({summaries.created.giftCard.totalOrders} orders)
//             </h3>
//             <MetricsGrid metrics={summaries.created.giftCard} />
//             <OrdersTable 
//               orders={todayCreated.giftCardOrders} 
//               currencyCode={summaries.created.giftCard.currencyCode} 
//               isGiftCard={true} 
//             />
//           </div>
//         )}
//       </div>

//       {/* MODIFIED ORDERS SECTION */}
//       <div style={{ marginBottom: 40, padding: 20, backgroundColor: '#fff3e0', borderRadius: 8 }}>
//         <h2 style={{ borderBottom: '3px solid #FF6B35', paddingBottom: 8, color: '#FF6B35', marginBottom: 20 }}>
//            Past Orders Modified Today
//         </h2>
        
//         {/* Regular Orders Modified Today */}
//         <div style={{ marginBottom: 40 }}>
//           <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
//             Regular Orders ({summaries.modified.regular.totalOrders} orders)
//           </h3>
//           <MetricsGrid metrics={summaries.modified.regular} />
//           <OrdersTable 
//             orders={todayModified.regularOrders} 
//             currencyCode={summaries.modified.regular.currencyCode} 
//             showModified={true}
//           />
//         </div>

//         {/* Gift Card Orders Modified Today */}
//         {todayModified.giftCardOrders.length > 0 && (
//           <div style={{ marginBottom: 40 }}>
//             <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
//               Gift Card Orders ({summaries.modified.giftCard.totalOrders} orders)
//             </h3>
//             <MetricsGrid metrics={summaries.modified.giftCard} />
//             <OrdersTable 
//               orders={todayModified.giftCardOrders} 
//               currencyCode={summaries.modified.giftCard.currencyCode} 
//               isGiftCard={true} 
//               showModified={true}
//             />
//           </div>
//         )}
//       </div>

//       {/* COMBINED SUMMARY */}
//       <div style={{ 
//         padding: 20, 
//         backgroundColor: '#4CAF50', 
//         color: 'white', 
//         borderRadius: 8,
//         marginTop: 20
//       }}>
//         <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
//         <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
//           <MetricItem 
//             title="Total Sales (Created + Modified)" 
//             value={summaries.created.regular.totalSales + summaries.created.giftCard.totalSales + summaries.modified.regular.totalSales + summaries.modified.giftCard.totalSales} 
//             currency={summaries.created.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Total Orders" 
//             value={summaries.created.regular.totalOrders + summaries.created.giftCard.totalOrders + summaries.modified.regular.totalOrders + summaries.modified.giftCard.totalOrders} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Net Sales" 
//             value={summaries.created.regular.totalNetSales + summaries.created.giftCard.totalNetSales + summaries.modified.regular.totalNetSales + summaries.modified.giftCard.totalNetSales} 
//             currency={summaries.created.regular.currencyCode}
//           />
//           <MetricItem 
//             title="Orders Created Today" 
//             value={summary.createdOrderCount} 
//             isCount={true}
//           />
//           <MetricItem 
//             title="Orders Modified Today" 
//             value={summary.modifiedOrderCount} 
//             isCount={true}
//           />
//         </div>
//       </div>
//     </div>
//   );
// }









































import { json, LoaderFunctionArgs } from "@remix-run/node";
import { useLoaderData } from "@remix-run/react";
import { authenticate } from "../shopify.server";

// Helper function to convert a UTC date to store timezone and get YYYY-MM-DD
const getStoreLocalDateString = (utcDate: Date, timezone: string = 'America/New_York'): string => {
  return utcDate.toLocaleDateString('en-CA', { timeZone: timezone });
};

// Helper to check if a UTC date is today in store timezone
const isTodayInStoreTime = (utcDate: Date, storeTimezone: string = 'America/New_York'): boolean => {
  const nowUTC = new Date();
  const orderDateStore = getStoreLocalDateString(utcDate, storeTimezone);
  const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);
  return orderDateStore === todayStore;
};

// Proportional discount allocation function (matches Shopify's rounding)
function allocateDiscountProportional(totalDiscount: number, subtotalA: number, subtotalB: number) {
  const totalSubtotal = subtotalA + subtotalB;
  
  if (totalSubtotal === 0) {
    return { portionADiscount: 0, portionBDiscount: 0 };
  }
  
  // Calculate first portion with rounding to match Shopify
  const portionADiscount = Math.round((totalDiscount * (subtotalA / totalSubtotal)) * 100) / 100;
  
  // Derive second portion to ensure exact total
  const portionBDiscount = Math.round((totalDiscount - portionADiscount) * 100) / 100;
  
  return {
    portionADiscount,
    portionBDiscount
  };
}

// Calculate order metrics following your exact logic
// Calculate order metrics following your exact logic
// Calculate order metrics following your exact logic

function calculateOrderMetrics(order: any, isGiftCardPortion: boolean = false, originalOrder?: any) {
  console.log(` CALCULATING ORDER ${order.name} - GIFT CARD: ${isGiftCardPortion} `);
  
  // Use originalOrder for return detection if provided, otherwise use current order
  const orderForReturnDetection = originalOrder || order;
  
  // Calculate line items total (ORIGINAL prices before discounts)
  const lineItemsTotal = order.lineItems?.edges?.reduce((sum: number, li: any) => {
    return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
  }, 0) || 0;

  // Get discounts from the order data
  const discounts = parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);

  // Get refund discrepancy directly from Shopify
  const refundDiscrepancy = parseFloat(order.refundDiscrepancySet?.shopMoney?.amount || 0);
  console.log(` ${order.name} - Refund Discrepancy: $${refundDiscrepancy}, Is Gift Card: ${isGiftCardPortion}`);

  // Calculate gross returns with proper filtering for BOTH portions
  let grossReturns = 0;
  order.refunds?.forEach((refund: any) => {
    refund.refundLineItems?.edges?.forEach((edge: any) => {
      const lineItemName = edge.node.lineItem?.name?.toLowerCase() || '';
      const lineItemTitle = edge.node.lineItem?.title?.toLowerCase() || '';
      const isGiftCardItem = lineItemName.includes('gift card') || lineItemTitle.includes('gift card');
      
      // Gift card portion: ONLY include gift card refunds
      if (isGiftCardPortion && isGiftCardItem) {
        grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
        console.log(` Gift Card Refund Included: ${lineItemName} - $${edge.node.subtotalSet?.shopMoney?.amount}`);
      }
      // Regular portion: ONLY include non-gift card refunds  
      else if (!isGiftCardPortion && !isGiftCardItem) {
        grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
        console.log(` Regular Refund Included: ${lineItemName} - $${edge.node.subtotalSet?.shopMoney?.amount}`);
      }
      // Empty refunds (no line items) - only include in regular portion
      else if (!isGiftCardPortion && !edge.node.lineItem) {
        grossReturns += parseFloat(edge.node.subtotalSet?.shopMoney?.amount || 0);
        console.log(` Empty Refund Included in Regular: $${edge.node.subtotalSet?.shopMoney?.amount}`);
      }
    });
  });

  console.log(` ${order.name} - Gross Returns: $${grossReturns}`);

  // Calculate refunded shipping - FROM REFUNDS DATA (only for regular portions)
  let refundedShipping = 0;
  if (!isGiftCardPortion) {
    refundedShipping = parseFloat(order.totalRefundedShippingSet?.shopMoney?.amount || 0);
  }

  // Calculate shipping charges
  const shippingAmount = parseFloat(order.totalShippingPriceSet?.shopMoney?.amount || 0);
  const shippingCharges = shippingAmount - refundedShipping;

  //  NEW: MATCH RETURNS TO REFUNDS FOR FEE ALLOCATION
  const matchReturnsToRefunds = (returns: any[], refunds: any[]) => {
    const matchedFees = {
      giftCard: { restocking: 0, shipping: 0 },
      regular: { restocking: 0, shipping: 0 }
    };

    // Helper function to get restocking fee from a return item
    const getRestockingFee = (returnItem: any): number => {
      let total = 0;
      returnItem.returnLineItems?.nodes?.forEach((lineItem: any) => {
        if (lineItem.restockingFee?.amountSet?.shopMoney?.amount) {
          total += parseFloat(lineItem.restockingFee.amountSet.shopMoney.amount);
        }
      });
      return total;
    };

    // Helper function to get return shipping fee
    const getReturnShippingFee = (returnItem: any): number => {
      let total = 0;
      returnItem.returnShippingFees?.forEach((fee: any) => {
        if (fee.amountSet?.shopMoney?.amount) {
          total += parseFloat(fee.amountSet.shopMoney.amount);
        }
      });
      return total;
    };

    console.log(` ${order.name} - Matching ${returns.length} returns to ${refunds.length} refunds`);

    returns.forEach((returnItem, index) => {
      const correspondingRefund = refunds[index];
      
      console.log(` ${order.name} - Return #${index + 1}:`, {
        restockingFee: getRestockingFee(returnItem),
        shippingFee: getReturnShippingFee(returnItem),
        hasCorrespondingRefund: !!correspondingRefund
      });

      if (correspondingRefund) {
        // Check if this refund contains gift card items
        const hasGiftCardRefund = correspondingRefund.refundLineItems?.edges?.some((edge: any) => {
          const lineItemName = edge.node.lineItem?.name?.toLowerCase() || '';
          const lineItemTitle = edge.node.lineItem?.title?.toLowerCase() || '';
          return lineItemName.includes('gift card') || lineItemTitle.includes('gift card');
        });

        console.log(` ${order.name} - Return #${index + 1} has gift card refund: ${hasGiftCardRefund}`);

        if (hasGiftCardRefund) {
          // This return belongs to gift card portion
          matchedFees.giftCard.restocking += getRestockingFee(returnItem);
          matchedFees.giftCard.shipping += getReturnShippingFee(returnItem);
          console.log(` ${order.name} - Return #${index + 1} allocated to GIFT CARD: $${getRestockingFee(returnItem)} restocking + $${getReturnShippingFee(returnItem)} shipping`);
        } else {
          // This return belongs to regular portion
          matchedFees.regular.restocking += getRestockingFee(returnItem);
          matchedFees.regular.shipping += getReturnShippingFee(returnItem);
          console.log(` ${order.name} - Return #${index + 1} allocated to REGULAR: $${getRestockingFee(returnItem)} restocking + $${getReturnShippingFee(returnItem)} shipping`);
        }
      } else {
        // No corresponding refund - use business logic
        console.log(` ${order.name} - Return #${index + 1} has no corresponding refund, using fallback logic`);
      }
    });

    console.log(` ${order.name} - Final Fee Allocation:`, matchedFees);
    return matchedFees;
  };

  // Get the matched fees
  const matchedFees = matchReturnsToRefunds(
    orderForReturnDetection.returns?.nodes || [],
    order.refunds || []
  );

  // Now calculate fees based on whether this is gift card or regular portion
  let totalRestockingFees = 0;
  let totalReturnShippingFees = 0;

  if (isGiftCardPortion) {
    totalRestockingFees = matchedFees.giftCard.restocking;
    totalReturnShippingFees = matchedFees.giftCard.shipping;
    console.log(` ${order.name} - GIFT CARD PORTION FEES: $${totalRestockingFees} restocking + $${totalReturnShippingFees} shipping`);
  } else {
    totalRestockingFees = matchedFees.regular.restocking;
    totalReturnShippingFees = matchedFees.regular.shipping;
    console.log(` ${order.name} - REGULAR PORTION FEES: $${totalRestockingFees} restocking + $${totalReturnShippingFees} shipping`);
  }

  // Calculate total return fees (restocking + return shipping)
  const totalReturnFees = totalRestockingFees + totalReturnShippingFees;

  console.log(` ${order.name} - FINAL FEE SUMMARY:`);
  console.log(`   - Total Restocking Fees: $${totalRestockingFees}`);
  console.log(`   - Total Return Shipping Fees: $${totalReturnShippingFees}`);
  console.log(`   - Total Return Fees: $${totalReturnFees}`);
  console.log(`   - Is Gift Card Portion: ${isGiftCardPortion}`);

  // Calculate sales metrics using accurate data
  // Gross Sales = Original line items total (BEFORE any discounts)
  const grossSales = lineItemsTotal;

  // Net Sales = Gross Sales - Returns - Discounts
  let netSales = grossSales - grossReturns - discounts;
  console.log(` ${order.name} - Net Sales before discrepancy: $${netSales}`);

  // FIXED: Gift cards should NOT have refund discrepancies
  let finalRefundDiscrepancy = isGiftCardPortion ? 0 : refundDiscrepancy;
  console.log(` ${order.name} - Final Refund Discrepancy: $${finalRefundDiscrepancy}`);

  // Handle refund discrepancies - OVER-refunds ADD to net sales, UNDER-refunds DEDUCT from net sales
  if (finalRefundDiscrepancy > 0) {
    // Positive discrepancy = OVER-refund (we refunded more than we should have)
    netSales += finalRefundDiscrepancy;
    console.log(` ${order.name} - After OVER-refund: $${netSales}`);
  } else if (finalRefundDiscrepancy < 0) {
    // Negative discrepancy = UNDER-refund (we refunded less than we should have)
    netSales -= Math.abs(finalRefundDiscrepancy);
    console.log(` ${order.name} - After UNDER-refund: $${netSales}`);
  }

  console.log(` ${order.name} - Final Net Sales: $${netSales}`);

  // Calculate net returns (gross returns adjusted for discrepancies)
  let netReturns = grossReturns;
  if (finalRefundDiscrepancy > 0) {
    netReturns = grossReturns - finalRefundDiscrepancy;
  } else if (finalRefundDiscrepancy < 0) {
    netReturns = grossReturns + Math.abs(finalRefundDiscrepancy);
  }

  // Calculate taxes from line item tax lines (most reliable for modified orders)
  let taxes = 0;
  order.lineItems?.edges?.forEach((li: any) => {
    li.node.taxLines?.forEach((taxLine: any) => {
      taxes += parseFloat(taxLine.priceSet?.shopMoney?.amount || 0);
    });
  });

  // If no tax from line items, fallback to currentTotalTaxSet
  if (taxes === 0) {
    taxes = parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
  }

  // If this is a refunded order, make taxes negative
  // If there are refunds on this order, make taxes negative to reflect tax refund
  if (order.refunds && order.refunds.length > 0) {
    taxes = -Math.abs(taxes);
  }

  // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
  const totalSales = netSales + shippingCharges + totalReturnFees + taxes;

  console.log(` ${order.name} - FINAL TOTALS: Net Sales: $${netSales}, Total Sales: $${totalSales}, Return Fees: $${totalReturnFees}`);
  console.log(` ${order.name} - RETURN FEES: Restocking: $${totalRestockingFees}, Return Shipping: $${totalReturnShippingFees}, Total: $${totalReturnFees}`);

  return {
    ...order,
    // Core calculated metrics
    calculatedGrossSales: grossSales,
    calculatedGrossReturns: grossReturns,
    calculatedNetReturns: netReturns,
    calculatedRefundedShipping: refundedShipping,
    calculatedReturnShippingFees: totalReturnShippingFees,
    calculatedNetSales: netSales,
    calculatedRefundDiscrepancy: finalRefundDiscrepancy,
    calculatedRestockingFees: totalRestockingFees,
    calculatedReturnFees: totalReturnFees,
    calculatedShippingCharges: shippingCharges,
    calculatedTaxes: taxes,
    calculatedTotalSales: totalSales,
    
    // Add flags for display purposes
    hasOverRefund: finalRefundDiscrepancy > 0,
    hasUnderRefund: finalRefundDiscrepancy < 0,
    
    // Debug info for gift card returns
    hasGiftCardReturnsWithFees: isGiftCardPortion && (totalRestockingFees > 0 || totalReturnShippingFees > 0),
    
    // Add matched fee details for debugging
    calculatedMatchedFees: matchedFees
  };
}
// Process orders and separate gift card transactions with proportional discount allocation

// Process orders and separate gift card transactions with proportional discount allocation
// Process orders and separate gift card transactions with proportional discount allocation
const processOrders = (orders: any[]) => {
  const regularOrders: any[] = [];
  const giftCardOrders: any[] = [];
  const mixedOrdersRegular: any[] = [];
  const mixedOrdersGiftCard: any[] = [];

  orders.forEach((originalOrder: any) => {
    // Check if order contains gift cards
    const hasGiftCards = originalOrder.lineItems?.edges?.some((li: any) => 
      li.node.name?.toLowerCase().includes('gift card') || 
      li.node.title?.toLowerCase().includes('gift card') || 
      li.node.product?.title?.toLowerCase().includes('gift card')
    );

    if (!hasGiftCards) {
      // Pure regular order
      const processed = calculateOrderMetrics(originalOrder, false, originalOrder);
      regularOrders.push(processed);
    } else {
      // Order contains gift cards - check if mixed or pure gift card
      const giftCardLineItems = originalOrder.lineItems?.edges?.filter((li: any) => 
        li.node.name?.toLowerCase().includes('gift card') || 
        li.node.title?.toLowerCase().includes('gift card') || 
        li.node.product?.title?.toLowerCase().includes('gift card')
      );
      
      const regularLineItems = originalOrder.lineItems?.edges?.filter((li: any) => 
        !li.node.name?.toLowerCase().includes('gift card') && 
        !li.node.title?.toLowerCase().includes('gift card') && 
        !li.node.product?.title?.toLowerCase().includes('gift card')
      );

      if (regularLineItems.length > 0 && giftCardLineItems.length > 0) {
        // Mixed order - use proportional discount allocation
        
        // Calculate subtotals for each portion
        const regularSubtotal = regularLineItems.reduce((sum: number, li: any) => {
          return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
        }, 0);
        
        const giftCardSubtotal = giftCardLineItems.reduce((sum: number, li: any) => {
          return sum + parseFloat(li.node.originalTotalSet?.shopMoney?.amount || 0);
        }, 0);
        
        const totalOrderDiscount = parseFloat(originalOrder.totalDiscountsSet?.shopMoney?.amount || 0);
        
        // Allocate discount proportionally (matching Shopify's rounding)
        const discountAllocation = allocateDiscountProportional(
          totalOrderDiscount, 
          giftCardSubtotal, 
          regularSubtotal
        );
        
        const giftCardDiscount = discountAllocation.portionADiscount;
        const regularDiscount = discountAllocation.portionBDiscount;

        // Helper function to create money set
        const createMoneySet = (amount: number, currencyCode: string = 'USD') => {
          return {
            shopMoney: { 
              amount: amount.toFixed(2), 
              currencyCode: currencyCode || originalOrder.totalPriceSet?.shopMoney?.currencyCode || 'USD' 
            }
          };
        };

        // Create regular portion with proportional discount
        const regularPortion = {
          ...originalOrder,
          lineItems: { edges: regularLineItems },
          isMixedOrderRegular: true,
          // Apply proportional discount
          totalDiscountsSet: createMoneySet(regularDiscount),
          calculatedDiscountAllocation: {
            method: 'proportional',
            regularDiscount,
            giftCardDiscount,
            totalOrderDiscount
          }
        };
        
        // Create gift card portion with proportional discount and NO shipping
        const giftCardPortion = {
          ...originalOrder,
          lineItems: { edges: giftCardLineItems },
          isMixedOrderGiftCard: true,
          // Gift cards get NO shipping
          totalShippingPriceSet: createMoneySet(0),
          totalRefundedShippingSet: createMoneySet(0),
          // Apply proportional discount
          totalDiscountsSet: createMoneySet(giftCardDiscount),
          calculatedDiscountAllocation: {
            method: 'proportional',
            regularDiscount,
            giftCardDiscount,
            totalOrderDiscount
          }
        };

        // FIX: Pass originalOrder as third parameter for proper return detection
        const processedRegular = calculateOrderMetrics(regularPortion, false, originalOrder);
        const processedGiftCard = calculateOrderMetrics(giftCardPortion, true, originalOrder);
        
        mixedOrdersRegular.push(processedRegular);
        mixedOrdersGiftCard.push(processedGiftCard);
      } else {
        // Pure gift card order
        const giftCardOrder = {
          ...originalOrder,
          // Gift cards get NO shipping
          totalShippingPriceSet: { shopMoney: { amount: "0.00", currencyCode: originalOrder.totalShippingPriceSet?.shopMoney?.currencyCode || "USD" } },
          totalRefundedShippingSet: { shopMoney: { amount: "0.00", currencyCode: originalOrder.totalRefundedShippingSet?.shopMoney?.currencyCode || "USD" } }
        };
        // FIX: Pass originalOrder as third parameter
        const processed = calculateOrderMetrics(giftCardOrder, true, originalOrder);
        processed.isGiftCardOrder = true;
        giftCardOrders.push(processed);
      }
    }
  });

  // Combine all regular orders (pure regular + mixed regular portions)
  const allRegularOrders = [...regularOrders, ...mixedOrdersRegular];
  const allGiftCardOrders = [...giftCardOrders, ...mixedOrdersGiftCard];
  
  return {
    regularOrders: allRegularOrders,
    giftCardOrders: allGiftCardOrders
  };
};
// // Calculate financial metrics
// function calculateFinancialMetrics(orders: any[]): any {
//   const totalGrossSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedGrossSales || 0);
//   }, 0);

//   const totalDiscounts = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
//   }, 0);

//   const totalNetReturns = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetReturns || 0);
//   }, 0);

//   const totalNetSales = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedNetSales || 0);
//   }, 0);

//   const totalShippingCharges = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedShippingCharges || 0);
//   }, 0);

//   // Return fees (restocking + return shipping)
//   const totalReturnFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnFees || 0);
//   }, 0);

//   const totalTaxes = orders.reduce((sum: number, order: any) => {
//     return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
//   }, 0);

// // const totalTaxes = orders.reduce((sum: number, order: any) => {
// //   return sum + (order.calculatedTaxes || 0);
// // }, 0);

//   // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
//   const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

//   const totalOrders = orders.length;
//   const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

//   // Breakdown of return fees
//   const totalRestockingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedRestockingFees || 0);
//   }, 0);

//   const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
//     return sum + (order.calculatedReturnShippingFees || 0);
//   }, 0);

//   return {
//     totalGrossSales,
//     totalDiscounts,
//     totalReturns: totalNetReturns,
//     totalNetSales,
//     totalShippingCharges,
//     totalReturnFees,
//     totalTaxes,
//     totalSales,
//     totalOrders,
//     averageOrderValue,
//     totalRestockingFees,
//     totalReturnShippingFees,
//     currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
//   };
// }


function calculateFinancialMetrics(orders: any[], useCalculatedTaxes: boolean = false): any {
  const totalGrossSales = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedGrossSales || 0);
  }, 0);

  const totalDiscounts = orders.reduce((sum: number, order: any) => {
    return sum + parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0);
  }, 0);

  const totalNetReturns = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedNetReturns || 0);
  }, 0);

  const totalNetSales = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedNetSales || 0);
  }, 0);

  const totalShippingCharges = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedShippingCharges || 0);
  }, 0);

  // Return fees (restocking + return shipping)
  const totalReturnFees = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedReturnFees || 0);
  }, 0);

  // TAX CALCULATION - Use parameter to determine which method to use
  const totalTaxes = orders.reduce((sum: number, order: any) => {
    if (useCalculatedTaxes) {
      // For modified orders - use calculatedTaxes (handles refund scenarios)
      return sum + (order.calculatedTaxes || 0);
    } else {
      // For today's orders - use currentTotalTaxSet (original approach)
      return sum + parseFloat(order.currentTotalTaxSet?.shopMoney?.amount || 0);
    }
  }, 0);

  // TOTAL SALES = Net Sales + Shipping Charges + Return Fees + Taxes
  const totalSales = totalNetSales + totalShippingCharges + totalReturnFees + totalTaxes;

  const totalOrders = orders.length;
  const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

  // Breakdown of return fees
  const totalRestockingFees = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedRestockingFees || 0);
  }, 0);

  const totalReturnShippingFees = orders.reduce((sum: number, order: any) => {
    return sum + (order.calculatedReturnShippingFees || 0);
  }, 0);

  return {
    totalGrossSales,
    totalDiscounts,
    totalReturns: totalNetReturns,
    totalNetSales,
    totalShippingCharges,
    totalReturnFees,
    totalTaxes,
    totalSales,
    totalOrders,
    averageOrderValue,
    totalRestockingFees,
    totalReturnShippingFees,
    currencyCode: orders[0]?.totalPriceSet?.shopMoney?.currencyCode || 'USD'
  };
}

// Generic function to fetch orders with pagination
async function fetchOrdersWithPagination(admin: any, query: string, description: string) {
  let allOrders: any[] = [];
  let hasNextPage = true;
  let afterCursor = null;
  let pageCount = 0;
  const maxPages = 50;

  while (hasNextPage && pageCount < maxPages) {
    pageCount++;
    
    const paginationVariables: any = {
      query: query,
      first: 100
    };
    
    if (afterCursor) {
      paginationVariables.after = afterCursor;
    }

    try {
      const response = await admin.graphql(
        `#graphql
        query OrdersPaginated($query: String!, $first: Int!, $after: String) {
          orders(first: $first, query: $query, sortKey: CREATED_AT, reverse: true, after: $after) {
            pageInfo {
              hasNextPage
              endCursor
            }
            edges {
              cursor
              node {
                id
                name
                createdAt
                updatedAt
                displayFinancialStatus
                displayFulfillmentStatus
                confirmed
                cancelledAt
                cancelReason
                note
                fullyPaid
                totalReceivedSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalRefundedSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalOutstandingSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalDiscountsSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalShippingPriceSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalRefundedShippingSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                refundDiscrepancySet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                returns(first: 7) {
                  nodes {
                    returnLineItems(first: 10) {
                      nodes {
                        ... on ReturnLineItem {
                          restockingFee {
                            amountSet {
                              shopMoney {
                                amount
                                currencyCode
                              }
                            }
                          }
                        }
                      }
                    }
                    returnShippingFees {
                      amountSet {
                        shopMoney {
                          amount
                          currencyCode
                        }
                      }
                    }
                  }
                }
                refunds {
                  id
                  createdAt
                  note
                  totalRefundedSet {
                    shopMoney {
                      amount
                      currencyCode
                    }
                  }
                  refundLineItems(first: 10) {
                    edges {
                      node {
                        lineItem {
                          id
                          name
                        }
                        quantity
                        subtotalSet {
                          shopMoney {
                            amount
                            currencyCode
                          }
                        }
                        totalTaxSet {
                          shopMoney {
                            amount
                            currencyCode
                          }
                        }
                      }
                    }
                  }
                }
                currentSubtotalPriceSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                currentTotalTaxSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalTaxSet {
  shopMoney {
    amount
    currencyCode
  }
}
                currentTotalDiscountsSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                currentTotalPriceSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                subtotalPriceSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                totalPriceSet {
                  shopMoney {
                    amount
                    currencyCode
                  }
                }
                lineItems(first: 50) {
                  edges {
                    node {
                      id
                      name
                      title
                      quantity
                      sku
                      variantTitle
                      product {
                        id
                        title
                      }
                      variant {
                        id
                        title
                        sku
                        price
                      }
                      originalUnitPriceSet {
                        shopMoney {
                          amount
                          currencyCode
                        }
                      }
                      discountedUnitPriceSet {
                        shopMoney {
                          amount
                          currencyCode
                        }
                      }
                      discountedTotalSet {
                        shopMoney {
                          amount
                          currencyCode
                        }
                      }
                      originalTotalSet {
                        shopMoney {
                          amount
                          currencyCode
                        }
                      }
                      taxLines {
                        priceSet {
                          shopMoney {
                            amount
                            currencyCode
                          }
                        }
                        rate
                        title
                      }
                    }
                  }
                }
              }
            }
          }
        }`,
        { variables: paginationVariables }
      );

      const responseData: any = await response.json();
      
      // Handle GraphQL errors
      if (responseData.errors && Array.isArray(responseData.errors)) {
        console.error('GraphQL Errors:', responseData.errors);
        throw new Error(`GraphQL error: ${JSON.stringify(responseData.errors)}`);
      }

      const ordersData = responseData?.data?.orders;
      if (!ordersData) {
        console.error('No orders data in response:', responseData);
        break;
      }

      const pageOrders = ordersData?.edges?.map((x: any) => x.node) ?? [];
      console.log(`Page ${pageCount} (${description}): Fetched ${pageOrders.length} orders`);

      allOrders = [...allOrders, ...pageOrders];
      hasNextPage = ordersData?.pageInfo?.hasNextPage || false;
      afterCursor = ordersData?.pageInfo?.endCursor;

      // Add a small delay to be respectful of API limits
      if (hasNextPage) {
        await new Promise(resolve => setTimeout(resolve, 200));
      }

      console.log(`Total ${description} orders so far: ${allOrders.length}, Has next page: ${hasNextPage}`);

    } catch (error: any) {
      console.error(`Error fetching page ${pageCount} (${description}):`, error);
      break;
    }
  }

  console.log(`Pagination complete for ${description}. Total orders fetched: ${allOrders.length} over ${pageCount} pages`);
  return allOrders;
}

export const loader = async ({ request }: LoaderFunctionArgs) => {
  const { admin, session } = await authenticate.admin(request);
  const shop = session.shop;

  // Get store timezone (default to Eastern Time)
  const storeTimezone = 'America/New_York';
  
  // Get current UTC time
  const nowUTC = new Date();
  const todayStore = getStoreLocalDateString(nowUTC, storeTimezone);

  // Calculate reference dates for the queries - 7 months ago to cover all time ranges
  const sevenMonthsAgoUTC = new Date(nowUTC);
  sevenMonthsAgoUTC.setMonth(nowUTC.getMonth() - 7);

  // Get UTC date range for today
  const todayStart = new Date(`${todayStore}T00:00:00`);
  const todayEnd = new Date(`${todayStore}T23:59:59`);
  const todayStartUTC = todayStart.toISOString();
  const todayEndUTC = todayEnd.toISOString();

  console.log('Fetching all relevant orders for today...');
  console.log('Store timezone:', storeTimezone);
  console.log('Today in store time:', todayStore);

  // Fetch orders CREATED today
  const createdTodayQuery = `created_at:>=${todayStartUTC} created_at:<=${todayEndUTC}`;
  const createdTodayOrders = await fetchOrdersWithPagination(admin, createdTodayQuery, "created today");

  // Fetch orders MODIFIED today but CREATED before today
  const modifiedTodayQuery = `updated_at:>=${todayStartUTC} updated_at:<=${todayEndUTC} created_at:<${todayStartUTC}`;
  const modifiedTodayOrders = await fetchOrdersWithPagination(admin, modifiedTodayQuery, "modified today");

  // Filter created today orders to only include those created today (in store timezone)
  const filteredCreatedToday = createdTodayOrders.filter((order: any) => {
    const orderDateUTC = new Date(order.createdAt);
    return isTodayInStoreTime(orderDateUTC, storeTimezone);
  });

  // Filter modified today orders to only include those created before today
  const filteredModifiedToday = modifiedTodayOrders.filter((order: any) => {
    const orderCreatedUTC = new Date(order.createdAt);
    return !isTodayInStoreTime(orderCreatedUTC, storeTimezone);
  });

  // DEBUG: Check raw tax data from API for modified orders
console.log('=== RAW MODIFIED ORDERS TAX DATA ===');
filteredModifiedToday.slice(0, 3).forEach((order: any, index: number) => {
  console.log(`Modified order ${index + 1} (${order.name}):`, {
    currentTotalTaxSet: order.currentTotalTaxSet,
    totalPriceSet: order.totalPriceSet,
    financialStatus: order.displayFinancialStatus
  });
});

  console.log(`Created today after filtering: ${filteredCreatedToday.length}`);
  console.log(`Modified today after filtering: ${filteredModifiedToday.length}`);

  // Process both sets of orders
  const todayCreatedProcessed = processOrders(filteredCreatedToday);
  const todayModifiedProcessed = processOrders(filteredModifiedToday);

  

// DEBUG: Check tax data in modified orders
console.log('=== MODIFIED ORDERS TAX DEBUG ===');
todayModifiedProcessed.regularOrders.forEach((order: any) => {
  console.log(`Modified order ${order.name}:`, {
    taxes: order.calculatedTaxes,
    currentTotalTaxSet: order.currentTotalTaxSet
  });
});

  // Calculate summaries for both sets
//   const todayCreatedSummary = calculateFinancialMetrics(todayCreatedProcessed.regularOrders);
//   const todayCreatedGiftCardSummary = calculateFinancialMetrics(todayCreatedProcessed.giftCardOrders);
//   const todayModifiedSummary = calculateFinancialMetrics(todayModifiedProcessed.regularOrders);
//   const todayModifiedGiftCardSummary = calculateFinancialMetrics(todayModifiedProcessed.giftCardOrders);

// Today's orders - use currentTotalTaxSet (false)
const todayCreatedSummary = calculateFinancialMetrics(todayCreatedProcessed.regularOrders, false);
const todayCreatedGiftCardSummary = calculateFinancialMetrics(todayCreatedProcessed.giftCardOrders, false);

// Modified orders - use calculatedTaxes (true)  
const todayModifiedSummary = calculateFinancialMetrics(todayModifiedProcessed.regularOrders, true);
const todayModifiedGiftCardSummary = calculateFinancialMetrics(todayModifiedProcessed.giftCardOrders, true);

  return json({ 
    todayCreated: todayCreatedProcessed,
    todayModified: todayModifiedProcessed,
    summaries: {
      created: {
        regular: todayCreatedSummary,
        giftCard: todayCreatedGiftCardSummary
      },
      modified: {
        regular: todayModifiedSummary,
        giftCard: todayModifiedGiftCardSummary
      }
    },
    summary: {
      date: new Date().toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        timeZone: storeTimezone 
      }),
      storeTimezone,
      createdOrderCount: filteredCreatedToday.length,
      modifiedOrderCount: filteredModifiedToday.length
    },
    debug: {
      created: {
        totalFetched: createdTodayOrders.length,
        todayFiltered: filteredCreatedToday.length,
        regularOrders: todayCreatedProcessed.regularOrders.length,
        giftCardOrders: todayCreatedProcessed.giftCardOrders.length
      },
      modified: {
        totalFetched: modifiedTodayOrders.length,
        modifiedFiltered: filteredModifiedToday.length,
        regularOrders: todayModifiedProcessed.regularOrders.length,
        giftCardOrders: todayModifiedProcessed.giftCardOrders.length
      }
    }
  });
};

// Supporting components
function MetricsGrid({ metrics }: { metrics: any }) {
  return (
    <div style={{ 
      display: 'grid', 
      gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
      gap: 16, 
      marginBottom: 20,
      padding: 16,
      backgroundColor: '#f5f5f5',
      borderRadius: 8
    }}>
      <MetricCard title="Gross Sales" value={metrics.totalGrossSales} currency={metrics.currencyCode} color="#4CAF50" />
      <MetricCard title="Discounts" value={-metrics.totalDiscounts} currency={metrics.currencyCode} color="#FF9800" />
      <MetricCard title="Returns" value={-metrics.totalReturns} currency={metrics.currencyCode} color="#F44336" />
      <MetricCard title="Net Sales" value={metrics.totalNetSales} currency={metrics.currencyCode} color="#2196F3" />
      <MetricCard title="Shipping Charges" value={metrics.totalShippingCharges} currency={metrics.currencyCode} color="#9C27B0" />
      <MetricCard title="Return Fees" value={metrics.totalReturnFees} currency={metrics.currencyCode} color="#795548" />
      <MetricCard title="Taxes" value={metrics.totalTaxes} currency={metrics.currencyCode} color="#607D8B" />
      <MetricCard title="Total Sales" value={metrics.totalSales} currency={metrics.currencyCode} color="#4CAF50" emphasis={true} />
    </div>
  );
}

function OrdersTable({ orders, currencyCode, isGiftCard = false, showModified = false }: { orders: any[], currencyCode: string, isGiftCard?: boolean, showModified?: boolean }) {
  if (orders.length === 0) {
    return (
      <div style={{ textAlign: 'center', padding: '20px', color: '#666' }}>
        No {isGiftCard ? 'gift card ' : ''}orders {showModified ? 'modified' : 'created'} today.
      </div>
    );
  }

  return (
    <div style={{ border: '1px solid #ddd', borderRadius: 8, overflow: 'hidden' }}>
      <table style={{ width: '100%', borderCollapse: 'collapse' }}>
        <thead style={{ backgroundColor: '#f5f5f5' }}>
          <tr>
            <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Order</th>
            <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>
              {showModified ? 'Created' : 'Time'}
            </th>
            {showModified && (
              <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Modified</th>
            )}
            <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Status</th>
            <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Total Sales</th>
            <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>Details</th>
          </tr>
        </thead>
        <tbody>
          {orders.map((order: any) => (
            <tr key={order.id} style={{ borderBottom: '1px solid #eee' }}>
              <td style={{ padding: '12px' }}>
                <strong>{order.name}</strong>
                {order.note && (
                  <div style={{ fontSize: '0.8em', color: '#666', marginTop: '4px' }}>
                     {order.note}
                  </div>
                )}
                {order.isMixedOrderRegular && (
                  <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
                    Mixed Order (Regular Portion)
                  </div>
                )}
                {order.isMixedOrderGiftCard && (
                  <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
                    Mixed Order (Gift Card Portion)
                  </div>
                )}
                {order.isGiftCardOrder && (
                  <div style={{ fontSize: '0.7em', color: '#9C27B0', marginTop: '2px' }}>
                    Gift Card Order
                  </div>
                )}
                {order.calculatedDiscountAllocation && (
                  <div style={{ fontSize: '0.7em', color: '#FF9800', marginTop: '2px' }}>
                    Proportional Discount Applied
                  </div>
                )}
                {showModified && (
                  <div style={{ fontSize: '0.7em', color: '#FF6B35', marginTop: '2px', fontWeight: 'bold' }}>
                    MODIFIED TODAY
                  </div>
                )}
              </td>
              <td style={{ padding: '12px' }}>
                {showModified ? (
                  <>
                    {new Date(order.createdAt).toLocaleDateString('en-US')}
                    <div style={{ fontSize: '0.8em', color: '#666' }}>
                      {new Date(order.createdAt).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit'
                      })}
                    </div>
                  </>
                ) : (
                  new Date(order.createdAt).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                  })
                )}
              </td>
              {showModified && (
                <td style={{ padding: '12px' }}>
                  {new Date(order.updatedAt).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit'
                  })}
                </td>
              )}
              <td style={{ padding: '12px' }}>
                <span style={{
                  padding: '4px 8px',
                  borderRadius: '4px',
                  fontSize: '0.8em',
                  backgroundColor: order.displayFinancialStatus === 'PAID' ? '#4CAF50' : 
                                 order.displayFinancialStatus === 'PENDING' ? '#FF9800' : '#F44336',
                  color: 'white'
                }}>
                  {order.displayFinancialStatus}
                </span>
              </td>
              <td style={{ padding: '12px' }}>
                <strong>
                  {order.calculatedTotalSales.toFixed(2)} {currencyCode}
                </strong>
                {order.calculatedGrossReturns > 0 && (
                  <div style={{ fontSize: '0.8em', color: '#F44336' }}>
                    Returns: -{order.calculatedGrossReturns.toFixed(2)}
                  </div>
                )}
              </td>
              <td style={{ padding: '12px' }}>
                <div style={{ fontSize: '0.8em', color: '#666' }}>
                  <div>Net Sales: {order.calculatedNetSales.toFixed(2)}</div>
                  <div>Shipping: {order.calculatedShippingCharges.toFixed(2)}</div>
                  {order.calculatedReturnFees > 0 && (
                    <div style={{ color: '#795548' }}>
                      Return Fees: {order.calculatedReturnFees.toFixed(2)}
                    </div>
                  )}
                  <div>Taxes: {order.calculatedTaxes.toFixed(2)}</div>
                  {order.calculatedDiscountAllocation && (
                    <div style={{ color: '#FF9800' }}>
                      Discount: {parseFloat(order.totalDiscountsSet?.shopMoney?.amount || 0).toFixed(2)}
                    </div>
                  )}
                  {order.hasOverRefund && (
                    <div style={{ color: '#F44336' }}>Over Refund</div>
                  )}
                  {order.hasUnderRefund && (
                    <div style={{ color: '#FF9800' }}>Under Refund</div>
                  )}
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

function MetricCard({ title, value, currency, color = '#333', emphasis = false, isCount = false }: any) {
  const isNegative = value < 0 && !isCount;
  const displayValue = isCount ? value.toString() : Math.abs(value).toFixed(2);
  
  return (
    <div style={{
      padding: '16px',
      backgroundColor: 'white',
      borderRadius: '8px',
      border: emphasis ? `2px solid ${color}` : '1px solid #ddd',
      textAlign: 'center',
      boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
    }}>
      <div style={{ fontSize: '0.9em', fontWeight: 'bold', color: '#666', marginBottom: '8px' }}>
        {title}
      </div>
      <div style={{ fontSize: '1.2em', fontWeight: 'bold', color: isCount ? color : (isNegative ? '#F44336' : color) }}>
        {!isCount && isNegative ? '-' : ''}
        {currency && !isCount ? `${currency} ` : ''}
        {displayValue}
        {isCount && ' orders'}
      </div>
    </div>
  );
}

function MetricItem({ title, value, currency, isCount = false }: any) {
  const displayValue = isCount ? value : value.toFixed(2);
  
  return (
    <div>
      <div style={{ fontSize: '0.9em', opacity: 0.9 }}>{title}</div>
      <div style={{ fontSize: '1.2em', fontWeight: 'bold' }}>
        {!isCount && currency}{displayValue}{isCount && ' orders'}
      </div>
    </div>
  );
}

// SINGLE DEFAULT EXPORT - MERGED COMPONENT
export default function OrdersToday() {
  const { todayCreated, todayModified, summaries, summary, debug } = useLoaderData<typeof loader>();

  return (
    <div style={{ padding: 20, fontFamily: 'Arial, sans-serif' }}>
      <h2>Today's Orders & Modifications - {summary.date}</h2>
      <p style={{ color: '#666', marginBottom: 20 }}>
        Store Timezone: {summary.storeTimezone}  {summary.createdOrderCount} orders created today  {summary.modifiedOrderCount} past orders modified today
      </p>

      {/* TODAY'S ORDERS SECTION */}
      <div style={{ marginBottom: 40, padding: 20, backgroundColor: '#f8f9fa', borderRadius: 8 }}>
        <h2 style={{ borderBottom: '3px solid #4CAF50', paddingBottom: 8, color: '#4CAF50', marginBottom: 20 }}>
           Orders Created Today
        </h2>
        
        {/* Regular Orders Created Today */}
        <div style={{ marginBottom: 40 }}>
          <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
            Regular Orders ({summaries.created.regular.totalOrders} orders)
          </h3>
          <MetricsGrid metrics={summaries.created.regular} />
          <OrdersTable 
            orders={todayCreated.regularOrders} 
            currencyCode={summaries.created.regular.currencyCode} 
          />
        </div>

        {/* Gift Card Orders Created Today */}
        {todayCreated.giftCardOrders.length > 0 && (
          <div style={{ marginBottom: 40 }}>
            <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
              Gift Card Orders ({summaries.created.giftCard.totalOrders} orders)
            </h3>
            <MetricsGrid metrics={summaries.created.giftCard} />
            <OrdersTable 
              orders={todayCreated.giftCardOrders} 
              currencyCode={summaries.created.giftCard.currencyCode} 
              isGiftCard={true} 
            />
          </div>
        )}
      </div>

      {/* MODIFIED ORDERS SECTION */}
      <div style={{ marginBottom: 40, padding: 20, backgroundColor: '#fff3e0', borderRadius: 8 }}>
        <h2 style={{ borderBottom: '3px solid #FF6B35', paddingBottom: 8, color: '#FF6B35', marginBottom: 20 }}>
           Past Orders Modified Today
        </h2>
        
        {/* Regular Orders Modified Today */}
        <div style={{ marginBottom: 40 }}>
          <h3 style={{ borderBottom: '2px solid #2196F3', paddingBottom: 8, color: '#2196F3' }}>
            Regular Orders ({summaries.modified.regular.totalOrders} orders)
          </h3>
          <MetricsGrid metrics={summaries.modified.regular} />
          <OrdersTable 
            orders={todayModified.regularOrders} 
            currencyCode={summaries.modified.regular.currencyCode} 
            showModified={true}
          />
        </div>

        {/* Gift Card Orders Modified Today */}
        {todayModified.giftCardOrders.length > 0 && (
          <div style={{ marginBottom: 40 }}>
            <h3 style={{ borderBottom: '2px solid #9C27B0', paddingBottom: 8, color: '#9C27B0' }}>
              Gift Card Orders ({summaries.modified.giftCard.totalOrders} orders)
            </h3>
            <MetricsGrid metrics={summaries.modified.giftCard} />
            <OrdersTable 
              orders={todayModified.giftCardOrders} 
              currencyCode={summaries.modified.giftCard.currencyCode} 
              isGiftCard={true} 
              showModified={true}
            />
          </div>
        )}
      </div>

      {/* COMBINED SUMMARY */}
      <div style={{ 
        padding: 20, 
        backgroundColor: '#4CAF50', 
        color: 'white', 
        borderRadius: 8,
        marginTop: 20
      }}>
        <h3 style={{ margin: '0 0 10px 0' }}>Combined Today's Performance</h3>
        <div style={{ display: 'flex', gap: 20, flexWrap: 'wrap' }}>
          <MetricItem 
            title="Total Sales (Created + Modified)" 
            value={summaries.created.regular.totalSales + summaries.created.giftCard.totalSales + summaries.modified.regular.totalSales + summaries.modified.giftCard.totalSales} 
            currency={summaries.created.regular.currencyCode}
          />
          <MetricItem 
            title="Total Orders" 
            value={summaries.created.regular.totalOrders + summaries.created.giftCard.totalOrders + summaries.modified.regular.totalOrders + summaries.modified.giftCard.totalOrders} 
            isCount={true}
          />
          <MetricItem 
            title="Net Sales" 
            value={summaries.created.regular.totalNetSales + summaries.created.giftCard.totalNetSales + summaries.modified.regular.totalNetSales + summaries.modified.giftCard.totalNetSales} 
            currency={summaries.created.regular.currencyCode}
          />
          <MetricItem 
            title="Orders Created Today" 
            value={summary.createdOrderCount} 
            isCount={true}
          />
          <MetricItem 
            title="Orders Modified Today" 
            value={summary.modifiedOrderCount} 
            isCount={true}
          />
        </div>
      </div>
    </div>
  );
}



